{"version":3,"file":"Search-ZA6utDAO.js","sources":["../../src/pages/Search/Search.tsx"],"sourcesContent":["import ReadEditor from '@/components/ReadEditor/ReadEditor'\nimport Avatar from '@/components/Avatar/Avatar'\nimport { $t, msgType } from '@/shared'\nimport useCacheStore from '@/stores/cache'\nimport useMessageStore from '@/stores/message'\nimport { useAsyncEffect } from '@reactuses/core'\nimport { List, ListItem, NavTitle, Navbar, Page, PageContent, Searchbar, Subnavbar } from 'framework7-react'\nimport { useCallback, useState } from 'react'\n\nconst Search: React.FC<RouterProps> = ({ f7router }) => {\n\tconst cacheStore = useCacheStore()\n\tconst messageStore = useMessageStore()\n\n\tconst [keyword, setKeyword] = useState<string>('')\n\tconst [dialogList, setDialogList] = useState<any[]>([])\n\n\tuseAsyncEffect(\n\t\tasync () => {\n\t\t\tconst dialogs: any[] = []\n\t\t\t// console.log('keyword', keyword)\n\t\t\tif (keyword.trim() === '') {\n\t\t\t\tsetDialogList([])\n\t\t\t\treturn\n\t\t\t}\n\t\t\t// 遍历所有会话消息\n\t\t\tawait Promise.all(\n\t\t\t\tcacheStore.cacheDialogs.map(async (dialog) => {\n\t\t\t\t\tconst newDialog = { ...dialog, msgs: [] }\n\t\t\t\t\tconst dialogAllMsg = await cacheStore.get(`${dialog.dialog_id}`)\n\t\t\t\t\tif (dialogAllMsg.length <= 0) return\n\t\t\t\t\tconst dialogMsg = dialogAllMsg.filter((i: any) => i.msg_type === msgType.TEXT)\n\t\t\t\t\tif (dialogMsg.length <= 0) return\n\t\t\t\t\tconst msgs = dialogMsg.filter((i: any) => {\n\t\t\t\t\t\t// console.log('比配')\n\t\t\t\t\t\t// console.log(keyword)\n\t\t\t\t\t\t// console.log(console.log(handlerContent(i.content)))\n\t\t\t\t\t\t// console.log()\n\t\t\t\t\t\treturn handlerContent(i.content).indexOf(keyword) !== -1\n\t\t\t\t\t})\n\t\t\t\t\tif (dialog.dialog_name.indexOf(keyword) !== -1 || msgs.length > 0) {\n\t\t\t\t\t\t// console.log(dialog?.dialog_name, msgs)\n\t\t\t\t\t\tnewDialog.msgs = msgs\n\t\t\t\t\t\tdialogs.push(newDialog)\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t)\n\t\t\t// console.log('dialogs', dialogs)\n\t\t\tsetDialogList(dialogs)\n\t\t},\n\t\t() => {},\n\t\t[keyword]\n\t)\n\n\tconst handlerContent = useCallback((content: string) => {\n\t\tconst doc = new DOMParser().parseFromString(content, 'text/html')\n\t\tconst imgs = doc.querySelectorAll('img')\n\n\t\t// 替换图片\n\t\tif (imgs.length) {\n\t\t\tconst span = document.createElement('span')\n\t\t\tspan.textContent = $t('[图片]')\n\t\t\t// 全部替换为 文字\n\t\t\tfor (let i = 0; i < imgs.length; i++) {\n\t\t\t\timgs[i].replaceWith(span)\n\t\t\t}\n\t\t\tcontent = doc.body.innerHTML\n\t\t}\n\t\treturn content\n\t}, [])\n\n\tconst Row = (item: any) => {\n\t\treturn item.msgs.map((msg: any) => {\n\t\t\treturn (\n\t\t\t\t<ReadEditor\n\t\t\t\t\tcontent={\n\t\t\t\t\t\t(item?.group_id && msg?.sender_info?.name ? msg.sender_info?.name + ':' : '') +\n\t\t\t\t\t\thandlerContent(msg?.content ?? '')\n\t\t\t\t\t}\n\t\t\t\t\tclassName=\"dialog-read-editor\"\n\t\t\t\t/>\n\t\t\t)\n\t\t})\n\t}\n\n\treturn (\n\t\t<Page className=\"group-page\" noToolbar messagesContent>\n\t\t\t<Navbar className=\"messages-navbar\" backLink>\n\t\t\t\t<NavTitle>\n\t\t\t\t\t<div className=\"\">{$t('搜索')}</div>\n\t\t\t\t</NavTitle>\n\t\t\t\t<Subnavbar inner={false}>\n\t\t\t\t\t<Searchbar\n\t\t\t\t\t\tsearchContainer=\".contacts-list\"\n\t\t\t\t\t\tplaceholder={$t('输入关键字')}\n\t\t\t\t\t\tsearchIn=\".item-inner\"\n\t\t\t\t\t\toutline={false}\n\t\t\t\t\t\tdisableButtonText={$t('取消')}\n\t\t\t\t\t\tonChange={(e) => setKeyword(e.target.value)}\n\t\t\t\t\t/>\n\t\t\t\t</Subnavbar>\n\t\t\t</Navbar>\n\t\t\t<PageContent className=\"p-0\">\n\t\t\t\t<List contactsList noChevron mediaList dividers>\n\t\t\t\t\t{dialogList.map((dialog: any) => (\n\t\t\t\t\t\t<ListItem\n\t\t\t\t\t\t\tkey={dialog?.dialog_id}\n\t\t\t\t\t\t\tlink\n\t\t\t\t\t\t\tonClick={async () => {\n\t\t\t\t\t\t\t\tmessageStore.init({\n\t\t\t\t\t\t\t\t\tdialogId: dialog?.dialog_id ?? 0,\n\t\t\t\t\t\t\t\t\treceiverId: dialog?.user_id ?? dialog?.group_id ?? 0,\n\t\t\t\t\t\t\t\t\tisGroup: !!dialog?.group_id,\n\t\t\t\t\t\t\t\t\treceiverInfo: dialog\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\tf7router?.navigate(\n\t\t\t\t\t\t\t\t\t`/message/${dialog?.user_id ?? dialog?.group_id}/${dialog?.dialog_id}/?is_group=${dialog?.user_id ? 'false' : 'true'}&dialog_name=${dialog?.dialog_name}`\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<Avatar slot=\"media\" size={50} src={`${dialog?.dialog_avatar}`} />\n\t\t\t\t\t\t\t<span slot=\"title\">{dialog?.dialog_name}</span>\n\t\t\t\t\t\t\t<span slot=\"footer\">\n\t\t\t\t\t\t\t\t{`发现「${dialog.msgs.length}」条消息`}\n\t\t\t\t\t\t\t\t{Row(dialog)}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</ListItem>\n\t\t\t\t\t))}\n\t\t\t\t</List>\n\t\t\t</PageContent>\n\t\t</Page>\n\t)\n}\n\nexport default Search\n"],"names":["Search","f7router","cacheStore","useCacheStore","messageStore","useMessageStore","keyword","setKeyword","useState","dialogList","setDialogList","useAsyncEffect","dialogs","dialog","newDialog","dialogAllMsg","dialogMsg","i","msgType","msgs","handlerContent","useCallback","content","doc","imgs","span","$t","Row","item","msg","jsx","ReadEditor","_a","_b","Page","jsxs","Navbar","NavTitle","Subnavbar","Searchbar","PageContent","List","ListItem","Avatar"],"mappings":"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"}