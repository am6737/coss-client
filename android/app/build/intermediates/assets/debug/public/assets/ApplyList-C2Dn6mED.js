import{r as f,g as O,h as G,i as U,R as S,a9 as q,e as V,aa as t,v as $,u as M,Q as B,j as e,P as H,N as Q,O as m,b as p,$ as l,L as z,l as D,ab as E,q as c,f as C,H as k,ac as y,ad as F,E as J}from"./index-CyFq9ppu.js";function L(){return L=Object.assign?Object.assign.bind():function(n){for(var o=1;o<arguments.length;o++){var u=arguments[o];for(var g in u)Object.prototype.hasOwnProperty.call(u,g)&&(n[g]=u[g])}return n},L.apply(this,arguments)}const T=f.forwardRef((n,o)=>{const{className:u,id:g,style:N,children:_,raised:j,raisedIos:R,raisedMd:h,round:I,roundIos:b,roundMd:A,strong:s,strongIos:r,strongMd:a,tag:d="div"}=n,i=O(n),x=f.useRef(null);f.useImperativeHandle(o,()=>({el:x.current}));const v=G(u,{segmented:!0,"segmented-raised":j,"segmented-raised-ios":R,"segmented-raised-md":h,"segmented-round":I,"segmented-round-ios":b,"segmented-round-md":A,"segmented-strong":s,"segmented-strong-ios":r,"segmented-strong-md":a},U(n)),P=d;return S.createElement(P,L({id:g,style:N,className:v,ref:x},i),_,(s||r||a)&&S.createElement("span",{className:"segmented-highlight"}))});T.displayName="f7-segmented";const K=T,w=q(V)||"",X=()=>{const[n,o]=f.useState(t.FRIEND),[u,g]=f.useState([]),{updateContacts:N}=$(),_=M(()=>c.findAll(c.tables.apply_list))||[],j=async()=>{const r=(await c.findAll(c.tables.apply_list)).filter(a=>n===t.FRIEND?a==null?void 0:a.sender_id:!(a!=null&&a.sender_id));return g(r),r},R=async()=>{try{const s=await j(),{data:r}=n===t.FRIEND?await k.friendApplyListApi({user_id:w}):await F.groupRequestListApi({user_id:w});r.map(async a=>{const d=s.find(i=>i.id===(n===t.FRIEND?a==null?void 0:a.id:`group_${a==null?void 0:a.id}`));d?!J(d,a)&&await c.update(c.tables.apply_list,"id",a==null?void 0:a.id,a):await c.add(c.tables.apply_list,{...a,id:n===t.FRIEND?a.id:`group_${a.id}`})})}catch(s){console.error("获取申请列表失败",s==null?void 0:s.message)}};f.useEffect(()=>{_.length&&j()},[_]),B(async()=>{await R()},()=>{},[n]);const h=async(s,r=0)=>{try{C.dialog.preloader(l("处理中..."));const a=r===E.ACCEPT;let d="";a&&(d="test");const{code:i,msg:x}=n===t.FRIEND?await k.manageFriendApplyApi({request_id:s.id,action:r,e2e_public_key:d}):(s==null?void 0:s.status)===y.INVITE_RECEIVER?await F.manageGroupRequestApi({group_id:s.group_id,action:r,id:parseInt(s.id.split("_")[1])}):await F.manageGroupRequestAdminApi({group_id:s.group_id,action:r,id:parseInt(s.id.split("_")[1])});if(i!==200){C.dialog.alert(l(x));return}await c.update(c.tables.apply_list,"id",s.id,{...s,status:a?y.ACCEPT:y.REFUSE}),await R(),N(!0)}catch(a){console.error("处理好友请求失败",a),C.dialog.alert(l("处理好友请求失败"))}finally{C.dialog.close()}},I=s=>({0:"待验证",1:"已通过",2:"已拒绝",3:"待验证",4:"邀请接收者"})[s],b=({status:s,sender_id:r})=>n===t.FRIEND?s===y.PENDING&&r!==w:s===y.PENDING||s===y.INVITE_RECEIVER,A=({status:s,sender_info:r})=>n===t.FRIEND?r.user_id===w:s===y.INVITE_SENDER;return e.jsxs(H,{noToolbar:!0,className:"bg-bgTertiary",onPageBeforeOut:()=>N(!0),children:[e.jsx(Q,{backLink:!0,className:"coss_applylist_navbar bg-bgPrimary hidden-navbar-bg",children:e.jsx(m,{children:e.jsxs(K,{strong:!0,children:[e.jsx(p,{active:n===t.FRIEND,onClick:()=>o(t.FRIEND),children:l("好友申请")}),e.jsx(p,{active:n===t.GROUP,onClick:()=>o(t.GROUP),children:l("群聊申请")})]})})}),e.jsx(z,{strongIos:!0,className:"mt-0",mediaList:!0,children:u.map((s,r)=>{var a,d,i,x,v;return n===t.FRIEND?e.jsxs(D,{text:l((s==null?void 0:s.remark)||"对方没有留言"),children:[e.jsx("div",{slot:"media",className:"w-12 h-12",children:e.jsx("img",{src:(a=s==null?void 0:s.receiver_info)==null?void 0:a.user_avatar,className:"w-full h-full object-cover rounded-full bg-black bg-opacity-10"})}),e.jsx("div",{slot:"title",children:e.jsx("span",{children:l((d=s==null?void 0:s.receiver_info)==null?void 0:d.user_name)})}),e.jsx("div",{slot:"content",className:"pr-2 flex",children:b(s)?e.jsxs(e.Fragment,{children:[e.jsx(p,{className:"text-sm text-red-500",onClick:()=>h(s,E.REFUSE),children:"拒绝"}),e.jsx(p,{className:"text-sm text-primary",onClick:()=>h(s,E.ACCEPT),children:"同意"})]}):e.jsx(p,{className:"text-sm text-gray-500",onClick:()=>{},children:I(s.status)})})]},r):e.jsxs(D,{text:l((s==null?void 0:s.remark)||"对方没有留言"),children:[e.jsx("div",{slot:"media",className:"w-12 h-12",children:e.jsx("img",{src:(i=s==null?void 0:s.receiver_info)==null?void 0:i.user_avatar,className:"w-full h-full object-cover rounded-full bg-black bg-opacity-10"})}),e.jsxs("div",{slot:"title",children:[e.jsx("span",{children:l(A(s)?"你":(x=s==null?void 0:s.sender_info)==null?void 0:x.user_name)}),e.jsx("span",{children:l("邀请")}),e.jsx("span",{children:l(A(s)?(v=s==null?void 0:s.receiver_info)==null?void 0:v.user_name:"你")}),e.jsx("span",{children:l("加入")}),e.jsx("span",{children:l(s==null?void 0:s.group_name)})]}),e.jsx("div",{slot:"content",className:"pr-2 flex",children:b(s)?e.jsxs(e.Fragment,{children:[e.jsx(p,{className:"text-sm text-red-500",onClick:()=>h(s,E.REFUSE),children:"拒绝"}),e.jsx(p,{className:"text-sm text-primary",onClick:()=>h(s,E.ACCEPT),children:"同意"})]}):e.jsx(p,{className:"text-sm text-gray-500",onClick:()=>{},children:I(s.status)})})]},r)})})]})};export{X as default};
