import{r as f,aj as gl,ak as vl,c as bl,x as $o,aa as yl,e as kl,al as gt,am as Sl,an as Cl,f as rr,j as K,P as Tl,ao as As,ap as Ds,b as Ls}from"./index-Bku3qZqe.js";const wl=n=>{const e=f.useRef(n);return f.useEffect(()=>{e.current=n}),e};var Us={};function El(n,e){return e.forEach(function(t){t&&typeof t!="string"&&!Array.isArray(t)&&Object.keys(t).forEach(function(i){if(i!=="default"&&!(i in n)){var r=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(n,i,r.get?r:{enumerable:!0,get:function(){return t[i]}})}})}),Object.freeze(n)}var Pl=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function xl(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var Yo={exports:{}};(function(n){(function(e,t){n.exports?n.exports=t():e.log=t()})(Pl,function(){var e=function(){},t="undefined",i=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),r=["trace","debug","info","warn","error"];function s(v,b){var k=v[b];if(typeof k.bind=="function")return k.bind(v);try{return Function.prototype.bind.call(k,v)}catch{return function(){return Function.prototype.apply.apply(k,[v,arguments])}}}function o(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function a(v){return v==="debug"&&(v="log"),typeof console===t?!1:v==="trace"&&i?o:console[v]!==void 0?s(console,v):console.log!==void 0?s(console,"log"):e}function c(v,b){for(var k=0;k<r.length;k++){var S=r[k];this[S]=k<v?e:this.methodFactory(S,v,b)}this.log=this.debug}function l(v,b,k){return function(){typeof console!==t&&(c.call(this,b,k),this[v].apply(this,arguments))}}function u(v,b,k){return a(v)||l.apply(this,arguments)}function d(v,b,k){var S=this,O;b=b??"WARN";var x="loglevel";typeof v=="string"?x+=":"+v:typeof v=="symbol"&&(x=void 0);function _(P){var V=(r[P]||"silent").toUpperCase();if(!(typeof window===t||!x)){try{window.localStorage[x]=V;return}catch{}try{window.document.cookie=encodeURIComponent(x)+"="+V+";"}catch{}}}function A(){var P;if(!(typeof window===t||!x)){try{P=window.localStorage[x]}catch{}if(typeof P===t)try{var V=window.document.cookie,$=V.indexOf(encodeURIComponent(x)+"=");$!==-1&&(P=/^([^;]+)/.exec(V.slice($))[1])}catch{}return S.levels[P]===void 0&&(P=void 0),P}}function j(){if(!(typeof window===t||!x)){try{window.localStorage.removeItem(x);return}catch{}try{window.document.cookie=encodeURIComponent(x)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}S.name=v,S.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},S.methodFactory=k||u,S.getLevel=function(){return O},S.setLevel=function(P,V){if(typeof P=="string"&&S.levels[P.toUpperCase()]!==void 0&&(P=S.levels[P.toUpperCase()]),typeof P=="number"&&P>=0&&P<=S.levels.SILENT){if(O=P,V!==!1&&_(P),c.call(S,P,v),typeof console===t&&P<S.levels.SILENT)return"No console available for logging"}else throw"log.setLevel() called with invalid level: "+P},S.setDefaultLevel=function(P){b=P,A()||S.setLevel(P,!1)},S.resetLevel=function(){S.setLevel(b,!1),j()},S.enableAll=function(P){S.setLevel(S.levels.TRACE,P)},S.disableAll=function(P){S.setLevel(S.levels.SILENT,P)};var N=A();N==null&&(N=b),S.setLevel(N,!1)}var h=new d,m={};h.getLogger=function(b){if(typeof b!="symbol"&&typeof b!="string"||b==="")throw new TypeError("You must supply a name when creating a logger.");var k=m[b];return k||(k=m[b]=new d(b,h.getLevel(),h.methodFactory)),k};var g=typeof window!==t?window.log:void 0;return h.noConflict=function(){return typeof window!==t&&window.log===h&&(window.log=g),h},h.getLoggers=function(){return m},h.default=h,h})})(Yo);var rs=Yo.exports,Cr;(function(n){n[n.trace=0]="trace",n[n.debug=1]="debug",n[n.info=2]="info",n[n.warn=3]="warn",n[n.error=4]="error",n[n.silent=5]="silent"})(Cr||(Cr={}));var dt;(function(n){n.Default="livekit",n.Room="livekit-room",n.Participant="livekit-participant",n.Track="livekit-track",n.Publication="livekit-track-publication",n.Engine="livekit-engine",n.Signal="livekit-signal",n.PCManager="livekit-pc-manager",n.PCTransport="livekit-pc-transport",n.E2EE="lk-e2ee"})(dt||(dt={}));let U=rs.getLogger("livekit");U.setDefaultLevel(Cr.info);function zt(n){const e=rs.getLogger(n);return e.setDefaultLevel(U.getLevel()),e}rs.getLogger("lk-e2ee");function ke(n,e){if(!n)throw new Error(e)}const Ol=34028234663852886e22,Rl=-34028234663852886e22,Il=4294967295,_l=2147483647,Ml=-2147483648;function Ti(n){if(typeof n!="number")throw new Error("invalid int 32: "+typeof n);if(!Number.isInteger(n)||n>_l||n<Ml)throw new Error("invalid int 32: "+n)}function Tr(n){if(typeof n!="number")throw new Error("invalid uint 32: "+typeof n);if(!Number.isInteger(n)||n>Il||n<0)throw new Error("invalid uint 32: "+n)}function Qo(n){if(typeof n!="number")throw new Error("invalid float 32: "+typeof n);if(Number.isFinite(n)&&(n>Ol||n<Rl))throw new Error("invalid float 32: "+n)}const Xo=Symbol("@bufbuild/protobuf/enum-type");function Nl(n){const e=n[Xo];return ke(e,"missing enum type on enum object"),e}function Zo(n,e,t,i){n[Xo]=ea(e,t.map(r=>({no:r.no,name:r.name,localName:n[r.no]})))}function ea(n,e,t){const i=Object.create(null),r=Object.create(null),s=[];for(const o of e){const a=ta(o);s.push(a),i[o.name]=a,r[o.no]=a}return{typeName:n,values:s,findName(o){return i[o]},findNumber(o){return r[o]}}}function Al(n,e,t){const i={};for(const r of e){const s=ta(r);i[s.localName]=s.no,i[s.no]=s.localName}return Zo(i,n,e),i}function ta(n){return"localName"in n?n:Object.assign(Object.assign({},n),{localName:n.name})}class I{equals(e){return this.getType().runtime.util.equals(this.getType(),this,e)}clone(){return this.getType().runtime.util.clone(this)}fromBinary(e,t){const i=this.getType(),r=i.runtime.bin,s=r.makeReadOptions(t);return r.readMessage(this,s.readerFactory(e),e.byteLength,s),this}fromJson(e,t){const i=this.getType(),r=i.runtime.json,s=r.makeReadOptions(t);return r.readMessage(i,e,s,this),this}fromJsonString(e,t){let i;try{i=JSON.parse(e)}catch(r){throw new Error("cannot decode ".concat(this.getType().typeName," from JSON: ").concat(r instanceof Error?r.message:String(r)))}return this.fromJson(i,t)}toBinary(e){const t=this.getType(),i=t.runtime.bin,r=i.makeWriteOptions(e),s=r.writerFactory();return i.writeMessage(this,s,r),s.finish()}toJson(e){const t=this.getType(),i=t.runtime.json,r=i.makeWriteOptions(e);return i.writeMessage(this,r)}toJsonString(e){var t;const i=this.toJson(e);return JSON.stringify(i,null,(t=e==null?void 0:e.prettySpaces)!==null&&t!==void 0?t:0)}toJSON(){return this.toJson({emitDefaultValues:!0})}getType(){return Object.getPrototypeOf(this).constructor}}function Dl(n,e,t,i){var r;const s=(r=i==null?void 0:i.localName)!==null&&r!==void 0?r:e.substring(e.lastIndexOf(".")+1),o={[s]:function(a){n.util.initFields(this),n.util.initPartial(a,this)}}[s];return Object.setPrototypeOf(o.prototype,new I),Object.assign(o,{runtime:n,typeName:e,fields:n.util.newFieldList(t),fromBinary(a,c){return new o().fromBinary(a,c)},fromJson(a,c){return new o().fromJson(a,c)},fromJsonString(a,c){return new o().fromJsonString(a,c)},equals(a,c){return n.util.equals(o,a,c)}}),o}function Ll(n,e,t,i){return{syntax:n,json:e,bin:t,util:i,makeMessageType(r,s,o){return Dl(this,r,s,o)},makeEnum:Al,makeEnumType:ea,getEnumType:Nl}}var w;(function(n){n[n.DOUBLE=1]="DOUBLE",n[n.FLOAT=2]="FLOAT",n[n.INT64=3]="INT64",n[n.UINT64=4]="UINT64",n[n.INT32=5]="INT32",n[n.FIXED64=6]="FIXED64",n[n.FIXED32=7]="FIXED32",n[n.BOOL=8]="BOOL",n[n.STRING=9]="STRING",n[n.BYTES=12]="BYTES",n[n.UINT32=13]="UINT32",n[n.SFIXED32=15]="SFIXED32",n[n.SFIXED64=16]="SFIXED64",n[n.SINT32=17]="SINT32",n[n.SINT64=18]="SINT64"})(w||(w={}));var gn;(function(n){n[n.BIGINT=0]="BIGINT",n[n.STRING=1]="STRING"})(gn||(gn={}));function Ul(){let n=0,e=0;for(let i=0;i<28;i+=7){let r=this.buf[this.pos++];if(n|=(r&127)<<i,!(r&128))return this.assertBounds(),[n,e]}let t=this.buf[this.pos++];if(n|=(t&15)<<28,e=(t&112)>>4,!(t&128))return this.assertBounds(),[n,e];for(let i=3;i<=31;i+=7){let r=this.buf[this.pos++];if(e|=(r&127)<<i,!(r&128))return this.assertBounds(),[n,e]}throw new Error("invalid varint")}function sr(n,e,t){for(let s=0;s<28;s=s+7){const o=n>>>s,a=!(!(o>>>7)&&e==0),c=(a?o|128:o)&255;if(t.push(c),!a)return}const i=n>>>28&15|(e&7)<<4,r=!!(e>>3);if(t.push((r?i|128:i)&255),!!r){for(let s=3;s<31;s=s+7){const o=e>>>s,a=!!(o>>>7),c=(a?o|128:o)&255;if(t.push(c),!a)return}t.push(e>>>31&1)}}const wi=4294967296;function Fs(n){const e=n[0]==="-";e&&(n=n.slice(1));const t=1e6;let i=0,r=0;function s(o,a){const c=Number(n.slice(o,a));r*=t,i=i*t+c,i>=wi&&(r=r+(i/wi|0),i=i%wi)}return s(-24,-18),s(-18,-12),s(-12,-6),s(-6),e?ia(i,r):ss(i,r)}function Fl(n,e){let t=ss(n,e);const i=t.hi&2147483648;i&&(t=ia(t.lo,t.hi));const r=na(t.lo,t.hi);return i?"-"+r:r}function na(n,e){if({lo:n,hi:e}=Bl(n,e),e<=2097151)return String(wi*e+n);const t=n&16777215,i=(n>>>24|e<<8)&16777215,r=e>>16&65535;let s=t+i*6777216+r*6710656,o=i+r*8147497,a=r*2;const c=1e7;return s>=c&&(o+=Math.floor(s/c),s%=c),o>=c&&(a+=Math.floor(o/c),o%=c),a.toString()+Bs(o)+Bs(s)}function Bl(n,e){return{lo:n>>>0,hi:e>>>0}}function ss(n,e){return{lo:n|0,hi:e|0}}function ia(n,e){return e=~e,n?n=~n+1:e+=1,ss(n,e)}const Bs=n=>{const e=String(n);return"0000000".slice(e.length)+e};function js(n,e){if(n>=0){for(;n>127;)e.push(n&127|128),n=n>>>7;e.push(n)}else{for(let t=0;t<9;t++)e.push(n&127|128),n=n>>7;e.push(1)}}function jl(){let n=this.buf[this.pos++],e=n&127;if(!(n&128))return this.assertBounds(),e;if(n=this.buf[this.pos++],e|=(n&127)<<7,!(n&128))return this.assertBounds(),e;if(n=this.buf[this.pos++],e|=(n&127)<<14,!(n&128))return this.assertBounds(),e;if(n=this.buf[this.pos++],e|=(n&127)<<21,!(n&128))return this.assertBounds(),e;n=this.buf[this.pos++],e|=(n&15)<<28;for(let t=5;n&128&&t<10;t++)n=this.buf[this.pos++];if(n&128)throw new Error("invalid varint");return this.assertBounds(),e>>>0}function Vl(){const n=new DataView(new ArrayBuffer(8));if(typeof BigInt=="function"&&typeof n.getBigInt64=="function"&&typeof n.getBigUint64=="function"&&typeof n.setBigInt64=="function"&&typeof n.setBigUint64=="function"&&(typeof process!="object"||typeof Us!="object"||Us.BUF_BIGINT_DISABLE!=="1")){const r=BigInt("-9223372036854775808"),s=BigInt("9223372036854775807"),o=BigInt("0"),a=BigInt("18446744073709551615");return{zero:BigInt(0),supported:!0,parse(c){const l=typeof c=="bigint"?c:BigInt(c);if(l>s||l<r)throw new Error("int64 invalid: ".concat(c));return l},uParse(c){const l=typeof c=="bigint"?c:BigInt(c);if(l>a||l<o)throw new Error("uint64 invalid: ".concat(c));return l},enc(c){return n.setBigInt64(0,this.parse(c),!0),{lo:n.getInt32(0,!0),hi:n.getInt32(4,!0)}},uEnc(c){return n.setBigInt64(0,this.uParse(c),!0),{lo:n.getInt32(0,!0),hi:n.getInt32(4,!0)}},dec(c,l){return n.setInt32(0,c,!0),n.setInt32(4,l,!0),n.getBigInt64(0,!0)},uDec(c,l){return n.setInt32(0,c,!0),n.setInt32(4,l,!0),n.getBigUint64(0,!0)}}}const t=r=>ke(/^-?[0-9]+$/.test(r),"int64 invalid: ".concat(r)),i=r=>ke(/^[0-9]+$/.test(r),"uint64 invalid: ".concat(r));return{zero:"0",supported:!1,parse(r){return typeof r!="string"&&(r=r.toString()),t(r),r},uParse(r){return typeof r!="string"&&(r=r.toString()),i(r),r},enc(r){return typeof r!="string"&&(r=r.toString()),t(r),Fs(r)},uEnc(r){return typeof r!="string"&&(r=r.toString()),i(r),Fs(r)},dec(r,s){return Fl(r,s)},uDec(r,s){return na(r,s)}}}const L=Vl();var Q;(function(n){n[n.Varint=0]="Varint",n[n.Bit64=1]="Bit64",n[n.LengthDelimited=2]="LengthDelimited",n[n.StartGroup=3]="StartGroup",n[n.EndGroup=4]="EndGroup",n[n.Bit32=5]="Bit32"})(Q||(Q={}));class Jl{constructor(e){this.stack=[],this.textEncoder=e??new TextEncoder,this.chunks=[],this.buf=[]}finish(){this.chunks.push(new Uint8Array(this.buf));let e=0;for(let r=0;r<this.chunks.length;r++)e+=this.chunks[r].length;let t=new Uint8Array(e),i=0;for(let r=0;r<this.chunks.length;r++)t.set(this.chunks[r],i),i+=this.chunks[r].length;return this.chunks=[],t}fork(){return this.stack.push({chunks:this.chunks,buf:this.buf}),this.chunks=[],this.buf=[],this}join(){let e=this.finish(),t=this.stack.pop();if(!t)throw new Error("invalid state, fork stack empty");return this.chunks=t.chunks,this.buf=t.buf,this.uint32(e.byteLength),this.raw(e)}tag(e,t){return this.uint32((e<<3|t)>>>0)}raw(e){return this.buf.length&&(this.chunks.push(new Uint8Array(this.buf)),this.buf=[]),this.chunks.push(e),this}uint32(e){for(Tr(e);e>127;)this.buf.push(e&127|128),e=e>>>7;return this.buf.push(e),this}int32(e){return Ti(e),js(e,this.buf),this}bool(e){return this.buf.push(e?1:0),this}bytes(e){return this.uint32(e.byteLength),this.raw(e)}string(e){let t=this.textEncoder.encode(e);return this.uint32(t.byteLength),this.raw(t)}float(e){Qo(e);let t=new Uint8Array(4);return new DataView(t.buffer).setFloat32(0,e,!0),this.raw(t)}double(e){let t=new Uint8Array(8);return new DataView(t.buffer).setFloat64(0,e,!0),this.raw(t)}fixed32(e){Tr(e);let t=new Uint8Array(4);return new DataView(t.buffer).setUint32(0,e,!0),this.raw(t)}sfixed32(e){Ti(e);let t=new Uint8Array(4);return new DataView(t.buffer).setInt32(0,e,!0),this.raw(t)}sint32(e){return Ti(e),e=(e<<1^e>>31)>>>0,js(e,this.buf),this}sfixed64(e){let t=new Uint8Array(8),i=new DataView(t.buffer),r=L.enc(e);return i.setInt32(0,r.lo,!0),i.setInt32(4,r.hi,!0),this.raw(t)}fixed64(e){let t=new Uint8Array(8),i=new DataView(t.buffer),r=L.uEnc(e);return i.setInt32(0,r.lo,!0),i.setInt32(4,r.hi,!0),this.raw(t)}int64(e){let t=L.enc(e);return sr(t.lo,t.hi,this.buf),this}sint64(e){let t=L.enc(e),i=t.hi>>31,r=t.lo<<1^i,s=(t.hi<<1|t.lo>>>31)^i;return sr(r,s,this.buf),this}uint64(e){let t=L.uEnc(e);return sr(t.lo,t.hi,this.buf),this}}class ql{constructor(e,t){this.varint64=Ul,this.uint32=jl,this.buf=e,this.len=e.length,this.pos=0,this.view=new DataView(e.buffer,e.byteOffset,e.byteLength),this.textDecoder=t??new TextDecoder}tag(){let e=this.uint32(),t=e>>>3,i=e&7;if(t<=0||i<0||i>5)throw new Error("illegal tag: field no "+t+" wire type "+i);return[t,i]}skip(e){let t=this.pos;switch(e){case Q.Varint:for(;this.buf[this.pos++]&128;);break;case Q.Bit64:this.pos+=4;case Q.Bit32:this.pos+=4;break;case Q.LengthDelimited:let i=this.uint32();this.pos+=i;break;case Q.StartGroup:let r;for(;(r=this.tag()[1])!==Q.EndGroup;)this.skip(r);break;default:throw new Error("cant skip wire type "+e)}return this.assertBounds(),this.buf.subarray(t,this.pos)}assertBounds(){if(this.pos>this.len)throw new RangeError("premature EOF")}int32(){return this.uint32()|0}sint32(){let e=this.uint32();return e>>>1^-(e&1)}int64(){return L.dec(...this.varint64())}uint64(){return L.uDec(...this.varint64())}sint64(){let[e,t]=this.varint64(),i=-(e&1);return e=(e>>>1|(t&1)<<31)^i,t=t>>>1^i,L.dec(e,t)}bool(){let[e,t]=this.varint64();return e!==0||t!==0}fixed32(){return this.view.getUint32((this.pos+=4)-4,!0)}sfixed32(){return this.view.getInt32((this.pos+=4)-4,!0)}fixed64(){return L.uDec(this.sfixed32(),this.sfixed32())}sfixed64(){return L.dec(this.sfixed32(),this.sfixed32())}float(){return this.view.getFloat32((this.pos+=4)-4,!0)}double(){return this.view.getFloat64((this.pos+=8)-8,!0)}bytes(){let e=this.uint32(),t=this.pos;return this.pos+=e,this.assertBounds(),this.buf.subarray(t,t+e)}string(){return this.textDecoder.decode(this.bytes())}}function wr(n,e){return e instanceof I||!n.fieldWrapper?e:n.fieldWrapper.wrapField(e)}w.DOUBLE,w.FLOAT,w.INT64,w.UINT64,w.INT32,w.UINT32,w.BOOL,w.STRING,w.BYTES;function en(n,e,t){if(e===t)return!0;if(n==w.BYTES){if(!(e instanceof Uint8Array)||!(t instanceof Uint8Array)||e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(e[i]!==t[i])return!1;return!0}switch(n){case w.UINT64:case w.FIXED64:case w.INT64:case w.SFIXED64:case w.SINT64:return e==t}return!1}function Er(n,e){switch(n){case w.BOOL:return!1;case w.UINT64:case w.FIXED64:case w.INT64:case w.SFIXED64:case w.SINT64:return e==0?L.zero:"0";case w.DOUBLE:case w.FLOAT:return 0;case w.BYTES:return new Uint8Array(0);case w.STRING:return"";default:return 0}}function ra(n,e){const t=e===void 0;let i=Q.Varint,r=e===0;switch(n){case w.STRING:r=t||!e.length,i=Q.LengthDelimited;break;case w.BOOL:r=e===!1;break;case w.DOUBLE:i=Q.Bit64;break;case w.FLOAT:i=Q.Bit32;break;case w.INT64:r=t||e==0;break;case w.UINT64:r=t||e==0;break;case w.FIXED64:r=t||e==0,i=Q.Bit64;break;case w.BYTES:r=t||!e.byteLength,i=Q.LengthDelimited;break;case w.FIXED32:i=Q.Bit32;break;case w.SFIXED32:i=Q.Bit32;break;case w.SFIXED64:r=t||e==0,i=Q.Bit64;break;case w.SINT64:r=t||e==0;break}const s=w[n].toLowerCase();return[i,s,t||r]}const En=Symbol("@bufbuild/protobuf/unknown-fields"),Vs={readUnknownFields:!0,readerFactory:n=>new ql(n)},Js={writeUnknownFields:!0,writerFactory:()=>new Jl};function Wl(n){return n?Object.assign(Object.assign({},Vs),n):Vs}function Gl(n){return n?Object.assign(Object.assign({},Js),n):Js}function Hl(){return{makeReadOptions:Wl,makeWriteOptions:Gl,listUnknownFields(n){var e;return(e=n[En])!==null&&e!==void 0?e:[]},discardUnknownFields(n){delete n[En]},writeUnknownFields(n,e){const i=n[En];if(i)for(const r of i)e.tag(r.no,r.wireType).raw(r.data)},onUnknownField(n,e,t,i){const r=n;Array.isArray(r[En])||(r[En]=[]),r[En].push({no:e,wireType:t,data:i})},readMessage(n,e,t,i){const r=n.getType(),s=t===void 0?e.len:e.pos+t;for(;e.pos<s;){const[o,a]=e.tag(),c=r.fields.find(o);if(!c){const h=e.skip(a);i.readUnknownFields&&this.onUnknownField(n,o,a,h);continue}let l=n,u=c.repeated,d=c.localName;switch(c.oneof&&(l=l[c.oneof.localName],l.case!=d&&delete l.value,l.case=d,d="value"),c.kind){case"scalar":case"enum":const h=c.kind=="enum"?w.INT32:c.T;let m=Ai;if(c.kind=="scalar"&&c.L>0&&(m=Kl),u){let k=l[d];if(a==Q.LengthDelimited&&h!=w.STRING&&h!=w.BYTES){let S=e.uint32()+e.pos;for(;e.pos<S;)k.push(m(e,h))}else k.push(m(e,h))}else l[d]=m(e,h);break;case"message":const g=c.T;u?l[d].push(Ei(e,new g,i)):l[d]instanceof I?Ei(e,l[d],i):(l[d]=Ei(e,new g,i),g.fieldWrapper&&!c.oneof&&!c.repeated&&(l[d]=g.fieldWrapper.unwrapField(l[d])));break;case"map":let[v,b]=zl(c,e,i);l[d][v]=b;break}}}}}function Ei(n,e,t){return e.getType().runtime.bin.readMessage(e,n,n.uint32(),t),e}function zl(n,e,t){const i=e.uint32(),r=e.pos+i;let s,o;for(;e.pos<r;){let[a]=e.tag();switch(a){case 1:s=Ai(e,n.K);break;case 2:switch(n.V.kind){case"scalar":o=Ai(e,n.V.T);break;case"enum":o=e.int32();break;case"message":o=Ei(e,new n.V.T,t);break}break}}if(s===void 0){let a=Er(n.K,gn.BIGINT);s=n.K==w.BOOL?a.toString():a}if(typeof s!="string"&&typeof s!="number"&&(s=s.toString()),o===void 0)switch(n.V.kind){case"scalar":o=Er(n.V.T,gn.BIGINT);break;case"enum":o=0;break;case"message":o=new n.V.T;break}return[s,o]}function Kl(n,e){const t=Ai(n,e);return typeof t=="bigint"?t.toString():t}function Ai(n,e){switch(e){case w.STRING:return n.string();case w.BOOL:return n.bool();case w.DOUBLE:return n.double();case w.FLOAT:return n.float();case w.INT32:return n.int32();case w.INT64:return n.int64();case w.UINT64:return n.uint64();case w.FIXED64:return n.fixed64();case w.BYTES:return n.bytes();case w.FIXED32:return n.fixed32();case w.SFIXED32:return n.sfixed32();case w.SFIXED64:return n.sfixed64();case w.SINT64:return n.sint64();case w.UINT32:return n.uint32();case w.SINT32:return n.sint32()}}function $l(n,e,t,i,r){n.tag(t.no,Q.LengthDelimited),n.fork();let s=i;switch(t.K){case w.INT32:case w.FIXED32:case w.UINT32:case w.SFIXED32:case w.SINT32:s=Number.parseInt(i);break;case w.BOOL:ke(i=="true"||i=="false"),s=i=="true";break}switch(ii(n,t.K,1,s,!0),t.V.kind){case"scalar":ii(n,t.V.T,2,r,!0);break;case"enum":ii(n,w.INT32,2,r,!0);break;case"message":Pr(n,e,t.V.T,2,r);break}n.join()}function Pr(n,e,t,i,r){if(r!==void 0){const s=wr(t,r);n.tag(i,Q.LengthDelimited).bytes(s.toBinary(e))}}function ii(n,e,t,i,r){let[s,o,a]=ra(e,i);(!a||r)&&n.tag(t,s)[o](i)}function Yl(n,e,t,i){if(!i.length)return;n.tag(t,Q.LengthDelimited).fork();let[,r]=ra(e);for(let s=0;s<i.length;s++)n[r](i[s]);n.join()}function Ql(){return Object.assign(Object.assign({},Hl()),{writeMessage(n,e,t){const i=n.getType();for(const r of i.fields.byNumber()){let s,o=r.repeated,a=r.localName;if(r.oneof){const c=n[r.oneof.localName];if(c.case!==a)continue;s=c.value}else s=n[a];switch(r.kind){case"scalar":case"enum":let c=r.kind=="enum"?w.INT32:r.T;if(o)if(r.packed)Yl(e,c,r.no,s);else for(const l of s)ii(e,c,r.no,l,!0);else s!==void 0&&ii(e,c,r.no,s,!!r.oneof||r.opt);break;case"message":if(o)for(const l of s)Pr(e,t,r.T,r.no,l);else Pr(e,t,r.T,r.no,s);break;case"map":for(const[l,u]of Object.entries(s))$l(e,t,r,l,u);break}}return t.writeUnknownFields&&this.writeUnknownFields(n,e),e}})}let yt="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),zi=[];for(let n=0;n<yt.length;n++)zi[yt[n].charCodeAt(0)]=n;zi[45]=yt.indexOf("+");zi[95]=yt.indexOf("/");const sa={dec(n){let e=n.length*3/4;n[n.length-2]=="="?e-=2:n[n.length-1]=="="&&(e-=1);let t=new Uint8Array(e),i=0,r=0,s,o=0;for(let a=0;a<n.length;a++){if(s=zi[n.charCodeAt(a)],s===void 0)switch(n[a]){case"=":r=0;case`
`:case"\r":case"	":case" ":continue;default:throw Error("invalid base64 string.")}switch(r){case 0:o=s,r=1;break;case 1:t[i++]=o<<2|(s&48)>>4,o=s,r=2;break;case 2:t[i++]=(o&15)<<4|(s&60)>>2,o=s,r=3;break;case 3:t[i++]=(o&3)<<6|s,r=0;break}}if(r==1)throw Error("invalid base64 string.");return t.subarray(0,i)},enc(n){let e="",t=0,i,r=0;for(let s=0;s<n.length;s++)switch(i=n[s],t){case 0:e+=yt[i>>2],r=(i&3)<<4,t=1;break;case 1:e+=yt[r|i>>4],r=(i&15)<<2,t=2;break;case 2:e+=yt[r|i>>6],e+=yt[i&63],t=0;break}return t&&(e+=yt[r],e+="=",t==1&&(e+="=")),e}},qs={ignoreUnknownFields:!1},Ws={emitDefaultValues:!1,enumAsInteger:!1,useProtoFieldName:!1,prettySpaces:0};function Xl(n){return n?Object.assign(Object.assign({},qs),n):qs}function Zl(n){return n?Object.assign(Object.assign({},Ws),n):Ws}function eu(n){const e=n(tu,Gs);return{makeReadOptions:Xl,makeWriteOptions:Zl,readMessage(t,i,r,s){if(i==null||Array.isArray(i)||typeof i!="object")throw new Error("cannot decode message ".concat(t.typeName," from JSON: ").concat(this.debug(i)));s=s??new t;const o={};for(const[a,c]of Object.entries(i)){const l=t.fields.findJsonName(a);if(!l){if(!r.ignoreUnknownFields)throw new Error("cannot decode message ".concat(t.typeName,' from JSON: key "').concat(a,'" is unknown'));continue}let u=l.localName,d=s;if(l.oneof){if(c===null&&l.kind=="scalar")continue;const h=o[l.oneof.localName];if(h)throw new Error("cannot decode message ".concat(t.typeName,' from JSON: multiple keys for oneof "').concat(l.oneof.name,'" present: "').concat(h,'", "').concat(a,'"'));o[l.oneof.localName]=a,d=d[l.oneof.localName]={case:u},u="value"}if(l.repeated){if(c===null)continue;if(!Array.isArray(c))throw new Error("cannot decode field ".concat(t.typeName,".").concat(l.name," from JSON: ").concat(this.debug(c)));const h=d[u];for(const m of c){if(m===null)throw new Error("cannot decode field ".concat(t.typeName,".").concat(l.name," from JSON: ").concat(this.debug(m)));let g;switch(l.kind){case"message":g=l.T.fromJson(m,r);break;case"enum":if(g=or(l.T,m,r.ignoreUnknownFields),g===void 0)continue;break;case"scalar":try{g=Kn(l.T,m,l.L)}catch(v){let b="cannot decode field ".concat(t.typeName,".").concat(l.name," from JSON: ").concat(this.debug(m));throw v instanceof Error&&v.message.length>0&&(b+=": ".concat(v.message)),new Error(b)}break}h.push(g)}}else if(l.kind=="map"){if(c===null)continue;if(Array.isArray(c)||typeof c!="object")throw new Error("cannot decode field ".concat(t.typeName,".").concat(l.name," from JSON: ").concat(this.debug(c)));const h=d[u];for(const[m,g]of Object.entries(c)){if(g===null)throw new Error("cannot decode field ".concat(t.typeName,".").concat(l.name," from JSON: map value null"));let v;switch(l.V.kind){case"message":v=l.V.T.fromJson(g,r);break;case"enum":if(v=or(l.V.T,g,r.ignoreUnknownFields),v===void 0)continue;break;case"scalar":try{v=Kn(l.V.T,g,gn.BIGINT)}catch(b){let k="cannot decode map value for field ".concat(t.typeName,".").concat(l.name," from JSON: ").concat(this.debug(c));throw b instanceof Error&&b.message.length>0&&(k+=": ".concat(b.message)),new Error(k)}break}try{h[Kn(l.K,l.K==w.BOOL?m=="true"?!0:m=="false"?!1:m:m,gn.BIGINT).toString()]=v}catch(b){let k="cannot decode map key for field ".concat(t.typeName,".").concat(l.name," from JSON: ").concat(this.debug(c));throw b instanceof Error&&b.message.length>0&&(k+=": ".concat(b.message)),new Error(k)}}}else switch(l.kind){case"message":const h=l.T;if(c===null&&h.typeName!="google.protobuf.Value"){if(l.oneof)throw new Error("cannot decode field ".concat(t.typeName,".").concat(l.name,' from JSON: null is invalid for oneof field "').concat(a,'"'));continue}d[u]instanceof I?d[u].fromJson(c,r):(d[u]=h.fromJson(c,r),h.fieldWrapper&&!l.oneof&&(d[u]=h.fieldWrapper.unwrapField(d[u])));break;case"enum":const m=or(l.T,c,r.ignoreUnknownFields);m!==void 0&&(d[u]=m);break;case"scalar":try{d[u]=Kn(l.T,c,l.L)}catch(g){let v="cannot decode field ".concat(t.typeName,".").concat(l.name," from JSON: ").concat(this.debug(c));throw g instanceof Error&&g.message.length>0&&(v+=": ".concat(g.message)),new Error(v)}break}}return s},writeMessage(t,i){const r=t.getType(),s={};let o;try{for(const a of r.fields.byMember()){let c;if(a.kind=="oneof"){const l=t[a.localName];if(l.value===void 0)continue;if(o=a.findField(l.case),!o)throw"oneof case not found: "+l.case;c=e(o,l.value,i)}else o=a,c=e(o,t[o.localName],i);c!==void 0&&(s[i.useProtoFieldName?o.name:o.jsonName]=c)}}catch(a){const c=o?"cannot encode field ".concat(r.typeName,".").concat(o.name," to JSON"):"cannot encode message ".concat(r.typeName," to JSON"),l=a instanceof Error?a.message:String(a);throw new Error(c+(l.length>0?": ".concat(l):""))}return s},readScalar:Kn,writeScalar:Gs,debug:oa}}function oa(n){if(n===null)return"null";switch(typeof n){case"object":return Array.isArray(n)?"array":"object";case"string":return n.length>100?"string":'"'.concat(n.split('"').join('\\"'),'"');default:return String(n)}}function Kn(n,e,t){switch(n){case w.DOUBLE:case w.FLOAT:if(e===null)return 0;if(e==="NaN")return Number.NaN;if(e==="Infinity")return Number.POSITIVE_INFINITY;if(e==="-Infinity")return Number.NEGATIVE_INFINITY;if(e===""||typeof e=="string"&&e.trim().length!==e.length||typeof e!="string"&&typeof e!="number")break;const i=Number(e);if(Number.isNaN(i)||!Number.isFinite(i))break;return n==w.FLOAT&&Qo(i),i;case w.INT32:case w.FIXED32:case w.SFIXED32:case w.SINT32:case w.UINT32:if(e===null)return 0;let r;if(typeof e=="number"?r=e:typeof e=="string"&&e.length>0&&e.trim().length===e.length&&(r=Number(e)),r===void 0)break;return n==w.UINT32?Tr(r):Ti(r),r;case w.INT64:case w.SFIXED64:case w.SINT64:if(e===null)return L.zero;if(typeof e!="number"&&typeof e!="string")break;const s=L.parse(e);return t?s.toString():s;case w.FIXED64:case w.UINT64:if(e===null)return L.zero;if(typeof e!="number"&&typeof e!="string")break;const o=L.uParse(e);return t?o.toString():o;case w.BOOL:if(e===null)return!1;if(typeof e!="boolean")break;return e;case w.STRING:if(e===null)return"";if(typeof e!="string")break;try{encodeURIComponent(e)}catch{throw new Error("invalid UTF8")}return e;case w.BYTES:if(e===null||e==="")return new Uint8Array(0);if(typeof e!="string")break;return sa.dec(e)}throw new Error}function or(n,e,t){if(e===null)return 0;switch(typeof e){case"number":if(Number.isInteger(e))return e;break;case"string":const i=n.findName(e);if(i||t)return i==null?void 0:i.no;break}throw new Error("cannot decode enum ".concat(n.typeName," from JSON: ").concat(oa(e)))}function tu(n,e,t,i){var r;if(e===void 0)return e;if(e===0&&!t)return;if(i)return e;if(n.typeName=="google.protobuf.NullValue")return null;const s=n.findNumber(e);return(r=s==null?void 0:s.name)!==null&&r!==void 0?r:e}function Gs(n,e,t){if(e!==void 0)switch(n){case w.INT32:case w.SFIXED32:case w.SINT32:case w.FIXED32:case w.UINT32:return ke(typeof e=="number"),e!=0||t?e:void 0;case w.FLOAT:case w.DOUBLE:return ke(typeof e=="number"),Number.isNaN(e)?"NaN":e===Number.POSITIVE_INFINITY?"Infinity":e===Number.NEGATIVE_INFINITY?"-Infinity":e!==0||t?e:void 0;case w.STRING:return ke(typeof e=="string"),e.length>0||t?e:void 0;case w.BOOL:return ke(typeof e=="boolean"),e||t?e:void 0;case w.UINT64:case w.FIXED64:case w.INT64:case w.SFIXED64:case w.SINT64:return ke(typeof e=="bigint"||typeof e=="string"||typeof e=="number"),t||e!=0?e.toString(10):void 0;case w.BYTES:return ke(e instanceof Uint8Array),t||e.byteLength>0?sa.enc(e):void 0}}function nu(){return eu((n,e)=>function(i,r,s){if(i.kind=="map"){const o={};switch(i.V.kind){case"scalar":for(const[c,l]of Object.entries(r)){const u=e(i.V.T,l,!0);ke(u!==void 0),o[c.toString()]=u}break;case"message":for(const[c,l]of Object.entries(r))o[c.toString()]=l.toJson(s);break;case"enum":const a=i.V.T;for(const[c,l]of Object.entries(r)){ke(l===void 0||typeof l=="number");const u=n(a,l,!0,s.enumAsInteger);ke(u!==void 0),o[c.toString()]=u}break}return s.emitDefaultValues||Object.keys(o).length>0?o:void 0}else if(i.repeated){const o=[];switch(i.kind){case"scalar":for(let a=0;a<r.length;a++)o.push(e(i.T,r[a],!0));break;case"enum":for(let a=0;a<r.length;a++)o.push(n(i.T,r[a],!0,s.enumAsInteger));break;case"message":for(let a=0;a<r.length;a++)o.push(wr(i.T,r[a]).toJson(s));break}return s.emitDefaultValues||o.length>0?o:void 0}else switch(i.kind){case"scalar":return e(i.T,r,!!i.oneof||i.opt||s.emitDefaultValues);case"enum":return n(i.T,r,!!i.oneof||i.opt||s.emitDefaultValues,s.enumAsInteger);case"message":return r!==void 0?wr(i.T,r).toJson(s):void 0}})}function iu(){return{setEnumType:Zo,initPartial(n,e){if(n===void 0)return;const t=e.getType();for(const i of t.fields.byMember()){const r=i.localName,s=e,o=n;if(o[r]!==void 0)switch(i.kind){case"oneof":const a=o[r].case;if(a===void 0)continue;const c=i.findField(a);let l=o[r].value;c&&c.kind=="message"&&!(l instanceof c.T)?l=new c.T(l):c&&c.kind==="scalar"&&c.T===w.BYTES&&(l=$n(l)),s[r]={case:a,value:l};break;case"scalar":case"enum":let u=o[r];i.T===w.BYTES&&(u=i.repeated?u.map($n):$n(u)),s[r]=u;break;case"map":switch(i.V.kind){case"scalar":case"enum":if(i.V.T===w.BYTES)for(const[m,g]of Object.entries(o[r]))s[r][m]=$n(g);else Object.assign(s[r],o[r]);break;case"message":const h=i.V.T;for(const m of Object.keys(o[r])){let g=o[r][m];h.fieldWrapper||(g=new h(g)),s[r][m]=g}break}break;case"message":const d=i.T;if(i.repeated)s[r]=o[r].map(h=>h instanceof d?h:new d(h));else if(o[r]!==void 0){const h=o[r];d.fieldWrapper?d.typeName==="google.protobuf.BytesValue"?s[r]=$n(h):s[r]=h:s[r]=h instanceof d?h:new d(h)}break}}},equals(n,e,t){return e===t?!0:!e||!t?!1:n.fields.byMember().every(i=>{const r=e[i.localName],s=t[i.localName];if(i.repeated){if(r.length!==s.length)return!1;switch(i.kind){case"message":return r.every((o,a)=>i.T.equals(o,s[a]));case"scalar":return r.every((o,a)=>en(i.T,o,s[a]));case"enum":return r.every((o,a)=>en(w.INT32,o,s[a]))}throw new Error("repeated cannot contain ".concat(i.kind))}switch(i.kind){case"message":return i.T.equals(r,s);case"enum":return en(w.INT32,r,s);case"scalar":return en(i.T,r,s);case"oneof":if(r.case!==s.case)return!1;const o=i.findField(r.case);if(o===void 0)return!0;switch(o.kind){case"message":return o.T.equals(r.value,s.value);case"enum":return en(w.INT32,r.value,s.value);case"scalar":return en(o.T,r.value,s.value)}throw new Error("oneof cannot contain ".concat(o.kind));case"map":const a=Object.keys(r).concat(Object.keys(s));switch(i.V.kind){case"message":const c=i.V.T;return a.every(u=>c.equals(r[u],s[u]));case"enum":return a.every(u=>en(w.INT32,r[u],s[u]));case"scalar":const l=i.V.T;return a.every(u=>en(l,r[u],s[u]))}break}})},clone(n){const e=n.getType(),t=new e,i=t;for(const r of e.fields.byMember()){const s=n[r.localName];let o;if(r.repeated)o=s.map(ki);else if(r.kind=="map"){o=i[r.localName];for(const[a,c]of Object.entries(s))o[a]=ki(c)}else r.kind=="oneof"?o=r.findField(s.case)?{case:s.case,value:ki(s.value)}:{case:void 0}:o=ki(s);i[r.localName]=o}return t}}}function ki(n){if(n===void 0)return n;if(n instanceof I)return n.clone();if(n instanceof Uint8Array){const e=new Uint8Array(n.byteLength);return e.set(n),e}return n}function $n(n){return n instanceof Uint8Array?n:new Uint8Array(n)}class ru{constructor(e,t){this._fields=e,this._normalizer=t}findJsonName(e){if(!this.jsonNames){const t={};for(const i of this.list())t[i.jsonName]=t[i.name]=i;this.jsonNames=t}return this.jsonNames[e]}find(e){if(!this.numbers){const t={};for(const i of this.list())t[i.no]=i;this.numbers=t}return this.numbers[e]}list(){return this.all||(this.all=this._normalizer(this._fields)),this.all}byNumber(){return this.numbersAsc||(this.numbersAsc=this.list().concat().sort((e,t)=>e.no-t.no)),this.numbersAsc}byMember(){if(!this.members){this.members=[];const e=this.members;let t;for(const i of this.list())i.oneof?i.oneof!==t&&(t=i.oneof,e.push(t)):e.push(i)}return this.members}}function aa(n,e){const t=ca(n);return e?t:uu(lu(t))}function su(n){return aa(n,!1)}const ou=ca;function ca(n){let e=!1;const t=[];for(let i=0;i<n.length;i++){let r=n.charAt(i);switch(r){case"_":e=!0;break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":t.push(r),e=!1;break;default:e&&(e=!1,r=r.toUpperCase()),t.push(r);break}}return t.join("")}const au=new Set(["constructor","toString","toJSON","valueOf"]),cu=new Set(["getType","clone","equals","fromBinary","fromJson","fromJsonString","toBinary","toJson","toJsonString","toObject"]),la=n=>"".concat(n,"$"),lu=n=>cu.has(n)?la(n):n,uu=n=>au.has(n)?la(n):n;class du{constructor(e){this.kind="oneof",this.repeated=!1,this.packed=!1,this.opt=!1,this.default=void 0,this.fields=[],this.name=e,this.localName=su(e)}addField(e){ke(e.oneof===this,"field ".concat(e.name," not one of ").concat(this.name)),this.fields.push(e)}findField(e){if(!this._lookup){this._lookup=Object.create(null);for(let t=0;t<this.fields.length;t++)this._lookup[this.fields[t].localName]=this.fields[t]}return this._lookup[e]}}const p=Ll("proto3",nu(),Ql(),Object.assign(Object.assign({},iu()),{newFieldList(n){return new ru(n,hu)},initFields(n){for(const e of n.getType().fields.byMember()){if(e.opt)continue;const t=e.localName,i=n;if(e.repeated){i[t]=[];continue}switch(e.kind){case"oneof":i[t]={case:void 0};break;case"enum":i[t]=0;break;case"map":i[t]={};break;case"scalar":i[t]=Er(e.T,e.L);break}}}}));function hu(n){var e,t,i,r;const s=[];let o;for(const a of typeof n=="function"?n():n){const c=a;if(c.localName=aa(a.name,a.oneof!==void 0),c.jsonName=(e=a.jsonName)!==null&&e!==void 0?e:ou(a.name),c.repeated=(t=a.repeated)!==null&&t!==void 0?t:!1,a.kind=="scalar"&&(c.L=(i=a.L)!==null&&i!==void 0?i:gn.BIGINT),c.packed=(r=a.packed)!==null&&r!==void 0?r:a.kind=="enum"||a.kind=="scalar"&&a.T!=w.BYTES&&a.T!=w.STRING,a.oneof!==void 0){const l=typeof a.oneof=="string"?a.oneof:a.oneof.name;(!o||o.name!=l)&&(o=new du(l)),c.oneof=o,o.addField(c)}s.push(c)}return s}class re extends I{constructor(e){super(),this.seconds=L.zero,this.nanos=0,p.util.initPartial(e,this)}fromJson(e,t){if(typeof e!="string")throw new Error("cannot decode google.protobuf.Timestamp from JSON: ".concat(p.json.debug(e)));const i=e.match(/^([0-9]{4})-([0-9]{2})-([0-9]{2})T([0-9]{2}):([0-9]{2}):([0-9]{2})(?:Z|\.([0-9]{3,9})Z|([+-][0-9][0-9]:[0-9][0-9]))$/);if(!i)throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");const r=Date.parse(i[1]+"-"+i[2]+"-"+i[3]+"T"+i[4]+":"+i[5]+":"+i[6]+(i[8]?i[8]:"Z"));if(Number.isNaN(r))throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");if(r<Date.parse("0001-01-01T00:00:00Z")||r>Date.parse("9999-12-31T23:59:59Z"))throw new Error("cannot decode message google.protobuf.Timestamp from JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");return this.seconds=L.parse(r/1e3),this.nanos=0,i[7]&&(this.nanos=parseInt("1"+i[7]+"0".repeat(9-i[7].length))-1e9),this}toJson(e){const t=Number(this.seconds)*1e3;if(t<Date.parse("0001-01-01T00:00:00Z")||t>Date.parse("9999-12-31T23:59:59Z"))throw new Error("cannot encode google.protobuf.Timestamp to JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");if(this.nanos<0)throw new Error("cannot encode google.protobuf.Timestamp to JSON: nanos must not be negative");let i="Z";if(this.nanos>0){const r=(this.nanos+1e9).toString().substring(1);r.substring(3)==="000000"?i="."+r.substring(0,3)+"Z":r.substring(6)==="000"?i="."+r.substring(0,6)+"Z":i="."+r+"Z"}return new Date(t).toISOString().replace(".000Z",i)}toDate(){return new Date(Number(this.seconds)*1e3+Math.ceil(this.nanos/1e6))}static now(){return re.fromDate(new Date)}static fromDate(e){const t=e.getTime();return new re({seconds:L.parse(Math.floor(t/1e3)),nanos:t%1e3*1e6})}static fromBinary(e,t){return new re().fromBinary(e,t)}static fromJson(e,t){return new re().fromJson(e,t)}static fromJsonString(e,t){return new re().fromJsonString(e,t)}static equals(e,t){return p.util.equals(re,e,t)}}re.runtime=p;re.typeName="google.protobuf.Timestamp";re.fields=p.util.newFieldList(()=>[{no:1,name:"seconds",kind:"scalar",T:3},{no:2,name:"nanos",kind:"scalar",T:5}]);var xr;(function(n){n[n.DEFAULT_AC=0]="DEFAULT_AC",n[n.OPUS=1]="OPUS",n[n.AAC=2]="AAC"})(xr||(xr={}));p.util.setEnumType(xr,"livekit.AudioCodec",[{no:0,name:"DEFAULT_AC"},{no:1,name:"OPUS"},{no:2,name:"AAC"}]);var Or;(function(n){n[n.DEFAULT_VC=0]="DEFAULT_VC",n[n.H264_BASELINE=1]="H264_BASELINE",n[n.H264_MAIN=2]="H264_MAIN",n[n.H264_HIGH=3]="H264_HIGH",n[n.VP8=4]="VP8"})(Or||(Or={}));p.util.setEnumType(Or,"livekit.VideoCodec",[{no:0,name:"DEFAULT_VC"},{no:1,name:"H264_BASELINE"},{no:2,name:"H264_MAIN"},{no:3,name:"H264_HIGH"},{no:4,name:"VP8"}]);var Rr;(function(n){n[n.IC_DEFAULT=0]="IC_DEFAULT",n[n.IC_JPEG=1]="IC_JPEG"})(Rr||(Rr={}));p.util.setEnumType(Rr,"livekit.ImageCodec",[{no:0,name:"IC_DEFAULT"},{no:1,name:"IC_JPEG"}]);var he;(function(n){n[n.AUDIO=0]="AUDIO",n[n.VIDEO=1]="VIDEO",n[n.DATA=2]="DATA"})(he||(he={}));p.util.setEnumType(he,"livekit.TrackType",[{no:0,name:"AUDIO"},{no:1,name:"VIDEO"},{no:2,name:"DATA"}]);var X;(function(n){n[n.UNKNOWN=0]="UNKNOWN",n[n.CAMERA=1]="CAMERA",n[n.MICROPHONE=2]="MICROPHONE",n[n.SCREEN_SHARE=3]="SCREEN_SHARE",n[n.SCREEN_SHARE_AUDIO=4]="SCREEN_SHARE_AUDIO"})(X||(X={}));p.util.setEnumType(X,"livekit.TrackSource",[{no:0,name:"UNKNOWN"},{no:1,name:"CAMERA"},{no:2,name:"MICROPHONE"},{no:3,name:"SCREEN_SHARE"},{no:4,name:"SCREEN_SHARE_AUDIO"}]);var ie;(function(n){n[n.LOW=0]="LOW",n[n.MEDIUM=1]="MEDIUM",n[n.HIGH=2]="HIGH",n[n.OFF=3]="OFF"})(ie||(ie={}));p.util.setEnumType(ie,"livekit.VideoQuality",[{no:0,name:"LOW"},{no:1,name:"MEDIUM"},{no:2,name:"HIGH"},{no:3,name:"OFF"}]);var kt;(function(n){n[n.POOR=0]="POOR",n[n.GOOD=1]="GOOD",n[n.EXCELLENT=2]="EXCELLENT",n[n.LOST=3]="LOST"})(kt||(kt={}));p.util.setEnumType(kt,"livekit.ConnectionQuality",[{no:0,name:"POOR"},{no:1,name:"GOOD"},{no:2,name:"EXCELLENT"},{no:3,name:"LOST"}]);var He;(function(n){n[n.UNSET=0]="UNSET",n[n.DISABLED=1]="DISABLED",n[n.ENABLED=2]="ENABLED"})(He||(He={}));p.util.setEnumType(He,"livekit.ClientConfigSetting",[{no:0,name:"UNSET"},{no:1,name:"DISABLED"},{no:2,name:"ENABLED"}]);var Wt;(function(n){n[n.UNKNOWN_REASON=0]="UNKNOWN_REASON",n[n.CLIENT_INITIATED=1]="CLIENT_INITIATED",n[n.DUPLICATE_IDENTITY=2]="DUPLICATE_IDENTITY",n[n.SERVER_SHUTDOWN=3]="SERVER_SHUTDOWN",n[n.PARTICIPANT_REMOVED=4]="PARTICIPANT_REMOVED",n[n.ROOM_DELETED=5]="ROOM_DELETED",n[n.STATE_MISMATCH=6]="STATE_MISMATCH",n[n.JOIN_FAILURE=7]="JOIN_FAILURE"})(Wt||(Wt={}));p.util.setEnumType(Wt,"livekit.DisconnectReason",[{no:0,name:"UNKNOWN_REASON"},{no:1,name:"CLIENT_INITIATED"},{no:2,name:"DUPLICATE_IDENTITY"},{no:3,name:"SERVER_SHUTDOWN"},{no:4,name:"PARTICIPANT_REMOVED"},{no:5,name:"ROOM_DELETED"},{no:6,name:"STATE_MISMATCH"},{no:7,name:"JOIN_FAILURE"}]);var vt;(function(n){n[n.RR_UNKNOWN=0]="RR_UNKNOWN",n[n.RR_SIGNAL_DISCONNECTED=1]="RR_SIGNAL_DISCONNECTED",n[n.RR_PUBLISHER_FAILED=2]="RR_PUBLISHER_FAILED",n[n.RR_SUBSCRIBER_FAILED=3]="RR_SUBSCRIBER_FAILED",n[n.RR_SWITCH_CANDIDATE=4]="RR_SWITCH_CANDIDATE"})(vt||(vt={}));p.util.setEnumType(vt,"livekit.ReconnectReason",[{no:0,name:"RR_UNKNOWN"},{no:1,name:"RR_SIGNAL_DISCONNECTED"},{no:2,name:"RR_PUBLISHER_FAILED"},{no:3,name:"RR_SUBSCRIBER_FAILED"},{no:4,name:"RR_SWITCH_CANDIDATE"}]);var ai;(function(n){n[n.SE_UNKNOWN=0]="SE_UNKNOWN",n[n.SE_CODEC_UNSUPPORTED=1]="SE_CODEC_UNSUPPORTED",n[n.SE_TRACK_NOTFOUND=2]="SE_TRACK_NOTFOUND"})(ai||(ai={}));p.util.setEnumType(ai,"livekit.SubscriptionError",[{no:0,name:"SE_UNKNOWN"},{no:1,name:"SE_CODEC_UNSUPPORTED"},{no:2,name:"SE_TRACK_NOTFOUND"}]);let Gn=class ei extends I{constructor(e){super(),this.sid="",this.name="",this.emptyTimeout=0,this.maxParticipants=0,this.creationTime=L.zero,this.turnPassword="",this.enabledCodecs=[],this.metadata="",this.numParticipants=0,this.numPublishers=0,this.activeRecording=!1,p.util.initPartial(e,this)}static fromBinary(e,t){return new ei().fromBinary(e,t)}static fromJson(e,t){return new ei().fromJson(e,t)}static fromJsonString(e,t){return new ei().fromJsonString(e,t)}static equals(e,t){return p.util.equals(ei,e,t)}};Gn.runtime=p;Gn.typeName="livekit.Room";Gn.fields=p.util.newFieldList(()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"empty_timeout",kind:"scalar",T:13},{no:4,name:"max_participants",kind:"scalar",T:13},{no:5,name:"creation_time",kind:"scalar",T:3},{no:6,name:"turn_password",kind:"scalar",T:9},{no:7,name:"enabled_codecs",kind:"message",T:Fe,repeated:!0},{no:8,name:"metadata",kind:"scalar",T:9},{no:9,name:"num_participants",kind:"scalar",T:13},{no:11,name:"num_publishers",kind:"scalar",T:13},{no:10,name:"active_recording",kind:"scalar",T:8}]);class Fe extends I{constructor(e){super(),this.mime="",this.fmtpLine="",p.util.initPartial(e,this)}static fromBinary(e,t){return new Fe().fromBinary(e,t)}static fromJson(e,t){return new Fe().fromJson(e,t)}static fromJsonString(e,t){return new Fe().fromJsonString(e,t)}static equals(e,t){return p.util.equals(Fe,e,t)}}Fe.runtime=p;Fe.typeName="livekit.Codec";Fe.fields=p.util.newFieldList(()=>[{no:1,name:"mime",kind:"scalar",T:9},{no:2,name:"fmtp_line",kind:"scalar",T:9}]);class tn extends I{constructor(e){super(),this.enabled=!1,this.min=0,this.max=0,p.util.initPartial(e,this)}static fromBinary(e,t){return new tn().fromBinary(e,t)}static fromJson(e,t){return new tn().fromJson(e,t)}static fromJsonString(e,t){return new tn().fromJsonString(e,t)}static equals(e,t){return p.util.equals(tn,e,t)}}tn.runtime=p;tn.typeName="livekit.PlayoutDelay";tn.fields=p.util.newFieldList(()=>[{no:1,name:"enabled",kind:"scalar",T:8},{no:2,name:"min",kind:"scalar",T:13},{no:3,name:"max",kind:"scalar",T:13}]);class St extends I{constructor(e){super(),this.canSubscribe=!1,this.canPublish=!1,this.canPublishData=!1,this.canPublishSources=[],this.hidden=!1,this.recorder=!1,this.canUpdateMetadata=!1,this.agent=!1,p.util.initPartial(e,this)}static fromBinary(e,t){return new St().fromBinary(e,t)}static fromJson(e,t){return new St().fromJson(e,t)}static fromJsonString(e,t){return new St().fromJsonString(e,t)}static equals(e,t){return p.util.equals(St,e,t)}}St.runtime=p;St.typeName="livekit.ParticipantPermission";St.fields=p.util.newFieldList(()=>[{no:1,name:"can_subscribe",kind:"scalar",T:8},{no:2,name:"can_publish",kind:"scalar",T:8},{no:3,name:"can_publish_data",kind:"scalar",T:8},{no:9,name:"can_publish_sources",kind:"enum",T:p.getEnumType(X),repeated:!0},{no:7,name:"hidden",kind:"scalar",T:8},{no:8,name:"recorder",kind:"scalar",T:8},{no:10,name:"can_update_metadata",kind:"scalar",T:8},{no:11,name:"agent",kind:"scalar",T:8}]);class Pe extends I{constructor(e){super(),this.sid="",this.identity="",this.state=vn.JOINING,this.tracks=[],this.metadata="",this.joinedAt=L.zero,this.name="",this.version=0,this.region="",this.isPublisher=!1,p.util.initPartial(e,this)}static fromBinary(e,t){return new Pe().fromBinary(e,t)}static fromJson(e,t){return new Pe().fromJson(e,t)}static fromJsonString(e,t){return new Pe().fromJsonString(e,t)}static equals(e,t){return p.util.equals(Pe,e,t)}}Pe.runtime=p;Pe.typeName="livekit.ParticipantInfo";Pe.fields=p.util.newFieldList(()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"identity",kind:"scalar",T:9},{no:3,name:"state",kind:"enum",T:p.getEnumType(vn)},{no:4,name:"tracks",kind:"message",T:Se,repeated:!0},{no:5,name:"metadata",kind:"scalar",T:9},{no:6,name:"joined_at",kind:"scalar",T:3},{no:9,name:"name",kind:"scalar",T:9},{no:10,name:"version",kind:"scalar",T:13},{no:11,name:"permission",kind:"message",T:St},{no:12,name:"region",kind:"scalar",T:9},{no:13,name:"is_publisher",kind:"scalar",T:8}]);var vn;(function(n){n[n.JOINING=0]="JOINING",n[n.JOINED=1]="JOINED",n[n.ACTIVE=2]="ACTIVE",n[n.DISCONNECTED=3]="DISCONNECTED"})(vn||(vn={}));p.util.setEnumType(vn,"livekit.ParticipantInfo.State",[{no:0,name:"JOINING"},{no:1,name:"JOINED"},{no:2,name:"ACTIVE"},{no:3,name:"DISCONNECTED"}]);class nn extends I{constructor(e){super(),p.util.initPartial(e,this)}static fromBinary(e,t){return new nn().fromBinary(e,t)}static fromJson(e,t){return new nn().fromJson(e,t)}static fromJsonString(e,t){return new nn().fromJsonString(e,t)}static equals(e,t){return p.util.equals(nn,e,t)}}nn.runtime=p;nn.typeName="livekit.Encryption";nn.fields=p.util.newFieldList(()=>[]);var ce;(function(n){n[n.NONE=0]="NONE",n[n.GCM=1]="GCM",n[n.CUSTOM=2]="CUSTOM"})(ce||(ce={}));p.util.setEnumType(ce,"livekit.Encryption.Type",[{no:0,name:"NONE"},{no:1,name:"GCM"},{no:2,name:"CUSTOM"}]);class Ct extends I{constructor(e){super(),this.mimeType="",this.mid="",this.cid="",this.layers=[],p.util.initPartial(e,this)}static fromBinary(e,t){return new Ct().fromBinary(e,t)}static fromJson(e,t){return new Ct().fromJson(e,t)}static fromJsonString(e,t){return new Ct().fromJsonString(e,t)}static equals(e,t){return p.util.equals(Ct,e,t)}}Ct.runtime=p;Ct.typeName="livekit.SimulcastCodecInfo";Ct.fields=p.util.newFieldList(()=>[{no:1,name:"mime_type",kind:"scalar",T:9},{no:2,name:"mid",kind:"scalar",T:9},{no:3,name:"cid",kind:"scalar",T:9},{no:4,name:"layers",kind:"message",T:be,repeated:!0}]);class Se extends I{constructor(e){super(),this.sid="",this.type=he.AUDIO,this.name="",this.muted=!1,this.width=0,this.height=0,this.simulcast=!1,this.disableDtx=!1,this.source=X.UNKNOWN,this.layers=[],this.mimeType="",this.mid="",this.codecs=[],this.stereo=!1,this.disableRed=!1,this.encryption=ce.NONE,this.stream="",p.util.initPartial(e,this)}static fromBinary(e,t){return new Se().fromBinary(e,t)}static fromJson(e,t){return new Se().fromJson(e,t)}static fromJsonString(e,t){return new Se().fromJsonString(e,t)}static equals(e,t){return p.util.equals(Se,e,t)}}Se.runtime=p;Se.typeName="livekit.TrackInfo";Se.fields=p.util.newFieldList(()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"type",kind:"enum",T:p.getEnumType(he)},{no:3,name:"name",kind:"scalar",T:9},{no:4,name:"muted",kind:"scalar",T:8},{no:5,name:"width",kind:"scalar",T:13},{no:6,name:"height",kind:"scalar",T:13},{no:7,name:"simulcast",kind:"scalar",T:8},{no:8,name:"disable_dtx",kind:"scalar",T:8},{no:9,name:"source",kind:"enum",T:p.getEnumType(X)},{no:10,name:"layers",kind:"message",T:be,repeated:!0},{no:11,name:"mime_type",kind:"scalar",T:9},{no:12,name:"mid",kind:"scalar",T:9},{no:13,name:"codecs",kind:"message",T:Ct,repeated:!0},{no:14,name:"stereo",kind:"scalar",T:8},{no:15,name:"disable_red",kind:"scalar",T:8},{no:16,name:"encryption",kind:"enum",T:p.getEnumType(ce)},{no:17,name:"stream",kind:"scalar",T:9}]);class be extends I{constructor(e){super(),this.quality=ie.LOW,this.width=0,this.height=0,this.bitrate=0,this.ssrc=0,p.util.initPartial(e,this)}static fromBinary(e,t){return new be().fromBinary(e,t)}static fromJson(e,t){return new be().fromJson(e,t)}static fromJsonString(e,t){return new be().fromJsonString(e,t)}static equals(e,t){return p.util.equals(be,e,t)}}be.runtime=p;be.typeName="livekit.VideoLayer";be.fields=p.util.newFieldList(()=>[{no:1,name:"quality",kind:"enum",T:p.getEnumType(ie)},{no:2,name:"width",kind:"scalar",T:13},{no:3,name:"height",kind:"scalar",T:13},{no:4,name:"bitrate",kind:"scalar",T:13},{no:5,name:"ssrc",kind:"scalar",T:13}]);class Ke extends I{constructor(e){super(),this.kind=oe.RELIABLE,this.value={case:void 0},p.util.initPartial(e,this)}static fromBinary(e,t){return new Ke().fromBinary(e,t)}static fromJson(e,t){return new Ke().fromJson(e,t)}static fromJsonString(e,t){return new Ke().fromJsonString(e,t)}static equals(e,t){return p.util.equals(Ke,e,t)}}Ke.runtime=p;Ke.typeName="livekit.DataPacket";Ke.fields=p.util.newFieldList(()=>[{no:1,name:"kind",kind:"enum",T:p.getEnumType(oe)},{no:2,name:"user",kind:"message",T:Ye,oneof:"value"},{no:3,name:"speaker",kind:"message",T:Tt,oneof:"value"}]);var oe;(function(n){n[n.RELIABLE=0]="RELIABLE",n[n.LOSSY=1]="LOSSY"})(oe||(oe={}));p.util.setEnumType(oe,"livekit.DataPacket.Kind",[{no:0,name:"RELIABLE"},{no:1,name:"LOSSY"}]);class Tt extends I{constructor(e){super(),this.speakers=[],p.util.initPartial(e,this)}static fromBinary(e,t){return new Tt().fromBinary(e,t)}static fromJson(e,t){return new Tt().fromJson(e,t)}static fromJsonString(e,t){return new Tt().fromJsonString(e,t)}static equals(e,t){return p.util.equals(Tt,e,t)}}Tt.runtime=p;Tt.typeName="livekit.ActiveSpeakerUpdate";Tt.fields=p.util.newFieldList(()=>[{no:1,name:"speakers",kind:"message",T:$e,repeated:!0}]);class $e extends I{constructor(e){super(),this.sid="",this.level=0,this.active=!1,p.util.initPartial(e,this)}static fromBinary(e,t){return new $e().fromBinary(e,t)}static fromJson(e,t){return new $e().fromJson(e,t)}static fromJsonString(e,t){return new $e().fromJsonString(e,t)}static equals(e,t){return p.util.equals($e,e,t)}}$e.runtime=p;$e.typeName="livekit.SpeakerInfo";$e.fields=p.util.newFieldList(()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"level",kind:"scalar",T:2},{no:3,name:"active",kind:"scalar",T:8}]);class Ye extends I{constructor(e){super(),this.participantSid="",this.participantIdentity="",this.payload=new Uint8Array(0),this.destinationSids=[],this.destinationIdentities=[],p.util.initPartial(e,this)}static fromBinary(e,t){return new Ye().fromBinary(e,t)}static fromJson(e,t){return new Ye().fromJson(e,t)}static fromJsonString(e,t){return new Ye().fromJsonString(e,t)}static equals(e,t){return p.util.equals(Ye,e,t)}}Ye.runtime=p;Ye.typeName="livekit.UserPacket";Ye.fields=p.util.newFieldList(()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:5,name:"participant_identity",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:12},{no:3,name:"destination_sids",kind:"scalar",T:9,repeated:!0},{no:6,name:"destination_identities",kind:"scalar",T:9,repeated:!0},{no:4,name:"topic",kind:"scalar",T:9,opt:!0}]);class Qe extends I{constructor(e){super(),this.participantSid="",this.trackSids=[],p.util.initPartial(e,this)}static fromBinary(e,t){return new Qe().fromBinary(e,t)}static fromJson(e,t){return new Qe().fromJson(e,t)}static fromJsonString(e,t){return new Qe().fromJsonString(e,t)}static equals(e,t){return p.util.equals(Qe,e,t)}}Qe.runtime=p;Qe.typeName="livekit.ParticipantTracks";Qe.fields=p.util.newFieldList(()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sids",kind:"scalar",T:9,repeated:!0}]);class wt extends I{constructor(e){super(),this.edition=Un.Standard,this.version="",this.protocol=0,this.region="",this.nodeId="",this.debugInfo="",p.util.initPartial(e,this)}static fromBinary(e,t){return new wt().fromBinary(e,t)}static fromJson(e,t){return new wt().fromJson(e,t)}static fromJsonString(e,t){return new wt().fromJsonString(e,t)}static equals(e,t){return p.util.equals(wt,e,t)}}wt.runtime=p;wt.typeName="livekit.ServerInfo";wt.fields=p.util.newFieldList(()=>[{no:1,name:"edition",kind:"enum",T:p.getEnumType(Un)},{no:2,name:"version",kind:"scalar",T:9},{no:3,name:"protocol",kind:"scalar",T:5},{no:4,name:"region",kind:"scalar",T:9},{no:5,name:"node_id",kind:"scalar",T:9},{no:6,name:"debug_info",kind:"scalar",T:9}]);var Un;(function(n){n[n.Standard=0]="Standard",n[n.Cloud=1]="Cloud"})(Un||(Un={}));p.util.setEnumType(Un,"livekit.ServerInfo.Edition",[{no:0,name:"Standard"},{no:1,name:"Cloud"}]);class Et extends I{constructor(e){super(),this.sdk=Fn.UNKNOWN,this.version="",this.protocol=0,this.os="",this.osVersion="",this.deviceModel="",this.browser="",this.browserVersion="",this.address="",this.network="",p.util.initPartial(e,this)}static fromBinary(e,t){return new Et().fromBinary(e,t)}static fromJson(e,t){return new Et().fromJson(e,t)}static fromJsonString(e,t){return new Et().fromJsonString(e,t)}static equals(e,t){return p.util.equals(Et,e,t)}}Et.runtime=p;Et.typeName="livekit.ClientInfo";Et.fields=p.util.newFieldList(()=>[{no:1,name:"sdk",kind:"enum",T:p.getEnumType(Fn)},{no:2,name:"version",kind:"scalar",T:9},{no:3,name:"protocol",kind:"scalar",T:5},{no:4,name:"os",kind:"scalar",T:9},{no:5,name:"os_version",kind:"scalar",T:9},{no:6,name:"device_model",kind:"scalar",T:9},{no:7,name:"browser",kind:"scalar",T:9},{no:8,name:"browser_version",kind:"scalar",T:9},{no:9,name:"address",kind:"scalar",T:9},{no:10,name:"network",kind:"scalar",T:9}]);var Fn;(function(n){n[n.UNKNOWN=0]="UNKNOWN",n[n.JS=1]="JS",n[n.SWIFT=2]="SWIFT",n[n.ANDROID=3]="ANDROID",n[n.FLUTTER=4]="FLUTTER",n[n.GO=5]="GO",n[n.UNITY=6]="UNITY",n[n.REACT_NATIVE=7]="REACT_NATIVE",n[n.RUST=8]="RUST",n[n.PYTHON=9]="PYTHON",n[n.CPP=10]="CPP"})(Fn||(Fn={}));p.util.setEnumType(Fn,"livekit.ClientInfo.SDK",[{no:0,name:"UNKNOWN"},{no:1,name:"JS"},{no:2,name:"SWIFT"},{no:3,name:"ANDROID"},{no:4,name:"FLUTTER"},{no:5,name:"GO"},{no:6,name:"UNITY"},{no:7,name:"REACT_NATIVE"},{no:8,name:"RUST"},{no:9,name:"PYTHON"},{no:10,name:"CPP"}]);class Xe extends I{constructor(e){super(),this.resumeConnection=He.UNSET,this.forceRelay=He.UNSET,p.util.initPartial(e,this)}static fromBinary(e,t){return new Xe().fromBinary(e,t)}static fromJson(e,t){return new Xe().fromJson(e,t)}static fromJsonString(e,t){return new Xe().fromJsonString(e,t)}static equals(e,t){return p.util.equals(Xe,e,t)}}Xe.runtime=p;Xe.typeName="livekit.ClientConfiguration";Xe.fields=p.util.newFieldList(()=>[{no:1,name:"video",kind:"message",T:Ze},{no:2,name:"screen",kind:"message",T:Ze},{no:3,name:"resume_connection",kind:"enum",T:p.getEnumType(He)},{no:4,name:"disabled_codecs",kind:"message",T:Pt},{no:5,name:"force_relay",kind:"enum",T:p.getEnumType(He)}]);class Ze extends I{constructor(e){super(),this.hardwareEncoder=He.UNSET,p.util.initPartial(e,this)}static fromBinary(e,t){return new Ze().fromBinary(e,t)}static fromJson(e,t){return new Ze().fromJson(e,t)}static fromJsonString(e,t){return new Ze().fromJsonString(e,t)}static equals(e,t){return p.util.equals(Ze,e,t)}}Ze.runtime=p;Ze.typeName="livekit.VideoConfiguration";Ze.fields=p.util.newFieldList(()=>[{no:1,name:"hardware_encoder",kind:"enum",T:p.getEnumType(He)}]);class Pt extends I{constructor(e){super(),this.codecs=[],this.publish=[],p.util.initPartial(e,this)}static fromBinary(e,t){return new Pt().fromBinary(e,t)}static fromJson(e,t){return new Pt().fromJson(e,t)}static fromJsonString(e,t){return new Pt().fromJsonString(e,t)}static equals(e,t){return p.util.equals(Pt,e,t)}}Pt.runtime=p;Pt.typeName="livekit.DisabledCodecs";Pt.fields=p.util.newFieldList(()=>[{no:1,name:"codecs",kind:"message",T:Fe,repeated:!0},{no:2,name:"publish",kind:"message",T:Fe,repeated:!0}]);class et extends I{constructor(e){super(),this.duration=0,this.startTimestamp=L.zero,this.endTimestamp=L.zero,this.rtpClockTicks=L.zero,this.driftSamples=L.zero,this.driftMs=0,this.clockRate=0,p.util.initPartial(e,this)}static fromBinary(e,t){return new et().fromBinary(e,t)}static fromJson(e,t){return new et().fromJson(e,t)}static fromJsonString(e,t){return new et().fromJsonString(e,t)}static equals(e,t){return p.util.equals(et,e,t)}}et.runtime=p;et.typeName="livekit.RTPDrift";et.fields=p.util.newFieldList(()=>[{no:1,name:"start_time",kind:"message",T:re},{no:2,name:"end_time",kind:"message",T:re},{no:3,name:"duration",kind:"scalar",T:1},{no:4,name:"start_timestamp",kind:"scalar",T:4},{no:5,name:"end_timestamp",kind:"scalar",T:4},{no:6,name:"rtp_clock_ticks",kind:"scalar",T:4},{no:7,name:"drift_samples",kind:"scalar",T:3},{no:8,name:"drift_ms",kind:"scalar",T:1},{no:9,name:"clock_rate",kind:"scalar",T:1}]);class rn extends I{constructor(e){super(),this.duration=0,this.packets=0,this.packetRate=0,this.bytes=L.zero,this.headerBytes=L.zero,this.bitrate=0,this.packetsLost=0,this.packetLossRate=0,this.packetLossPercentage=0,this.packetsDuplicate=0,this.packetDuplicateRate=0,this.bytesDuplicate=L.zero,this.headerBytesDuplicate=L.zero,this.bitrateDuplicate=0,this.packetsPadding=0,this.packetPaddingRate=0,this.bytesPadding=L.zero,this.headerBytesPadding=L.zero,this.bitratePadding=0,this.packetsOutOfOrder=0,this.frames=0,this.frameRate=0,this.jitterCurrent=0,this.jitterMax=0,this.gapHistogram={},this.nacks=0,this.nackAcks=0,this.nackMisses=0,this.nackRepeated=0,this.plis=0,this.firs=0,this.rttCurrent=0,this.rttMax=0,this.keyFrames=0,this.layerLockPlis=0,p.util.initPartial(e,this)}static fromBinary(e,t){return new rn().fromBinary(e,t)}static fromJson(e,t){return new rn().fromJson(e,t)}static fromJsonString(e,t){return new rn().fromJsonString(e,t)}static equals(e,t){return p.util.equals(rn,e,t)}}rn.runtime=p;rn.typeName="livekit.RTPStats";rn.fields=p.util.newFieldList(()=>[{no:1,name:"start_time",kind:"message",T:re},{no:2,name:"end_time",kind:"message",T:re},{no:3,name:"duration",kind:"scalar",T:1},{no:4,name:"packets",kind:"scalar",T:13},{no:5,name:"packet_rate",kind:"scalar",T:1},{no:6,name:"bytes",kind:"scalar",T:4},{no:39,name:"header_bytes",kind:"scalar",T:4},{no:7,name:"bitrate",kind:"scalar",T:1},{no:8,name:"packets_lost",kind:"scalar",T:13},{no:9,name:"packet_loss_rate",kind:"scalar",T:1},{no:10,name:"packet_loss_percentage",kind:"scalar",T:2},{no:11,name:"packets_duplicate",kind:"scalar",T:13},{no:12,name:"packet_duplicate_rate",kind:"scalar",T:1},{no:13,name:"bytes_duplicate",kind:"scalar",T:4},{no:40,name:"header_bytes_duplicate",kind:"scalar",T:4},{no:14,name:"bitrate_duplicate",kind:"scalar",T:1},{no:15,name:"packets_padding",kind:"scalar",T:13},{no:16,name:"packet_padding_rate",kind:"scalar",T:1},{no:17,name:"bytes_padding",kind:"scalar",T:4},{no:41,name:"header_bytes_padding",kind:"scalar",T:4},{no:18,name:"bitrate_padding",kind:"scalar",T:1},{no:19,name:"packets_out_of_order",kind:"scalar",T:13},{no:20,name:"frames",kind:"scalar",T:13},{no:21,name:"frame_rate",kind:"scalar",T:1},{no:22,name:"jitter_current",kind:"scalar",T:1},{no:23,name:"jitter_max",kind:"scalar",T:1},{no:24,name:"gap_histogram",kind:"map",K:5,V:{kind:"scalar",T:13}},{no:25,name:"nacks",kind:"scalar",T:13},{no:37,name:"nack_acks",kind:"scalar",T:13},{no:26,name:"nack_misses",kind:"scalar",T:13},{no:38,name:"nack_repeated",kind:"scalar",T:13},{no:27,name:"plis",kind:"scalar",T:13},{no:28,name:"last_pli",kind:"message",T:re},{no:29,name:"firs",kind:"scalar",T:13},{no:30,name:"last_fir",kind:"message",T:re},{no:31,name:"rtt_current",kind:"scalar",T:13},{no:32,name:"rtt_max",kind:"scalar",T:13},{no:33,name:"key_frames",kind:"scalar",T:13},{no:34,name:"last_key_frame",kind:"message",T:re},{no:35,name:"layer_lock_plis",kind:"scalar",T:13},{no:36,name:"last_layer_lock_pli",kind:"message",T:re},{no:44,name:"packet_drift",kind:"message",T:et},{no:45,name:"report_drift",kind:"message",T:et}]);class sn extends I{constructor(e){super(),this.unixMicro=L.zero,this.ticks=0,p.util.initPartial(e,this)}static fromBinary(e,t){return new sn().fromBinary(e,t)}static fromJson(e,t){return new sn().fromJson(e,t)}static fromJsonString(e,t){return new sn().fromJsonString(e,t)}static equals(e,t){return p.util.equals(sn,e,t)}}sn.runtime=p;sn.typeName="livekit.TimedVersion";sn.fields=p.util.newFieldList(()=>[{no:1,name:"unix_micro",kind:"scalar",T:3},{no:2,name:"ticks",kind:"scalar",T:5}]);const Yn=7e3,fu=[0,300,2*2*300,3*3*300,4*4*300,Yn,Yn,Yn,Yn,Yn];class pu{constructor(e){this._retryDelays=e!==void 0?[...e]:fu}nextRetryDelayInMs(e){if(e.retryCount>=this._retryDelays.length)return null;const t=this._retryDelays[e.retryCount];return e.retryCount<=1?t:t+Math.random()*1e3}}function y(n,e,t,i){function r(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function a(u){try{l(i.next(u))}catch(d){o(d)}}function c(u){try{l(i.throw(u))}catch(d){o(d)}}function l(u){u.done?s(u.value):r(u.value).then(a,c)}l((i=i.apply(n,e||[])).next())})}function Hs(n){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&n[e],i=0;if(t)return t.call(n);if(n&&typeof n.length=="number")return{next:function(){return n&&i>=n.length&&(n=void 0),{value:n&&n[i++],done:!n}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function xn(n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=n[Symbol.asyncIterator],t;return e?e.call(n):(n=typeof Hs=="function"?Hs(n):n[Symbol.iterator](),t={},i("next"),i("throw"),i("return"),t[Symbol.asyncIterator]=function(){return this},t);function i(s){t[s]=n[s]&&function(o){return new Promise(function(a,c){o=n[s](o),r(a,c,o.done,o.value)})}}function r(s,o,a,c){Promise.resolve(c).then(function(l){s({value:l,done:a})},o)}}var os={exports:{}},Rn=typeof Reflect=="object"?Reflect:null,zs=Rn&&typeof Rn.apply=="function"?Rn.apply:function(e,t,i){return Function.prototype.apply.call(e,t,i)},Pi;Rn&&typeof Rn.ownKeys=="function"?Pi=Rn.ownKeys:Object.getOwnPropertySymbols?Pi=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:Pi=function(e){return Object.getOwnPropertyNames(e)};function mu(n){console&&console.warn&&console.warn(n)}var ua=Number.isNaN||function(e){return e!==e};function q(){q.init.call(this)}os.exports=q;os.exports.once=yu;q.EventEmitter=q;q.prototype._events=void 0;q.prototype._eventsCount=0;q.prototype._maxListeners=void 0;var Ks=10;function Ki(n){if(typeof n!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof n)}Object.defineProperty(q,"defaultMaxListeners",{enumerable:!0,get:function(){return Ks},set:function(n){if(typeof n!="number"||n<0||ua(n))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+n+".");Ks=n}});q.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};q.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||ua(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function da(n){return n._maxListeners===void 0?q.defaultMaxListeners:n._maxListeners}q.prototype.getMaxListeners=function(){return da(this)};q.prototype.emit=function(e){for(var t=[],i=1;i<arguments.length;i++)t.push(arguments[i]);var r=e==="error",s=this._events;if(s!==void 0)r=r&&s.error===void 0;else if(!r)return!1;if(r){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var c=s[e];if(c===void 0)return!1;if(typeof c=="function")zs(c,this,t);else for(var l=c.length,u=ga(c,l),i=0;i<l;++i)zs(u[i],this,t);return!0};function ha(n,e,t,i){var r,s,o;if(Ki(t),s=n._events,s===void 0?(s=n._events=Object.create(null),n._eventsCount=0):(s.newListener!==void 0&&(n.emit("newListener",e,t.listener?t.listener:t),s=n._events),o=s[e]),o===void 0)o=s[e]=t,++n._eventsCount;else if(typeof o=="function"?o=s[e]=i?[t,o]:[o,t]:i?o.unshift(t):o.push(t),r=da(n),r>0&&o.length>r&&!o.warned){o.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=n,a.type=e,a.count=o.length,mu(a)}return n}q.prototype.addListener=function(e,t){return ha(this,e,t,!1)};q.prototype.on=q.prototype.addListener;q.prototype.prependListener=function(e,t){return ha(this,e,t,!0)};function gu(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function fa(n,e,t){var i={fired:!1,wrapFn:void 0,target:n,type:e,listener:t},r=gu.bind(i);return r.listener=t,i.wrapFn=r,r}q.prototype.once=function(e,t){return Ki(t),this.on(e,fa(this,e,t)),this};q.prototype.prependOnceListener=function(e,t){return Ki(t),this.prependListener(e,fa(this,e,t)),this};q.prototype.removeListener=function(e,t){var i,r,s,o,a;if(Ki(t),r=this._events,r===void 0)return this;if(i=r[e],i===void 0)return this;if(i===t||i.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,i.listener||t));else if(typeof i!="function"){for(s=-1,o=i.length-1;o>=0;o--)if(i[o]===t||i[o].listener===t){a=i[o].listener,s=o;break}if(s<0)return this;s===0?i.shift():vu(i,s),i.length===1&&(r[e]=i[0]),r.removeListener!==void 0&&this.emit("removeListener",e,a||t)}return this};q.prototype.off=q.prototype.removeListener;q.prototype.removeAllListeners=function(e){var t,i,r;if(i=this._events,i===void 0)return this;if(i.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):i[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete i[e]),this;if(arguments.length===0){var s=Object.keys(i),o;for(r=0;r<s.length;++r)o=s[r],o!=="removeListener"&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=i[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this};function pa(n,e,t){var i=n._events;if(i===void 0)return[];var r=i[e];return r===void 0?[]:typeof r=="function"?t?[r.listener||r]:[r]:t?bu(r):ga(r,r.length)}q.prototype.listeners=function(e){return pa(this,e,!0)};q.prototype.rawListeners=function(e){return pa(this,e,!1)};q.listenerCount=function(n,e){return typeof n.listenerCount=="function"?n.listenerCount(e):ma.call(n,e)};q.prototype.listenerCount=ma;function ma(n){var e=this._events;if(e!==void 0){var t=e[n];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}q.prototype.eventNames=function(){return this._eventsCount>0?Pi(this._events):[]};function ga(n,e){for(var t=new Array(e),i=0;i<e;++i)t[i]=n[i];return t}function vu(n,e){for(;e+1<n.length;e++)n[e]=n[e+1];n.pop()}function bu(n){for(var e=new Array(n.length),t=0;t<e.length;++t)e[t]=n[t].listener||n[t];return e}function yu(n,e){return new Promise(function(t,i){function r(o){n.removeListener(e,s),i(o)}function s(){typeof n.removeListener=="function"&&n.removeListener("error",r),t([].slice.call(arguments))}va(n,e,s,{once:!0}),e!=="error"&&ku(n,r,{once:!0})})}function ku(n,e,t){typeof n.on=="function"&&va(n,"error",e,t)}function va(n,e,t,i){if(typeof n.on=="function")i.once?n.once(e,t):n.on(e,t);else if(typeof n.addEventListener=="function")n.addEventListener(e,function r(s){i.once&&n.removeEventListener(e,r),t(s)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof n)}var ft=os.exports;let ba=!0,ya=!0;function xi(n,e,t){const i=n.match(e);return i&&i.length>=t&&parseInt(i[t],10)}function Cn(n,e,t){if(!n.RTCPeerConnection)return;const i=n.RTCPeerConnection.prototype,r=i.addEventListener;i.addEventListener=function(o,a){if(o!==e)return r.apply(this,arguments);const c=l=>{const u=t(l);u&&(a.handleEvent?a.handleEvent(u):a(u))};return this._eventMap=this._eventMap||{},this._eventMap[e]||(this._eventMap[e]=new Map),this._eventMap[e].set(a,c),r.apply(this,[o,c])};const s=i.removeEventListener;i.removeEventListener=function(o,a){if(o!==e||!this._eventMap||!this._eventMap[e])return s.apply(this,arguments);if(!this._eventMap[e].has(a))return s.apply(this,arguments);const c=this._eventMap[e].get(a);return this._eventMap[e].delete(a),this._eventMap[e].size===0&&delete this._eventMap[e],Object.keys(this._eventMap).length===0&&delete this._eventMap,s.apply(this,[o,c])},Object.defineProperty(i,"on"+e,{get(){return this["_on"+e]},set(o){this["_on"+e]&&(this.removeEventListener(e,this["_on"+e]),delete this["_on"+e]),o&&this.addEventListener(e,this["_on"+e]=o)},enumerable:!0,configurable:!0})}function Su(n){return typeof n!="boolean"?new Error("Argument type: "+typeof n+". Please use a boolean."):(ba=n,n?"adapter.js logging disabled":"adapter.js logging enabled")}function Cu(n){return typeof n!="boolean"?new Error("Argument type: "+typeof n+". Please use a boolean."):(ya=!n,"adapter.js deprecation warnings "+(n?"disabled":"enabled"))}function ka(){if(typeof window=="object"){if(ba)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function as(n,e){ya&&console.warn(n+" is deprecated, please use "+e+" instead.")}function Tu(n){const e={browser:null,version:null};if(typeof n>"u"||!n.navigator||!n.navigator.userAgent)return e.browser="Not a browser.",e;const{navigator:t}=n;if(t.mozGetUserMedia)e.browser="firefox",e.version=xi(t.userAgent,/Firefox\/(\d+)\./,1);else if(t.webkitGetUserMedia||n.isSecureContext===!1&&n.webkitRTCPeerConnection)e.browser="chrome",e.version=xi(t.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(n.RTCPeerConnection&&t.userAgent.match(/AppleWebKit\/(\d+)\./))e.browser="safari",e.version=xi(t.userAgent,/AppleWebKit\/(\d+)\./,1),e.supportsUnifiedPlan=n.RTCRtpTransceiver&&"currentDirection"in n.RTCRtpTransceiver.prototype;else return e.browser="Not a supported browser.",e;return e}function $s(n){return Object.prototype.toString.call(n)==="[object Object]"}function Sa(n){return $s(n)?Object.keys(n).reduce(function(e,t){const i=$s(n[t]),r=i?Sa(n[t]):n[t],s=i&&!Object.keys(r).length;return r===void 0||s?e:Object.assign(e,{[t]:r})},{}):n}function Ir(n,e,t){!e||t.has(e.id)||(t.set(e.id,e),Object.keys(e).forEach(i=>{i.endsWith("Id")?Ir(n,n.get(e[i]),t):i.endsWith("Ids")&&e[i].forEach(r=>{Ir(n,n.get(r),t)})}))}function Ys(n,e,t){const i=t?"outbound-rtp":"inbound-rtp",r=new Map;if(e===null)return r;const s=[];return n.forEach(o=>{o.type==="track"&&o.trackIdentifier===e.id&&s.push(o)}),s.forEach(o=>{n.forEach(a=>{a.type===i&&a.trackId===o.id&&Ir(n,a,r)})}),r}const Qs=ka;function Ca(n,e){const t=n&&n.navigator;if(!t.mediaDevices)return;const i=function(a){if(typeof a!="object"||a.mandatory||a.optional)return a;const c={};return Object.keys(a).forEach(l=>{if(l==="require"||l==="advanced"||l==="mediaSource")return;const u=typeof a[l]=="object"?a[l]:{ideal:a[l]};u.exact!==void 0&&typeof u.exact=="number"&&(u.min=u.max=u.exact);const d=function(h,m){return h?h+m.charAt(0).toUpperCase()+m.slice(1):m==="deviceId"?"sourceId":m};if(u.ideal!==void 0){c.optional=c.optional||[];let h={};typeof u.ideal=="number"?(h[d("min",l)]=u.ideal,c.optional.push(h),h={},h[d("max",l)]=u.ideal,c.optional.push(h)):(h[d("",l)]=u.ideal,c.optional.push(h))}u.exact!==void 0&&typeof u.exact!="number"?(c.mandatory=c.mandatory||{},c.mandatory[d("",l)]=u.exact):["min","max"].forEach(h=>{u[h]!==void 0&&(c.mandatory=c.mandatory||{},c.mandatory[d(h,l)]=u[h])})}),a.advanced&&(c.optional=(c.optional||[]).concat(a.advanced)),c},r=function(a,c){if(e.version>=61)return c(a);if(a=JSON.parse(JSON.stringify(a)),a&&typeof a.audio=="object"){const l=function(u,d,h){d in u&&!(h in u)&&(u[h]=u[d],delete u[d])};a=JSON.parse(JSON.stringify(a)),l(a.audio,"autoGainControl","googAutoGainControl"),l(a.audio,"noiseSuppression","googNoiseSuppression"),a.audio=i(a.audio)}if(a&&typeof a.video=="object"){let l=a.video.facingMode;l=l&&(typeof l=="object"?l:{ideal:l});const u=e.version<66;if(l&&(l.exact==="user"||l.exact==="environment"||l.ideal==="user"||l.ideal==="environment")&&!(t.mediaDevices.getSupportedConstraints&&t.mediaDevices.getSupportedConstraints().facingMode&&!u)){delete a.video.facingMode;let d;if(l.exact==="environment"||l.ideal==="environment"?d=["back","rear"]:(l.exact==="user"||l.ideal==="user")&&(d=["front"]),d)return t.mediaDevices.enumerateDevices().then(h=>{h=h.filter(g=>g.kind==="videoinput");let m=h.find(g=>d.some(v=>g.label.toLowerCase().includes(v)));return!m&&h.length&&d.includes("back")&&(m=h[h.length-1]),m&&(a.video.deviceId=l.exact?{exact:m.deviceId}:{ideal:m.deviceId}),a.video=i(a.video),Qs("chrome: "+JSON.stringify(a)),c(a)})}a.video=i(a.video)}return Qs("chrome: "+JSON.stringify(a)),c(a)},s=function(a){return e.version>=64?a:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[a.name]||a.name,message:a.message,constraint:a.constraint||a.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}},o=function(a,c,l){r(a,u=>{t.webkitGetUserMedia(u,c,d=>{l&&l(s(d))})})};if(t.getUserMedia=o.bind(t),t.mediaDevices.getUserMedia){const a=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(c){return r(c,l=>a(l).then(u=>{if(l.audio&&!u.getAudioTracks().length||l.video&&!u.getVideoTracks().length)throw u.getTracks().forEach(d=>{d.stop()}),new DOMException("","NotFoundError");return u},u=>Promise.reject(s(u))))}}}function wu(n,e){if(!(n.navigator.mediaDevices&&"getDisplayMedia"in n.navigator.mediaDevices)&&n.navigator.mediaDevices){if(typeof e!="function"){console.error("shimGetDisplayMedia: getSourceId argument is not a function");return}n.navigator.mediaDevices.getDisplayMedia=function(i){return e(i).then(r=>{const s=i.video&&i.video.width,o=i.video&&i.video.height,a=i.video&&i.video.frameRate;return i.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:r,maxFrameRate:a||3}},s&&(i.video.mandatory.maxWidth=s),o&&(i.video.mandatory.maxHeight=o),n.navigator.mediaDevices.getUserMedia(i)})}}}function Ta(n){n.MediaStream=n.MediaStream||n.webkitMediaStream}function wa(n){if(typeof n=="object"&&n.RTCPeerConnection&&!("ontrack"in n.RTCPeerConnection.prototype)){Object.defineProperty(n.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(t){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=t)},enumerable:!0,configurable:!0});const e=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=i=>{i.stream.addEventListener("addtrack",r=>{let s;n.RTCPeerConnection.prototype.getReceivers?s=this.getReceivers().find(a=>a.track&&a.track.id===r.track.id):s={track:r.track};const o=new Event("track");o.track=r.track,o.receiver=s,o.transceiver={receiver:s},o.streams=[i.stream],this.dispatchEvent(o)}),i.stream.getTracks().forEach(r=>{let s;n.RTCPeerConnection.prototype.getReceivers?s=this.getReceivers().find(a=>a.track&&a.track.id===r.id):s={track:r};const o=new Event("track");o.track=r,o.receiver=s,o.transceiver={receiver:s},o.streams=[i.stream],this.dispatchEvent(o)})},this.addEventListener("addstream",this._ontrackpoly)),e.apply(this,arguments)}}else Cn(n,"track",e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e))}function Ea(n){if(typeof n=="object"&&n.RTCPeerConnection&&!("getSenders"in n.RTCPeerConnection.prototype)&&"createDTMFSender"in n.RTCPeerConnection.prototype){const e=function(r,s){return{track:s,get dtmf(){return this._dtmf===void 0&&(s.kind==="audio"?this._dtmf=r.createDTMFSender(s):this._dtmf=null),this._dtmf},_pc:r}};if(!n.RTCPeerConnection.prototype.getSenders){n.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const r=n.RTCPeerConnection.prototype.addTrack;n.RTCPeerConnection.prototype.addTrack=function(a,c){let l=r.apply(this,arguments);return l||(l=e(this,a),this._senders.push(l)),l};const s=n.RTCPeerConnection.prototype.removeTrack;n.RTCPeerConnection.prototype.removeTrack=function(a){s.apply(this,arguments);const c=this._senders.indexOf(a);c!==-1&&this._senders.splice(c,1)}}const t=n.RTCPeerConnection.prototype.addStream;n.RTCPeerConnection.prototype.addStream=function(s){this._senders=this._senders||[],t.apply(this,[s]),s.getTracks().forEach(o=>{this._senders.push(e(this,o))})};const i=n.RTCPeerConnection.prototype.removeStream;n.RTCPeerConnection.prototype.removeStream=function(s){this._senders=this._senders||[],i.apply(this,[s]),s.getTracks().forEach(o=>{const a=this._senders.find(c=>c.track===o);a&&this._senders.splice(this._senders.indexOf(a),1)})}}else if(typeof n=="object"&&n.RTCPeerConnection&&"getSenders"in n.RTCPeerConnection.prototype&&"createDTMFSender"in n.RTCPeerConnection.prototype&&n.RTCRtpSender&&!("dtmf"in n.RTCRtpSender.prototype)){const e=n.RTCPeerConnection.prototype.getSenders;n.RTCPeerConnection.prototype.getSenders=function(){const i=e.apply(this,[]);return i.forEach(r=>r._pc=this),i},Object.defineProperty(n.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function Pa(n){if(!n.RTCPeerConnection)return;const e=n.RTCPeerConnection.prototype.getStats;n.RTCPeerConnection.prototype.getStats=function(){const[i,r,s]=arguments;if(arguments.length>0&&typeof i=="function")return e.apply(this,arguments);if(e.length===0&&(arguments.length===0||typeof i!="function"))return e.apply(this,[]);const o=function(c){const l={};return c.result().forEach(d=>{const h={id:d.id,timestamp:d.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[d.type]||d.type};d.names().forEach(m=>{h[m]=d.stat(m)}),l[h.id]=h}),l},a=function(c){return new Map(Object.keys(c).map(l=>[l,c[l]]))};if(arguments.length>=2){const c=function(l){r(a(o(l)))};return e.apply(this,[c,i])}return new Promise((c,l)=>{e.apply(this,[function(u){c(a(o(u)))},l])}).then(r,s)}}function xa(n){if(!(typeof n=="object"&&n.RTCPeerConnection&&n.RTCRtpSender&&n.RTCRtpReceiver))return;if(!("getStats"in n.RTCRtpSender.prototype)){const t=n.RTCPeerConnection.prototype.getSenders;t&&(n.RTCPeerConnection.prototype.getSenders=function(){const s=t.apply(this,[]);return s.forEach(o=>o._pc=this),s});const i=n.RTCPeerConnection.prototype.addTrack;i&&(n.RTCPeerConnection.prototype.addTrack=function(){const s=i.apply(this,arguments);return s._pc=this,s}),n.RTCRtpSender.prototype.getStats=function(){const s=this;return this._pc.getStats().then(o=>Ys(o,s.track,!0))}}if(!("getStats"in n.RTCRtpReceiver.prototype)){const t=n.RTCPeerConnection.prototype.getReceivers;t&&(n.RTCPeerConnection.prototype.getReceivers=function(){const r=t.apply(this,[]);return r.forEach(s=>s._pc=this),r}),Cn(n,"track",i=>(i.receiver._pc=i.srcElement,i)),n.RTCRtpReceiver.prototype.getStats=function(){const r=this;return this._pc.getStats().then(s=>Ys(s,r.track,!1))}}if(!("getStats"in n.RTCRtpSender.prototype&&"getStats"in n.RTCRtpReceiver.prototype))return;const e=n.RTCPeerConnection.prototype.getStats;n.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof n.MediaStreamTrack){const i=arguments[0];let r,s,o;return this.getSenders().forEach(a=>{a.track===i&&(r?o=!0:r=a)}),this.getReceivers().forEach(a=>(a.track===i&&(s?o=!0:s=a),a.track===i)),o||r&&s?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):r?r.getStats():s?s.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return e.apply(this,arguments)}}function Oa(n){n.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(o=>this._shimmedLocalStreams[o][0])};const e=n.RTCPeerConnection.prototype.addTrack;n.RTCPeerConnection.prototype.addTrack=function(o,a){if(!a)return e.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const c=e.apply(this,arguments);return this._shimmedLocalStreams[a.id]?this._shimmedLocalStreams[a.id].indexOf(c)===-1&&this._shimmedLocalStreams[a.id].push(c):this._shimmedLocalStreams[a.id]=[a,c],c};const t=n.RTCPeerConnection.prototype.addStream;n.RTCPeerConnection.prototype.addStream=function(o){this._shimmedLocalStreams=this._shimmedLocalStreams||{},o.getTracks().forEach(l=>{if(this.getSenders().find(d=>d.track===l))throw new DOMException("Track already exists.","InvalidAccessError")});const a=this.getSenders();t.apply(this,arguments);const c=this.getSenders().filter(l=>a.indexOf(l)===-1);this._shimmedLocalStreams[o.id]=[o].concat(c)};const i=n.RTCPeerConnection.prototype.removeStream;n.RTCPeerConnection.prototype.removeStream=function(o){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[o.id],i.apply(this,arguments)};const r=n.RTCPeerConnection.prototype.removeTrack;n.RTCPeerConnection.prototype.removeTrack=function(o){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},o&&Object.keys(this._shimmedLocalStreams).forEach(a=>{const c=this._shimmedLocalStreams[a].indexOf(o);c!==-1&&this._shimmedLocalStreams[a].splice(c,1),this._shimmedLocalStreams[a].length===1&&delete this._shimmedLocalStreams[a]}),r.apply(this,arguments)}}function Ra(n,e){if(!n.RTCPeerConnection)return;if(n.RTCPeerConnection.prototype.addTrack&&e.version>=65)return Oa(n);const t=n.RTCPeerConnection.prototype.getLocalStreams;n.RTCPeerConnection.prototype.getLocalStreams=function(){const u=t.apply(this);return this._reverseStreams=this._reverseStreams||{},u.map(d=>this._reverseStreams[d.id])};const i=n.RTCPeerConnection.prototype.addStream;n.RTCPeerConnection.prototype.addStream=function(u){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},u.getTracks().forEach(d=>{if(this.getSenders().find(m=>m.track===d))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[u.id]){const d=new n.MediaStream(u.getTracks());this._streams[u.id]=d,this._reverseStreams[d.id]=u,u=d}i.apply(this,[u])};const r=n.RTCPeerConnection.prototype.removeStream;n.RTCPeerConnection.prototype.removeStream=function(u){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},r.apply(this,[this._streams[u.id]||u]),delete this._reverseStreams[this._streams[u.id]?this._streams[u.id].id:u.id],delete this._streams[u.id]},n.RTCPeerConnection.prototype.addTrack=function(u,d){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const h=[].slice.call(arguments,1);if(h.length!==1||!h[0].getTracks().find(v=>v===u))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(v=>v.track===u))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const g=this._streams[d.id];if(g)g.addTrack(u),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const v=new n.MediaStream([u]);this._streams[d.id]=v,this._reverseStreams[v.id]=d,this.addStream(v)}return this.getSenders().find(v=>v.track===u)};function s(l,u){let d=u.sdp;return Object.keys(l._reverseStreams||[]).forEach(h=>{const m=l._reverseStreams[h],g=l._streams[m.id];d=d.replace(new RegExp(g.id,"g"),m.id)}),new RTCSessionDescription({type:u.type,sdp:d})}function o(l,u){let d=u.sdp;return Object.keys(l._reverseStreams||[]).forEach(h=>{const m=l._reverseStreams[h],g=l._streams[m.id];d=d.replace(new RegExp(m.id,"g"),g.id)}),new RTCSessionDescription({type:u.type,sdp:d})}["createOffer","createAnswer"].forEach(function(l){const u=n.RTCPeerConnection.prototype[l],d={[l](){const h=arguments;return arguments.length&&typeof arguments[0]=="function"?u.apply(this,[g=>{const v=s(this,g);h[0].apply(null,[v])},g=>{h[1]&&h[1].apply(null,g)},arguments[2]]):u.apply(this,arguments).then(g=>s(this,g))}};n.RTCPeerConnection.prototype[l]=d[l]});const a=n.RTCPeerConnection.prototype.setLocalDescription;n.RTCPeerConnection.prototype.setLocalDescription=function(){return!arguments.length||!arguments[0].type?a.apply(this,arguments):(arguments[0]=o(this,arguments[0]),a.apply(this,arguments))};const c=Object.getOwnPropertyDescriptor(n.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(n.RTCPeerConnection.prototype,"localDescription",{get(){const l=c.get.apply(this);return l.type===""?l:s(this,l)}}),n.RTCPeerConnection.prototype.removeTrack=function(u){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!u._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(u._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{};let h;Object.keys(this._streams).forEach(m=>{this._streams[m].getTracks().find(v=>u.track===v)&&(h=this._streams[m])}),h&&(h.getTracks().length===1?this.removeStream(this._reverseStreams[h.id]):h.removeTrack(u.track),this.dispatchEvent(new Event("negotiationneeded")))}}function _r(n,e){!n.RTCPeerConnection&&n.webkitRTCPeerConnection&&(n.RTCPeerConnection=n.webkitRTCPeerConnection),n.RTCPeerConnection&&e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){const i=n.RTCPeerConnection.prototype[t],r={[t](){return arguments[0]=new(t==="addIceCandidate"?n.RTCIceCandidate:n.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};n.RTCPeerConnection.prototype[t]=r[t]})}function Ia(n,e){Cn(n,"negotiationneeded",t=>{const i=t.target;if(!((e.version<72||i.getConfiguration&&i.getConfiguration().sdpSemantics==="plan-b")&&i.signalingState!=="stable"))return t})}var Xs=Object.freeze({__proto__:null,fixNegotiationNeeded:Ia,shimAddTrackRemoveTrack:Ra,shimAddTrackRemoveTrackWithNative:Oa,shimGetDisplayMedia:wu,shimGetSendersWithDtmf:Ea,shimGetStats:Pa,shimGetUserMedia:Ca,shimMediaStream:Ta,shimOnTrack:wa,shimPeerConnection:_r,shimSenderReceiverGetStats:xa});function _a(n,e){const t=n&&n.navigator,i=n&&n.MediaStreamTrack;if(t.getUserMedia=function(r,s,o){as("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),t.mediaDevices.getUserMedia(r).then(s,o)},!(e.version>55&&"autoGainControl"in t.mediaDevices.getSupportedConstraints())){const r=function(o,a,c){a in o&&!(c in o)&&(o[c]=o[a],delete o[a])},s=t.mediaDevices.getUserMedia.bind(t.mediaDevices);if(t.mediaDevices.getUserMedia=function(o){return typeof o=="object"&&typeof o.audio=="object"&&(o=JSON.parse(JSON.stringify(o)),r(o.audio,"autoGainControl","mozAutoGainControl"),r(o.audio,"noiseSuppression","mozNoiseSuppression")),s(o)},i&&i.prototype.getSettings){const o=i.prototype.getSettings;i.prototype.getSettings=function(){const a=o.apply(this,arguments);return r(a,"mozAutoGainControl","autoGainControl"),r(a,"mozNoiseSuppression","noiseSuppression"),a}}if(i&&i.prototype.applyConstraints){const o=i.prototype.applyConstraints;i.prototype.applyConstraints=function(a){return this.kind==="audio"&&typeof a=="object"&&(a=JSON.parse(JSON.stringify(a)),r(a,"autoGainControl","mozAutoGainControl"),r(a,"noiseSuppression","mozNoiseSuppression")),o.apply(this,[a])}}}}function Eu(n,e){n.navigator.mediaDevices&&"getDisplayMedia"in n.navigator.mediaDevices||n.navigator.mediaDevices&&(n.navigator.mediaDevices.getDisplayMedia=function(i){if(!(i&&i.video)){const r=new DOMException("getDisplayMedia without video constraints is undefined");return r.name="NotFoundError",r.code=8,Promise.reject(r)}return i.video===!0?i.video={mediaSource:e}:i.video.mediaSource=e,n.navigator.mediaDevices.getUserMedia(i)})}function Ma(n){typeof n=="object"&&n.RTCTrackEvent&&"receiver"in n.RTCTrackEvent.prototype&&!("transceiver"in n.RTCTrackEvent.prototype)&&Object.defineProperty(n.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function Mr(n,e){if(typeof n!="object"||!(n.RTCPeerConnection||n.mozRTCPeerConnection))return;!n.RTCPeerConnection&&n.mozRTCPeerConnection&&(n.RTCPeerConnection=n.mozRTCPeerConnection),e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(r){const s=n.RTCPeerConnection.prototype[r],o={[r](){return arguments[0]=new(r==="addIceCandidate"?n.RTCIceCandidate:n.RTCSessionDescription)(arguments[0]),s.apply(this,arguments)}};n.RTCPeerConnection.prototype[r]=o[r]});const t={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},i=n.RTCPeerConnection.prototype.getStats;n.RTCPeerConnection.prototype.getStats=function(){const[s,o,a]=arguments;return i.apply(this,[s||null]).then(c=>{if(e.version<53&&!o)try{c.forEach(l=>{l.type=t[l.type]||l.type})}catch(l){if(l.name!=="TypeError")throw l;c.forEach((u,d)=>{c.set(d,Object.assign({},u,{type:t[u.type]||u.type}))})}return c}).then(o,a)}}function Na(n){if(!(typeof n=="object"&&n.RTCPeerConnection&&n.RTCRtpSender)||n.RTCRtpSender&&"getStats"in n.RTCRtpSender.prototype)return;const e=n.RTCPeerConnection.prototype.getSenders;e&&(n.RTCPeerConnection.prototype.getSenders=function(){const r=e.apply(this,[]);return r.forEach(s=>s._pc=this),r});const t=n.RTCPeerConnection.prototype.addTrack;t&&(n.RTCPeerConnection.prototype.addTrack=function(){const r=t.apply(this,arguments);return r._pc=this,r}),n.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function Aa(n){if(!(typeof n=="object"&&n.RTCPeerConnection&&n.RTCRtpSender)||n.RTCRtpSender&&"getStats"in n.RTCRtpReceiver.prototype)return;const e=n.RTCPeerConnection.prototype.getReceivers;e&&(n.RTCPeerConnection.prototype.getReceivers=function(){const i=e.apply(this,[]);return i.forEach(r=>r._pc=this),i}),Cn(n,"track",t=>(t.receiver._pc=t.srcElement,t)),n.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function Da(n){!n.RTCPeerConnection||"removeStream"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.removeStream=function(t){as("removeStream","removeTrack"),this.getSenders().forEach(i=>{i.track&&t.getTracks().includes(i.track)&&this.removeTrack(i)})})}function La(n){n.DataChannel&&!n.RTCDataChannel&&(n.RTCDataChannel=n.DataChannel)}function Ua(n){if(!(typeof n=="object"&&n.RTCPeerConnection))return;const e=n.RTCPeerConnection.prototype.addTransceiver;e&&(n.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let i=arguments[1]&&arguments[1].sendEncodings;i===void 0&&(i=[]),i=[...i];const r=i.length>0;r&&i.forEach(o=>{if("rid"in o&&!/^[a-z0-9]{0,16}$/i.test(o.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in o&&!(parseFloat(o.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in o&&!(parseFloat(o.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const s=e.apply(this,arguments);if(r){const{sender:o}=s,a=o.getParameters();(!("encodings"in a)||a.encodings.length===1&&Object.keys(a.encodings[0]).length===0)&&(a.encodings=i,o.sendEncodings=i,this.setParametersPromises.push(o.setParameters(a).then(()=>{delete o.sendEncodings}).catch(()=>{delete o.sendEncodings})))}return s})}function Fa(n){if(!(typeof n=="object"&&n.RTCRtpSender))return;const e=n.RTCRtpSender.prototype.getParameters;e&&(n.RTCRtpSender.prototype.getParameters=function(){const i=e.apply(this,arguments);return"encodings"in i||(i.encodings=[].concat(this.sendEncodings||[{}])),i})}function Ba(n){if(!(typeof n=="object"&&n.RTCPeerConnection))return;const e=n.RTCPeerConnection.prototype.createOffer;n.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}function ja(n){if(!(typeof n=="object"&&n.RTCPeerConnection))return;const e=n.RTCPeerConnection.prototype.createAnswer;n.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}var Zs=Object.freeze({__proto__:null,shimAddTransceiver:Ua,shimCreateAnswer:ja,shimCreateOffer:Ba,shimGetDisplayMedia:Eu,shimGetParameters:Fa,shimGetUserMedia:_a,shimOnTrack:Ma,shimPeerConnection:Mr,shimRTCDataChannel:La,shimReceiverGetStats:Aa,shimRemoveStream:Da,shimSenderGetStats:Na});function Va(n){if(!(typeof n!="object"||!n.RTCPeerConnection)){if("getLocalStreams"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in n.RTCPeerConnection.prototype)){const e=n.RTCPeerConnection.prototype.addTrack;n.RTCPeerConnection.prototype.addStream=function(i){this._localStreams||(this._localStreams=[]),this._localStreams.includes(i)||this._localStreams.push(i),i.getAudioTracks().forEach(r=>e.call(this,r,i)),i.getVideoTracks().forEach(r=>e.call(this,r,i))},n.RTCPeerConnection.prototype.addTrack=function(i){for(var r=arguments.length,s=new Array(r>1?r-1:0),o=1;o<r;o++)s[o-1]=arguments[o];return s&&s.forEach(a=>{this._localStreams?this._localStreams.includes(a)||this._localStreams.push(a):this._localStreams=[a]}),e.apply(this,arguments)}}"removeStream"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.removeStream=function(t){this._localStreams||(this._localStreams=[]);const i=this._localStreams.indexOf(t);if(i===-1)return;this._localStreams.splice(i,1);const r=t.getTracks();this.getSenders().forEach(s=>{r.includes(s.track)&&this.removeTrack(s)})})}}function Ja(n){if(!(typeof n!="object"||!n.RTCPeerConnection)&&("getRemoteStreams"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in n.RTCPeerConnection.prototype))){Object.defineProperty(n.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(t){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=t),this.addEventListener("track",this._onaddstreampoly=i=>{i.streams.forEach(r=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(r))return;this._remoteStreams.push(r);const s=new Event("addstream");s.stream=r,this.dispatchEvent(s)})})}});const e=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(){const i=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(r){r.streams.forEach(s=>{if(i._remoteStreams||(i._remoteStreams=[]),i._remoteStreams.indexOf(s)>=0)return;i._remoteStreams.push(s);const o=new Event("addstream");o.stream=s,i.dispatchEvent(o)})}),e.apply(i,arguments)}}}function qa(n){if(typeof n!="object"||!n.RTCPeerConnection)return;const e=n.RTCPeerConnection.prototype,t=e.createOffer,i=e.createAnswer,r=e.setLocalDescription,s=e.setRemoteDescription,o=e.addIceCandidate;e.createOffer=function(l,u){const d=arguments.length>=2?arguments[2]:arguments[0],h=t.apply(this,[d]);return u?(h.then(l,u),Promise.resolve()):h},e.createAnswer=function(l,u){const d=arguments.length>=2?arguments[2]:arguments[0],h=i.apply(this,[d]);return u?(h.then(l,u),Promise.resolve()):h};let a=function(c,l,u){const d=r.apply(this,[c]);return u?(d.then(l,u),Promise.resolve()):d};e.setLocalDescription=a,a=function(c,l,u){const d=s.apply(this,[c]);return u?(d.then(l,u),Promise.resolve()):d},e.setRemoteDescription=a,a=function(c,l,u){const d=o.apply(this,[c]);return u?(d.then(l,u),Promise.resolve()):d},e.addIceCandidate=a}function Wa(n){const e=n&&n.navigator;if(e.mediaDevices&&e.mediaDevices.getUserMedia){const t=e.mediaDevices,i=t.getUserMedia.bind(t);e.mediaDevices.getUserMedia=r=>i(Ga(r))}!e.getUserMedia&&e.mediaDevices&&e.mediaDevices.getUserMedia&&(e.getUserMedia=(function(i,r,s){e.mediaDevices.getUserMedia(i).then(r,s)}).bind(e))}function Ga(n){return n&&n.video!==void 0?Object.assign({},n,{video:Sa(n.video)}):n}function Ha(n){if(!n.RTCPeerConnection)return;const e=n.RTCPeerConnection;n.RTCPeerConnection=function(i,r){if(i&&i.iceServers){const s=[];for(let o=0;o<i.iceServers.length;o++){let a=i.iceServers[o];a.urls===void 0&&a.url?(as("RTCIceServer.url","RTCIceServer.urls"),a=JSON.parse(JSON.stringify(a)),a.urls=a.url,delete a.url,s.push(a)):s.push(i.iceServers[o])}i.iceServers=s}return new e(i,r)},n.RTCPeerConnection.prototype=e.prototype,"generateCertificate"in e&&Object.defineProperty(n.RTCPeerConnection,"generateCertificate",{get(){return e.generateCertificate}})}function za(n){typeof n=="object"&&n.RTCTrackEvent&&"receiver"in n.RTCTrackEvent.prototype&&!("transceiver"in n.RTCTrackEvent.prototype)&&Object.defineProperty(n.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function Ka(n){const e=n.RTCPeerConnection.prototype.createOffer;n.RTCPeerConnection.prototype.createOffer=function(i){if(i){typeof i.offerToReceiveAudio<"u"&&(i.offerToReceiveAudio=!!i.offerToReceiveAudio);const r=this.getTransceivers().find(o=>o.receiver.track.kind==="audio");i.offerToReceiveAudio===!1&&r?r.direction==="sendrecv"?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":r.direction==="recvonly"&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):i.offerToReceiveAudio===!0&&!r&&this.addTransceiver("audio",{direction:"recvonly"}),typeof i.offerToReceiveVideo<"u"&&(i.offerToReceiveVideo=!!i.offerToReceiveVideo);const s=this.getTransceivers().find(o=>o.receiver.track.kind==="video");i.offerToReceiveVideo===!1&&s?s.direction==="sendrecv"?s.setDirection?s.setDirection("sendonly"):s.direction="sendonly":s.direction==="recvonly"&&(s.setDirection?s.setDirection("inactive"):s.direction="inactive"):i.offerToReceiveVideo===!0&&!s&&this.addTransceiver("video",{direction:"recvonly"})}return e.apply(this,arguments)}}function $a(n){typeof n!="object"||n.AudioContext||(n.AudioContext=n.webkitAudioContext)}var eo=Object.freeze({__proto__:null,shimAudioContext:$a,shimCallbacksAPI:qa,shimConstraints:Ga,shimCreateOfferLegacy:Ka,shimGetUserMedia:Wa,shimLocalStreamsAPI:Va,shimRTCIceServerUrls:Ha,shimRemoteStreamsAPI:Ja,shimTrackEventTransceiver:za}),Ya={exports:{}};(function(n){const e={};e.generateIdentifier=function(){return Math.random().toString(36).substring(2,12)},e.localCName=e.generateIdentifier(),e.splitLines=function(t){return t.trim().split(`
`).map(i=>i.trim())},e.splitSections=function(t){return t.split(`
m=`).map((r,s)=>(s>0?"m="+r:r).trim()+`\r
`)},e.getDescription=function(t){const i=e.splitSections(t);return i&&i[0]},e.getMediaSections=function(t){const i=e.splitSections(t);return i.shift(),i},e.matchPrefix=function(t,i){return e.splitLines(t).filter(r=>r.indexOf(i)===0)},e.parseCandidate=function(t){let i;t.indexOf("a=candidate:")===0?i=t.substring(12).split(" "):i=t.substring(10).split(" ");const r={foundation:i[0],component:{1:"rtp",2:"rtcp"}[i[1]]||i[1],protocol:i[2].toLowerCase(),priority:parseInt(i[3],10),ip:i[4],address:i[4],port:parseInt(i[5],10),type:i[7]};for(let s=8;s<i.length;s+=2)switch(i[s]){case"raddr":r.relatedAddress=i[s+1];break;case"rport":r.relatedPort=parseInt(i[s+1],10);break;case"tcptype":r.tcpType=i[s+1];break;case"ufrag":r.ufrag=i[s+1],r.usernameFragment=i[s+1];break;default:r[i[s]]===void 0&&(r[i[s]]=i[s+1]);break}return r},e.writeCandidate=function(t){const i=[];i.push(t.foundation);const r=t.component;r==="rtp"?i.push(1):r==="rtcp"?i.push(2):i.push(r),i.push(t.protocol.toUpperCase()),i.push(t.priority),i.push(t.address||t.ip),i.push(t.port);const s=t.type;return i.push("typ"),i.push(s),s!=="host"&&t.relatedAddress&&t.relatedPort&&(i.push("raddr"),i.push(t.relatedAddress),i.push("rport"),i.push(t.relatedPort)),t.tcpType&&t.protocol.toLowerCase()==="tcp"&&(i.push("tcptype"),i.push(t.tcpType)),(t.usernameFragment||t.ufrag)&&(i.push("ufrag"),i.push(t.usernameFragment||t.ufrag)),"candidate:"+i.join(" ")},e.parseIceOptions=function(t){return t.substring(14).split(" ")},e.parseRtpMap=function(t){let i=t.substring(9).split(" ");const r={payloadType:parseInt(i.shift(),10)};return i=i[0].split("/"),r.name=i[0],r.clockRate=parseInt(i[1],10),r.channels=i.length===3?parseInt(i[2],10):1,r.numChannels=r.channels,r},e.writeRtpMap=function(t){let i=t.payloadType;t.preferredPayloadType!==void 0&&(i=t.preferredPayloadType);const r=t.channels||t.numChannels||1;return"a=rtpmap:"+i+" "+t.name+"/"+t.clockRate+(r!==1?"/"+r:"")+`\r
`},e.parseExtmap=function(t){const i=t.substring(9).split(" ");return{id:parseInt(i[0],10),direction:i[0].indexOf("/")>0?i[0].split("/")[1]:"sendrecv",uri:i[1],attributes:i.slice(2).join(" ")}},e.writeExtmap=function(t){return"a=extmap:"+(t.id||t.preferredId)+(t.direction&&t.direction!=="sendrecv"?"/"+t.direction:"")+" "+t.uri+(t.attributes?" "+t.attributes:"")+`\r
`},e.parseFmtp=function(t){const i={};let r;const s=t.substring(t.indexOf(" ")+1).split(";");for(let o=0;o<s.length;o++)r=s[o].trim().split("="),i[r[0].trim()]=r[1];return i},e.writeFmtp=function(t){let i="",r=t.payloadType;if(t.preferredPayloadType!==void 0&&(r=t.preferredPayloadType),t.parameters&&Object.keys(t.parameters).length){const s=[];Object.keys(t.parameters).forEach(o=>{t.parameters[o]!==void 0?s.push(o+"="+t.parameters[o]):s.push(o)}),i+="a=fmtp:"+r+" "+s.join(";")+`\r
`}return i},e.parseRtcpFb=function(t){const i=t.substring(t.indexOf(" ")+1).split(" ");return{type:i.shift(),parameter:i.join(" ")}},e.writeRtcpFb=function(t){let i="",r=t.payloadType;return t.preferredPayloadType!==void 0&&(r=t.preferredPayloadType),t.rtcpFeedback&&t.rtcpFeedback.length&&t.rtcpFeedback.forEach(s=>{i+="a=rtcp-fb:"+r+" "+s.type+(s.parameter&&s.parameter.length?" "+s.parameter:"")+`\r
`}),i},e.parseSsrcMedia=function(t){const i=t.indexOf(" "),r={ssrc:parseInt(t.substring(7,i),10)},s=t.indexOf(":",i);return s>-1?(r.attribute=t.substring(i+1,s),r.value=t.substring(s+1)):r.attribute=t.substring(i+1),r},e.parseSsrcGroup=function(t){const i=t.substring(13).split(" ");return{semantics:i.shift(),ssrcs:i.map(r=>parseInt(r,10))}},e.getMid=function(t){const i=e.matchPrefix(t,"a=mid:")[0];if(i)return i.substring(6)},e.parseFingerprint=function(t){const i=t.substring(14).split(" ");return{algorithm:i[0].toLowerCase(),value:i[1].toUpperCase()}},e.getDtlsParameters=function(t,i){return{role:"auto",fingerprints:e.matchPrefix(t+i,"a=fingerprint:").map(e.parseFingerprint)}},e.writeDtlsParameters=function(t,i){let r="a=setup:"+i+`\r
`;return t.fingerprints.forEach(s=>{r+="a=fingerprint:"+s.algorithm+" "+s.value+`\r
`}),r},e.parseCryptoLine=function(t){const i=t.substring(9).split(" ");return{tag:parseInt(i[0],10),cryptoSuite:i[1],keyParams:i[2],sessionParams:i.slice(3)}},e.writeCryptoLine=function(t){return"a=crypto:"+t.tag+" "+t.cryptoSuite+" "+(typeof t.keyParams=="object"?e.writeCryptoKeyParams(t.keyParams):t.keyParams)+(t.sessionParams?" "+t.sessionParams.join(" "):"")+`\r
`},e.parseCryptoKeyParams=function(t){if(t.indexOf("inline:")!==0)return null;const i=t.substring(7).split("|");return{keyMethod:"inline",keySalt:i[0],lifeTime:i[1],mkiValue:i[2]?i[2].split(":")[0]:void 0,mkiLength:i[2]?i[2].split(":")[1]:void 0}},e.writeCryptoKeyParams=function(t){return t.keyMethod+":"+t.keySalt+(t.lifeTime?"|"+t.lifeTime:"")+(t.mkiValue&&t.mkiLength?"|"+t.mkiValue+":"+t.mkiLength:"")},e.getCryptoParameters=function(t,i){return e.matchPrefix(t+i,"a=crypto:").map(e.parseCryptoLine)},e.getIceParameters=function(t,i){const r=e.matchPrefix(t+i,"a=ice-ufrag:")[0],s=e.matchPrefix(t+i,"a=ice-pwd:")[0];return r&&s?{usernameFragment:r.substring(12),password:s.substring(10)}:null},e.writeIceParameters=function(t){let i="a=ice-ufrag:"+t.usernameFragment+`\r
a=ice-pwd:`+t.password+`\r
`;return t.iceLite&&(i+=`a=ice-lite\r
`),i},e.parseRtpParameters=function(t){const i={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},s=e.splitLines(t)[0].split(" ");i.profile=s[2];for(let a=3;a<s.length;a++){const c=s[a],l=e.matchPrefix(t,"a=rtpmap:"+c+" ")[0];if(l){const u=e.parseRtpMap(l),d=e.matchPrefix(t,"a=fmtp:"+c+" ");switch(u.parameters=d.length?e.parseFmtp(d[0]):{},u.rtcpFeedback=e.matchPrefix(t,"a=rtcp-fb:"+c+" ").map(e.parseRtcpFb),i.codecs.push(u),u.name.toUpperCase()){case"RED":case"ULPFEC":i.fecMechanisms.push(u.name.toUpperCase());break}}}e.matchPrefix(t,"a=extmap:").forEach(a=>{i.headerExtensions.push(e.parseExtmap(a))});const o=e.matchPrefix(t,"a=rtcp-fb:* ").map(e.parseRtcpFb);return i.codecs.forEach(a=>{o.forEach(c=>{a.rtcpFeedback.find(u=>u.type===c.type&&u.parameter===c.parameter)||a.rtcpFeedback.push(c)})}),i},e.writeRtpDescription=function(t,i){let r="";r+="m="+t+" ",r+=i.codecs.length>0?"9":"0",r+=" "+(i.profile||"UDP/TLS/RTP/SAVPF")+" ",r+=i.codecs.map(o=>o.preferredPayloadType!==void 0?o.preferredPayloadType:o.payloadType).join(" ")+`\r
`,r+=`c=IN IP4 0.0.0.0\r
`,r+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,i.codecs.forEach(o=>{r+=e.writeRtpMap(o),r+=e.writeFmtp(o),r+=e.writeRtcpFb(o)});let s=0;return i.codecs.forEach(o=>{o.maxptime>s&&(s=o.maxptime)}),s>0&&(r+="a=maxptime:"+s+`\r
`),i.headerExtensions&&i.headerExtensions.forEach(o=>{r+=e.writeExtmap(o)}),r},e.parseRtpEncodingParameters=function(t){const i=[],r=e.parseRtpParameters(t),s=r.fecMechanisms.indexOf("RED")!==-1,o=r.fecMechanisms.indexOf("ULPFEC")!==-1,a=e.matchPrefix(t,"a=ssrc:").map(h=>e.parseSsrcMedia(h)).filter(h=>h.attribute==="cname"),c=a.length>0&&a[0].ssrc;let l;const u=e.matchPrefix(t,"a=ssrc-group:FID").map(h=>h.substring(17).split(" ").map(g=>parseInt(g,10)));u.length>0&&u[0].length>1&&u[0][0]===c&&(l=u[0][1]),r.codecs.forEach(h=>{if(h.name.toUpperCase()==="RTX"&&h.parameters.apt){let m={ssrc:c,codecPayloadType:parseInt(h.parameters.apt,10)};c&&l&&(m.rtx={ssrc:l}),i.push(m),s&&(m=JSON.parse(JSON.stringify(m)),m.fec={ssrc:c,mechanism:o?"red+ulpfec":"red"},i.push(m))}}),i.length===0&&c&&i.push({ssrc:c});let d=e.matchPrefix(t,"b=");return d.length&&(d[0].indexOf("b=TIAS:")===0?d=parseInt(d[0].substring(7),10):d[0].indexOf("b=AS:")===0?d=parseInt(d[0].substring(5),10)*1e3*.95-50*40*8:d=void 0,i.forEach(h=>{h.maxBitrate=d})),i},e.parseRtcpParameters=function(t){const i={},r=e.matchPrefix(t,"a=ssrc:").map(a=>e.parseSsrcMedia(a)).filter(a=>a.attribute==="cname")[0];r&&(i.cname=r.value,i.ssrc=r.ssrc);const s=e.matchPrefix(t,"a=rtcp-rsize");i.reducedSize=s.length>0,i.compound=s.length===0;const o=e.matchPrefix(t,"a=rtcp-mux");return i.mux=o.length>0,i},e.writeRtcpParameters=function(t){let i="";return t.reducedSize&&(i+=`a=rtcp-rsize\r
`),t.mux&&(i+=`a=rtcp-mux\r
`),t.ssrc!==void 0&&t.cname&&(i+="a=ssrc:"+t.ssrc+" cname:"+t.cname+`\r
`),i},e.parseMsid=function(t){let i;const r=e.matchPrefix(t,"a=msid:");if(r.length===1)return i=r[0].substring(7).split(" "),{stream:i[0],track:i[1]};const s=e.matchPrefix(t,"a=ssrc:").map(o=>e.parseSsrcMedia(o)).filter(o=>o.attribute==="msid");if(s.length>0)return i=s[0].value.split(" "),{stream:i[0],track:i[1]}},e.parseSctpDescription=function(t){const i=e.parseMLine(t),r=e.matchPrefix(t,"a=max-message-size:");let s;r.length>0&&(s=parseInt(r[0].substring(19),10)),isNaN(s)&&(s=65536);const o=e.matchPrefix(t,"a=sctp-port:");if(o.length>0)return{port:parseInt(o[0].substring(12),10),protocol:i.fmt,maxMessageSize:s};const a=e.matchPrefix(t,"a=sctpmap:");if(a.length>0){const c=a[0].substring(10).split(" ");return{port:parseInt(c[0],10),protocol:c[1],maxMessageSize:s}}},e.writeSctpDescription=function(t,i){let r=[];return t.protocol!=="DTLS/SCTP"?r=["m="+t.kind+" 9 "+t.protocol+" "+i.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+i.port+`\r
`]:r=["m="+t.kind+" 9 "+t.protocol+" "+i.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+i.port+" "+i.protocol+` 65535\r
`],i.maxMessageSize!==void 0&&r.push("a=max-message-size:"+i.maxMessageSize+`\r
`),r.join("")},e.generateSessionId=function(){return Math.random().toString().substr(2,22)},e.writeSessionBoilerplate=function(t,i,r){let s;const o=i!==void 0?i:2;return t?s=t:s=e.generateSessionId(),`v=0\r
o=`+(r||"thisisadapterortc")+" "+s+" "+o+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},e.getDirection=function(t,i){const r=e.splitLines(t);for(let s=0;s<r.length;s++)switch(r[s]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[s].substring(2)}return i?e.getDirection(i):"sendrecv"},e.getKind=function(t){return e.splitLines(t)[0].split(" ")[0].substring(2)},e.isRejected=function(t){return t.split(" ",2)[1]==="0"},e.parseMLine=function(t){const r=e.splitLines(t)[0].substring(2).split(" ");return{kind:r[0],port:parseInt(r[1],10),protocol:r[2],fmt:r.slice(3).join(" ")}},e.parseOLine=function(t){const r=e.matchPrefix(t,"o=")[0].substring(2).split(" ");return{username:r[0],sessionId:r[1],sessionVersion:parseInt(r[2],10),netType:r[3],addressType:r[4],address:r[5]}},e.isValidSDP=function(t){if(typeof t!="string"||t.length===0)return!1;const i=e.splitLines(t);for(let r=0;r<i.length;r++)if(i[r].length<2||i[r].charAt(1)!=="=")return!1;return!0},n.exports=e})(Ya);var Qa=Ya.exports,In=xl(Qa),Pu=El({__proto__:null,default:In},[Qa]);function Oi(n){if(!n.RTCIceCandidate||n.RTCIceCandidate&&"foundation"in n.RTCIceCandidate.prototype)return;const e=n.RTCIceCandidate;n.RTCIceCandidate=function(i){if(typeof i=="object"&&i.candidate&&i.candidate.indexOf("a=")===0&&(i=JSON.parse(JSON.stringify(i)),i.candidate=i.candidate.substring(2)),i.candidate&&i.candidate.length){const r=new e(i),s=In.parseCandidate(i.candidate);for(const o in s)o in r||Object.defineProperty(r,o,{value:s[o]});return r.toJSON=function(){return{candidate:r.candidate,sdpMid:r.sdpMid,sdpMLineIndex:r.sdpMLineIndex,usernameFragment:r.usernameFragment}},r}return new e(i)},n.RTCIceCandidate.prototype=e.prototype,Cn(n,"icecandidate",t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new n.RTCIceCandidate(t.candidate),writable:"false"}),t))}function Nr(n){!n.RTCIceCandidate||n.RTCIceCandidate&&"relayProtocol"in n.RTCIceCandidate.prototype||Cn(n,"icecandidate",e=>{if(e.candidate){const t=In.parseCandidate(e.candidate.candidate);t.type==="relay"&&(e.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[t.priority>>24])}return e})}function Ri(n,e){if(!n.RTCPeerConnection)return;"sctp"in n.RTCPeerConnection.prototype||Object.defineProperty(n.RTCPeerConnection.prototype,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp}});const t=function(a){if(!a||!a.sdp)return!1;const c=In.splitSections(a.sdp);return c.shift(),c.some(l=>{const u=In.parseMLine(l);return u&&u.kind==="application"&&u.protocol.indexOf("SCTP")!==-1})},i=function(a){const c=a.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(c===null||c.length<2)return-1;const l=parseInt(c[1],10);return l!==l?-1:l},r=function(a){let c=65536;return e.browser==="firefox"&&(e.version<57?a===-1?c=16384:c=2147483637:e.version<60?c=e.version===57?65535:65536:c=2147483637),c},s=function(a,c){let l=65536;e.browser==="firefox"&&e.version===57&&(l=65535);const u=In.matchPrefix(a.sdp,"a=max-message-size:");return u.length>0?l=parseInt(u[0].substring(19),10):e.browser==="firefox"&&c!==-1&&(l=2147483637),l},o=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,e.browser==="chrome"&&e.version>=76){const{sdpSemantics:c}=this.getConfiguration();c==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp},enumerable:!0,configurable:!0})}if(t(arguments[0])){const c=i(arguments[0]),l=r(c),u=s(arguments[0],c);let d;l===0&&u===0?d=Number.POSITIVE_INFINITY:l===0||u===0?d=Math.max(l,u):d=Math.min(l,u);const h={};Object.defineProperty(h,"maxMessageSize",{get(){return d}}),this._sctp=h}return o.apply(this,arguments)}}function Ii(n){if(!(n.RTCPeerConnection&&"createDataChannel"in n.RTCPeerConnection.prototype))return;function e(i,r){const s=i.send;i.send=function(){const a=arguments[0],c=a.length||a.size||a.byteLength;if(i.readyState==="open"&&r.sctp&&c>r.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+r.sctp.maxMessageSize+" bytes)");return s.apply(i,arguments)}}const t=n.RTCPeerConnection.prototype.createDataChannel;n.RTCPeerConnection.prototype.createDataChannel=function(){const r=t.apply(this,arguments);return e(r,this),r},Cn(n,"datachannel",i=>(e(i.channel,i.target),i))}function Ar(n){if(!n.RTCPeerConnection||"connectionState"in n.RTCPeerConnection.prototype)return;const e=n.RTCPeerConnection.prototype;Object.defineProperty(e,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(e,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(t){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),t&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=t)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(t=>{const i=e[t];e[t]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=r=>{const s=r.target;if(s._lastConnectionState!==s.connectionState){s._lastConnectionState=s.connectionState;const o=new Event("connectionstatechange",r);s.dispatchEvent(o)}return r},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),i.apply(this,arguments)}})}function Dr(n,e){if(!n.RTCPeerConnection||e.browser==="chrome"&&e.version>=71||e.browser==="safari"&&e.version>=605)return;const t=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(r){if(r&&r.sdp&&r.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){const s=r.sdp.split(`
`).filter(o=>o.trim()!=="a=extmap-allow-mixed").join(`
`);n.RTCSessionDescription&&r instanceof n.RTCSessionDescription?arguments[0]=new n.RTCSessionDescription({type:r.type,sdp:s}):r.sdp=s}return t.apply(this,arguments)}}function _i(n,e){if(!(n.RTCPeerConnection&&n.RTCPeerConnection.prototype))return;const t=n.RTCPeerConnection.prototype.addIceCandidate;!t||t.length===0||(n.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(e.browser==="chrome"&&e.version<78||e.browser==="firefox"&&e.version<68||e.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?Promise.resolve():t.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function Mi(n,e){if(!(n.RTCPeerConnection&&n.RTCPeerConnection.prototype))return;const t=n.RTCPeerConnection.prototype.setLocalDescription;!t||t.length===0||(n.RTCPeerConnection.prototype.setLocalDescription=function(){let r=arguments[0]||{};if(typeof r!="object"||r.type&&r.sdp)return t.apply(this,arguments);if(r={type:r.type,sdp:r.sdp},!r.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":r.type="offer";break;default:r.type="answer";break}return r.sdp||r.type!=="offer"&&r.type!=="answer"?t.apply(this,[r]):(r.type==="offer"?this.createOffer:this.createAnswer).apply(this).then(o=>t.apply(this,[o]))})}var xu=Object.freeze({__proto__:null,removeExtmapAllowMixed:Dr,shimAddIceCandidateNullOrEmpty:_i,shimConnectionState:Ar,shimMaxMessageSize:Ri,shimParameterlessSetLocalDescription:Mi,shimRTCIceCandidate:Oi,shimRTCIceCandidateRelayProtocol:Nr,shimSendThrowTypeError:Ii});function Ou(){let{window:n}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0};const t=ka,i=Tu(n),r={browserDetails:i,commonShim:xu,extractVersion:xi,disableLog:Su,disableWarnings:Cu,sdp:Pu};switch(i.browser){case"chrome":if(!Xs||!_r||!e.shimChrome)return t("Chrome shim is not included in this adapter release."),r;if(i.version===null)return t("Chrome shim can not determine version, not shimming."),r;t("adapter.js shimming chrome."),r.browserShim=Xs,_i(n,i),Mi(n),Ca(n,i),Ta(n),_r(n,i),wa(n),Ra(n,i),Ea(n),Pa(n),xa(n),Ia(n,i),Oi(n),Nr(n),Ar(n),Ri(n,i),Ii(n),Dr(n,i);break;case"firefox":if(!Zs||!Mr||!e.shimFirefox)return t("Firefox shim is not included in this adapter release."),r;t("adapter.js shimming firefox."),r.browserShim=Zs,_i(n,i),Mi(n),_a(n,i),Mr(n,i),Ma(n),Da(n),Na(n),Aa(n),La(n),Ua(n),Fa(n),Ba(n),ja(n),Oi(n),Ar(n),Ri(n,i),Ii(n);break;case"safari":if(!eo||!e.shimSafari)return t("Safari shim is not included in this adapter release."),r;t("adapter.js shimming safari."),r.browserShim=eo,_i(n,i),Mi(n),Ha(n),Ka(n),qa(n),Va(n),Ja(n),za(n),Wa(n),$a(n),Oi(n),Nr(n),Ri(n,i),Ii(n),Dr(n,i);break;default:t("Unsupported browser!");break}return r}Ou({window:typeof window>"u"?void 0:window});const Ru=10,Si="lk_e2ee",Iu="LKFrameEncryptionKey",_u={sharedKey:!1,ratchetSalt:Iu,ratchetWindowSize:8,failureTolerance:Ru};var cn;(function(n){n.SetKey="setKey",n.RatchetRequest="ratchetRequest",n.KeyRatcheted="keyRatcheted"})(cn||(cn={}));var to;(function(n){n.KeyRatcheted="keyRatcheted"})(to||(to={}));var on;(function(n){n.ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",n.EncryptionError="encryptionError"})(on||(on={}));var no;(function(n){n.Error="cryptorError"})(no||(no={}));function Mu(){return Nu()||Lr()}function Lr(){return typeof window.RTCRtpScriptTransform<"u"}function Nu(){return typeof window.RTCRtpSender<"u"&&typeof window.RTCRtpSender.prototype.createEncodedStreams<"u"}class Og extends ft.EventEmitter{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};super(),this.onKeyRatcheted=(t,i)=>{U.debug("key ratcheted event received",{material:t,keyIndex:i})},this.keyInfoMap=new Map,this.options=Object.assign(Object.assign({},_u),e),this.on(cn.KeyRatcheted,this.onKeyRatcheted)}onSetEncryptionKey(e,t,i){const r={key:e,participantIdentity:t,keyIndex:i};this.keyInfoMap.set("".concat(t??"shared","-").concat(i??0),r),this.emit(cn.SetKey,r)}getKeys(){return Array.from(this.keyInfoMap.values())}getOptions(){return this.options}ratchetKey(e,t){this.emit(cn.RatchetRequest,e,t)}}class Hn extends Error{constructor(e,t){super(t||"an error has occured"),this.code=e}}class W extends Hn{constructor(e,t,i){super(1,e),this.status=i,this.reason=t}}class cs extends Hn{constructor(e){super(21,e??"device is unsupported")}}class ze extends Hn{constructor(e){super(20,e??"track is invalid")}}class Au extends Hn{constructor(e){super(10,e??"unsupported server")}}class te extends Hn{constructor(e){super(12,e??"unexpected connection state")}}class Ur extends Hn{constructor(e){super(13,e??"unable to negotiate")}}var ci;(function(n){n.PermissionDenied="PermissionDenied",n.NotFound="NotFound",n.DeviceInUse="DeviceInUse",n.Other="Other"})(ci||(ci={}));(function(n){function e(t){if(t&&"name"in t)return t.name==="NotFoundError"||t.name==="DevicesNotFoundError"?n.NotFound:t.name==="NotAllowedError"||t.name==="PermissionDeniedError"?n.PermissionDenied:t.name==="NotReadableError"||t.name==="TrackStartError"?n.DeviceInUse:n.Other}n.getFailure=e})(ci||(ci={}));var T;(function(n){n.Connected="connected",n.Reconnecting="reconnecting",n.Reconnected="reconnected",n.Disconnected="disconnected",n.ConnectionStateChanged="connectionStateChanged",n.StateChanged="connectionStateChanged",n.MediaDevicesChanged="mediaDevicesChanged",n.ParticipantConnected="participantConnected",n.ParticipantDisconnected="participantDisconnected",n.TrackPublished="trackPublished",n.TrackSubscribed="trackSubscribed",n.TrackSubscriptionFailed="trackSubscriptionFailed",n.TrackUnpublished="trackUnpublished",n.TrackUnsubscribed="trackUnsubscribed",n.TrackMuted="trackMuted",n.TrackUnmuted="trackUnmuted",n.LocalTrackPublished="localTrackPublished",n.LocalTrackUnpublished="localTrackUnpublished",n.LocalAudioSilenceDetected="localAudioSilenceDetected",n.ActiveSpeakersChanged="activeSpeakersChanged",n.ParticipantMetadataChanged="participantMetadataChanged",n.ParticipantNameChanged="participantNameChanged",n.RoomMetadataChanged="roomMetadataChanged",n.DataReceived="dataReceived",n.ConnectionQualityChanged="connectionQualityChanged",n.TrackStreamStateChanged="trackStreamStateChanged",n.TrackSubscriptionPermissionChanged="trackSubscriptionPermissionChanged",n.TrackSubscriptionStatusChanged="trackSubscriptionStatusChanged",n.AudioPlaybackStatusChanged="audioPlaybackChanged",n.VideoPlaybackStatusChanged="videoPlaybackChanged",n.MediaDevicesError="mediaDevicesError",n.ParticipantPermissionsChanged="participantPermissionsChanged",n.SignalConnected="signalConnected",n.RecordingStatusChanged="recordingStatusChanged",n.ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",n.EncryptionError="encryptionError",n.DCBufferStatusChanged="dcBufferStatusChanged",n.ActiveDeviceChanged="activeDeviceChanged"})(T||(T={}));var E;(function(n){n.TrackPublished="trackPublished",n.TrackSubscribed="trackSubscribed",n.TrackSubscriptionFailed="trackSubscriptionFailed",n.TrackUnpublished="trackUnpublished",n.TrackUnsubscribed="trackUnsubscribed",n.TrackMuted="trackMuted",n.TrackUnmuted="trackUnmuted",n.LocalTrackPublished="localTrackPublished",n.LocalTrackUnpublished="localTrackUnpublished",n.ParticipantMetadataChanged="participantMetadataChanged",n.ParticipantNameChanged="participantNameChanged",n.DataReceived="dataReceived",n.IsSpeakingChanged="isSpeakingChanged",n.ConnectionQualityChanged="connectionQualityChanged",n.TrackStreamStateChanged="trackStreamStateChanged",n.TrackSubscriptionPermissionChanged="trackSubscriptionPermissionChanged",n.TrackSubscriptionStatusChanged="trackSubscriptionStatusChanged",n.MediaDevicesError="mediaDevicesError",n.AudioStreamAcquired="audioStreamAcquired",n.ParticipantPermissionsChanged="participantPermissionsChanged",n.PCTrackAdded="pcTrackAdded"})(E||(E={}));var M;(function(n){n.TransportsCreated="transportsCreated",n.Connected="connected",n.Disconnected="disconnected",n.Resuming="resuming",n.Resumed="resumed",n.Restarting="restarting",n.Restarted="restarted",n.SignalResumed="signalResumed",n.SignalRestarted="signalRestarted",n.Closing="closing",n.MediaTrackAdded="mediaTrackAdded",n.ActiveSpeakersUpdate="activeSpeakersUpdate",n.DataPacketReceived="dataPacketReceived",n.RTPVideoMapUpdate="rtpVideoMapUpdate",n.DCBufferStatusChanged="dcBufferStatusChanged",n.ParticipantUpdate="participantUpdate",n.RoomUpdate="roomUpdate",n.SpeakersChanged="speakersChanged",n.StreamStateChanged="streamStateChanged",n.ConnectionQualityUpdate="connectionQualityUpdate",n.SubscriptionError="subscriptionError",n.SubscriptionPermissionUpdate="subscriptionPermissionUpdate",n.RemoteMute="remoteMute",n.SubscribedQualityUpdate="subscribedQualityUpdate",n.LocalTrackUnpublished="localTrackUnpublished"})(M||(M={}));var R;(function(n){n.Message="message",n.Muted="muted",n.Unmuted="unmuted",n.Restarted="restarted",n.Ended="ended",n.Subscribed="subscribed",n.Unsubscribed="unsubscribed",n.UpdateSettings="updateSettings",n.UpdateSubscription="updateSubscription",n.AudioPlaybackStarted="audioPlaybackStarted",n.AudioPlaybackFailed="audioPlaybackFailed",n.AudioSilenceDetected="audioSilenceDetected",n.VisibilityChanged="visibilityChanged",n.VideoDimensionsChanged="videoDimensionsChanged",n.VideoPlaybackStarted="videoPlaybackStarted",n.VideoPlaybackFailed="videoPlaybackFailed",n.ElementAttached="elementAttached",n.ElementDetached="elementDetached",n.UpstreamPaused="upstreamPaused",n.UpstreamResumed="upstreamResumed",n.SubscriptionPermissionChanged="subscriptionPermissionChanged",n.SubscriptionStatusChanged="subscriptionStatusChanged",n.SubscriptionFailed="subscriptionFailed"})(R||(R={}));function ls(n,e,t){var i,r,s;e===void 0&&(e=50),t===void 0&&(t={});var o=(i=t.isImmediate)!=null&&i,a=(r=t.callback)!=null&&r,c=t.maxWait,l=Date.now(),u=[];function d(){if(c!==void 0){var m=Date.now()-l;if(m+e>=c)return c-m}return e}var h=function(){var m=[].slice.call(arguments),g=this;return new Promise(function(v,b){var k=o&&s===void 0;if(s!==void 0&&clearTimeout(s),s=setTimeout(function(){if(s=void 0,l=Date.now(),!o){var O=n.apply(g,m);a&&a(O),u.forEach(function(x){return(0,x.resolve)(O)}),u=[]}},d()),k){var S=n.apply(g,m);return a&&a(S),v(S)}u.push({resolve:v,reject:b})})};return h.cancel=function(m){s!==void 0&&clearTimeout(s),u.forEach(function(g){return(0,g.reject)(m)}),u=[]},h}const Du=/version\/(\d+(\.?_?\d+)+)/i;let ar;function Kt(n){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;if(typeof n>"u"&&typeof navigator>"u")return;const t=(n??navigator.userAgent).toLowerCase();if(ar===void 0||e){const i=Lu.find(r=>{let{test:s}=r;return s.test(t)});ar=i==null?void 0:i.describe(t)}return ar}const Lu=[{test:/firefox|iceweasel|fxios/i,describe(n){return{name:"Firefox",version:cr(/(?:firefox|iceweasel|fxios)[\s/](\d+(\.?_?\d+)+)/i,n),os:n.toLowerCase().includes("fxios")?"iOS":void 0}}},{test:/chrom|crios|crmo/i,describe(n){return{name:"Chrome",version:cr(/(?:chrome|chromium|crios|crmo)\/(\d+(\.?_?\d+)+)/i,n),os:n.toLowerCase().includes("crios")?"iOS":void 0}}},{test:/safari|applewebkit/i,describe(n){return{name:"Safari",version:cr(Du,n),os:n.includes("mobile/")?"iOS":"macOS"}}}];function cr(n,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1;const i=e.match(n);return i&&i.length>=t&&i[t]||""}var Uu="1.15.11";const Fu=Uu,Bu=11;class le{}le.setTimeout=function(){return setTimeout(...arguments)};le.setInterval=function(){return setInterval(...arguments)};le.clearTimeout=function(){return clearTimeout(...arguments)};le.clearInterval=function(){return clearInterval(...arguments)};class J{constructor(e,t,i,r,s){this.width=e,this.height=t,this.encoding={maxBitrate:i,maxFramerate:r,priority:s}}get resolution(){return{width:this.width,height:this.height,frameRate:this.encoding.maxFramerate,aspectRatio:this.width/this.height}}}const ju=["vp8","h264"],Xa=["vp8","h264","vp9","av1"];function Vu(n){return!!ju.find(e=>e===n)}var Di;(function(n){n.telephone={maxBitrate:12e3},n.speech={maxBitrate:2e4},n.music={maxBitrate:32e3},n.musicStereo={maxBitrate:48e3},n.musicHighQuality={maxBitrate:64e3},n.musicHighQualityStereo={maxBitrate:96e3}})(Di||(Di={}));const li={h90:new J(160,90,9e4,20),h180:new J(320,180,16e4,20),h216:new J(384,216,18e4,20),h360:new J(640,360,45e4,20),h540:new J(960,540,8e5,25),h720:new J(1280,720,17e5,30),h1080:new J(1920,1080,3e6,30),h1440:new J(2560,1440,5e6,30),h2160:new J(3840,2160,8e6,30)},Fr={h120:new J(160,120,7e4,20),h180:new J(240,180,125e3,20),h240:new J(320,240,14e4,20),h360:new J(480,360,33e4,20),h480:new J(640,480,5e5,20),h540:new J(720,540,6e5,25),h720:new J(960,720,13e5,30),h1080:new J(1440,1080,23e5,30),h1440:new J(1920,1440,38e5,30)},us={h360fps3:new J(640,360,2e5,3,"medium"),h360fps15:new J(640,360,4e5,15,"medium"),h720fps5:new J(1280,720,8e5,5,"medium"),h720fps15:new J(1280,720,15e5,15,"medium"),h720fps30:new J(1280,720,2e6,30,"medium"),h1080fps15:new J(1920,1080,25e5,15,"medium"),h1080fps30:new J(1920,1080,5e6,30,"medium"),original:new J(0,0,7e6,30,"medium")};var fe;(function(n){n[n.PUBLISHER=0]="PUBLISHER",n[n.SUBSCRIBER=1]="SUBSCRIBER"})(fe||(fe={}));p.util.setEnumType(fe,"livekit.SignalTarget",[{no:0,name:"PUBLISHER"},{no:1,name:"SUBSCRIBER"}]);var bn;(function(n){n[n.ACTIVE=0]="ACTIVE",n[n.PAUSED=1]="PAUSED"})(bn||(bn={}));p.util.setEnumType(bn,"livekit.StreamState",[{no:0,name:"ACTIVE"},{no:1,name:"PAUSED"}]);var Li;(function(n){n[n.UDP=0]="UDP",n[n.TCP=1]="TCP",n[n.TLS=2]="TLS"})(Li||(Li={}));p.util.setEnumType(Li,"livekit.CandidateProtocol",[{no:0,name:"UDP"},{no:1,name:"TCP"},{no:2,name:"TLS"}]);class xt extends I{constructor(e){super(),this.message={case:void 0},p.util.initPartial(e,this)}static fromBinary(e,t){return new xt().fromBinary(e,t)}static fromJson(e,t){return new xt().fromJson(e,t)}static fromJsonString(e,t){return new xt().fromJsonString(e,t)}static equals(e,t){return p.util.equals(xt,e,t)}}xt.runtime=p;xt.typeName="livekit.SignalRequest";xt.fields=p.util.newFieldList(()=>[{no:1,name:"offer",kind:"message",T:ye,oneof:"message"},{no:2,name:"answer",kind:"message",T:ye,oneof:"message"},{no:3,name:"trickle",kind:"message",T:Ve,oneof:"message"},{no:4,name:"add_track",kind:"message",T:je,oneof:"message"},{no:5,name:"mute",kind:"message",T:Je,oneof:"message"},{no:6,name:"subscription",kind:"message",T:Ie,oneof:"message"},{no:7,name:"track_setting",kind:"message",T:nt,oneof:"message"},{no:8,name:"leave",kind:"message",T:_e,oneof:"message"},{no:10,name:"update_layers",kind:"message",T:it,oneof:"message"},{no:11,name:"subscription_permission",kind:"message",T:at,oneof:"message"},{no:12,name:"sync_state",kind:"message",T:ct,oneof:"message"},{no:13,name:"simulate",kind:"message",T:ae,oneof:"message"},{no:14,name:"ping",kind:"scalar",T:3,oneof:"message"},{no:15,name:"update_metadata",kind:"message",T:rt,oneof:"message"},{no:16,name:"ping_req",kind:"message",T:ut,oneof:"message"}]);class tt extends I{constructor(e){super(),this.message={case:void 0},p.util.initPartial(e,this)}static fromBinary(e,t){return new tt().fromBinary(e,t)}static fromJson(e,t){return new tt().fromJson(e,t)}static fromJsonString(e,t){return new tt().fromJsonString(e,t)}static equals(e,t){return p.util.equals(tt,e,t)}}tt.runtime=p;tt.typeName="livekit.SignalResponse";tt.fields=p.util.newFieldList(()=>[{no:1,name:"join",kind:"message",T:Ot,oneof:"message"},{no:2,name:"answer",kind:"message",T:ye,oneof:"message"},{no:3,name:"offer",kind:"message",T:ye,oneof:"message"},{no:4,name:"trickle",kind:"message",T:Ve,oneof:"message"},{no:5,name:"update",kind:"message",T:_t,oneof:"message"},{no:6,name:"track_published",kind:"message",T:qe,oneof:"message"},{no:8,name:"leave",kind:"message",T:_e,oneof:"message"},{no:9,name:"mute",kind:"message",T:Je,oneof:"message"},{no:10,name:"speakers_changed",kind:"message",T:Mt,oneof:"message"},{no:11,name:"room_update",kind:"message",T:Nt,oneof:"message"},{no:12,name:"connection_quality",kind:"message",T:Dt,oneof:"message"},{no:13,name:"stream_state_update",kind:"message",T:Ut,oneof:"message"},{no:14,name:"subscribed_quality_update",kind:"message",T:Bt,oneof:"message"},{no:15,name:"subscription_permission_update",kind:"message",T:jt,oneof:"message"},{no:16,name:"refresh_token",kind:"scalar",T:9,oneof:"message"},{no:17,name:"track_unpublished",kind:"message",T:It,oneof:"message"},{no:18,name:"pong",kind:"scalar",T:3,oneof:"message"},{no:19,name:"reconnect",kind:"message",T:Rt,oneof:"message"},{no:20,name:"pong_resp",kind:"message",T:Vt,oneof:"message"},{no:21,name:"subscription_response",kind:"message",T:qt,oneof:"message"}]);class Be extends I{constructor(e){super(),this.codec="",this.cid="",p.util.initPartial(e,this)}static fromBinary(e,t){return new Be().fromBinary(e,t)}static fromJson(e,t){return new Be().fromJson(e,t)}static fromJsonString(e,t){return new Be().fromJsonString(e,t)}static equals(e,t){return p.util.equals(Be,e,t)}}Be.runtime=p;Be.typeName="livekit.SimulcastCodec";Be.fields=p.util.newFieldList(()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"cid",kind:"scalar",T:9}]);class je extends I{constructor(e){super(),this.cid="",this.name="",this.type=he.AUDIO,this.width=0,this.height=0,this.muted=!1,this.disableDtx=!1,this.source=X.UNKNOWN,this.layers=[],this.simulcastCodecs=[],this.sid="",this.stereo=!1,this.disableRed=!1,this.encryption=ce.NONE,this.stream="",p.util.initPartial(e,this)}static fromBinary(e,t){return new je().fromBinary(e,t)}static fromJson(e,t){return new je().fromJson(e,t)}static fromJsonString(e,t){return new je().fromJsonString(e,t)}static equals(e,t){return p.util.equals(je,e,t)}}je.runtime=p;je.typeName="livekit.AddTrackRequest";je.fields=p.util.newFieldList(()=>[{no:1,name:"cid",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"type",kind:"enum",T:p.getEnumType(he)},{no:4,name:"width",kind:"scalar",T:13},{no:5,name:"height",kind:"scalar",T:13},{no:6,name:"muted",kind:"scalar",T:8},{no:7,name:"disable_dtx",kind:"scalar",T:8},{no:8,name:"source",kind:"enum",T:p.getEnumType(X)},{no:9,name:"layers",kind:"message",T:be,repeated:!0},{no:10,name:"simulcast_codecs",kind:"message",T:Be,repeated:!0},{no:11,name:"sid",kind:"scalar",T:9},{no:12,name:"stereo",kind:"scalar",T:8},{no:13,name:"disable_red",kind:"scalar",T:8},{no:14,name:"encryption",kind:"enum",T:p.getEnumType(ce)},{no:15,name:"stream",kind:"scalar",T:9}]);class Ve extends I{constructor(e){super(),this.candidateInit="",this.target=fe.PUBLISHER,p.util.initPartial(e,this)}static fromBinary(e,t){return new Ve().fromBinary(e,t)}static fromJson(e,t){return new Ve().fromJson(e,t)}static fromJsonString(e,t){return new Ve().fromJsonString(e,t)}static equals(e,t){return p.util.equals(Ve,e,t)}}Ve.runtime=p;Ve.typeName="livekit.TrickleRequest";Ve.fields=p.util.newFieldList(()=>[{no:1,name:"candidateInit",kind:"scalar",T:9},{no:2,name:"target",kind:"enum",T:p.getEnumType(fe)}]);class Je extends I{constructor(e){super(),this.sid="",this.muted=!1,p.util.initPartial(e,this)}static fromBinary(e,t){return new Je().fromBinary(e,t)}static fromJson(e,t){return new Je().fromJson(e,t)}static fromJsonString(e,t){return new Je().fromJsonString(e,t)}static equals(e,t){return p.util.equals(Je,e,t)}}Je.runtime=p;Je.typeName="livekit.MuteTrackRequest";Je.fields=p.util.newFieldList(()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"muted",kind:"scalar",T:8}]);class Ot extends I{constructor(e){super(),this.otherParticipants=[],this.serverVersion="",this.iceServers=[],this.subscriberPrimary=!1,this.alternativeUrl="",this.serverRegion="",this.pingTimeout=0,this.pingInterval=0,this.sifTrailer=new Uint8Array(0),p.util.initPartial(e,this)}static fromBinary(e,t){return new Ot().fromBinary(e,t)}static fromJson(e,t){return new Ot().fromJson(e,t)}static fromJsonString(e,t){return new Ot().fromJsonString(e,t)}static equals(e,t){return p.util.equals(Ot,e,t)}}Ot.runtime=p;Ot.typeName="livekit.JoinResponse";Ot.fields=p.util.newFieldList(()=>[{no:1,name:"room",kind:"message",T:Gn},{no:2,name:"participant",kind:"message",T:Pe},{no:3,name:"other_participants",kind:"message",T:Pe,repeated:!0},{no:4,name:"server_version",kind:"scalar",T:9},{no:5,name:"ice_servers",kind:"message",T:st,repeated:!0},{no:6,name:"subscriber_primary",kind:"scalar",T:8},{no:7,name:"alternative_url",kind:"scalar",T:9},{no:8,name:"client_configuration",kind:"message",T:Xe},{no:9,name:"server_region",kind:"scalar",T:9},{no:10,name:"ping_timeout",kind:"scalar",T:5},{no:11,name:"ping_interval",kind:"scalar",T:5},{no:12,name:"server_info",kind:"message",T:wt},{no:13,name:"sif_trailer",kind:"scalar",T:12}]);class Rt extends I{constructor(e){super(),this.iceServers=[],p.util.initPartial(e,this)}static fromBinary(e,t){return new Rt().fromBinary(e,t)}static fromJson(e,t){return new Rt().fromJson(e,t)}static fromJsonString(e,t){return new Rt().fromJsonString(e,t)}static equals(e,t){return p.util.equals(Rt,e,t)}}Rt.runtime=p;Rt.typeName="livekit.ReconnectResponse";Rt.fields=p.util.newFieldList(()=>[{no:1,name:"ice_servers",kind:"message",T:st,repeated:!0},{no:2,name:"client_configuration",kind:"message",T:Xe}]);class qe extends I{constructor(e){super(),this.cid="",p.util.initPartial(e,this)}static fromBinary(e,t){return new qe().fromBinary(e,t)}static fromJson(e,t){return new qe().fromJson(e,t)}static fromJsonString(e,t){return new qe().fromJsonString(e,t)}static equals(e,t){return p.util.equals(qe,e,t)}}qe.runtime=p;qe.typeName="livekit.TrackPublishedResponse";qe.fields=p.util.newFieldList(()=>[{no:1,name:"cid",kind:"scalar",T:9},{no:2,name:"track",kind:"message",T:Se}]);class It extends I{constructor(e){super(),this.trackSid="",p.util.initPartial(e,this)}static fromBinary(e,t){return new It().fromBinary(e,t)}static fromJson(e,t){return new It().fromJson(e,t)}static fromJsonString(e,t){return new It().fromJsonString(e,t)}static equals(e,t){return p.util.equals(It,e,t)}}It.runtime=p;It.typeName="livekit.TrackUnpublishedResponse";It.fields=p.util.newFieldList(()=>[{no:1,name:"track_sid",kind:"scalar",T:9}]);class ye extends I{constructor(e){super(),this.type="",this.sdp="",p.util.initPartial(e,this)}static fromBinary(e,t){return new ye().fromBinary(e,t)}static fromJson(e,t){return new ye().fromJson(e,t)}static fromJsonString(e,t){return new ye().fromJsonString(e,t)}static equals(e,t){return p.util.equals(ye,e,t)}}ye.runtime=p;ye.typeName="livekit.SessionDescription";ye.fields=p.util.newFieldList(()=>[{no:1,name:"type",kind:"scalar",T:9},{no:2,name:"sdp",kind:"scalar",T:9}]);class _t extends I{constructor(e){super(),this.participants=[],p.util.initPartial(e,this)}static fromBinary(e,t){return new _t().fromBinary(e,t)}static fromJson(e,t){return new _t().fromJson(e,t)}static fromJsonString(e,t){return new _t().fromJsonString(e,t)}static equals(e,t){return p.util.equals(_t,e,t)}}_t.runtime=p;_t.typeName="livekit.ParticipantUpdate";_t.fields=p.util.newFieldList(()=>[{no:1,name:"participants",kind:"message",T:Pe,repeated:!0}]);class Ie extends I{constructor(e){super(),this.trackSids=[],this.subscribe=!1,this.participantTracks=[],p.util.initPartial(e,this)}static fromBinary(e,t){return new Ie().fromBinary(e,t)}static fromJson(e,t){return new Ie().fromJson(e,t)}static fromJsonString(e,t){return new Ie().fromJsonString(e,t)}static equals(e,t){return p.util.equals(Ie,e,t)}}Ie.runtime=p;Ie.typeName="livekit.UpdateSubscription";Ie.fields=p.util.newFieldList(()=>[{no:1,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:2,name:"subscribe",kind:"scalar",T:8},{no:3,name:"participant_tracks",kind:"message",T:Qe,repeated:!0}]);class nt extends I{constructor(e){super(),this.trackSids=[],this.disabled=!1,this.quality=ie.LOW,this.width=0,this.height=0,this.fps=0,this.priority=0,p.util.initPartial(e,this)}static fromBinary(e,t){return new nt().fromBinary(e,t)}static fromJson(e,t){return new nt().fromJson(e,t)}static fromJsonString(e,t){return new nt().fromJsonString(e,t)}static equals(e,t){return p.util.equals(nt,e,t)}}nt.runtime=p;nt.typeName="livekit.UpdateTrackSettings";nt.fields=p.util.newFieldList(()=>[{no:1,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:3,name:"disabled",kind:"scalar",T:8},{no:4,name:"quality",kind:"enum",T:p.getEnumType(ie)},{no:5,name:"width",kind:"scalar",T:13},{no:6,name:"height",kind:"scalar",T:13},{no:7,name:"fps",kind:"scalar",T:13},{no:8,name:"priority",kind:"scalar",T:13}]);class _e extends I{constructor(e){super(),this.canReconnect=!1,this.reason=Wt.UNKNOWN_REASON,p.util.initPartial(e,this)}static fromBinary(e,t){return new _e().fromBinary(e,t)}static fromJson(e,t){return new _e().fromJson(e,t)}static fromJsonString(e,t){return new _e().fromJsonString(e,t)}static equals(e,t){return p.util.equals(_e,e,t)}}_e.runtime=p;_e.typeName="livekit.LeaveRequest";_e.fields=p.util.newFieldList(()=>[{no:1,name:"can_reconnect",kind:"scalar",T:8},{no:2,name:"reason",kind:"enum",T:p.getEnumType(Wt)}]);class it extends I{constructor(e){super(),this.trackSid="",this.layers=[],p.util.initPartial(e,this)}static fromBinary(e,t){return new it().fromBinary(e,t)}static fromJson(e,t){return new it().fromJson(e,t)}static fromJsonString(e,t){return new it().fromJsonString(e,t)}static equals(e,t){return p.util.equals(it,e,t)}}it.runtime=p;it.typeName="livekit.UpdateVideoLayers";it.fields=p.util.newFieldList(()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"layers",kind:"message",T:be,repeated:!0}]);class rt extends I{constructor(e){super(),this.metadata="",this.name="",p.util.initPartial(e,this)}static fromBinary(e,t){return new rt().fromBinary(e,t)}static fromJson(e,t){return new rt().fromJson(e,t)}static fromJsonString(e,t){return new rt().fromJsonString(e,t)}static equals(e,t){return p.util.equals(rt,e,t)}}rt.runtime=p;rt.typeName="livekit.UpdateParticipantMetadata";rt.fields=p.util.newFieldList(()=>[{no:1,name:"metadata",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9}]);class st extends I{constructor(e){super(),this.urls=[],this.username="",this.credential="",p.util.initPartial(e,this)}static fromBinary(e,t){return new st().fromBinary(e,t)}static fromJson(e,t){return new st().fromJson(e,t)}static fromJsonString(e,t){return new st().fromJsonString(e,t)}static equals(e,t){return p.util.equals(st,e,t)}}st.runtime=p;st.typeName="livekit.ICEServer";st.fields=p.util.newFieldList(()=>[{no:1,name:"urls",kind:"scalar",T:9,repeated:!0},{no:2,name:"username",kind:"scalar",T:9},{no:3,name:"credential",kind:"scalar",T:9}]);class Mt extends I{constructor(e){super(),this.speakers=[],p.util.initPartial(e,this)}static fromBinary(e,t){return new Mt().fromBinary(e,t)}static fromJson(e,t){return new Mt().fromJson(e,t)}static fromJsonString(e,t){return new Mt().fromJsonString(e,t)}static equals(e,t){return p.util.equals(Mt,e,t)}}Mt.runtime=p;Mt.typeName="livekit.SpeakersChanged";Mt.fields=p.util.newFieldList(()=>[{no:1,name:"speakers",kind:"message",T:$e,repeated:!0}]);class Nt extends I{constructor(e){super(),p.util.initPartial(e,this)}static fromBinary(e,t){return new Nt().fromBinary(e,t)}static fromJson(e,t){return new Nt().fromJson(e,t)}static fromJsonString(e,t){return new Nt().fromJsonString(e,t)}static equals(e,t){return p.util.equals(Nt,e,t)}}Nt.runtime=p;Nt.typeName="livekit.RoomUpdate";Nt.fields=p.util.newFieldList(()=>[{no:1,name:"room",kind:"message",T:Gn}]);class At extends I{constructor(e){super(),this.participantSid="",this.quality=kt.POOR,this.score=0,p.util.initPartial(e,this)}static fromBinary(e,t){return new At().fromBinary(e,t)}static fromJson(e,t){return new At().fromJson(e,t)}static fromJsonString(e,t){return new At().fromJsonString(e,t)}static equals(e,t){return p.util.equals(At,e,t)}}At.runtime=p;At.typeName="livekit.ConnectionQualityInfo";At.fields=p.util.newFieldList(()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"quality",kind:"enum",T:p.getEnumType(kt)},{no:3,name:"score",kind:"scalar",T:2}]);class Dt extends I{constructor(e){super(),this.updates=[],p.util.initPartial(e,this)}static fromBinary(e,t){return new Dt().fromBinary(e,t)}static fromJson(e,t){return new Dt().fromJson(e,t)}static fromJsonString(e,t){return new Dt().fromJsonString(e,t)}static equals(e,t){return p.util.equals(Dt,e,t)}}Dt.runtime=p;Dt.typeName="livekit.ConnectionQualityUpdate";Dt.fields=p.util.newFieldList(()=>[{no:1,name:"updates",kind:"message",T:At,repeated:!0}]);class Lt extends I{constructor(e){super(),this.participantSid="",this.trackSid="",this.state=bn.ACTIVE,p.util.initPartial(e,this)}static fromBinary(e,t){return new Lt().fromBinary(e,t)}static fromJson(e,t){return new Lt().fromJson(e,t)}static fromJsonString(e,t){return new Lt().fromJsonString(e,t)}static equals(e,t){return p.util.equals(Lt,e,t)}}Lt.runtime=p;Lt.typeName="livekit.StreamStateInfo";Lt.fields=p.util.newFieldList(()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sid",kind:"scalar",T:9},{no:3,name:"state",kind:"enum",T:p.getEnumType(bn)}]);class Ut extends I{constructor(e){super(),this.streamStates=[],p.util.initPartial(e,this)}static fromBinary(e,t){return new Ut().fromBinary(e,t)}static fromJson(e,t){return new Ut().fromJson(e,t)}static fromJsonString(e,t){return new Ut().fromJsonString(e,t)}static equals(e,t){return p.util.equals(Ut,e,t)}}Ut.runtime=p;Ut.typeName="livekit.StreamStateUpdate";Ut.fields=p.util.newFieldList(()=>[{no:1,name:"stream_states",kind:"message",T:Lt,repeated:!0}]);class We extends I{constructor(e){super(),this.quality=ie.LOW,this.enabled=!1,p.util.initPartial(e,this)}static fromBinary(e,t){return new We().fromBinary(e,t)}static fromJson(e,t){return new We().fromJson(e,t)}static fromJsonString(e,t){return new We().fromJsonString(e,t)}static equals(e,t){return p.util.equals(We,e,t)}}We.runtime=p;We.typeName="livekit.SubscribedQuality";We.fields=p.util.newFieldList(()=>[{no:1,name:"quality",kind:"enum",T:p.getEnumType(ie)},{no:2,name:"enabled",kind:"scalar",T:8}]);class Ft extends I{constructor(e){super(),this.codec="",this.qualities=[],p.util.initPartial(e,this)}static fromBinary(e,t){return new Ft().fromBinary(e,t)}static fromJson(e,t){return new Ft().fromJson(e,t)}static fromJsonString(e,t){return new Ft().fromJsonString(e,t)}static equals(e,t){return p.util.equals(Ft,e,t)}}Ft.runtime=p;Ft.typeName="livekit.SubscribedCodec";Ft.fields=p.util.newFieldList(()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"qualities",kind:"message",T:We,repeated:!0}]);class Bt extends I{constructor(e){super(),this.trackSid="",this.subscribedQualities=[],this.subscribedCodecs=[],p.util.initPartial(e,this)}static fromBinary(e,t){return new Bt().fromBinary(e,t)}static fromJson(e,t){return new Bt().fromJson(e,t)}static fromJsonString(e,t){return new Bt().fromJsonString(e,t)}static equals(e,t){return p.util.equals(Bt,e,t)}}Bt.runtime=p;Bt.typeName="livekit.SubscribedQualityUpdate";Bt.fields=p.util.newFieldList(()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"subscribed_qualities",kind:"message",T:We,repeated:!0},{no:3,name:"subscribed_codecs",kind:"message",T:Ft,repeated:!0}]);class ot extends I{constructor(e){super(),this.participantSid="",this.allTracks=!1,this.trackSids=[],this.participantIdentity="",p.util.initPartial(e,this)}static fromBinary(e,t){return new ot().fromBinary(e,t)}static fromJson(e,t){return new ot().fromJson(e,t)}static fromJsonString(e,t){return new ot().fromJsonString(e,t)}static equals(e,t){return p.util.equals(ot,e,t)}}ot.runtime=p;ot.typeName="livekit.TrackPermission";ot.fields=p.util.newFieldList(()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"all_tracks",kind:"scalar",T:8},{no:3,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:4,name:"participant_identity",kind:"scalar",T:9}]);class at extends I{constructor(e){super(),this.allParticipants=!1,this.trackPermissions=[],p.util.initPartial(e,this)}static fromBinary(e,t){return new at().fromBinary(e,t)}static fromJson(e,t){return new at().fromJson(e,t)}static fromJsonString(e,t){return new at().fromJsonString(e,t)}static equals(e,t){return p.util.equals(at,e,t)}}at.runtime=p;at.typeName="livekit.SubscriptionPermission";at.fields=p.util.newFieldList(()=>[{no:1,name:"all_participants",kind:"scalar",T:8},{no:2,name:"track_permissions",kind:"message",T:ot,repeated:!0}]);class jt extends I{constructor(e){super(),this.participantSid="",this.trackSid="",this.allowed=!1,p.util.initPartial(e,this)}static fromBinary(e,t){return new jt().fromBinary(e,t)}static fromJson(e,t){return new jt().fromJson(e,t)}static fromJsonString(e,t){return new jt().fromJsonString(e,t)}static equals(e,t){return p.util.equals(jt,e,t)}}jt.runtime=p;jt.typeName="livekit.SubscriptionPermissionUpdate";jt.fields=p.util.newFieldList(()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sid",kind:"scalar",T:9},{no:3,name:"allowed",kind:"scalar",T:8}]);class ct extends I{constructor(e){super(),this.publishTracks=[],this.dataChannels=[],p.util.initPartial(e,this)}static fromBinary(e,t){return new ct().fromBinary(e,t)}static fromJson(e,t){return new ct().fromJson(e,t)}static fromJsonString(e,t){return new ct().fromJsonString(e,t)}static equals(e,t){return p.util.equals(ct,e,t)}}ct.runtime=p;ct.typeName="livekit.SyncState";ct.fields=p.util.newFieldList(()=>[{no:1,name:"answer",kind:"message",T:ye},{no:2,name:"subscription",kind:"message",T:Ie},{no:3,name:"publish_tracks",kind:"message",T:qe,repeated:!0},{no:4,name:"data_channels",kind:"message",T:lt,repeated:!0},{no:5,name:"offer",kind:"message",T:ye}]);class lt extends I{constructor(e){super(),this.label="",this.id=0,this.target=fe.PUBLISHER,p.util.initPartial(e,this)}static fromBinary(e,t){return new lt().fromBinary(e,t)}static fromJson(e,t){return new lt().fromJson(e,t)}static fromJsonString(e,t){return new lt().fromJsonString(e,t)}static equals(e,t){return p.util.equals(lt,e,t)}}lt.runtime=p;lt.typeName="livekit.DataChannelInfo";lt.fields=p.util.newFieldList(()=>[{no:1,name:"label",kind:"scalar",T:9},{no:2,name:"id",kind:"scalar",T:13},{no:3,name:"target",kind:"enum",T:p.getEnumType(fe)}]);class ae extends I{constructor(e){super(),this.scenario={case:void 0},p.util.initPartial(e,this)}static fromBinary(e,t){return new ae().fromBinary(e,t)}static fromJson(e,t){return new ae().fromJson(e,t)}static fromJsonString(e,t){return new ae().fromJsonString(e,t)}static equals(e,t){return p.util.equals(ae,e,t)}}ae.runtime=p;ae.typeName="livekit.SimulateScenario";ae.fields=p.util.newFieldList(()=>[{no:1,name:"speaker_update",kind:"scalar",T:5,oneof:"scenario"},{no:2,name:"node_failure",kind:"scalar",T:8,oneof:"scenario"},{no:3,name:"migration",kind:"scalar",T:8,oneof:"scenario"},{no:4,name:"server_leave",kind:"scalar",T:8,oneof:"scenario"},{no:5,name:"switch_candidate_protocol",kind:"enum",T:p.getEnumType(Li),oneof:"scenario"},{no:6,name:"subscriber_bandwidth",kind:"scalar",T:3,oneof:"scenario"},{no:7,name:"disconnect_signal_on_resume",kind:"scalar",T:8,oneof:"scenario"},{no:8,name:"disconnect_signal_on_resume_no_messages",kind:"scalar",T:8,oneof:"scenario"}]);class ut extends I{constructor(e){super(),this.timestamp=L.zero,this.rtt=L.zero,p.util.initPartial(e,this)}static fromBinary(e,t){return new ut().fromBinary(e,t)}static fromJson(e,t){return new ut().fromJson(e,t)}static fromJsonString(e,t){return new ut().fromJsonString(e,t)}static equals(e,t){return p.util.equals(ut,e,t)}}ut.runtime=p;ut.typeName="livekit.Ping";ut.fields=p.util.newFieldList(()=>[{no:1,name:"timestamp",kind:"scalar",T:3},{no:2,name:"rtt",kind:"scalar",T:3}]);class Vt extends I{constructor(e){super(),this.lastPingTimestamp=L.zero,this.timestamp=L.zero,p.util.initPartial(e,this)}static fromBinary(e,t){return new Vt().fromBinary(e,t)}static fromJson(e,t){return new Vt().fromJson(e,t)}static fromJsonString(e,t){return new Vt().fromJsonString(e,t)}static equals(e,t){return p.util.equals(Vt,e,t)}}Vt.runtime=p;Vt.typeName="livekit.Pong";Vt.fields=p.util.newFieldList(()=>[{no:1,name:"last_ping_timestamp",kind:"scalar",T:3},{no:2,name:"timestamp",kind:"scalar",T:3}]);class an extends I{constructor(e){super(),this.regions=[],p.util.initPartial(e,this)}static fromBinary(e,t){return new an().fromBinary(e,t)}static fromJson(e,t){return new an().fromJson(e,t)}static fromJsonString(e,t){return new an().fromJsonString(e,t)}static equals(e,t){return p.util.equals(an,e,t)}}an.runtime=p;an.typeName="livekit.RegionSettings";an.fields=p.util.newFieldList(()=>[{no:1,name:"regions",kind:"message",T:Jt,repeated:!0}]);class Jt extends I{constructor(e){super(),this.region="",this.url="",this.distance=L.zero,p.util.initPartial(e,this)}static fromBinary(e,t){return new Jt().fromBinary(e,t)}static fromJson(e,t){return new Jt().fromJson(e,t)}static fromJsonString(e,t){return new Jt().fromJsonString(e,t)}static equals(e,t){return p.util.equals(Jt,e,t)}}Jt.runtime=p;Jt.typeName="livekit.RegionInfo";Jt.fields=p.util.newFieldList(()=>[{no:1,name:"region",kind:"scalar",T:9},{no:2,name:"url",kind:"scalar",T:9},{no:3,name:"distance",kind:"scalar",T:3}]);class qt extends I{constructor(e){super(),this.trackSid="",this.err=ai.SE_UNKNOWN,p.util.initPartial(e,this)}static fromBinary(e,t){return new qt().fromBinary(e,t)}static fromJson(e,t){return new qt().fromJson(e,t)}static fromJsonString(e,t){return new qt().fromJsonString(e,t)}static equals(e,t){return p.util.equals(qt,e,t)}}qt.runtime=p;qt.typeName="livekit.SubscriptionResponse";qt.fields=p.util.newFieldList(()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"err",kind:"enum",T:p.getEnumType(ai)}]);function Ju(n){if(!(typeof n>"u"))return typeof structuredClone=="function"?structuredClone(n):JSON.parse(JSON.stringify(n))}const qu=5e3,Qn=[];class C extends ft.EventEmitter{constructor(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};var r;super(),this.attachedElements=[],this.isMuted=!1,this.streamState=C.StreamState.Active,this.isInBackground=!1,this._currentBitrate=0,this.log=U,this.appVisibilityChangedListener=()=>{this.backgroundTimeout&&clearTimeout(this.backgroundTimeout),document.visibilityState==="hidden"?this.backgroundTimeout=setTimeout(()=>this.handleAppVisibilityChanged(),qu):this.handleAppVisibilityChanged()},this.log=zt((r=i.loggerName)!==null&&r!==void 0?r:dt.Track),this.loggerContextCb=i.loggerContextCb,this.setMaxListeners(100),this.kind=t,this._mediaStreamTrack=e,this._mediaStreamID=e.id,this.source=C.Source.Unknown}get logContext(){var e;return Object.assign(Object.assign({},(e=this.loggerContextCb)===null||e===void 0?void 0:e.call(this)),H(this))}get currentBitrate(){return this._currentBitrate}get mediaStreamTrack(){return this._mediaStreamTrack}get mediaStreamID(){return this._mediaStreamID}attach(e){let t="audio";this.kind===C.Kind.Video&&(t="video"),this.attachedElements.length===0&&C.Kind.Video&&this.addAppVisibilityListener(),e||(t==="audio"&&(Qn.forEach(s=>{s.parentElement===null&&!e&&(e=s)}),e&&Qn.splice(Qn.indexOf(e),1)),e||(e=document.createElement(t))),this.attachedElements.includes(e)||this.attachedElements.push(e),On(this.mediaStreamTrack,e);const i=e.srcObject.getTracks(),r=i.some(s=>s.kind==="audio");return e.play().then(()=>{this.emit(r?R.AudioPlaybackStarted:R.VideoPlaybackStarted)}).catch(s=>{s.name==="NotAllowedError"?this.emit(r?R.AudioPlaybackFailed:R.VideoPlaybackFailed,s):s.name==="AbortError"?U.debug("".concat(r?"audio":"video"," playback aborted, likely due to new play request")):U.warn("could not playback ".concat(r?"audio":"video"),s),r&&e&&i.some(o=>o.kind==="video")&&s.name==="NotAllowedError"&&(e.muted=!0,e.play().catch(()=>{}))}),this.emit(R.ElementAttached,e),e}detach(e){try{if(e){_n(this.mediaStreamTrack,e);const i=this.attachedElements.indexOf(e);return i>=0&&(this.attachedElements.splice(i,1),this.recycleElement(e),this.emit(R.ElementDetached,e)),e}const t=[];return this.attachedElements.forEach(i=>{_n(this.mediaStreamTrack,i),t.push(i),this.recycleElement(i),this.emit(R.ElementDetached,i)}),this.attachedElements=[],t}finally{this.attachedElements.length===0&&this.removeAppVisibilityListener()}}stop(){this.stopMonitor(),this._mediaStreamTrack.stop()}enable(){this._mediaStreamTrack.enabled=!0}disable(){this._mediaStreamTrack.enabled=!1}stopMonitor(){this.monitorInterval&&clearInterval(this.monitorInterval)}updateLoggerOptions(e){e.loggerName&&(this.log=zt(e.loggerName)),e.loggerContextCb&&(this.loggerContextCb=e.loggerContextCb)}recycleElement(e){if(e instanceof HTMLAudioElement){let t=!0;e.pause(),Qn.forEach(i=>{i.parentElement||(t=!1)}),t&&Qn.push(e)}}handleAppVisibilityChanged(){return y(this,void 0,void 0,function*(){this.isInBackground=document.visibilityState==="hidden"})}addAppVisibilityListener(){Ce()?(this.isInBackground=document.visibilityState==="hidden",document.addEventListener("visibilitychange",this.appVisibilityChangedListener)):this.isInBackground=!1}removeAppVisibilityListener(){Ce()&&document.removeEventListener("visibilitychange",this.appVisibilityChangedListener)}}function On(n,e){let t;e.srcObject instanceof MediaStream?t=e.srcObject:t=new MediaStream;let i;n.kind==="audio"?i=t.getAudioTracks():i=t.getVideoTracks(),i.includes(n)||(i.forEach(r=>{t.removeTrack(r)}),t.addTrack(n)),(!yn()||!(e instanceof HTMLVideoElement))&&(e.autoplay=!0),e.muted=t.getAudioTracks().length===0,e instanceof HTMLVideoElement&&(e.playsInline=!0),e.srcObject!==t&&(e.srcObject=t,(yn()||Bn())&&e instanceof HTMLVideoElement&&setTimeout(()=>{e.srcObject=t,e.play().catch(()=>{})},0))}function _n(n,e){if(e.srcObject instanceof MediaStream){const t=e.srcObject;t.removeTrack(n),t.getTracks().length>0?e.srcObject=t:e.srcObject=null}}(function(n){let e;(function(l){l.Audio="audio",l.Video="video",l.Unknown="unknown"})(e=n.Kind||(n.Kind={}));let t;(function(l){l.Camera="camera",l.Microphone="microphone",l.ScreenShare="screen_share",l.ScreenShareAudio="screen_share_audio",l.Unknown="unknown"})(t=n.Source||(n.Source={}));let i;(function(l){l.Active="active",l.Paused="paused",l.Unknown="unknown"})(i=n.StreamState||(n.StreamState={}));function r(l){switch(l){case e.Audio:return he.AUDIO;case e.Video:return he.VIDEO;default:return he.DATA}}n.kindToProto=r;function s(l){switch(l){case he.AUDIO:return e.Audio;case he.VIDEO:return e.Video;default:return e.Unknown}}n.kindFromProto=s;function o(l){switch(l){case t.Camera:return X.CAMERA;case t.Microphone:return X.MICROPHONE;case t.ScreenShare:return X.SCREEN_SHARE;case t.ScreenShareAudio:return X.SCREEN_SHARE_AUDIO;default:return X.UNKNOWN}}n.sourceToProto=o;function a(l){switch(l){case X.CAMERA:return t.Camera;case X.MICROPHONE:return t.Microphone;case X.SCREEN_SHARE:return t.ScreenShare;case X.SCREEN_SHARE_AUDIO:return t.ScreenShareAudio;default:return t.Unknown}}n.sourceFromProto=a;function c(l){switch(l){case bn.ACTIVE:return i.Active;case bn.PAUSED:return i.Paused;default:return i.Unknown}}n.streamStateFromProto=c})(C||(C={}));function Za(n,e,t){var i;const r=(i=Ju(n))!==null&&i!==void 0?i:{};return r.audio===!0&&(r.audio={}),r.video===!0&&(r.video={}),r.audio&&Br(r.audio,e),r.video&&Br(r.video,t),r}function Br(n,e){return Object.keys(e).forEach(t=>{n[t]===void 0&&(n[t]=e[t])}),n}function $i(n){const e={};if(n.video)if(typeof n.video=="object"){const t={},i=t,r=n.video;Object.keys(r).forEach(s=>{switch(s){case"resolution":Br(i,r.resolution);break;default:i[s]=r[s]}}),e.video=t}else e.video=n.video;else e.video=!1;return n.audio?typeof n.audio=="object"?e.audio=n.audio:e.audio=!0:e.audio=!1,e}function Wu(n){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:200;return y(this,void 0,void 0,function*(){const t=ec();if(t){const i=t.createAnalyser();i.fftSize=2048;const r=i.frequencyBinCount,s=new Uint8Array(r);t.createMediaStreamSource(new MediaStream([n.mediaStreamTrack])).connect(i),yield Gt(e),i.getByteTimeDomainData(s);const a=s.some(c=>c!==128&&c!==0);return t.close(),!a}return!1})}function ec(){const n=typeof window<"u"&&(window.AudioContext||window.webkitAudioContext);if(n)return new n({latencyHint:"interactive"})}function Gu(n){return n===C.Source.Microphone?"audioinput":n===C.Source.Camera?"videoinput":void 0}function Hu(n){var e,t;let i=(e=n.video)!==null&&e!==void 0?e:!0;return n.resolution&&n.resolution.width>0&&n.resolution.height>0&&(i=typeof i=="boolean"?{}:i,yn()?i=Object.assign(Object.assign({},i),{width:{max:n.resolution.width},height:{max:n.resolution.height},frameRate:n.resolution.frameRate}):i=Object.assign(Object.assign({},i),{width:{ideal:n.resolution.width},height:{ideal:n.resolution.height},frameRate:n.resolution.frameRate})),{audio:(t=n.audio)!==null&&t!==void 0?t:!1,video:i,controller:n.controller,selfBrowserSurface:n.selfBrowserSurface,surfaceSwitching:n.surfaceSwitching,systemAudio:n.systemAudio}}function tc(n){const e=n.split("/")[1].toLowerCase();if(!Xa.includes(e))throw Error("Video codec not supported: ".concat(e));return e}function zu(n){const e=[];return n.forEach(t=>{t.track!==void 0&&e.push(new qe({cid:t.track.mediaStreamID,track:t.trackInfo}))}),e}function H(n){return n instanceof C?{trackSid:n.sid,trackSource:n.source,trackMuted:n.isMuted,trackEnabled:n.mediaStreamTrack.enabled,trackKind:n.kind}:{trackSid:n.trackSid,trackName:n.trackName,track:n.track?H(n.track):void 0,trackEnabled:n.isEnabled,trackEncrypted:n.isEncrypted,trackMimeType:n.mimeType}}const Ku="|",io="https://aomediacodec.github.io/av1-rtp-spec/#dependency-descriptor-rtp-header-extension";function $u(n){const e=n.split(Ku);return e.length>1?[e[0],n.substr(e[0].length+1)]:[n,""]}function Gt(n){return y(this,void 0,void 0,function*(){return new Promise(e=>le.setTimeout(e,n))})}function ro(){return"addTransceiver"in RTCPeerConnection.prototype}function so(){return"addTrack"in RTCPeerConnection.prototype}function Yu(){if(!("getCapabilities"in RTCRtpSender)||yn())return!1;const n=RTCRtpSender.getCapabilities("video");let e=!1;if(n){for(const t of n.codecs)if(t.mimeType==="video/AV1"){e=!0;break}}return e}function Qu(){if(!("getCapabilities"in RTCRtpSender)||Bn())return!1;if(yn()){const t=Kt();if(t!=null&&t.version&&ds(t.version,"16")<0)return!1}const n=RTCRtpSender.getCapabilities("video");let e=!1;if(n){for(const t of n.codecs)if(t.mimeType==="video/VP9"){e=!0;break}}return e}function ri(n){return n==="av1"||n==="vp9"}function jr(n){return document?(n||(n=document.createElement("audio")),"setSinkId"in n):!1}const Xu={Chrome:"100",Safari:"15",Firefox:"100"};function Zu(n){if(!Ce()||!("setCodecPreferences"in n))return!1;const e=Kt();if(!(e!=null&&e.name)||!e.version)return!1;const t=Xu[e.name];return t?ds(e.version,t)>=0:!1}function Bn(){var n;return((n=Kt())===null||n===void 0?void 0:n.name)==="Firefox"}function ed(){var n;return((n=Kt())===null||n===void 0?void 0:n.name)==="Chrome"}function yn(){var n;return((n=Kt())===null||n===void 0?void 0:n.name)==="Safari"}function td(){const n=Kt();return(n==null?void 0:n.name)==="Safari"&&n.version.startsWith("17.")}function nc(){return Ce()?/Tablet|iPad|Mobile|Android|BlackBerry/.test(navigator.userAgent):!1}function Ce(){return typeof document<"u"}function kn(){return navigator.product=="ReactNative"}function Vr(n){return n.hostname.endsWith(".livekit.cloud")||n.hostname.endsWith(".livekit.run")}function ic(){if(global&&global.LiveKitReactNativeGlobal)return global.LiveKitReactNativeGlobal}function rc(){if(!kn())return;let n=ic();if(n)return n.platform}function oo(){if(Ce())return window.devicePixelRatio;if(kn()){let n=ic();if(n)return n.devicePixelRatio}return 1}function ds(n,e){const t=n.split("."),i=e.split("."),r=Math.min(t.length,i.length);for(let s=0;s<r;++s){const o=parseInt(t[s],10),a=parseInt(i[s],10);if(o>a)return 1;if(o<a)return-1;if(s===r-1&&o===a)return 0}return n===""&&e!==""?-1:e===""?1:t.length==i.length?0:t.length<i.length?-1:1}function nd(n){for(const e of n)e.target.handleResize(e)}function id(n){for(const e of n)e.target.handleVisibilityChanged(e)}let lr=null;const ao=()=>(lr||(lr=new ResizeObserver(nd)),lr);let ur=null;const co=()=>(ur||(ur=new IntersectionObserver(id,{root:null,rootMargin:"0px"})),ur);function rd(){var n;const e=new Et({sdk:Fn.JS,protocol:Bu,version:Fu});return kn()&&(e.os=(n=rc())!==null&&n!==void 0?n:""),e}function lo(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:16,e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:16,t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;const r=document.createElement("canvas");r.width=n,r.height=e;const s=r.getContext("2d");s==null||s.fillRect(0,0,r.width,r.height),i&&s&&(s.beginPath(),s.arc(n/2,e/2,50,0,Math.PI*2,!0),s.closePath(),s.fillStyle="grey",s.fill());const o=r.captureStream(),[a]=o.getTracks();if(!a)throw Error("Could not get empty media stream video track");return a.enabled=t,a}let Xn;function dr(){if(!Xn){const n=new AudioContext,e=n.createOscillator(),t=n.createGain();t.gain.setValueAtTime(0,0);const i=n.createMediaStreamDestination();if(e.connect(t),t.connect(i),e.start(),[Xn]=i.stream.getAudioTracks(),!Xn)throw Error("Could not get empty media stream audio track");Xn.enabled=!1}return Xn.clone()}class sc{constructor(e,t){this.onFinally=t,this.promise=new Promise((i,r)=>y(this,void 0,void 0,function*(){this.resolve=i,this.reject=r,e&&(yield e(i,r))})).finally(()=>{var i;return(i=this.onFinally)===null||i===void 0?void 0:i.call(this)})}}class Ge{constructor(){this._locking=Promise.resolve(),this._locks=0}isLocked(){return this._locks>0}lock(){this._locks+=1;let e;const t=new Promise(r=>e=()=>{this._locks-=1,r()}),i=this._locking.then(()=>e);return this._locking=this._locking.then(()=>t),i}}function sd(n){return Xa.includes(n)}function mn(n){if(typeof n=="string")return n;if(Array.isArray(n))return n[0];if(n.exact)return Array.isArray(n.exact)?n.exact[0]:n.exact;if(n.ideal)return Array.isArray(n.ideal)?n.ideal[0]:n.ideal;throw Error("could not unwrap constraint")}function od(n){return n.startsWith("http")?n.replace(/^(http)/,"ws"):n}function uo(n){return n.startsWith("ws")?n.replace(/^(ws)/,"http"):n}const ho="default";class ve{static getInstance(){return this.instance===void 0&&(this.instance=new ve),this.instance}getDevices(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;var i;return y(this,void 0,void 0,function*(){if(((i=ve.userMediaPromiseMap)===null||i===void 0?void 0:i.size)>0){U.debug("awaiting getUserMedia promise");try{e?yield ve.userMediaPromiseMap.get(e):yield Promise.all(ve.userMediaPromiseMap.values())}catch{U.warn("error waiting for media permissons")}}let r=yield navigator.mediaDevices.enumerateDevices();if(t&&!(yn()&&this.hasDeviceInUse(e))&&(r.length===0||r.some(o=>{const a=o.label==="",c=e?o.kind===e:!0;return a&&c}))){const o={video:e!=="audioinput"&&e!=="audiooutput",audio:e!=="videoinput"},a=yield navigator.mediaDevices.getUserMedia(o);r=yield navigator.mediaDevices.enumerateDevices(),a.getTracks().forEach(c=>{c.stop()})}return e&&(r=r.filter(s=>s.kind===e)),r})}normalizeDeviceId(e,t,i){return y(this,void 0,void 0,function*(){if(t!==ho)return t;const s=(yield this.getDevices(e)).find(o=>o.groupId===i&&o.deviceId!==ho);return s==null?void 0:s.deviceId})}hasDeviceInUse(e){return e?ve.userMediaPromiseMap.has(e):ve.userMediaPromiseMap.size>0}}ve.mediaDeviceKinds=["audioinput","audiooutput","videoinput"];ve.userMediaPromiseMap=new Map;const ad=1e3;class jn extends C{get constraints(){return this._constraints}constructor(e,t,i){let r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1,s=arguments.length>4?arguments[4]:void 0;super(e,t,s),this._isUpstreamPaused=!1,this.handleTrackMuteEvent=()=>this.debouncedTrackMuteHandler().catch(()=>this.log.debug("track mute bounce got cancelled by an unmute event",this.logContext)),this.debouncedTrackMuteHandler=ls(()=>y(this,void 0,void 0,function*(){yield this.pauseUpstream()}),5e3),this.handleTrackUnmuteEvent=()=>y(this,void 0,void 0,function*(){this.debouncedTrackMuteHandler.cancel("unmute"),yield this.resumeUpstream()}),this.handleEnded=()=>{this.isInBackground&&(this.reacquireTrack=!0),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent),this.emit(R.Ended,this)},this.reacquireTrack=!1,this.providedByUser=r,this.muteLock=new Ge,this.pauseUpstreamLock=new Ge,this.processorLock=new Ge,this.setMediaStreamTrack(e,!0),this._constraints=e.getConstraints(),i&&(this._constraints=i)}get id(){return this._mediaStreamTrack.id}get dimensions(){if(this.kind!==C.Kind.Video)return;const{width:e,height:t}=this._mediaStreamTrack.getSettings();if(e&&t)return{width:e,height:t}}get isUpstreamPaused(){return this._isUpstreamPaused}get isUserProvided(){return this.providedByUser}get mediaStreamTrack(){var e,t;return(t=(e=this.processor)===null||e===void 0?void 0:e.processedTrack)!==null&&t!==void 0?t:this._mediaStreamTrack}setMediaStreamTrack(e,t){return y(this,void 0,void 0,function*(){if(e===this._mediaStreamTrack&&!t)return;this._mediaStreamTrack&&(this.attachedElements.forEach(r=>{_n(this._mediaStreamTrack,r)}),this.debouncedTrackMuteHandler.cancel("new-track"),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent)),this.mediaStream=new MediaStream([e]),e&&(e.addEventListener("ended",this.handleEnded),e.addEventListener("mute",this.handleTrackMuteEvent),e.addEventListener("unmute",this.handleTrackUnmuteEvent),this._constraints=e.getConstraints());let i;if(this.processor&&e&&this.processorElement){if(this.log.debug("restarting processor",this.logContext),this.kind==="unknown")throw TypeError("cannot set processor on track of unknown kind");On(e,this.processorElement),this.processorElement.muted=!0,yield this.processor.restart({track:e,kind:this.kind,element:this.processorElement}),i=this.processor.processedTrack}this.sender&&(yield this.sender.replaceTrack(i??e)),!this.providedByUser&&this._mediaStreamTrack!==e&&this._mediaStreamTrack.stop(),this._mediaStreamTrack=e,e&&(this._mediaStreamTrack.enabled=!this.isMuted,yield this.resumeUpstream(),this.attachedElements.forEach(r=>{On(i??e,r)}))})}waitForDimensions(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:ad;var t;return y(this,void 0,void 0,function*(){if(this.kind===C.Kind.Audio)throw new Error("cannot get dimensions for audio tracks");((t=Kt())===null||t===void 0?void 0:t.os)==="iOS"&&(yield Gt(10));const i=Date.now();for(;Date.now()-i<e;){const r=this.dimensions;if(r)return r;yield Gt(50)}throw new ze("unable to get track dimensions after timeout")})}getDeviceId(){return y(this,void 0,void 0,function*(){if(this.source===C.Source.ScreenShare)return;const{deviceId:e,groupId:t}=this._mediaStreamTrack.getSettings(),i=this.kind===C.Kind.Audio?"audioinput":"videoinput";return ve.getInstance().normalizeDeviceId(i,e,t)})}mute(){return y(this,void 0,void 0,function*(){return this.setTrackMuted(!0),this})}unmute(){return y(this,void 0,void 0,function*(){return this.setTrackMuted(!1),this})}replaceTrack(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return y(this,void 0,void 0,function*(){if(!this.sender)throw new ze("unable to replace an unpublished track");return this.log.debug("replace MediaStreamTrack",this.logContext),yield this.setMediaStreamTrack(e),this.providedByUser=t,this.processor&&(yield this.stopProcessor()),this})}restart(e){return y(this,void 0,void 0,function*(){e||(e=this._constraints),this.log.debug("restarting track with constraints",Object.assign(Object.assign({},this.logContext),{constraints:e}));const t={audio:!1,video:!1};this.kind===C.Kind.Video?t.video=e:t.audio=e,this.attachedElements.forEach(s=>{_n(this.mediaStreamTrack,s)}),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.stop();const r=(yield navigator.mediaDevices.getUserMedia(t)).getTracks()[0];return r.addEventListener("ended",this.handleEnded),this.log.debug("re-acquired MediaStreamTrack",this.logContext),yield this.setMediaStreamTrack(r),this._constraints=e,this.emit(R.Restarted,this),this})}setTrackMuted(e){this.log.debug("setting ".concat(this.kind," track ").concat(e?"muted":"unmuted"),this.logContext),!(this.isMuted===e&&this._mediaStreamTrack.enabled!==e)&&(this.isMuted=e,this._mediaStreamTrack.enabled=!e,this.emit(e?R.Muted:R.Unmuted,this))}get needsReAcquisition(){return this._mediaStreamTrack.readyState!=="live"||this._mediaStreamTrack.muted||!this._mediaStreamTrack.enabled||this.reacquireTrack}handleAppVisibilityChanged(){const e=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return y(this,void 0,void 0,function*(){yield e.handleAppVisibilityChanged.call(this),nc()&&(this.log.debug("visibility changed, is in Background: ".concat(this.isInBackground),this.logContext),!this.isInBackground&&this.needsReAcquisition&&!this.isUserProvided&&!this.isMuted&&(this.log.debug("track needs to be reacquired, restarting ".concat(this.source),this.logContext),yield this.restart(),this.reacquireTrack=!1))})}stop(){var e;super.stop(),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent),(e=this.processor)===null||e===void 0||e.destroy(),this.processor=void 0}pauseUpstream(){return y(this,void 0,void 0,function*(){const e=yield this.pauseUpstreamLock.lock();try{if(this._isUpstreamPaused===!0)return;if(!this.sender){this.log.warn("unable to pause upstream for an unpublished track",this.logContext);return}this._isUpstreamPaused=!0,this.emit(R.UpstreamPaused,this);const t=Kt();if((t==null?void 0:t.name)==="Safari"&&ds(t.version,"12.0")<0)throw new cs("pauseUpstream is not supported on Safari < 12.");yield this.sender.replaceTrack(null)}finally{e()}})}resumeUpstream(){return y(this,void 0,void 0,function*(){const e=yield this.pauseUpstreamLock.lock();try{if(this._isUpstreamPaused===!1)return;if(!this.sender){this.log.warn("unable to resume upstream for an unpublished track",this.logContext);return}this._isUpstreamPaused=!1,this.emit(R.UpstreamResumed,this),yield this.sender.replaceTrack(this._mediaStreamTrack)}finally{e()}})}getRTCStatsReport(){var e;return y(this,void 0,void 0,function*(){return!((e=this.sender)===null||e===void 0)&&e.getStats?yield this.sender.getStats():void 0})}setProcessor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;var i,r;return y(this,void 0,void 0,function*(){const s=yield this.processorLock.lock();try{if(this.log.debug("setting up processor",this.logContext),this.processor&&(yield this.stopProcessor()),this.kind==="unknown")throw TypeError("cannot set processor on track of unknown kind");this.processorElement=(i=this.processorElement)!==null&&i!==void 0?i:document.createElement(this.kind),On(this._mediaStreamTrack,this.processorElement),this.processorElement.muted=!0,this.processorElement.play().catch(a=>this.log.error("failed to play processor element",Object.assign(Object.assign({},this.logContext),{error:a})));const o={kind:this.kind,track:this._mediaStreamTrack,element:this.processorElement};if(yield e.init(o),this.processor=e,this.processor.processedTrack){for(const a of this.attachedElements)a!==this.processorElement&&t&&(_n(this._mediaStreamTrack,a),On(this.processor.processedTrack,a));yield(r=this.sender)===null||r===void 0?void 0:r.replaceTrack(this.processor.processedTrack)}}finally{s()}})}getProcessor(){return this.processor}stopProcessor(){var e,t;return y(this,void 0,void 0,function*(){this.processor&&(this.log.debug("stopping processor",this.logContext),(e=this.processor.processedTrack)===null||e===void 0||e.stop(),yield this.processor.destroy(),this.processor=void 0,(t=this.processorElement)===null||t===void 0||t.remove(),this.processorElement=void 0,yield this.restart())})}}class cd extends ft.EventEmitter{constructor(e){super(),this.onWorkerMessage=t=>{var i,r;const{kind:s,data:o}=t.data;switch(s){case"error":U.error(o.error.message),this.emit(on.EncryptionError,o.error);break;case"initAck":o.enabled&&this.keyProvider.getKeys().forEach(a=>{this.postKey(a)});break;case"enable":if(this.encryptionEnabled!==o.enabled&&o.participantIdentity===((i=this.room)===null||i===void 0?void 0:i.localParticipant.identity))this.emit(on.ParticipantEncryptionStatusChanged,o.enabled,this.room.localParticipant),this.encryptionEnabled=o.enabled;else if(o.participantIdentity){const a=(r=this.room)===null||r===void 0?void 0:r.getParticipantByIdentity(o.participantIdentity);if(!a)throw TypeError("couldn't set encryption status, participant not found".concat(o.participantIdentity));this.emit(on.ParticipantEncryptionStatusChanged,o.enabled,a)}this.encryptionEnabled&&this.keyProvider.getKeys().forEach(a=>{this.postKey(a)});break;case"ratchetKey":this.keyProvider.emit(cn.KeyRatcheted,o.material,o.keyIndex);break}},this.onWorkerError=t=>{U.error("e2ee worker encountered an error:",{error:t.error}),this.emit(on.EncryptionError,t.error)},this.keyProvider=e.keyProvider,this.worker=e.worker,this.encryptionEnabled=!1}setup(e){if(!Mu())throw new cs("tried to setup end-to-end encryption on an unsupported browser");if(U.info("setting up e2ee"),e!==this.room){this.room=e,this.setupEventListeners(e,this.keyProvider);const t={kind:"init",data:{keyProviderOptions:this.keyProvider.getOptions()}};this.worker&&(U.info("initializing worker",{worker:this.worker}),this.worker.onmessage=this.onWorkerMessage,this.worker.onerror=this.onWorkerError,this.worker.postMessage(t))}}setParticipantCryptorEnabled(e,t){U.debug("set e2ee to ".concat(e," for participant ").concat(t)),this.postEnable(e,t)}setSifTrailer(e){!e||e.length===0?U.warn("ignoring server sent trailer as it's empty"):this.postSifTrailer(e)}setupEngine(e){e.on(M.RTPVideoMapUpdate,t=>{this.postRTPMap(t)})}setupEventListeners(e,t){e.on(T.TrackPublished,(i,r)=>this.setParticipantCryptorEnabled(i.trackInfo.encryption!==ce.NONE,r.identity)),e.on(T.ConnectionStateChanged,i=>{i===B.Connected&&e.participants.forEach(r=>{r.tracks.forEach(s=>{this.setParticipantCryptorEnabled(s.trackInfo.encryption!==ce.NONE,r.identity)})})}).on(T.TrackUnsubscribed,(i,r,s)=>{var o;const a={kind:"removeTransform",data:{participantIdentity:s.identity,trackId:i.mediaStreamID}};(o=this.worker)===null||o===void 0||o.postMessage(a)}).on(T.TrackSubscribed,(i,r,s)=>{this.setupE2EEReceiver(i,s.identity,r.trackInfo)}).on(T.SignalConnected,()=>{if(!this.room)throw new TypeError("expected room to be present on signal connect");this.setParticipantCryptorEnabled(this.room.localParticipant.isE2EEEnabled,this.room.localParticipant.identity),t.getKeys().forEach(i=>{this.postKey(i)})}),e.localParticipant.on(E.LocalTrackPublished,i=>y(this,void 0,void 0,function*(){this.setupE2EESender(i.track,i.track.sender)})),t.on(cn.SetKey,i=>this.postKey(i)).on(cn.RatchetRequest,(i,r)=>this.postRatchetRequest(i,r))}postRatchetRequest(e,t){if(!this.worker)throw Error("could not ratchet key, worker is missing");const i={kind:"ratchetRequest",data:{participantIdentity:e,keyIndex:t}};this.worker.postMessage(i)}postKey(e){let{key:t,participantIdentity:i,keyIndex:r}=e;var s;if(!this.worker)throw Error("could not set key, worker is missing");const o={kind:"setKey",data:{participantIdentity:i,isPublisher:i===((s=this.room)===null||s===void 0?void 0:s.localParticipant.identity),key:t,keyIndex:r}};this.worker.postMessage(o)}postEnable(e,t){if(this.worker){const i={kind:"enable",data:{enabled:e,participantIdentity:t}};this.worker.postMessage(i)}else throw new ReferenceError("failed to enable e2ee, worker is not ready")}postRTPMap(e){var t;if(!this.worker)throw TypeError("could not post rtp map, worker is missing");if(!(!((t=this.room)===null||t===void 0)&&t.localParticipant.identity))throw TypeError("could not post rtp map, local participant identity is missing");const i={kind:"setRTPMap",data:{map:e,participantIdentity:this.room.localParticipant.identity}};this.worker.postMessage(i)}postSifTrailer(e){if(!this.worker)throw Error("could not post SIF trailer, worker is missing");const t={kind:"setSifTrailer",data:{trailer:e}};this.worker.postMessage(t)}setupE2EEReceiver(e,t,i){if(e.receiver){if(!(i!=null&&i.mimeType)||i.mimeType==="")throw new TypeError("MimeType missing from trackInfo, cannot set up E2EE cryptor");this.handleReceiver(e.receiver,e.mediaStreamID,t,e.kind==="video"?tc(i.mimeType):void 0)}}setupE2EESender(e,t){if(!(e instanceof jn)||!t){t||U.warn("early return because sender is not ready");return}this.handleSender(t,e.mediaStreamID,void 0)}handleReceiver(e,t,i,r){return y(this,void 0,void 0,function*(){if(this.worker){if(Lr()){const s={kind:"decode",participantIdentity:i,trackId:t,codec:r};e.transform=new RTCRtpScriptTransform(this.worker,s)}else{if(Si in e&&r){const c={kind:"updateCodec",data:{trackId:t,codec:r,participantIdentity:i}};this.worker.postMessage(c);return}let s=e.writableStream,o=e.readableStream;if(!s||!o){const c=e.createEncodedStreams();e.writableStream=c.writable,s=c.writable,e.readableStream=c.readable,o=c.readable}const a={kind:"decode",data:{readableStream:o,writableStream:s,trackId:t,codec:r,participantIdentity:i}};this.worker.postMessage(a,[o,s])}e[Si]=!0}})}handleSender(e,t,i){var r;if(!(Si in e||!this.worker)){if(!(!((r=this.room)===null||r===void 0)&&r.localParticipant.identity)||this.room.localParticipant.identity==="")throw TypeError("local identity needs to be known in order to set up encrypted sender");if(Lr()){U.info("initialize script transform");const s={kind:"encode",participantIdentity:this.room.localParticipant.identity,trackId:t,codec:i};e.transform=new RTCRtpScriptTransform(this.worker,s)}else{U.info("initialize encoded streams");const s=e.createEncodedStreams(),o={kind:"encode",data:{readableStream:s.readable,writableStream:s.writable,codec:i,trackId:t,participantIdentity:this.room.localParticipant.identity}};this.worker.postMessage(o,[s.readable,s.writable])}e[Si]=!0}}}var si;(function(n){n[n.WAITING=0]="WAITING",n[n.RUNNING=1]="RUNNING",n[n.COMPLETED=2]="COMPLETED"})(si||(si={}));class ld{constructor(){this.pendingTasks=new Map,this.taskMutex=new Ge,this.nextTaskIndex=0}run(e){return y(this,void 0,void 0,function*(){const t={id:this.nextTaskIndex++,enqueuedAt:Date.now(),status:si.WAITING};this.pendingTasks.set(t.id,t);const i=yield this.taskMutex.lock();try{return t.executedAt=Date.now(),t.status=si.RUNNING,yield e()}finally{t.status=si.COMPLETED,this.pendingTasks.delete(t.id),i()}})}flush(){return y(this,void 0,void 0,function*(){return this.run(()=>y(this,void 0,void 0,function*(){}))})}snapshot(){return Array.from(this.pendingTasks.values())}}const ud=["syncState","trickle","offer","answer","simulate","leave"];function dd(n){const e=ud.indexOf(n.case)>=0;return U.trace("request allowed to bypass queue:",{canPass:e,req:n}),e}var z;(function(n){n[n.CONNECTING=0]="CONNECTING",n[n.CONNECTED=1]="CONNECTED",n[n.RECONNECTING=2]="RECONNECTING",n[n.DISCONNECTING=3]="DISCONNECTING",n[n.DISCONNECTED=4]="DISCONNECTED"})(z||(z={}));class hs{get currentState(){return this.state}get isDisconnected(){return this.state===z.DISCONNECTING||this.state===z.DISCONNECTED}get isEstablishingConnection(){return this.state===z.CONNECTING||this.state===z.RECONNECTING}constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var i;this.rtt=0,this.state=z.DISCONNECTED,this.log=U,this.resetCallbacks=()=>{this.onAnswer=void 0,this.onLeave=void 0,this.onLocalTrackPublished=void 0,this.onLocalTrackUnpublished=void 0,this.onNegotiateRequested=void 0,this.onOffer=void 0,this.onRemoteMuteChanged=void 0,this.onSubscribedQualityUpdate=void 0,this.onTokenRefresh=void 0,this.onTrickle=void 0,this.onClose=void 0},this.log=zt((i=t.loggerName)!==null&&i!==void 0?i:dt.Signal),this.loggerContextCb=t.loggerContextCb,this.useJSON=e,this.requestQueue=new ld,this.queuedRequests=[],this.closingLock=new Ge,this.connectionLock=new Ge,this.state=z.DISCONNECTED}get logContext(){var e,t;return(t=(e=this.loggerContextCb)===null||e===void 0?void 0:e.call(this))!==null&&t!==void 0?t:{}}join(e,t,i,r){return y(this,void 0,void 0,function*(){return this.state=z.CONNECTING,this.options=i,yield this.connect(e,t,i,r)})}reconnect(e,t,i,r){return y(this,void 0,void 0,function*(){if(!this.options){this.log.warn("attempted to reconnect without signal options being set, ignoring",this.logContext);return}return this.state=z.RECONNECTING,this.clearPingInterval(),yield this.connect(e,t,Object.assign(Object.assign({},this.options),{reconnect:!0,sid:i,reconnectReason:r}))})}connect(e,t,i,r){this.connectOptions=i,e=od(e),e=e.replace(/\/$/,""),e+="/rtc";const s=rd(),o=hd(t,s,i);return new Promise((a,c)=>y(this,void 0,void 0,function*(){const l=yield this.connectionLock.lock();try{const u=()=>y(this,void 0,void 0,function*(){this.close(),clearTimeout(d),c(new W("room connection has been cancelled (signal)"))}),d=setTimeout(()=>{this.close(),c(new W("room connection has timed out (signal)"))},i.websocketTimeout);r!=null&&r.aborted&&u(),r==null||r.addEventListener("abort",u),this.log.debug("connecting to ".concat(e+o),this.logContext),this.ws&&(yield this.close(!1)),this.ws=new WebSocket(e+o),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>{clearTimeout(d)},this.ws.onerror=h=>y(this,void 0,void 0,function*(){if(this.state!==z.CONNECTED){clearTimeout(d);try{const m=yield fetch("http".concat(e.substring(2),"/validate").concat(o));if(m.status.toFixed(0).startsWith("4")){const g=yield m.text();c(new W(g,0,m.status))}else c(new W("Internal error",2,m.status))}catch{c(new W("server was not reachable",1))}return}this.handleWSError(h)}),this.ws.onmessage=h=>y(this,void 0,void 0,function*(){var m,g,v,b;let k;if(typeof h.data=="string"){const S=JSON.parse(h.data);k=tt.fromJson(S)}else if(h.data instanceof ArrayBuffer)k=tt.fromBinary(new Uint8Array(h.data));else{this.log.error("could not decode websocket message: ".concat(typeof h.data),this.logContext);return}if(this.state!==z.CONNECTED){let S=!1;if(((m=k.message)===null||m===void 0?void 0:m.case)==="join"?(this.state=z.CONNECTED,r==null||r.removeEventListener("abort",u),this.pingTimeoutDuration=k.message.value.pingTimeout,this.pingIntervalDuration=k.message.value.pingInterval,this.pingTimeoutDuration&&this.pingTimeoutDuration>0&&(this.log.debug("ping config",Object.assign(Object.assign({},this.logContext),{timeout:this.pingTimeoutDuration,interval:this.pingIntervalDuration})),this.startPingInterval()),a(k.message.value)):this.state===z.RECONNECTING&&k.message.case!=="leave"?(this.state=z.CONNECTED,r==null||r.removeEventListener("abort",u),this.startPingInterval(),((g=k.message)===null||g===void 0?void 0:g.case)==="reconnect"?a((v=k.message)===null||v===void 0?void 0:v.value):(a(),S=!0)):this.isEstablishingConnection&&k.message.case==="leave"?c(new W("Received leave request while trying to (re)connect",4)):i.reconnect||c(new W("did not receive join response, got ".concat((b=k.message)===null||b===void 0?void 0:b.case," instead"))),!S)return}this.signalLatency&&(yield Gt(this.signalLatency)),this.handleSignalResponse(k)}),this.ws.onclose=h=>{this.isEstablishingConnection&&c(new W("Websocket got closed during a (re)connection attempt")),this.log.warn("websocket closed",Object.assign(Object.assign({},this.logContext),{reason:h.reason,state:this.state})),this.handleOnClose(h.reason)}}finally{l()}}))}close(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return y(this,void 0,void 0,function*(){const t=yield this.closingLock.lock();try{if(e&&(this.state=z.DISCONNECTING),this.ws){this.ws.onmessage=null,this.ws.onopen=null,this.ws.onclose=null;const i=new Promise(r=>{this.ws?this.ws.onclose=()=>{r()}:r()});this.ws.readyState<this.ws.CLOSING&&(this.ws.close(),yield Promise.race([i,Gt(250)])),this.ws=void 0}}finally{e&&(this.state=z.DISCONNECTED),this.clearPingInterval(),t()}})}sendOffer(e){this.log.debug("sending offer",Object.assign(Object.assign({},this.logContext),{offerSdp:e.sdp})),this.sendRequest({case:"offer",value:Ui(e)})}sendAnswer(e){return this.log.debug("sending answer",Object.assign(Object.assign({},this.logContext),{answerSdp:e.sdp})),this.sendRequest({case:"answer",value:Ui(e)})}sendIceCandidate(e,t){return this.log.trace("sending ice candidate",Object.assign(Object.assign({},this.logContext),{candidate:e})),this.sendRequest({case:"trickle",value:new Ve({candidateInit:JSON.stringify(e),target:t})})}sendMuteTrack(e,t){return this.sendRequest({case:"mute",value:new Je({sid:e,muted:t})})}sendAddTrack(e){return this.sendRequest({case:"addTrack",value:e})}sendUpdateLocalMetadata(e,t){return this.sendRequest({case:"updateMetadata",value:new rt({metadata:e,name:t})})}sendUpdateTrackSettings(e){this.sendRequest({case:"trackSetting",value:e})}sendUpdateSubscription(e){return this.sendRequest({case:"subscription",value:e})}sendSyncState(e){return this.sendRequest({case:"syncState",value:e})}sendUpdateVideoLayers(e,t){return this.sendRequest({case:"updateLayers",value:new it({trackSid:e,layers:t})})}sendUpdateSubscriptionPermissions(e,t){return this.sendRequest({case:"subscriptionPermission",value:new at({allParticipants:e,trackPermissions:t})})}sendSimulateScenario(e){return this.sendRequest({case:"simulate",value:e})}sendPing(){return Promise.all([this.sendRequest({case:"ping",value:L.parse(Date.now())}),this.sendRequest({case:"pingReq",value:new ut({timestamp:L.parse(Date.now()),rtt:L.parse(this.rtt)})})])}sendLeave(){return this.sendRequest({case:"leave",value:new _e({canReconnect:!1,reason:Wt.CLIENT_INITIATED})})}sendRequest(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;return y(this,void 0,void 0,function*(){if(!t&&!dd(e)&&this.state===z.RECONNECTING){this.queuedRequests.push(()=>y(this,void 0,void 0,function*(){yield this.sendRequest(e,!0)}));return}if(t||(yield this.requestQueue.flush()),this.signalLatency&&(yield Gt(this.signalLatency)),!this.ws||this.ws.readyState!==this.ws.OPEN){this.log.error("cannot send signal request before connected, type: ".concat(e==null?void 0:e.case),this.logContext);return}const r=new xt({message:e});try{this.useJSON?this.ws.send(r.toJsonString()):this.ws.send(r.toBinary())}catch(s){this.log.error("error sending signal message",Object.assign(Object.assign({},this.logContext),{error:s}))}})}handleSignalResponse(e){var t,i;const r=e.message;if(r==null){this.log.debug("received unsupported message",this.logContext);return}let s=!1;if(r.case==="answer"){const o=fo(r.value);this.onAnswer&&this.onAnswer(o)}else if(r.case==="offer"){const o=fo(r.value);this.onOffer&&this.onOffer(o)}else if(r.case==="trickle"){const o=JSON.parse(r.value.candidateInit);this.onTrickle&&this.onTrickle(o,r.value.target)}else r.case==="update"?this.onParticipantUpdate&&this.onParticipantUpdate((t=r.value.participants)!==null&&t!==void 0?t:[]):r.case==="trackPublished"?this.onLocalTrackPublished&&this.onLocalTrackPublished(r.value):r.case==="speakersChanged"?this.onSpeakersChanged&&this.onSpeakersChanged((i=r.value.speakers)!==null&&i!==void 0?i:[]):r.case==="leave"?this.onLeave&&this.onLeave(r.value):r.case==="mute"?this.onRemoteMuteChanged&&this.onRemoteMuteChanged(r.value.sid,r.value.muted):r.case==="roomUpdate"?this.onRoomUpdate&&r.value.room&&this.onRoomUpdate(r.value.room):r.case==="connectionQuality"?this.onConnectionQuality&&this.onConnectionQuality(r.value):r.case==="streamStateUpdate"?this.onStreamStateUpdate&&this.onStreamStateUpdate(r.value):r.case==="subscribedQualityUpdate"?this.onSubscribedQualityUpdate&&this.onSubscribedQualityUpdate(r.value):r.case==="subscriptionPermissionUpdate"?this.onSubscriptionPermissionUpdate&&this.onSubscriptionPermissionUpdate(r.value):r.case==="refreshToken"?this.onTokenRefresh&&this.onTokenRefresh(r.value):r.case==="trackUnpublished"?this.onLocalTrackUnpublished&&this.onLocalTrackUnpublished(r.value):r.case==="subscriptionResponse"?this.onSubscriptionError&&this.onSubscriptionError(r.value):r.case==="pong"||(r.case==="pongResp"?(this.rtt=Date.now()-Number.parseInt(r.value.lastPingTimestamp.toString()),this.resetPingTimeout(),s=!0):this.log.debug("unsupported message",Object.assign(Object.assign({},this.logContext),{msgCase:r.case})));s||this.resetPingTimeout()}setReconnected(){for(;this.queuedRequests.length>0;){const e=this.queuedRequests.shift();e&&this.requestQueue.run(e)}}handleOnClose(e){return y(this,void 0,void 0,function*(){if(this.state===z.DISCONNECTED)return;const t=this.onClose;yield this.close(),this.log.debug("websocket connection closed: ".concat(e),Object.assign(Object.assign({},this.logContext),{reason:e})),t&&t(e)})}handleWSError(e){this.log.error("websocket error",Object.assign(Object.assign({},this.logContext),{error:e}))}resetPingTimeout(){if(this.clearPingTimeout(),!this.pingTimeoutDuration){this.log.warn("ping timeout duration not set",this.logContext);return}this.pingTimeout=le.setTimeout(()=>{this.log.warn("ping timeout triggered. last pong received at: ".concat(new Date(Date.now()-this.pingTimeoutDuration*1e3).toUTCString()),this.logContext),this.handleOnClose("ping timeout")},this.pingTimeoutDuration*1e3)}clearPingTimeout(){this.pingTimeout&&le.clearTimeout(this.pingTimeout)}startPingInterval(){if(this.clearPingInterval(),this.resetPingTimeout(),!this.pingIntervalDuration){this.log.warn("ping interval duration not set",this.logContext);return}this.log.debug("start ping interval",this.logContext),this.pingInterval=le.setInterval(()=>{this.sendPing()},this.pingIntervalDuration*1e3)}clearPingInterval(){this.log.debug("clearing ping interval",this.logContext),this.clearPingTimeout(),this.pingInterval&&le.clearInterval(this.pingInterval)}}function fo(n){const e={type:"offer",sdp:n.sdp};switch(n.type){case"answer":case"offer":case"pranswer":case"rollback":e.type=n.type;break}return e}function Ui(n){return new ye({sdp:n.sdp,type:n.type})}function hd(n,e,t){var i;const r=new URLSearchParams;return r.set("access_token",n),t.reconnect&&(r.set("reconnect","1"),t.sid&&r.set("sid",t.sid)),r.set("auto_subscribe",t.autoSubscribe?"1":"0"),r.set("sdk",kn()?"reactnative":"js"),r.set("version",e.version),r.set("protocol",e.protocol.toString()),e.deviceModel&&r.set("device_model",e.deviceModel),e.os&&r.set("os",e.os),e.osVersion&&r.set("os_version",e.osVersion),e.browser&&r.set("browser",e.browser),e.browserVersion&&r.set("browser_version",e.browserVersion),t.publishOnly!==void 0&&r.set("publish",t.publishOnly),t.adaptiveStream&&r.set("adaptive_stream","1"),t.reconnectReason&&r.set("reconnect_reason",t.reconnectReason.toString()),!((i=navigator.connection)===null||i===void 0)&&i.type&&r.set("network",navigator.connection.type),"?".concat(r.toString())}var oc={},ac={exports:{}},po=ac.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(n){return n.encoding?"rtpmap:%d %s/%s/%s":n.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(n){return n.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(n){return n.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(n){return"extmap:%d"+(n.direction?"/%s":"%v")+(n["encrypt-uri"]?" %s":"%v")+" %s"+(n.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(n){return n.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(n){var e="candidate:%s %d %s %d %s %d typ %s";return e+=n.raddr!=null?" raddr %s rport %d":"%v%v",e+=n.tcptype!=null?" tcptype %s":"%v",n.generation!=null&&(e+=" generation %d"),e+=n["network-id"]!=null?" network-id %d":"%v",e+=n["network-cost"]!=null?" network-cost %d":"%v",e}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(n){var e="ssrc:%d";return n.attribute!=null&&(e+=" %s",n.value!=null&&(e+=":%s")),e}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(n){return n.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(n){return n.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(n){return"imageattr:%s %s %s"+(n.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(n){return"simulcast:%s %s"+(n.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(n){return"ts-refclk:%s"+(n.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(n){var e="mediaclk:";return e+=n.id!=null?"id=%s %s":"%v%s",e+=n.mediaClockValue!=null?"=%s":"",e+=n.rateNumerator!=null?" rate=%s":"",e+=n.rateDenominator!=null?"/%s":"",e}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(po).forEach(function(n){var e=po[n];e.forEach(function(t){t.reg||(t.reg=/(.*)/),t.format||(t.format="%s")})});var cc=ac.exports;(function(n){var e=function(a){return String(Number(a))===a?Number(a):a},t=function(a,c,l,u){if(u&&!l)c[u]=e(a[1]);else for(var d=0;d<l.length;d+=1)a[d+1]!=null&&(c[l[d]]=e(a[d+1]))},i=function(a,c,l){var u=a.name&&a.names;a.push&&!c[a.push]?c[a.push]=[]:u&&!c[a.name]&&(c[a.name]={});var d=a.push?{}:u?c[a.name]:c;t(l.match(a.reg),d,a.names,a.name),a.push&&c[a.push].push(d)},r=cc,s=RegExp.prototype.test.bind(/^([a-z])=(.*)/);n.parse=function(a){var c={},l=[],u=c;return a.split(/(\r\n|\r|\n)/).filter(s).forEach(function(d){var h=d[0],m=d.slice(2);h==="m"&&(l.push({rtp:[],fmtp:[]}),u=l[l.length-1]);for(var g=0;g<(r[h]||[]).length;g+=1){var v=r[h][g];if(v.reg.test(m))return i(v,u,m)}}),c.media=l,c};var o=function(a,c){var l=c.split(/=(.+)/,2);return l.length===2?a[l[0]]=e(l[1]):l.length===1&&c.length>1&&(a[l[0]]=void 0),a};n.parseParams=function(a){return a.split(/;\s?/).reduce(o,{})},n.parseFmtpConfig=n.parseParams,n.parsePayloads=function(a){return a.toString().split(" ").map(Number)},n.parseRemoteCandidates=function(a){for(var c=[],l=a.split(" ").map(e),u=0;u<l.length;u+=3)c.push({component:l[u],ip:l[u+1],port:l[u+2]});return c},n.parseImageAttributes=function(a){return a.split(" ").map(function(c){return c.substring(1,c.length-1).split(",").reduce(o,{})})},n.parseSimulcastStreamList=function(a){return a.split(";").map(function(c){return c.split(",").map(function(l){var u,d=!1;return l[0]!=="~"?u=e(l):(u=e(l.substring(1,l.length)),d=!0),{scid:u,paused:d}})})}})(oc);var hr=cc,fd=/%[sdv%]/g,pd=function(n){var e=1,t=arguments,i=t.length;return n.replace(fd,function(r){if(e>=i)return r;var s=t[e];switch(e+=1,r){case"%%":return"%";case"%s":return String(s);case"%d":return Number(s);case"%v":return""}})},Zn=function(n,e,t){var i=e.format instanceof Function?e.format(e.push?t:t[e.name]):e.format,r=[n+"="+i];if(e.names)for(var s=0;s<e.names.length;s+=1){var o=e.names[s];e.name?r.push(t[e.name][o]):r.push(t[e.names[s]])}else r.push(t[e.name]);return pd.apply(null,r)},md=["v","o","s","i","u","e","p","c","b","t","r","z","a"],gd=["i","c","b","a"],vd=function(n,e){e=e||{},n.version==null&&(n.version=0),n.name==null&&(n.name=" "),n.media.forEach(function(s){s.payloads==null&&(s.payloads="")});var t=e.outerOrder||md,i=e.innerOrder||gd,r=[];return t.forEach(function(s){hr[s].forEach(function(o){o.name in n&&n[o.name]!=null?r.push(Zn(s,o,n)):o.push in n&&n[o.push]!=null&&n[o.push].forEach(function(a){r.push(Zn(s,o,a))})})}),n.media.forEach(function(s){r.push(Zn("m",hr.m[0],s)),i.forEach(function(o){hr[o].forEach(function(a){a.name in s&&s[a.name]!=null?r.push(Zn(o,a,s)):a.push in s&&s[a.push]!=null&&s[a.push].forEach(function(c){r.push(Zn(o,a,c))})})})}),r.join(`\r
`)+`\r
`},bd=oc,yd=vd,fr=yd,ti=bd.parse;const mo=.7,Mn={NegotiationStarted:"negotiationStarted",NegotiationComplete:"negotiationComplete",RTPVideoPayloadTypes:"rtpVideoPayloadTypes"};class go extends ft.EventEmitter{get pc(){return this._pc||(this._pc=this.createPC()),this._pc}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};var r;super(),this.log=U,this.pendingCandidates=[],this.restartingIce=!1,this.renegotiate=!1,this.trackBitrates=[],this.remoteStereoMids=[],this.remoteNackMids=[],this.negotiate=ls(s=>y(this,void 0,void 0,function*(){this.emit(Mn.NegotiationStarted);try{yield this.createAndSendOffer()}catch(o){if(s)s(o);else throw o}}),100),this.close=()=>{this._pc&&(this._pc.close(),this._pc.onconnectionstatechange=null,this._pc.oniceconnectionstatechange=null,this._pc.onicegatheringstatechange=null,this._pc.ondatachannel=null,this._pc.onnegotiationneeded=null,this._pc.onsignalingstatechange=null,this._pc.onicecandidate=null,this._pc.ondatachannel=null,this._pc.ontrack=null,this._pc.onconnectionstatechange=null,this._pc.oniceconnectionstatechange=null,this._pc=null)},this.log=zt((r=i.loggerName)!==null&&r!==void 0?r:dt.PCTransport),this.loggerOptions=i,this.config=e,this.mediaConstraints=t,this._pc=this.createPC()}createPC(){const e=ed()?new RTCPeerConnection(this.config,this.mediaConstraints):new RTCPeerConnection(this.config);return e.onicecandidate=t=>{var i;t.candidate&&((i=this.onIceCandidate)===null||i===void 0||i.call(this,t.candidate))},e.onicecandidateerror=t=>{var i;(i=this.onIceCandidateError)===null||i===void 0||i.call(this,t)},e.oniceconnectionstatechange=()=>{var t;(t=this.onIceConnectionStateChange)===null||t===void 0||t.call(this,e.iceConnectionState)},e.onsignalingstatechange=()=>{var t;(t=this.onSignalingStatechange)===null||t===void 0||t.call(this,e.signalingState)},e.onconnectionstatechange=()=>{var t;(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,e.connectionState)},e.ondatachannel=t=>{var i;(i=this.onDataChannel)===null||i===void 0||i.call(this,t)},e.ontrack=t=>{var i;(i=this.onTrack)===null||i===void 0||i.call(this,t)},e}get logContext(){var e,t;return Object.assign({},(t=(e=this.loggerOptions).loggerContextCb)===null||t===void 0?void 0:t.call(e))}get isICEConnected(){return this._pc!==null&&(this.pc.iceConnectionState==="connected"||this.pc.iceConnectionState==="completed")}addIceCandidate(e){return y(this,void 0,void 0,function*(){if(this.pc.remoteDescription&&!this.restartingIce)return this.pc.addIceCandidate(e);this.pendingCandidates.push(e)})}setRemoteDescription(e){var t;return y(this,void 0,void 0,function*(){let i;if(e.type==="offer"){let{stereoMids:r,nackMids:s}=Sd(e);this.remoteStereoMids=r,this.remoteNackMids=s}else if(e.type==="answer"){const r=ti((t=e.sdp)!==null&&t!==void 0?t:"");r.media.forEach(s=>{s.type==="audio"&&this.trackBitrates.some(o=>{if(!o.transceiver||s.mid!=o.transceiver.mid)return!1;let a=0;if(s.rtp.some(l=>l.codec.toUpperCase()===o.codec.toUpperCase()?(a=l.payload,!0):!1),a===0)return!0;let c=!1;for(const l of s.fmtp)if(l.payload===a){l.config=l.config.split(";").filter(u=>!u.includes("maxaveragebitrate")).join(";"),o.maxbr>0&&(l.config+=";maxaveragebitrate=".concat(o.maxbr*1e3)),c=!0;break}return c||o.maxbr>0&&s.fmtp.push({payload:a,config:"maxaveragebitrate=".concat(o.maxbr*1e3)}),!0})}),i=fr(r)}yield this.setMungedSDP(e,i,!0),this.pendingCandidates.forEach(r=>{this.pc.addIceCandidate(r)}),this.pendingCandidates=[],this.restartingIce=!1,this.renegotiate?(this.renegotiate=!1,yield this.createAndSendOffer()):e.type==="answer"&&(this.emit(Mn.NegotiationComplete),e.sdp&&ti(e.sdp).media.forEach(s=>{s.type==="video"&&this.emit(Mn.RTPVideoPayloadTypes,s.rtp)}))})}createAndSendOffer(e){var t;return y(this,void 0,void 0,function*(){if(this.onOffer===void 0)return;if(e!=null&&e.iceRestart&&(this.log.debug("restarting ICE",this.logContext),this.restartingIce=!0),this._pc&&this._pc.signalingState==="have-local-offer"){const s=this._pc.remoteDescription;if(e!=null&&e.iceRestart&&s)yield this._pc.setRemoteDescription(s);else{this.renegotiate=!0;return}}else if(!this._pc||this._pc.signalingState==="closed"){this.log.warn("could not createOffer with closed peer connection",this.logContext);return}this.log.debug("starting to negotiate",this.logContext);const i=yield this.pc.createOffer(e),r=ti((t=i.sdp)!==null&&t!==void 0?t:"");r.media.forEach(s=>{s.type==="audio"?vo(s,[],[]):s.type==="video"&&(kd(s),this.trackBitrates.some(o=>{if(!s.msid||!o.cid||!s.msid.includes(o.cid))return!1;let a=0;if(s.rtp.some(l=>l.codec.toUpperCase()===o.codec.toUpperCase()?(a=l.payload,!0):!1),a===0)return!0;let c=!1;for(const l of s.fmtp)if(l.payload===a){l.config.includes("x-google-start-bitrate")||(l.config+=";x-google-start-bitrate=".concat(Math.round(o.maxbr*mo))),l.config.includes("x-google-max-bitrate")||(l.config+=";x-google-max-bitrate=".concat(o.maxbr)),c=!0;break}return c||s.fmtp.push({payload:a,config:"x-google-start-bitrate=".concat(Math.round(o.maxbr*mo),";x-google-max-bitrate=").concat(o.maxbr)}),!0}))}),yield this.setMungedSDP(i,fr(r)),this.onOffer(i)})}createAndSetAnswer(){var e;return y(this,void 0,void 0,function*(){const t=yield this.pc.createAnswer(),i=ti((e=t.sdp)!==null&&e!==void 0?e:"");return i.media.forEach(r=>{r.type==="audio"&&vo(r,this.remoteStereoMids,this.remoteNackMids)}),yield this.setMungedSDP(t,fr(i)),t})}createDataChannel(e,t){return this.pc.createDataChannel(e,t)}addTransceiver(e,t){return this.pc.addTransceiver(e,t)}addTrack(e){if(!this._pc)throw new te("PC closed, cannot add track");return this._pc.addTrack(e)}setTrackCodecBitrate(e){this.trackBitrates.push(e)}setConfiguration(e){var t;if(!this._pc)throw new te("PC closed, cannot configure");return(t=this._pc)===null||t===void 0?void 0:t.setConfiguration(e)}canRemoveTrack(){var e;return!!(!((e=this._pc)===null||e===void 0)&&e.removeTrack)}removeTrack(e){var t;return(t=this._pc)===null||t===void 0?void 0:t.removeTrack(e)}getConnectionState(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.connectionState)!==null&&t!==void 0?t:"closed"}getICEConnectionState(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.iceConnectionState)!==null&&t!==void 0?t:"closed"}getSignallingState(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.signalingState)!==null&&t!==void 0?t:"closed"}getTransceivers(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.getTransceivers())!==null&&t!==void 0?t:[]}getSenders(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.getSenders())!==null&&t!==void 0?t:[]}getLocalDescription(){var e;return(e=this._pc)===null||e===void 0?void 0:e.localDescription}getRemoteDescription(){var e;return(e=this.pc)===null||e===void 0?void 0:e.remoteDescription}getStats(){return this.pc.getStats()}getConnectedAddress(){var e;return y(this,void 0,void 0,function*(){if(!this._pc)return;let t="";const i=new Map,r=new Map;if((yield this._pc.getStats()).forEach(a=>{switch(a.type){case"transport":t=a.selectedCandidatePairId;break;case"candidate-pair":t===""&&a.selected&&(t=a.id),i.set(a.id,a);break;case"remote-candidate":r.set(a.id,"".concat(a.address,":").concat(a.port));break}}),t==="")return;const o=(e=i.get(t))===null||e===void 0?void 0:e.remoteCandidateId;if(o!==void 0)return r.get(o)})}setMungedSDP(e,t,i){return y(this,void 0,void 0,function*(){if(t){const r=e.sdp;e.sdp=t;try{this.log.debug("setting munged ".concat(i?"remote":"local"," description"),this.logContext),i?yield this.pc.setRemoteDescription(e):yield this.pc.setLocalDescription(e);return}catch(s){this.log.warn("not able to set ".concat(e.type,", falling back to unmodified sdp"),Object.assign(Object.assign({},this.logContext),{error:s,sdp:t})),e.sdp=r}}try{i?yield this.pc.setRemoteDescription(e):yield this.pc.setLocalDescription(e)}catch(r){let s="unknown error";r instanceof Error?s=r.message:typeof r=="string"&&(s=r);const o={error:s,sdp:e.sdp};throw!i&&this.pc.remoteDescription&&(o.remoteSdp=this.pc.remoteDescription),this.log.error("unable to set ".concat(e.type),Object.assign(Object.assign({},this.logContext),{fields:o})),new Ur(s)}})}}function vo(n,e,t){let i=0;n.rtp.some(r=>r.codec==="opus"?(i=r.payload,!0):!1),i>0&&(n.rtcpFb||(n.rtcpFb=[]),t.includes(n.mid)&&!n.rtcpFb.some(r=>r.payload===i&&r.type==="nack")&&n.rtcpFb.push({payload:i,type:"nack"}),e.includes(n.mid)&&n.fmtp.some(r=>r.payload===i?(r.config.includes("stereo=1")||(r.config+=";stereo=1"),!0):!1))}function kd(n){var e,t,i,r;const s=(t=(e=n.rtp[0])===null||e===void 0?void 0:e.codec)===null||t===void 0?void 0:t.toLowerCase();if(!ri(s))return;let o=0;((i=n.ext)===null||i===void 0?void 0:i.some(c=>c.uri===io?!0:(c.value>o&&(o=c.value),!1)))||(r=n.ext)===null||r===void 0||r.push({value:o+1,uri:io})}function Sd(n){var e;const t=[],i=[],r=ti((e=n.sdp)!==null&&e!==void 0?e:"");let s=0;return r.media.forEach(o=>{var a;o.type==="audio"&&(o.rtp.some(c=>c.codec==="opus"?(s=c.payload,!0):!1),!((a=o.rtcpFb)===null||a===void 0)&&a.some(c=>c.payload===s&&c.type==="nack")&&i.push(o.mid),o.fmtp.some(c=>c.payload===s?(c.config.includes("sprop-stereo=1")&&t.push(o.mid),!0):!1))}),{stereoMids:t,nackMids:i}}const Jr="vp8",Cd={audioBitrate:Di.music.maxBitrate,audioPreset:Di.music,dtx:!0,red:!0,forceStereo:!1,simulcast:!0,screenShareEncoding:us.h1080fps15.encoding,stopMicTrackOnMute:!1,videoCodec:Jr,backupCodec:!0},lc={autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0},uc={resolution:li.h720.resolution},Td={adaptiveStream:!1,dynacast:!1,stopLocalTrackOnUnpublish:!0,reconnectPolicy:new pu,disconnectOnPageLeave:!0,expWebAudioMix:!1},fs={autoSubscribe:!0,maxRetries:1,peerConnectionTimeout:15e3,websocketTimeout:15e3};var ne;(function(n){n[n.NEW=0]="NEW",n[n.CONNECTING=1]="CONNECTING",n[n.CONNECTED=2]="CONNECTED",n[n.FAILED=3]="FAILED",n[n.CLOSING=4]="CLOSING",n[n.CLOSED=5]="CLOSED"})(ne||(ne={}));class wd{get needsPublisher(){return this.isPublisherConnectionRequired}get needsSubscriber(){return this.isSubscriberConnectionRequired}get currentState(){return this.state}constructor(e,t,i){var r;this.peerConnectionTimeout=fs.peerConnectionTimeout,this.log=U,this.updateState=()=>{var o;const a=this.state,c=this.requiredTransports.map(l=>l.getConnectionState());c.every(l=>l==="connected")?this.state=ne.CONNECTED:c.some(l=>l==="failed")?this.state=ne.FAILED:c.some(l=>l==="connecting")?this.state=ne.CONNECTING:c.every(l=>l==="closed")?this.state=ne.CLOSED:c.some(l=>l==="closed")?this.state=ne.CLOSING:c.every(l=>l==="new")&&(this.state=ne.NEW),a!==this.state&&(this.log.debug("pc state change: from ".concat(ne[a]," to ").concat(ne[this.state]),this.logContext),(o=this.onStateChange)===null||o===void 0||o.call(this,this.state,this.publisher.getConnectionState(),this.subscriber.getConnectionState()))},this.log=zt((r=i.loggerName)!==null&&r!==void 0?r:dt.PCManager),this.loggerOptions=i,this.isPublisherConnectionRequired=!t,this.isSubscriberConnectionRequired=t;const s={optional:[{googDscp:!0}]};this.publisher=new go(e,s,i),this.subscriber=new go(e,i),this.publisher.onConnectionStateChange=this.updateState,this.subscriber.onConnectionStateChange=this.updateState,this.publisher.onIceConnectionStateChange=this.updateState,this.subscriber.onIceConnectionStateChange=this.updateState,this.publisher.onSignalingStatechange=this.updateState,this.subscriber.onSignalingStatechange=this.updateState,this.publisher.onIceCandidate=o=>{var a;(a=this.onIceCandidate)===null||a===void 0||a.call(this,o,fe.PUBLISHER)},this.subscriber.onIceCandidate=o=>{var a;(a=this.onIceCandidate)===null||a===void 0||a.call(this,o,fe.SUBSCRIBER)},this.subscriber.onDataChannel=o=>{var a;(a=this.onDataChannel)===null||a===void 0||a.call(this,o)},this.subscriber.onTrack=o=>{var a;(a=this.onTrack)===null||a===void 0||a.call(this,o)},this.publisher.onOffer=o=>{var a;(a=this.onPublisherOffer)===null||a===void 0||a.call(this,o)},this.state=ne.NEW,this.connectionLock=new Ge}get logContext(){var e,t;return Object.assign({},(t=(e=this.loggerOptions).loggerContextCb)===null||t===void 0?void 0:t.call(e))}requirePublisher(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;this.isPublisherConnectionRequired=e,this.updateState()}requireSubscriber(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;this.isSubscriberConnectionRequired=e,this.updateState()}createAndSendPublisherOffer(e){return this.publisher.createAndSendOffer(e)}setPublisherAnswer(e){return this.publisher.setRemoteDescription(e)}removeTrack(e){return this.publisher.removeTrack(e)}close(){return y(this,void 0,void 0,function*(){if(this.publisher&&this.publisher.getSignallingState()!=="closed"){const e=this.publisher;for(const t of e.getSenders())try{e.canRemoveTrack()&&e.removeTrack(t)}catch(i){this.log.warn("could not removeTrack",Object.assign(Object.assign({},this.logContext),{error:i}))}}yield Promise.all([this.publisher.close(),this.subscriber.close()]),this.updateState()})}triggerIceRestart(){return y(this,void 0,void 0,function*(){this.subscriber.restartingIce=!0,this.needsPublisher&&(yield this.createAndSendPublisherOffer({iceRestart:!0}))})}addIceCandidate(e,t){return y(this,void 0,void 0,function*(){t===fe.PUBLISHER?yield this.publisher.addIceCandidate(e):yield this.subscriber.addIceCandidate(e)})}createSubscriberAnswerFromOffer(e){return y(this,void 0,void 0,function*(){return this.log.debug("received server offer",Object.assign(Object.assign({},this.logContext),{RTCSdpType:e.type,sdp:e.sdp,signalingState:this.subscriber.getSignallingState().toString()})),yield this.subscriber.setRemoteDescription(e),yield this.subscriber.createAndSetAnswer()})}updateConfiguration(e,t){this.publisher.setConfiguration(e),this.subscriber.setConfiguration(e),t&&this.triggerIceRestart()}ensurePCTransportConnection(e,t){var i;return y(this,void 0,void 0,function*(){const r=yield this.connectionLock.lock();try{this.isPublisherConnectionRequired&&this.publisher.getConnectionState()!=="connected"&&this.publisher.getConnectionState()!=="connecting"&&(this.log.debug("negotiation required, start negotiating",this.logContext),this.publisher.negotiate()),yield Promise.all((i=this.requiredTransports)===null||i===void 0?void 0:i.map(s=>this.ensureTransportConnected(s,e,t)))}finally{r()}})}negotiate(e){return y(this,void 0,void 0,function*(){return new Promise((t,i)=>y(this,void 0,void 0,function*(){const r=setTimeout(()=>{i("negotiation timed out")},this.peerConnectionTimeout),s=()=>{clearTimeout(r),i("negotiation aborted")};e.signal.addEventListener("abort",s),this.publisher.once(Mn.NegotiationStarted,()=>{e.signal.aborted||this.publisher.once(Mn.NegotiationComplete,()=>{clearTimeout(r),t()})}),yield this.publisher.negotiate(o=>{clearTimeout(r),i(o)})}))})}addPublisherTransceiver(e,t){return this.publisher.addTransceiver(e,t)}addPublisherTrack(e){return this.publisher.addTrack(e)}createPublisherDataChannel(e,t){return this.publisher.createDataChannel(e,t)}getConnectedAddress(e){return e===fe.PUBLISHER?this.publisher.getConnectedAddress():e===fe.SUBSCRIBER?this.publisher.getConnectedAddress():this.requiredTransports[0].getConnectedAddress()}get requiredTransports(){const e=[];return this.isPublisherConnectionRequired&&e.push(this.publisher),this.isSubscriberConnectionRequired&&e.push(this.subscriber),e}ensureTransportConnected(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.peerConnectionTimeout;return y(this,void 0,void 0,function*(){if(e.getConnectionState()!=="connected")return new Promise((s,o)=>y(this,void 0,void 0,function*(){const a=()=>{this.log.warn("abort transport connection",this.logContext),le.clearTimeout(c),o(new W("room connection has been cancelled",3))};t!=null&&t.signal.aborted&&a(),t==null||t.signal.addEventListener("abort",a);const c=le.setTimeout(()=>{t==null||t.signal.removeEventListener("abort",a),o(new W("could not establish pc connection"))},i);for(;this.state!==ne.CONNECTED;)if(yield Gt(50),t!=null&&t.signal.aborted){o(new W("room connection has been cancelled",3));return}le.clearTimeout(c),t==null||t.signal.removeEventListener("abort",a),s()}))})}}const bo="_lossy",yo="_reliable",Ed=2*1e3,ko="leave-reconnect";var De;(function(n){n[n.New=0]="New",n[n.Connected=1]="Connected",n[n.Disconnected=2]="Disconnected",n[n.Reconnecting=3]="Reconnecting",n[n.Closed=4]="Closed"})(De||(De={}));class Pd extends ft.EventEmitter{get isClosed(){return this._isClosed}constructor(e){var t;super(),this.options=e,this.rtcConfig={},this.peerConnectionTimeout=fs.peerConnectionTimeout,this.fullReconnectOnNext=!1,this.subscriberPrimary=!1,this.pcState=De.New,this._isClosed=!0,this.pendingTrackResolvers={},this.reconnectAttempts=0,this.reconnectStart=0,this.attemptingReconnect=!1,this.joinAttempts=0,this.maxJoinAttempts=1,this.shouldFailNext=!1,this.log=U,this.handleDataChannel=i=>{let{channel:r}=i;return y(this,void 0,void 0,function*(){if(r){if(r.label===yo)this.reliableDCSub=r;else if(r.label===bo)this.lossyDCSub=r;else return;this.log.debug("on data channel ".concat(r.id,", ").concat(r.label),this.logContext),r.onmessage=this.handleDataMessage}})},this.handleDataMessage=i=>y(this,void 0,void 0,function*(){var r,s;const o=yield this.dataProcessLock.lock();try{let a;if(i.data instanceof ArrayBuffer)a=i.data;else if(i.data instanceof Blob)a=yield i.data.arrayBuffer();else{this.log.error("unsupported data type",Object.assign(Object.assign({},this.logContext),{data:i.data}));return}const c=Ke.fromBinary(new Uint8Array(a));((r=c.value)===null||r===void 0?void 0:r.case)==="speaker"?this.emit(M.ActiveSpeakersUpdate,c.value.value.speakers):((s=c.value)===null||s===void 0?void 0:s.case)==="user"&&this.emit(M.DataPacketReceived,c.value.value,c.kind)}finally{o()}}),this.handleDataError=i=>{const s=i.currentTarget.maxRetransmits===0?"lossy":"reliable";if(i instanceof ErrorEvent&&i.error){const{error:o}=i.error;this.log.error("DataChannel error on ".concat(s,": ").concat(i.message),Object.assign(Object.assign({},this.logContext),{error:o}))}else this.log.error("Unknown DataChannel error on ".concat(s),Object.assign(Object.assign({},this.logContext),{event:i}))},this.handleBufferedAmountLow=i=>{const s=i.currentTarget.maxRetransmits===0?oe.LOSSY:oe.RELIABLE;this.updateAndEmitDCBufferStatus(s)},this.handleDisconnect=(i,r)=>{if(this._isClosed)return;this.log.warn("".concat(i," disconnected"),this.logContext),this.reconnectAttempts===0&&(this.reconnectStart=Date.now());const s=c=>{this.log.warn("could not recover connection after ".concat(this.reconnectAttempts," attempts, ").concat(c,"ms. giving up"),this.logContext),this.emit(M.Disconnected),this.close()},o=Date.now()-this.reconnectStart;let a=this.getNextRetryDelay({elapsedMs:o,retryCount:this.reconnectAttempts});if(a===null){s(o);return}i===ko&&(a=0),this.log.debug("reconnecting in ".concat(a,"ms"),this.logContext),this.clearReconnectTimeout(),this.token&&this.regionUrlProvider&&this.regionUrlProvider.updateToken(this.token),this.reconnectTimeout=le.setTimeout(()=>this.attemptReconnect(r),a)},this.waitForRestarted=()=>new Promise((i,r)=>{this.pcState===De.Connected&&i();const s=()=>{this.off(M.Disconnected,o),i()},o=()=>{this.off(M.Restarted,s),r()};this.once(M.Restarted,s),this.once(M.Disconnected,o)}),this.updateAndEmitDCBufferStatus=i=>{const r=this.isBufferStatusLow(i);typeof r<"u"&&r!==this.dcBufferStatus.get(i)&&(this.dcBufferStatus.set(i,r),this.emit(M.DCBufferStatusChanged,r,i))},this.isBufferStatusLow=i=>{const r=this.dataChannelForKind(i);if(r)return r.bufferedAmount<=r.bufferedAmountLowThreshold},this.handleBrowserOnLine=()=>{this.client.currentState===z.RECONNECTING&&(this.clearReconnectTimeout(),this.attemptReconnect(vt.RR_SIGNAL_DISCONNECTED))},this.log=zt((t=e.loggerName)!==null&&t!==void 0?t:dt.Engine),this.loggerOptions={loggerName:e.loggerName,loggerContextCb:()=>this.logContext},this.client=new hs(void 0,this.loggerOptions),this.client.signalLatency=this.options.expSignalLatency,this.reconnectPolicy=this.options.reconnectPolicy,this.registerOnLineListener(),this.closingLock=new Ge,this.dataProcessLock=new Ge,this.dcBufferStatus=new Map([[oe.LOSSY,!0],[oe.RELIABLE,!0]]),this.client.onParticipantUpdate=i=>this.emit(M.ParticipantUpdate,i),this.client.onConnectionQuality=i=>this.emit(M.ConnectionQualityUpdate,i),this.client.onRoomUpdate=i=>this.emit(M.RoomUpdate,i),this.client.onSubscriptionError=i=>this.emit(M.SubscriptionError,i),this.client.onSubscriptionPermissionUpdate=i=>this.emit(M.SubscriptionPermissionUpdate,i),this.client.onSpeakersChanged=i=>this.emit(M.SpeakersChanged,i),this.client.onStreamStateUpdate=i=>this.emit(M.StreamStateChanged,i)}get logContext(){var e,t,i,r,s,o;return{room:(t=(e=this.latestJoinResponse)===null||e===void 0?void 0:e.room)===null||t===void 0?void 0:t.name,roomSid:(r=(i=this.latestJoinResponse)===null||i===void 0?void 0:i.room)===null||r===void 0?void 0:r.sid,identity:(o=(s=this.latestJoinResponse)===null||s===void 0?void 0:s.participant)===null||o===void 0?void 0:o.identity}}join(e,t,i,r){return y(this,void 0,void 0,function*(){this.url=e,this.token=t,this.signalOpts=i,this.maxJoinAttempts=i.maxRetries;try{this.joinAttempts+=1,this.setupSignalClientCallbacks();const s=yield this.client.join(e,t,i,r);return this._isClosed=!1,this.latestJoinResponse=s,this.subscriberPrimary=s.subscriberPrimary,this.pcManager||(yield this.configure(s)),this.subscriberPrimary||this.negotiate(),this.clientConfiguration=s.clientConfiguration,s}catch(s){if(s instanceof W&&s.reason===1&&(this.log.warn("Couldn't connect to server, attempt ".concat(this.joinAttempts," of ").concat(this.maxJoinAttempts),this.logContext),this.joinAttempts<this.maxJoinAttempts))return this.join(e,t,i,r);throw s}})}close(){return y(this,void 0,void 0,function*(){const e=yield this.closingLock.lock();if(this.isClosed){e();return}try{this._isClosed=!0,this.emit(M.Closing),this.removeAllListeners(),this.deregisterOnLineListener(),this.clearPendingReconnect(),yield this.cleanupPeerConnections(),yield this.cleanupClient()}finally{e()}})}cleanupPeerConnections(){var e;return y(this,void 0,void 0,function*(){yield(e=this.pcManager)===null||e===void 0?void 0:e.close(),this.pcManager=void 0;const t=i=>{i&&(i.close(),i.onbufferedamountlow=null,i.onclose=null,i.onclosing=null,i.onerror=null,i.onmessage=null,i.onopen=null)};t(this.lossyDC),t(this.lossyDCSub),t(this.reliableDC),t(this.reliableDCSub),this.lossyDC=void 0,this.lossyDCSub=void 0,this.reliableDC=void 0,this.reliableDCSub=void 0})}cleanupClient(){return y(this,void 0,void 0,function*(){yield this.client.close(),this.client.resetCallbacks()})}addTrack(e){if(this.pendingTrackResolvers[e.cid])throw new ze("a track with the same ID has already been published");return new Promise((t,i)=>{const r=setTimeout(()=>{delete this.pendingTrackResolvers[e.cid],i(new W("publication of local track timed out, no response from server"))},1e4);this.pendingTrackResolvers[e.cid]={resolve:s=>{clearTimeout(r),t(s)},reject:()=>{clearTimeout(r),i(new Error("Cancelled publication by calling unpublish"))}},this.client.sendAddTrack(e)})}removeTrack(e){if(e.track&&this.pendingTrackResolvers[e.track.id]){const{reject:t}=this.pendingTrackResolvers[e.track.id];t&&t(),delete this.pendingTrackResolvers[e.track.id]}try{return this.pcManager.removeTrack(e),!0}catch(t){this.log.warn("failed to remove track",Object.assign(Object.assign({},this.logContext),{error:t}))}return!1}updateMuteStatus(e,t){this.client.sendMuteTrack(e,t)}get dataSubscriberReadyState(){var e;return(e=this.reliableDCSub)===null||e===void 0?void 0:e.readyState}getConnectedServerAddress(){var e;return y(this,void 0,void 0,function*(){return(e=this.pcManager)===null||e===void 0?void 0:e.getConnectedAddress()})}setRegionUrlProvider(e){this.regionUrlProvider=e}configure(e){var t;return y(this,void 0,void 0,function*(){if(this.pcManager&&this.pcManager.currentState!==ne.NEW)return;this.participantSid=(t=e.participant)===null||t===void 0?void 0:t.sid;const i=this.makeRTCConfiguration(e);this.pcManager=new wd(i,e.subscriberPrimary,this.loggerOptions),this.emit(M.TransportsCreated,this.pcManager.publisher,this.pcManager.subscriber),this.pcManager.onIceCandidate=(r,s)=>{this.client.sendIceCandidate(r,s)},this.pcManager.onPublisherOffer=r=>{this.client.sendOffer(r)},this.pcManager.onDataChannel=this.handleDataChannel,this.pcManager.onStateChange=(r,s,o)=>y(this,void 0,void 0,function*(){if(this.log.debug("primary PC state changed ".concat(r),this.logContext),r===ne.CONNECTED){const a=this.pcState===De.New;this.pcState=De.Connected,a&&this.emit(M.Connected,e)}else r===ne.FAILED&&this.pcState===De.Connected&&(this.pcState=De.Disconnected,this.handleDisconnect("peerconnection failed",o==="failed"?vt.RR_SUBSCRIBER_FAILED:vt.RR_PUBLISHER_FAILED))}),this.pcManager.onTrack=r=>{this.emit(M.MediaTrackAdded,r.track,r.streams[0],r.receiver)},this.createDataChannels()})}setupSignalClientCallbacks(){this.client.onAnswer=e=>y(this,void 0,void 0,function*(){this.pcManager&&(this.log.debug("received server answer",Object.assign(Object.assign({},this.logContext),{RTCSdpType:e.type})),yield this.pcManager.setPublisherAnswer(e))}),this.client.onTrickle=(e,t)=>{this.pcManager&&(this.log.trace("got ICE candidate from peer",Object.assign(Object.assign({},this.logContext),{candidate:e,target:t})),this.pcManager.addIceCandidate(e,t))},this.client.onOffer=e=>y(this,void 0,void 0,function*(){if(!this.pcManager)return;const t=yield this.pcManager.createSubscriberAnswerFromOffer(e);this.client.sendAnswer(t)}),this.client.onLocalTrackPublished=e=>{var t;if(this.log.debug("received trackPublishedResponse",Object.assign(Object.assign({},this.logContext),{cid:e.cid,track:(t=e.track)===null||t===void 0?void 0:t.sid})),!this.pendingTrackResolvers[e.cid]){this.log.error("missing track resolver for ".concat(e.cid),Object.assign(Object.assign({},this.logContext),{cid:e.cid}));return}const{resolve:i}=this.pendingTrackResolvers[e.cid];delete this.pendingTrackResolvers[e.cid],i(e.track)},this.client.onLocalTrackUnpublished=e=>{this.emit(M.LocalTrackUnpublished,e)},this.client.onTokenRefresh=e=>{this.token=e},this.client.onRemoteMuteChanged=(e,t)=>{this.emit(M.RemoteMute,e,t)},this.client.onSubscribedQualityUpdate=e=>{this.emit(M.SubscribedQualityUpdate,e)},this.client.onClose=()=>{this.handleDisconnect("signal",vt.RR_SIGNAL_DISCONNECTED)},this.client.onLeave=e=>{e!=null&&e.canReconnect?(this.fullReconnectOnNext=!0,this.handleDisconnect(ko)):(this.emit(M.Disconnected,e==null?void 0:e.reason),this.close()),this.log.debug("client leave request",Object.assign(Object.assign({},this.logContext),{reason:e==null?void 0:e.reason}))}}makeRTCConfiguration(e){var t;const i=Object.assign({},this.rtcConfig);if(!((t=this.signalOpts)===null||t===void 0)&&t.e2eeEnabled&&(this.log.debug("E2EE - setting up transports with insertable streams",this.logContext),i.encodedInsertableStreams=!0),e.iceServers&&!i.iceServers){const r=[];e.iceServers.forEach(s=>{const o={urls:s.urls};s.username&&(o.username=s.username),s.credential&&(o.credential=s.credential),r.push(o)}),i.iceServers=r}return e.clientConfiguration&&e.clientConfiguration.forceRelay===He.ENABLED&&(i.iceTransportPolicy="relay"),i.sdpSemantics="unified-plan",i.continualGatheringPolicy="gather_continually",i}createDataChannels(){this.pcManager&&(this.lossyDC&&(this.lossyDC.onmessage=null,this.lossyDC.onerror=null),this.reliableDC&&(this.reliableDC.onmessage=null,this.reliableDC.onerror=null),this.lossyDC=this.pcManager.createPublisherDataChannel(bo,{ordered:!0,maxRetransmits:0}),this.reliableDC=this.pcManager.createPublisherDataChannel(yo,{ordered:!0}),this.lossyDC.onmessage=this.handleDataMessage,this.reliableDC.onmessage=this.handleDataMessage,this.lossyDC.onerror=this.handleDataError,this.reliableDC.onerror=this.handleDataError,this.lossyDC.bufferedAmountLowThreshold=65535,this.reliableDC.bufferedAmountLowThreshold=65535,this.lossyDC.onbufferedamountlow=this.handleBufferedAmountLow,this.reliableDC.onbufferedamountlow=this.handleBufferedAmountLow)}setPreferredCodec(e,t,i){if(!("getCapabilities"in RTCRtpSender))return;const r=RTCRtpSender.getCapabilities(t);if(!r)return;this.log.debug("get sender capabilities",Object.assign(Object.assign({},this.logContext),{cap:r}));const s=[],o=[],a=[];r.codecs.forEach(c=>{const l=c.mimeType.toLowerCase();if(l==="audio/opus"){s.push(c);return}if(!(l==="video/".concat(i))){a.push(c);return}if(i==="h264"){c.sdpFmtpLine&&c.sdpFmtpLine.includes("profile-level-id=42e01f")?s.push(c):o.push(c);return}s.push(c)}),Zu(e)&&e.setCodecPreferences(s.concat(o,a))}createSender(e,t,i){return y(this,void 0,void 0,function*(){if(ro())return yield this.createTransceiverRTCRtpSender(e,t,i);if(so())return this.log.warn("using add-track fallback",this.logContext),yield this.createRTCRtpSender(e.mediaStreamTrack);throw new te("Required webRTC APIs not supported on this device")})}createSimulcastSender(e,t,i,r){return y(this,void 0,void 0,function*(){if(ro())return this.createSimulcastTransceiverSender(e,t,i,r);if(so())return this.log.debug("using add-track fallback",this.logContext),this.createRTCRtpSender(e.mediaStreamTrack);throw new te("Cannot stream on this device")})}createTransceiverRTCRtpSender(e,t,i){return y(this,void 0,void 0,function*(){if(!this.pcManager)throw new te("publisher is closed");const r=[];e.mediaStream&&r.push(e.mediaStream);const s={direction:"sendonly",streams:r};i&&(s.sendEncodings=i);const o=yield this.pcManager.addPublisherTransceiver(e.mediaStreamTrack,s);return e.kind===C.Kind.Video&&t.videoCodec&&(this.setPreferredCodec(o,e.kind,t.videoCodec),e.codec=t.videoCodec),o.sender})}createSimulcastTransceiverSender(e,t,i,r){return y(this,void 0,void 0,function*(){if(!this.pcManager)throw new te("publisher is closed");const s={direction:"sendonly"};r&&(s.sendEncodings=r);const o=yield this.pcManager.addPublisherTransceiver(t.mediaStreamTrack,s);if(i.videoCodec)return this.setPreferredCodec(o,e.kind,i.videoCodec),e.setSimulcastTrackSender(i.videoCodec,o.sender),o.sender})}createRTCRtpSender(e){return y(this,void 0,void 0,function*(){if(!this.pcManager)throw new te("publisher is closed");return this.pcManager.addPublisherTrack(e)})}attemptReconnect(e){var t,i,r;return y(this,void 0,void 0,function*(){if(!this._isClosed){if(this.attemptingReconnect){U.warn("already attempting reconnect, returning early",this.logContext);return}(((t=this.clientConfiguration)===null||t===void 0?void 0:t.resumeConnection)===He.DISABLED||((r=(i=this.pcManager)===null||i===void 0?void 0:i.currentState)!==null&&r!==void 0?r:ne.NEW)===ne.NEW)&&(this.fullReconnectOnNext=!0);try{this.attemptingReconnect=!0,this.fullReconnectOnNext?yield this.restartConnection():yield this.resumeConnection(e),this.clearPendingReconnect(),this.fullReconnectOnNext=!1}catch(s){this.reconnectAttempts+=1;let o=!0;s instanceof te?(this.log.debug("received unrecoverable error",Object.assign(Object.assign({},this.logContext),{error:s})),o=!1):s instanceof Pn||(this.fullReconnectOnNext=!0),o?this.handleDisconnect("reconnect",vt.RR_UNKNOWN):(this.log.info("could not recover connection after ".concat(this.reconnectAttempts," attempts, ").concat(Date.now()-this.reconnectStart,"ms. giving up"),this.logContext),this.emit(M.Disconnected),yield this.close())}finally{this.attemptingReconnect=!1}}})}getNextRetryDelay(e){try{return this.reconnectPolicy.nextRetryDelayInMs(e)}catch(t){this.log.warn("encountered error in reconnect policy",Object.assign(Object.assign({},this.logContext),{error:t}))}return null}restartConnection(e){var t,i,r;return y(this,void 0,void 0,function*(){try{if(!this.url||!this.token)throw new te("could not reconnect, url or token not saved");this.log.info("reconnecting, attempt: ".concat(this.reconnectAttempts),this.logContext),this.emit(M.Restarting),this.client.isDisconnected||(yield this.client.sendLeave()),yield this.cleanupPeerConnections(),yield this.cleanupClient();let s;try{if(!this.signalOpts)throw this.log.warn("attempted connection restart, without signal options present",this.logContext),new Pn;s=yield this.join(e??this.url,this.token,this.signalOpts)}catch(o){throw o instanceof W&&o.reason===0?new te("could not reconnect, token might be expired"):new Pn}if(this.shouldFailNext)throw this.shouldFailNext=!1,new Error("simulated failure");if(this.client.setReconnected(),this.emit(M.SignalRestarted,s),yield this.waitForPCReconnected(),this.client.currentState!==z.CONNECTED)throw new Pn("Signal connection got severed during reconnect");(t=this.regionUrlProvider)===null||t===void 0||t.resetAttempts(),this.emit(M.Restarted)}catch(s){const o=yield(i=this.regionUrlProvider)===null||i===void 0?void 0:i.getNextBestRegionUrl();if(o){yield this.restartConnection(o);return}else throw(r=this.regionUrlProvider)===null||r===void 0||r.resetAttempts(),s}})}resumeConnection(e){var t;return y(this,void 0,void 0,function*(){if(!this.url||!this.token)throw new te("could not reconnect, url or token not saved");if(!this.pcManager)throw new te("publisher and subscriber connections unset");this.log.info("resuming signal connection, attempt ".concat(this.reconnectAttempts),this.logContext),this.emit(M.Resuming);try{this.setupSignalClientCallbacks();const i=yield this.client.reconnect(this.url,this.token,this.participantSid,e);if(i){const r=this.makeRTCConfiguration(i);this.pcManager.updateConfiguration(r)}}catch(i){let r="";throw i instanceof Error&&(r=i.message,this.log.error(i.message,Object.assign(Object.assign({},this.logContext),{error:i}))),i instanceof W&&i.reason===0?new te("could not reconnect, token might be expired"):i instanceof W&&i.reason===4?i:new Pn(r)}if(this.emit(M.SignalResumed),this.shouldFailNext)throw this.shouldFailNext=!1,new Error("simulated failure");if(yield this.pcManager.triggerIceRestart(),yield this.waitForPCReconnected(),this.client.currentState!==z.CONNECTED)throw new Pn("Signal connection got severed during reconnect");this.client.setReconnected(),((t=this.reliableDC)===null||t===void 0?void 0:t.readyState)==="open"&&this.reliableDC.id===null&&this.createDataChannels(),this.emit(M.Resumed)})}waitForPCInitialConnection(e,t){return y(this,void 0,void 0,function*(){if(!this.pcManager)throw new te("PC manager is closed");yield this.pcManager.ensurePCTransportConnection(t,e)})}waitForPCReconnected(){return y(this,void 0,void 0,function*(){this.pcState=De.Reconnecting,this.log.debug("waiting for peer connection to reconnect",this.logContext);try{if(yield Gt(Ed),!this.pcManager)throw new te("PC manager is closed");yield this.pcManager.ensurePCTransportConnection(void 0,this.peerConnectionTimeout),this.pcState=De.Connected}catch(e){throw this.pcState=De.Disconnected,new W("could not establish PC connection, ".concat(e.message))}})}sendDataPacket(e,t){return y(this,void 0,void 0,function*(){const i=e.toBinary();yield this.ensurePublisherConnected(t);const r=this.dataChannelForKind(t);r&&r.send(i),this.updateAndEmitDCBufferStatus(t)})}ensureDataTransportConnected(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this.subscriberPrimary;var i;return y(this,void 0,void 0,function*(){if(!this.pcManager)throw new te("PC manager is closed");const r=t?this.pcManager.subscriber:this.pcManager.publisher,s=t?"Subscriber":"Publisher";if(!r)throw new W("".concat(s," connection not set"));!t&&!this.pcManager.publisher.isICEConnected&&this.pcManager.publisher.getICEConnectionState()!=="checking"&&this.negotiate();const o=this.dataChannelForKind(e,t);if((o==null?void 0:o.readyState)==="open")return;const a=new Date().getTime()+this.peerConnectionTimeout;for(;new Date().getTime()<a;){if(r.isICEConnected&&((i=this.dataChannelForKind(e,t))===null||i===void 0?void 0:i.readyState)==="open")return;yield Gt(50)}throw new W("could not establish ".concat(s," connection, state: ").concat(r.getICEConnectionState()))})}ensurePublisherConnected(e){return y(this,void 0,void 0,function*(){yield this.ensureDataTransportConnected(e,!1)})}verifyTransport(){return!(!this.pcManager||this.pcManager.currentState!==ne.CONNECTED||!this.client.ws||this.client.ws.readyState===WebSocket.CLOSED)}negotiate(){return y(this,void 0,void 0,function*(){return new Promise((e,t)=>y(this,void 0,void 0,function*(){if(!this.pcManager){t(new Ur("PC manager is closed"));return}this.pcManager.requirePublisher();const i=new AbortController,r=()=>{i.abort(),this.log.debug("engine disconnected while negotiation was ongoing",this.logContext),e()};this.isClosed&&t("cannot negotiate on closed engine"),this.on(M.Closing,r),this.pcManager.publisher.once(Mn.RTPVideoPayloadTypes,s=>{const o=new Map;s.forEach(a=>{const c=a.codec.toLowerCase();sd(c)&&o.set(a.payload,c)}),this.emit(M.RTPVideoMapUpdate,o)});try{yield this.pcManager.negotiate(i),e()}catch(s){s instanceof Ur&&(this.fullReconnectOnNext=!0),this.handleDisconnect("negotiation",vt.RR_UNKNOWN),t(s)}finally{this.off(M.Closing,r)}}))})}dataChannelForKind(e,t){if(t){if(e===oe.LOSSY)return this.lossyDCSub;if(e===oe.RELIABLE)return this.reliableDCSub}else{if(e===oe.LOSSY)return this.lossyDC;if(e===oe.RELIABLE)return this.reliableDC}}sendSyncState(e,t){var i,r;if(!this.pcManager){this.log.warn("sync state cannot be sent without peer connection setup",this.logContext);return}const s=this.pcManager.subscriber.getLocalDescription(),o=this.pcManager.subscriber.getRemoteDescription(),a=(r=(i=this.signalOpts)===null||i===void 0?void 0:i.autoSubscribe)!==null&&r!==void 0?r:!0,c=new Array;e.forEach(l=>{l.isDesired!==a&&c.push(l.trackSid)}),this.client.sendSyncState(new ct({answer:s?Ui({sdp:s.sdp,type:s.type}):void 0,offer:o?Ui({sdp:o.sdp,type:o.type}):void 0,subscription:new Ie({trackSids:c,subscribe:!a,participantTracks:[]}),publishTracks:zu(t),dataChannels:this.dataChannelsInfo()}))}failNext(){this.shouldFailNext=!0}dataChannelsInfo(){const e=[],t=(i,r)=>{(i==null?void 0:i.id)!==void 0&&i.id!==null&&e.push(new lt({label:i.label,id:i.id,target:r}))};return t(this.dataChannelForKind(oe.LOSSY),fe.PUBLISHER),t(this.dataChannelForKind(oe.RELIABLE),fe.PUBLISHER),t(this.dataChannelForKind(oe.LOSSY,!0),fe.SUBSCRIBER),t(this.dataChannelForKind(oe.RELIABLE,!0),fe.SUBSCRIBER),e}clearReconnectTimeout(){this.reconnectTimeout&&le.clearTimeout(this.reconnectTimeout)}clearPendingReconnect(){this.clearReconnectTimeout(),this.reconnectAttempts=0}registerOnLineListener(){Ce()&&window.addEventListener("online",this.handleBrowserOnLine)}deregisterOnLineListener(){Ce()&&window.removeEventListener("online",this.handleBrowserOnLine)}}class Pn extends Error{}class So{constructor(e,t){this.lastUpdateAt=0,this.settingsCacheTime=3e3,this.attemptedRegions=[],this.serverUrl=new URL(e),this.token=t}updateToken(e){this.token=e}isCloud(){return Vr(this.serverUrl)}getServerUrl(){return this.serverUrl}getNextBestRegionUrl(e){return y(this,void 0,void 0,function*(){if(!this.isCloud())throw Error("region availability is only supported for LiveKit Cloud domains");(!this.regionSettings||Date.now()-this.lastUpdateAt>this.settingsCacheTime)&&(this.regionSettings=yield this.fetchRegionSettings(e));const t=this.regionSettings.regions.filter(i=>!this.attemptedRegions.find(r=>r.url===i.url));if(t.length>0){const i=t[0];return this.attemptedRegions.push(i),U.debug("next region: ".concat(i.region)),i.url}else return null})}resetAttempts(){this.attemptedRegions=[]}fetchRegionSettings(e){return y(this,void 0,void 0,function*(){const t=yield fetch("".concat(xd(this.serverUrl),"/regions"),{headers:{authorization:"Bearer ".concat(this.token)},signal:e});if(t.ok){const i=yield t.json();return this.lastUpdateAt=Date.now(),i}else throw new W("Could not fetch region settings: ".concat(t.statusText),t.status===401?0:void 0,t.status)})}}function xd(n){return"".concat(n.protocol.replace("ws","http"),"//").concat(n.host,"/settings")}const ps=2e3;function Yi(n,e){if(!e)return 0;let t,i;return"bytesReceived"in n?(t=n.bytesReceived,i=e.bytesReceived):"bytesSent"in n&&(t=n.bytesSent,i=e.bytesSent),t===void 0||i===void 0||n.timestamp===void 0||e.timestamp===void 0?0:(t-i)*8*1e3/(n.timestamp-e.timestamp)}class Ee extends jn{constructor(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,r=arguments.length>3?arguments[3]:void 0,s=arguments.length>4?arguments[4]:void 0;super(e,C.Kind.Audio,t,i,s),this.stopOnMute=!1,this.monitorSender=()=>y(this,void 0,void 0,function*(){if(!this.sender){this._currentBitrate=0;return}let o;try{o=yield this.getSenderStats()}catch(a){this.log.error("could not get audio sender stats",Object.assign(Object.assign({},this.logContext),{error:a}));return}o&&this.prevStats&&(this._currentBitrate=Yi(o,this.prevStats)),this.prevStats=o}),this.audioContext=r,this.checkForSilence()}setDeviceId(e){return y(this,void 0,void 0,function*(){return this._constraints.deviceId===e?!0:(this._constraints.deviceId=e,this.isMuted||(yield this.restartTrack()),this.isMuted||mn(e)===this.mediaStreamTrack.getSettings().deviceId)})}mute(){const e=Object.create(null,{mute:{get:()=>super.mute}});return y(this,void 0,void 0,function*(){const t=yield this.muteLock.lock();try{return this.source===C.Source.Microphone&&this.stopOnMute&&!this.isUserProvided&&(this.log.debug("stopping mic track",this.logContext),this._mediaStreamTrack.stop()),yield e.mute.call(this),this}finally{t()}})}unmute(){const e=Object.create(null,{unmute:{get:()=>super.unmute}});return y(this,void 0,void 0,function*(){const t=yield this.muteLock.lock();try{const i=this._constraints.deviceId&&this._mediaStreamTrack.getSettings().deviceId!==mn(this._constraints.deviceId);return this.source===C.Source.Microphone&&(this.stopOnMute||this._mediaStreamTrack.readyState==="ended"||i)&&!this.isUserProvided&&(this.log.debug("reacquiring mic track",this.logContext),yield this.restartTrack()),yield e.unmute.call(this),this}finally{t()}})}restartTrack(e){return y(this,void 0,void 0,function*(){let t;if(e){const i=$i({audio:e});typeof i.audio!="boolean"&&(t=i.audio)}yield this.restart(t)})}restart(e){const t=Object.create(null,{restart:{get:()=>super.restart}});return y(this,void 0,void 0,function*(){const i=yield t.restart.call(this,e);return this.checkForSilence(),i})}startMonitor(){Ce()&&(this.monitorInterval||(this.monitorInterval=setInterval(()=>{this.monitorSender()},ps)))}setProcessor(e){var t;return y(this,void 0,void 0,function*(){const i=yield this.processorLock.lock();try{if(!this.audioContext)throw Error("Audio context needs to be set on LocalAudioTrack in order to enable processors");if(this.processor&&(yield this.stopProcessor()),this.kind==="unknown")throw TypeError("cannot set processor on track of unknown kind");const r={kind:this.kind,track:this._mediaStreamTrack,audioContext:this.audioContext};this.log.debug("setting up audio processor ".concat(e.name),this.logContext),yield e.init(r),this.processor=e,this.processor.processedTrack&&(yield(t=this.sender)===null||t===void 0?void 0:t.replaceTrack(this.processor.processedTrack))}finally{i()}})}setAudioContext(e){this.audioContext=e}getSenderStats(){var e;return y(this,void 0,void 0,function*(){if(!(!((e=this.sender)===null||e===void 0)&&e.getStats))return;const t=yield this.sender.getStats();let i;return t.forEach(r=>{r.type==="outbound-rtp"&&(i={type:"audio",streamId:r.id,packetsSent:r.packetsSent,packetsLost:r.packetsLost,bytesSent:r.bytesSent,timestamp:r.timestamp,roundTripTime:r.roundTripTime,jitter:r.jitter})}),i})}checkForSilence(){return y(this,void 0,void 0,function*(){const e=yield Wu(this);return e&&(this.isMuted||this.log.warn("silence detected on local audio track",this.logContext),this.emit(R.AudioSilenceDetected)),e})}}function dc(n,e,t){switch(n.kind){case"audio":return new Ee(n,e,!1,void 0,t);case"video":return new Oe(n,e,!1,t);default:throw new ze("unsupported track type: ".concat(n.kind))}}const Od=Object.values(li),Rd=Object.values(Fr),Id=Object.values(us),_d=[li.h180,li.h360],Md=[Fr.h180,Fr.h360],Nd=n=>[{scaleResolutionDownBy:2,fps:n.encoding.maxFramerate}].map(t=>{var i,r;return new J(Math.floor(n.width/t.scaleResolutionDownBy),Math.floor(n.height/t.scaleResolutionDownBy),Math.max(15e4,Math.floor(n.encoding.maxBitrate/(Math.pow(t.scaleResolutionDownBy,2)*(((i=n.encoding.maxFramerate)!==null&&i!==void 0?i:30)/((r=t.fps)!==null&&r!==void 0?r:30))))),t.fps,n.encoding.priority)}),qr=["q","h","f"];function Wr(n,e,t,i){var r,s;let o=i==null?void 0:i.videoEncoding;n&&(o=i==null?void 0:i.screenShareEncoding);const a=i==null?void 0:i.simulcast,c=i==null?void 0:i.scalabilityMode,l=i==null?void 0:i.videoCodec;if(!o&&!a&&!c||!e||!t)return[{}];o||(o=Dd(n,e,t,l),U.debug("using video encoding",o));const u=new J(e,t,o.maxBitrate,o.maxFramerate,o.priority);if(c&&ri(l)){U.debug("using svc with scalabilityMode ".concat(c));const m=new hc(c),g=[];if(m.spatial>3)throw new Error("unsupported scalabilityMode: ".concat(c));for(let v=0;v<m.spatial;v+=1)g.push({rid:qr[2-v],maxBitrate:o.maxBitrate/Math.pow(3,v),maxFramerate:u.encoding.maxFramerate});return g[0].scalabilityMode=c,U.debug("encodings",g),g}if(!a)return[o];let d=[];n?d=(r=To(i==null?void 0:i.screenShareSimulcastLayers))!==null&&r!==void 0?r:Co(n,u):d=(s=To(i==null?void 0:i.videoSimulcastLayers))!==null&&s!==void 0?s:Co(n,u);let h;if(d.length>0){const m=d[0];d.length>1&&([,h]=d);const g=Math.max(e,t);if(g>=960&&h)return pr(e,t,[m,h,u]);if(g>=480)return pr(e,t,[m,u])}return pr(e,t,[u])}function Ad(n,e,t){var i,r,s,o;if(!t.backupCodec||t.backupCodec===!0||t.backupCodec.codec===t.videoCodec)return;e!==t.backupCodec.codec&&U.warn("requested a different codec than specified as backup",{serverRequested:e,backup:t.backupCodec.codec}),t.videoCodec=e,t.videoEncoding=t.backupCodec.encoding;const a=n.mediaStreamTrack.getSettings(),c=(i=a.width)!==null&&i!==void 0?i:(r=n.dimensions)===null||r===void 0?void 0:r.width,l=(s=a.height)!==null&&s!==void 0?s:(o=n.dimensions)===null||o===void 0?void 0:o.height;return Wr(n.source===C.Source.ScreenShare,c,l,t)}function Dd(n,e,t,i){const r=Ld(n,e,t);let{encoding:s}=r[0];const o=Math.max(e,t);for(let a=0;a<r.length;a+=1){const c=r[a];if(s=c.encoding,c.width>=o)break}if(i)switch(i){case"av1":s=Object.assign({},s),s.maxBitrate=s.maxBitrate*.7;break;case"vp9":s=Object.assign({},s),s.maxBitrate=s.maxBitrate*.85;break}return s}function Ld(n,e,t){if(n)return Id;const i=e>t?e/t:t/e;return Math.abs(i-16/9)<Math.abs(i-4/3)?Od:Rd}function Co(n,e){if(n)return Nd(e);const{width:t,height:i}=e,r=t>i?t/i:i/t;return Math.abs(r-16/9)<Math.abs(r-4/3)?_d:Md}function pr(n,e,t){const i=[];if(t.forEach((r,s)=>{if(s>=qr.length)return;const o=Math.min(n,e),c={rid:qr[s],scaleResolutionDownBy:Math.max(1,o/Math.min(r.width,r.height)),maxBitrate:r.encoding.maxBitrate};r.encoding.maxFramerate&&(c.maxFramerate=r.encoding.maxFramerate);const l=Bn()||s===0;r.encoding.priority&&l&&(c.priority=r.encoding.priority,c.networkPriority=r.encoding.priority),i.push(c)}),kn()&&rc()==="ios"){let r;i.forEach(o=>{r?o.maxFramerate&&o.maxFramerate>r&&(r=o.maxFramerate):r=o.maxFramerate});let s=!0;i.forEach(o=>{var a;o.maxFramerate!=r&&(s&&(s=!1,U.info("Simulcast on iOS React-Native requires all encodings to share the same framerate.")),U.info('Setting framerate of encoding "'.concat((a=o.rid)!==null&&a!==void 0?a:"",'" to ').concat(r)),o.maxFramerate=r)})}return i}function To(n){if(n)return n.sort((e,t)=>{const{encoding:i}=e,{encoding:r}=t;return i.maxBitrate>r.maxBitrate?1:i.maxBitrate<r.maxBitrate?-1:i.maxBitrate===r.maxBitrate&&i.maxFramerate&&r.maxFramerate?i.maxFramerate>r.maxFramerate?1:-1:0})}class hc{constructor(e){const t=e.match(/^L(\d)T(\d)(h|_KEY|_KEY_SHIFT){0,1}$/);if(!t)throw new Error("invalid scalability mode");if(this.spatial=parseInt(t[1]),this.temporal=parseInt(t[2]),t.length>3)switch(t[3]){case"h":case"_KEY":case"_KEY_SHIFT":this.suffix=t[3]}}toString(){var e;return"L".concat(this.spatial,"T").concat(this.temporal).concat((e=this.suffix)!==null&&e!==void 0?e:"")}}const Ud=5e3;class Oe extends jn{constructor(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,r=arguments.length>3?arguments[3]:void 0;super(e,C.Kind.Video,t,i,r),this.simulcastCodecs=new Map,this.monitorSender=()=>y(this,void 0,void 0,function*(){if(!this.sender){this._currentBitrate=0;return}let s;try{s=yield this.getSenderStats()}catch(a){this.log.error("could not get audio sender stats",Object.assign(Object.assign({},this.logContext),{error:a}));return}const o=new Map(s.map(a=>[a.rid,a]));if(this.prevStats){let a=0;o.forEach((c,l)=>{var u;const d=(u=this.prevStats)===null||u===void 0?void 0:u.get(l);a+=Yi(c,d)}),this._currentBitrate=a}this.prevStats=o}),this.senderLock=new Ge}get isSimulcast(){return!!(this.sender&&this.sender.getParameters().encodings.length>1)}startMonitor(e){var t;if(this.signalClient=e,!Ce())return;const i=(t=this.sender)===null||t===void 0?void 0:t.getParameters();i&&(this.encodings=i.encodings),!this.monitorInterval&&(this.monitorInterval=setInterval(()=>{this.monitorSender()},ps))}stop(){this._mediaStreamTrack.getConstraints(),this.simulcastCodecs.forEach(e=>{e.mediaStreamTrack.stop()}),super.stop()}pauseUpstream(){const e=Object.create(null,{pauseUpstream:{get:()=>super.pauseUpstream}});var t,i,r,s,o;return y(this,void 0,void 0,function*(){yield e.pauseUpstream.call(this);try{for(var a=!0,c=xn(this.simulcastCodecs.values()),l;l=yield c.next(),t=l.done,!t;a=!0)s=l.value,a=!1,yield(o=s.sender)===null||o===void 0?void 0:o.replaceTrack(null)}catch(u){i={error:u}}finally{try{!a&&!t&&(r=c.return)&&(yield r.call(c))}finally{if(i)throw i.error}}})}resumeUpstream(){const e=Object.create(null,{resumeUpstream:{get:()=>super.resumeUpstream}});var t,i,r,s,o;return y(this,void 0,void 0,function*(){yield e.resumeUpstream.call(this);try{for(var a=!0,c=xn(this.simulcastCodecs.values()),l;l=yield c.next(),t=l.done,!t;a=!0){s=l.value,a=!1;const u=s;yield(o=u.sender)===null||o===void 0?void 0:o.replaceTrack(u.mediaStreamTrack)}}catch(u){i={error:u}}finally{try{!a&&!t&&(r=c.return)&&(yield r.call(c))}finally{if(i)throw i.error}}})}mute(){const e=Object.create(null,{mute:{get:()=>super.mute}});return y(this,void 0,void 0,function*(){const t=yield this.muteLock.lock();try{return this.source===C.Source.Camera&&!this.isUserProvided&&(this.log.debug("stopping camera track",this.logContext),this._mediaStreamTrack.stop()),yield e.mute.call(this),this}finally{t()}})}unmute(){const e=Object.create(null,{unmute:{get:()=>super.unmute}});return y(this,void 0,void 0,function*(){const t=yield this.muteLock.lock();try{return this.source===C.Source.Camera&&!this.isUserProvided&&(this.log.debug("reacquiring camera track",this.logContext),yield this.restartTrack()),yield e.unmute.call(this),this}finally{t()}})}setTrackMuted(e){super.setTrackMuted(e);for(const t of this.simulcastCodecs.values())t.mediaStreamTrack.enabled=!e}getSenderStats(){var e;return y(this,void 0,void 0,function*(){if(!(!((e=this.sender)===null||e===void 0)&&e.getStats))return[];const t=[],i=yield this.sender.getStats();return i.forEach(r=>{var s;if(r.type==="outbound-rtp"){const o={type:"video",streamId:r.id,frameHeight:r.frameHeight,frameWidth:r.frameWidth,firCount:r.firCount,pliCount:r.pliCount,nackCount:r.nackCount,packetsSent:r.packetsSent,bytesSent:r.bytesSent,framesSent:r.framesSent,timestamp:r.timestamp,rid:(s=r.rid)!==null&&s!==void 0?s:r.id,retransmittedPacketsSent:r.retransmittedPacketsSent,qualityLimitationReason:r.qualityLimitationReason,qualityLimitationResolutionChanges:r.qualityLimitationResolutionChanges},a=i.get(r.remoteId);a&&(o.jitter=a.jitter,o.packetsLost=a.packetsLost,o.roundTripTime=a.roundTripTime),t.push(o)}}),t})}setPublishingQuality(e){const t=[];for(let i=ie.LOW;i<=ie.HIGH;i+=1)t.push(new We({quality:i,enabled:i<=e}));this.log.debug("setting publishing quality. max quality ".concat(e),this.logContext),this.setPublishingLayers(t)}setDeviceId(e){return y(this,void 0,void 0,function*(){return this._constraints.deviceId===e&&this._mediaStreamTrack.getSettings().deviceId===mn(e)?!0:(this._constraints.deviceId=e,this.isMuted||(yield this.restartTrack()),this.isMuted||mn(e)===this._mediaStreamTrack.getSettings().deviceId)})}restartTrack(e){var t,i,r,s;return y(this,void 0,void 0,function*(){let o;if(e){const u=$i({video:e});typeof u.video!="boolean"&&(o=u.video)}yield this.restart(o);try{for(var a=!0,c=xn(this.simulcastCodecs.values()),l;l=yield c.next(),t=l.done,!t;a=!0){s=l.value,a=!1;const u=s;u.sender&&(u.mediaStreamTrack=this.mediaStreamTrack.clone(),yield u.sender.replaceTrack(u.mediaStreamTrack))}}catch(u){i={error:u}}finally{try{!a&&!t&&(r=c.return)&&(yield r.call(c))}finally{if(i)throw i.error}}})}setProcessor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;const i=Object.create(null,{setProcessor:{get:()=>super.setProcessor}});var r,s,o,a,c,l;return y(this,void 0,void 0,function*(){if(yield i.setProcessor.call(this,e,t),!((c=this.processor)===null||c===void 0)&&c.processedTrack)try{for(var u=!0,d=xn(this.simulcastCodecs.values()),h;h=yield d.next(),r=h.done,!r;u=!0)a=h.value,u=!1,yield(l=a.sender)===null||l===void 0?void 0:l.replaceTrack(this.processor.processedTrack)}catch(m){s={error:m}}finally{try{!u&&!r&&(o=d.return)&&(yield o.call(d))}finally{if(s)throw s.error}}})}addSimulcastTrack(e,t){if(this.simulcastCodecs.has(e))throw new Error("".concat(e," already added"));const i={codec:e,mediaStreamTrack:this.mediaStreamTrack.clone(),sender:void 0,encodings:t};return this.simulcastCodecs.set(e,i),i}setSimulcastTrackSender(e,t){const i=this.simulcastCodecs.get(e);i&&(i.sender=t,setTimeout(()=>{this.subscribedCodecs&&this.setPublishingCodecs(this.subscribedCodecs)},Ud))}setPublishingCodecs(e){var t,i,r,s,o,a,c;return y(this,void 0,void 0,function*(){if(this.log.debug("setting publishing codecs",Object.assign(Object.assign({},this.logContext),{codecs:e,currentCodec:this.codec})),!this.codec&&e.length>0)return yield this.setPublishingLayers(e[0].qualities),[];this.subscribedCodecs=e;const l=[];try{for(t=!0,i=xn(e);r=yield i.next(),s=r.done,!s;t=!0){c=r.value,t=!1;const u=c;if(!this.codec||this.codec===u.codec)yield this.setPublishingLayers(u.qualities);else{const d=this.simulcastCodecs.get(u.codec);if(this.log.debug("try setPublishingCodec for ".concat(u.codec),Object.assign(Object.assign({},this.logContext),{simulcastCodecInfo:d})),!d||!d.sender){for(const h of u.qualities)if(h.enabled){l.push(u.codec);break}}else d.encodings&&(this.log.debug("try setPublishingLayersForSender ".concat(u.codec),this.logContext),yield wo(d.sender,d.encodings,u.qualities,this.senderLock,this.log,this.logContext))}}}catch(u){o={error:u}}finally{try{!t&&!s&&(a=i.return)&&(yield a.call(i))}finally{if(o)throw o.error}}return l})}setPublishingLayers(e){return y(this,void 0,void 0,function*(){this.log.debug("setting publishing layers",Object.assign(Object.assign({},this.logContext),{qualities:e})),!(!this.sender||!this.encodings)&&(yield wo(this.sender,this.encodings,e,this.senderLock,this.log,this.logContext))})}handleAppVisibilityChanged(){const e=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return y(this,void 0,void 0,function*(){yield e.handleAppVisibilityChanged.call(this),nc()&&this.isInBackground&&this.source===C.Source.Camera&&(this._mediaStreamTrack.enabled=!1)})}}function wo(n,e,t,i,r,s){return y(this,void 0,void 0,function*(){const o=yield i.lock();r.debug("setPublishingLayersForSender",Object.assign(Object.assign({},s),{sender:n,qualities:t,senderEncodings:e}));try{const a=n.getParameters(),{encodings:c}=a;if(!c)return;if(c.length!==e.length){r.warn("cannot set publishing layers, encodings mismatch");return}let l=!1;!1&&c[0].scalabilityMode||c.forEach((d,h)=>{var m;let g=(m=d.rid)!==null&&m!==void 0?m:"";g===""&&(g="q");const v=fc(g),b=t.find(k=>k.quality===v);b&&d.active!==b.enabled&&(l=!0,d.active=b.enabled,r.debug("setting layer ".concat(b.quality," to ").concat(d.active?"enabled":"disabled"),s),Bn()&&(b.enabled?(d.scaleResolutionDownBy=e[h].scaleResolutionDownBy,d.maxBitrate=e[h].maxBitrate,d.maxFrameRate=e[h].maxFrameRate):(d.scaleResolutionDownBy=4,d.maxBitrate=10,d.maxFrameRate=2)))}),l&&(a.encodings=c,r.debug("setting encodings",Object.assign(Object.assign({},s),{encodings:a.encodings})),yield n.setParameters(a))}finally{o()}})}function fc(n){switch(n){case"f":return ie.HIGH;case"h":return ie.MEDIUM;case"q":return ie.LOW;default:return ie.HIGH}}function Eo(n,e,t,i){if(!t)return[new be({quality:ie.HIGH,width:n,height:e,bitrate:0,ssrc:0})];if(i){const r=t[0].scalabilityMode,s=new hc(r),o=[];for(let a=0;a<s.spatial;a+=1)o.push(new be({quality:ie.HIGH-a,width:Math.ceil(n/Math.pow(2,a)),height:Math.ceil(e/Math.pow(2,a)),bitrate:t[0].maxBitrate?Math.ceil(t[0].maxBitrate/Math.pow(3,a)):0,ssrc:0}));return o}return t.map(r=>{var s,o,a;const c=(s=r.scaleResolutionDownBy)!==null&&s!==void 0?s:1;let l=fc((o=r.rid)!==null&&o!==void 0?o:"");return new be({quality:l,width:Math.ceil(n/c),height:Math.ceil(e/c),bitrate:(a=r.maxBitrate)!==null&&a!==void 0?a:0,ssrc:0})})}class pc extends C{constructor(e,t,i,r,s){super(e,i,s),this.sid=t,this.receiver=r}setMuted(e){this.isMuted!==e&&(this.isMuted=e,this._mediaStreamTrack.enabled=!e,this.emit(e?R.Muted:R.Unmuted,this))}setMediaStream(e){this.mediaStream=e;const t=i=>{i.track===this._mediaStreamTrack&&(e.removeEventListener("removetrack",t),this.receiver=void 0,this._currentBitrate=0,this.emit(R.Ended,this))};e.addEventListener("removetrack",t)}start(){this.startMonitor(),super.enable()}stop(){this.stopMonitor(),super.disable()}getRTCStatsReport(){var e;return y(this,void 0,void 0,function*(){return!((e=this.receiver)===null||e===void 0)&&e.getStats?yield this.receiver.getStats():void 0})}startMonitor(){this.monitorInterval||(this.monitorInterval=setInterval(()=>this.monitorReceiver(),ps))}}class Nn extends pc{constructor(e,t,i,r,s,o){super(e,t,C.Kind.Audio,i,o),this.monitorReceiver=()=>y(this,void 0,void 0,function*(){if(!this.receiver){this._currentBitrate=0;return}const a=yield this.getReceiverStats();a&&this.prevStats&&this.receiver&&(this._currentBitrate=Yi(a,this.prevStats)),this.prevStats=a}),this.audioContext=r,this.webAudioPluginNodes=[],s&&(this.sinkId=s.deviceId)}setVolume(e){var t;for(const i of this.attachedElements)this.audioContext?(t=this.gainNode)===null||t===void 0||t.gain.setTargetAtTime(e,0,.1):i.volume=e;kn()&&this._mediaStreamTrack._setVolume(e),this.elementVolume=e}getVolume(){if(this.elementVolume)return this.elementVolume;if(kn())return 1;let e=0;return this.attachedElements.forEach(t=>{t.volume>e&&(e=t.volume)}),e}setSinkId(e){return y(this,void 0,void 0,function*(){this.sinkId=e,yield Promise.all(this.attachedElements.map(t=>{if(jr(t))return t.setSinkId(e)}))})}attach(e){const t=this.attachedElements.length===0;return e?super.attach(e):e=super.attach(),this.sinkId&&jr(e)&&e.setSinkId(this.sinkId),this.audioContext&&t&&(this.log.debug("using audio context mapping",this.logContext),this.connectWebAudio(this.audioContext,e),e.volume=0,e.muted=!0),this.elementVolume&&this.setVolume(this.elementVolume),e}detach(e){let t;return e?(t=super.detach(e),this.audioContext&&(this.attachedElements.length>0?this.connectWebAudio(this.audioContext,this.attachedElements[0]):this.disconnectWebAudio())):(t=super.detach(),this.disconnectWebAudio()),t}setAudioContext(e){this.audioContext=e,e&&this.attachedElements.length>0?this.connectWebAudio(e,this.attachedElements[0]):e||this.disconnectWebAudio()}setWebAudioPlugins(e){this.webAudioPluginNodes=e,this.attachedElements.length>0&&this.audioContext&&this.connectWebAudio(this.audioContext,this.attachedElements[0])}connectWebAudio(e,t){this.disconnectWebAudio(),this.sourceNode=e.createMediaStreamSource(t.srcObject);let i=this.sourceNode;this.webAudioPluginNodes.forEach(r=>{i.connect(r),i=r}),this.gainNode=e.createGain(),i.connect(this.gainNode),this.gainNode.connect(e.destination),this.elementVolume&&this.gainNode.gain.setTargetAtTime(this.elementVolume,0,.1),e.state!=="running"&&e.resume().then(()=>{e.state!=="running"&&this.emit(R.AudioPlaybackFailed,new Error("Audio Context couldn't be started automatically"))}).catch(r=>{this.emit(R.AudioPlaybackFailed,r)})}disconnectWebAudio(){var e,t;(e=this.gainNode)===null||e===void 0||e.disconnect(),(t=this.sourceNode)===null||t===void 0||t.disconnect(),this.gainNode=void 0,this.sourceNode=void 0}getReceiverStats(){return y(this,void 0,void 0,function*(){if(!this.receiver||!this.receiver.getStats)return;const e=yield this.receiver.getStats();let t;return e.forEach(i=>{i.type==="inbound-rtp"&&(t={type:"audio",timestamp:i.timestamp,jitter:i.jitter,bytesReceived:i.bytesReceived,concealedSamples:i.concealedSamples,concealmentEvents:i.concealmentEvents,silentConcealedSamples:i.silentConcealedSamples,silentConcealmentEvents:i.silentConcealmentEvents,totalAudioEnergy:i.totalAudioEnergy,totalSamplesDuration:i.totalSamplesDuration})}),t})}}const mr=100;class oi extends pc{constructor(e,t,i,r,s){super(e,t,C.Kind.Video,i,s),this.elementInfos=[],this.monitorReceiver=()=>y(this,void 0,void 0,function*(){if(!this.receiver){this._currentBitrate=0;return}const o=yield this.getReceiverStats();o&&this.prevStats&&this.receiver&&(this._currentBitrate=Yi(o,this.prevStats)),this.prevStats=o}),this.debouncedHandleResize=ls(()=>{this.updateDimensions()},mr),this.adaptiveStreamSettings=r}get isAdaptiveStream(){return this.adaptiveStreamSettings!==void 0}get mediaStreamTrack(){return this._mediaStreamTrack}setMuted(e){super.setMuted(e),this.attachedElements.forEach(t=>{e?_n(this._mediaStreamTrack,t):On(this._mediaStreamTrack,t)})}attach(e){if(e?super.attach(e):e=super.attach(),this.adaptiveStreamSettings&&this.elementInfos.find(t=>t.element===e)===void 0){const t=new Fd(e);this.observeElementInfo(t)}return e}observeElementInfo(e){this.adaptiveStreamSettings&&this.elementInfos.find(t=>t===e)===void 0?(e.handleResize=()=>{this.debouncedHandleResize()},e.handleVisibilityChanged=()=>{this.updateVisibility()},this.elementInfos.push(e),e.observe(),this.debouncedHandleResize(),this.updateVisibility()):this.log.warn("visibility resize observer not triggered",this.logContext)}stopObservingElementInfo(e){if(!this.isAdaptiveStream){this.log.warn("stopObservingElementInfo ignored",this.logContext);return}const t=this.elementInfos.filter(i=>i===e);for(const i of t)i.stopObserving();this.elementInfos=this.elementInfos.filter(i=>i!==e),this.updateVisibility(),this.debouncedHandleResize()}detach(e){let t=[];if(e)return this.stopObservingElement(e),super.detach(e);t=super.detach();for(const i of t)this.stopObservingElement(i);return t}getDecoderImplementation(){var e;return(e=this.prevStats)===null||e===void 0?void 0:e.decoderImplementation}getReceiverStats(){return y(this,void 0,void 0,function*(){if(!this.receiver||!this.receiver.getStats)return;const e=yield this.receiver.getStats();let t,i="",r=new Map;return e.forEach(s=>{s.type==="inbound-rtp"?(i=s.codecId,t={type:"video",framesDecoded:s.framesDecoded,framesDropped:s.framesDropped,framesReceived:s.framesReceived,packetsReceived:s.packetsReceived,packetsLost:s.packetsLost,frameWidth:s.frameWidth,frameHeight:s.frameHeight,pliCount:s.pliCount,firCount:s.firCount,nackCount:s.nackCount,jitter:s.jitter,timestamp:s.timestamp,bytesReceived:s.bytesReceived,decoderImplementation:s.decoderImplementation}):s.type==="codec"&&r.set(s.id,s)}),t&&i!==""&&r.get(i)&&(t.mimeType=r.get(i).mimeType),t})}stopObservingElement(e){const t=this.elementInfos.filter(i=>i.element===e);for(const i of t)this.stopObservingElementInfo(i)}handleAppVisibilityChanged(){const e=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return y(this,void 0,void 0,function*(){yield e.handleAppVisibilityChanged.call(this),this.isAdaptiveStream&&this.updateVisibility()})}updateVisibility(){var e,t;const i=this.elementInfos.reduce((a,c)=>Math.max(a,c.visibilityChangedAt||0),0),r=!((t=(e=this.adaptiveStreamSettings)===null||e===void 0?void 0:e.pauseVideoInBackground)!==null&&t!==void 0)||t?this.isInBackground:!1,s=this.elementInfos.some(a=>a.pictureInPicture),o=this.elementInfos.some(a=>a.visible)&&!r||s;if(this.lastVisible!==o){if(!o&&Date.now()-i<mr){le.setTimeout(()=>{this.updateVisibility()},mr);return}this.lastVisible=o,this.emit(R.VisibilityChanged,o,this)}}updateDimensions(){var e,t;let i=0,r=0;const s=this.getPixelDensity();for(const o of this.elementInfos){const a=o.width()*s,c=o.height()*s;a+c>i+r&&(i=a,r=c)}((e=this.lastDimensions)===null||e===void 0?void 0:e.width)===i&&((t=this.lastDimensions)===null||t===void 0?void 0:t.height)===r||(this.lastDimensions={width:i,height:r},this.emit(R.VideoDimensionsChanged,this.lastDimensions,this))}getPixelDensity(){var e;const t=(e=this.adaptiveStreamSettings)===null||e===void 0?void 0:e.pixelDensity;return t==="screen"?oo():t||(oo()>2?2:1)}}class Fd{get visible(){return this.isPiP||this.isIntersecting}get pictureInPicture(){return this.isPiP}constructor(e,t){this.onVisibilityChanged=i=>{var r;const{target:s,isIntersecting:o}=i;s===this.element&&(this.isIntersecting=o,this.visibilityChangedAt=Date.now(),(r=this.handleVisibilityChanged)===null||r===void 0||r.call(this))},this.onEnterPiP=()=>{var i;this.isPiP=!0,(i=this.handleVisibilityChanged)===null||i===void 0||i.call(this)},this.onLeavePiP=()=>{var i;this.isPiP=!1,(i=this.handleVisibilityChanged)===null||i===void 0||i.call(this)},this.element=e,this.isIntersecting=t??Po(e),this.isPiP=Ce()&&document.pictureInPictureElement===e,this.visibilityChangedAt=0}width(){return this.element.clientWidth}height(){return this.element.clientHeight}observe(){this.isIntersecting=Po(this.element),this.isPiP=document.pictureInPictureElement===this.element,this.element.handleResize=()=>{var e;(e=this.handleResize)===null||e===void 0||e.call(this)},this.element.handleVisibilityChanged=this.onVisibilityChanged,co().observe(this.element),ao().observe(this.element),this.element.addEventListener("enterpictureinpicture",this.onEnterPiP),this.element.addEventListener("leavepictureinpicture",this.onLeavePiP)}stopObserving(){var e,t;(e=co())===null||e===void 0||e.unobserve(this.element),(t=ao())===null||t===void 0||t.unobserve(this.element),this.element.removeEventListener("enterpictureinpicture",this.onEnterPiP),this.element.removeEventListener("leavepictureinpicture",this.onLeavePiP)}}function Po(n){let e=n.offsetTop,t=n.offsetLeft;const i=n.offsetWidth,r=n.offsetHeight,{hidden:s}=n,{opacity:o,display:a}=getComputedStyle(n);for(;n.offsetParent;)n=n.offsetParent,e+=n.offsetTop,t+=n.offsetLeft;return e<window.pageYOffset+window.innerHeight&&t<window.pageXOffset+window.innerWidth&&e+r>window.pageYOffset&&t+i>window.pageXOffset&&!s&&(o!==""?parseFloat(o)>0:!0)&&a!=="none"}class bt extends ft.EventEmitter{constructor(e,t,i,r){var s;super(),this.metadataMuted=!1,this.encryption=ce.NONE,this.log=U,this.handleMuted=()=>{this.emit(R.Muted)},this.handleUnmuted=()=>{this.emit(R.Unmuted)},this.log=zt((s=r==null?void 0:r.loggerName)!==null&&s!==void 0?s:dt.Publication),this.loggerContextCb=this.loggerContextCb,this.setMaxListeners(100),this.kind=e,this.trackSid=t,this.trackName=i,this.source=C.Source.Unknown}setTrack(e){this.track&&(this.track.off(R.Muted,this.handleMuted),this.track.off(R.Unmuted,this.handleUnmuted)),this.track=e,e&&(e.on(R.Muted,this.handleMuted),e.on(R.Unmuted,this.handleUnmuted))}get logContext(){var e;return Object.assign(Object.assign({},(e=this.loggerContextCb)===null||e===void 0?void 0:e.call(this)),H(this))}get isMuted(){return this.metadataMuted}get isEnabled(){return!0}get isSubscribed(){return this.track!==void 0}get isEncrypted(){return this.encryption!==ce.NONE}get audioTrack(){if(this.track instanceof Ee||this.track instanceof Nn)return this.track}get videoTrack(){if(this.track instanceof Oe||this.track instanceof oi)return this.track}updateInfo(e){this.trackSid=e.sid,this.trackName=e.name,this.source=C.sourceFromProto(e.source),this.mimeType=e.mimeType,this.kind===C.Kind.Video&&e.width>0&&(this.dimensions={width:e.width,height:e.height},this.simulcasted=e.simulcast),this.encryption=e.encryption,this.trackInfo=e,this.log.debug("update publication info",Object.assign(Object.assign({},this.logContext),{info:e}))}}(function(n){(function(e){e.Desired="desired",e.Subscribed="subscribed",e.Unsubscribed="unsubscribed"})(n.SubscriptionStatus||(n.SubscriptionStatus={})),function(e){e.Allowed="allowed",e.NotAllowed="not_allowed"}(n.PermissionStatus||(n.PermissionStatus={}))})(bt||(bt={}));class ui extends bt{get isUpstreamPaused(){var e;return(e=this.track)===null||e===void 0?void 0:e.isUpstreamPaused}constructor(e,t,i,r){super(e,t.sid,t.name,r),this.track=void 0,this.handleTrackEnded=()=>{this.emit(R.Ended)},this.updateInfo(t),this.setTrack(i)}setTrack(e){this.track&&this.track.off(R.Ended,this.handleTrackEnded),super.setTrack(e),e&&e.on(R.Ended,this.handleTrackEnded)}get isMuted(){return this.track?this.track.isMuted:super.isMuted}get audioTrack(){return super.audioTrack}get videoTrack(){return super.videoTrack}mute(){var e;return y(this,void 0,void 0,function*(){return(e=this.track)===null||e===void 0?void 0:e.mute()})}unmute(){var e;return y(this,void 0,void 0,function*(){return(e=this.track)===null||e===void 0?void 0:e.unmute()})}pauseUpstream(){var e;return y(this,void 0,void 0,function*(){yield(e=this.track)===null||e===void 0?void 0:e.pauseUpstream()})}resumeUpstream(){var e;return y(this,void 0,void 0,function*(){yield(e=this.track)===null||e===void 0?void 0:e.resumeUpstream()})}}var Re;(function(n){n.Excellent="excellent",n.Good="good",n.Poor="poor",n.Lost="lost",n.Unknown="unknown"})(Re||(Re={}));function Bd(n){switch(n){case kt.EXCELLENT:return Re.Excellent;case kt.GOOD:return Re.Good;case kt.POOR:return Re.Poor;case kt.LOST:return Re.Lost;default:return Re.Unknown}}class mc extends ft.EventEmitter{get logContext(){var e,t;return Object.assign(Object.assign({},(t=(e=this.loggerOptions)===null||e===void 0?void 0:e.loggerContextCb)===null||t===void 0?void 0:t.call(e)),{participantSid:this.sid,participantId:this.identity})}get isEncrypted(){return this.tracks.size>0&&Array.from(this.tracks.values()).every(e=>e.isEncrypted)}get isAgent(){var e,t;return(t=(e=this.permissions)===null||e===void 0?void 0:e.agent)!==null&&t!==void 0?t:!1}constructor(e,t,i,r,s){var o;super(),this.audioLevel=0,this.isSpeaking=!1,this._connectionQuality=Re.Unknown,this.log=U,this.log=zt((o=s==null?void 0:s.loggerName)!==null&&o!==void 0?o:dt.Participant),this.loggerOptions=s,this.setMaxListeners(100),this.sid=e,this.identity=t,this.name=i,this.metadata=r,this.audioTracks=new Map,this.videoTracks=new Map,this.tracks=new Map}getTracks(){return Array.from(this.tracks.values())}getTrack(e){for(const[,t]of this.tracks)if(t.source===e)return t}getTrackByName(e){for(const[,t]of this.tracks)if(t.trackName===e)return t}get connectionQuality(){return this._connectionQuality}get isCameraEnabled(){var e;const t=this.getTrack(C.Source.Camera);return!(!((e=t==null?void 0:t.isMuted)!==null&&e!==void 0)||e)}get isMicrophoneEnabled(){var e;const t=this.getTrack(C.Source.Microphone);return!(!((e=t==null?void 0:t.isMuted)!==null&&e!==void 0)||e)}get isScreenShareEnabled(){return!!this.getTrack(C.Source.ScreenShare)}get isLocal(){return!1}get joinedAt(){return this.participantInfo?new Date(Number.parseInt(this.participantInfo.joinedAt.toString())*1e3):new Date}updateInfo(e){return this.participantInfo&&this.participantInfo.sid===e.sid&&this.participantInfo.version>e.version?!1:(this.identity=e.identity,this.sid=e.sid,this._setName(e.name),this._setMetadata(e.metadata),e.permission&&this.setPermissions(e.permission),this.participantInfo=e,this.log.trace("update participant info",Object.assign(Object.assign({},this.logContext),{info:e})),!0)}_setMetadata(e){const t=this.metadata!==e,i=this.metadata;this.metadata=e,t&&this.emit(E.ParticipantMetadataChanged,i)}_setName(e){const t=this.name!==e;this.name=e,t&&this.emit(E.ParticipantNameChanged,e)}setPermissions(e){var t,i,r,s,o;const a=this.permissions,c=e.canPublish!==((t=this.permissions)===null||t===void 0?void 0:t.canPublish)||e.canSubscribe!==((i=this.permissions)===null||i===void 0?void 0:i.canSubscribe)||e.canPublishData!==((r=this.permissions)===null||r===void 0?void 0:r.canPublishData)||e.hidden!==((s=this.permissions)===null||s===void 0?void 0:s.hidden)||e.recorder!==((o=this.permissions)===null||o===void 0?void 0:o.recorder)||e.canPublishSources.length!==this.permissions.canPublishSources.length||e.canPublishSources.some((l,u)=>{var d;return l!==((d=this.permissions)===null||d===void 0?void 0:d.canPublishSources[u])});return this.permissions=e,c&&this.emit(E.ParticipantPermissionsChanged,a),c}setIsSpeaking(e){e!==this.isSpeaking&&(this.isSpeaking=e,e&&(this.lastSpokeAt=new Date),this.emit(E.IsSpeakingChanged,e))}setConnectionQuality(e){const t=this._connectionQuality;this._connectionQuality=Bd(e),t!==this._connectionQuality&&this.emit(E.ConnectionQualityChanged,this._connectionQuality)}setAudioContext(e){this.audioContext=e,this.audioTracks.forEach(t=>(t.track instanceof Nn||t.track instanceof Ee)&&t.track.setAudioContext(e))}addTrackPublication(e){e.on(R.Muted,()=>{this.emit(E.TrackMuted,e)}),e.on(R.Unmuted,()=>{this.emit(E.TrackUnmuted,e)});const t=e;switch(t.track&&(t.track.sid=e.trackSid),this.tracks.set(e.trackSid,e),e.kind){case C.Kind.Audio:this.audioTracks.set(e.trackSid,e);break;case C.Kind.Video:this.videoTracks.set(e.trackSid,e);break}}}function jd(n){var e,t,i;if(!n.participantSid&&!n.participantIdentity)throw new Error("Invalid track permission, must provide at least one of participantIdentity and participantSid");return new ot({participantIdentity:(e=n.participantIdentity)!==null&&e!==void 0?e:"",participantSid:(t=n.participantSid)!==null&&t!==void 0?t:"",allTracks:(i=n.allowAll)!==null&&i!==void 0?i:!1,trackSids:n.allowedTrackSids||[]})}class di extends bt{constructor(e,t,i,r){super(e,t.sid,t.name,r),this.track=void 0,this.allowed=!0,this.disabled=!1,this.currentVideoQuality=ie.HIGH,this.handleEnded=s=>{this.setTrack(void 0),this.emit(R.Ended,s)},this.handleVisibilityChange=s=>{this.log.debug("adaptivestream video visibility ".concat(this.trackSid,", visible=").concat(s),this.logContext),this.disabled=!s,this.emitTrackUpdate()},this.handleVideoDimensionsChange=s=>{this.log.debug("adaptivestream video dimensions ".concat(s.width,"x").concat(s.height),this.logContext),this.videoDimensions=s,this.emitTrackUpdate()},this.subscribed=i,this.updateInfo(t)}setSubscribed(e){const t=this.subscriptionStatus,i=this.permissionStatus;this.subscribed=e,e&&(this.allowed=!0);const r=new Ie({trackSids:[this.trackSid],subscribe:this.subscribed,participantTracks:[new Qe({participantSid:"",trackSids:[this.trackSid]})]});this.emit(R.UpdateSubscription,r),this.emitSubscriptionUpdateIfChanged(t),this.emitPermissionUpdateIfChanged(i)}get subscriptionStatus(){return this.subscribed===!1?bt.SubscriptionStatus.Unsubscribed:super.isSubscribed?bt.SubscriptionStatus.Subscribed:bt.SubscriptionStatus.Desired}get permissionStatus(){return this.allowed?bt.PermissionStatus.Allowed:bt.PermissionStatus.NotAllowed}get isSubscribed(){return this.subscribed===!1?!1:super.isSubscribed}get isDesired(){return this.subscribed!==!1}get isEnabled(){return!this.disabled}setEnabled(e){!this.isManualOperationAllowed()||this.disabled===!e||(this.disabled=!e,this.emitTrackUpdate())}setVideoQuality(e){!this.isManualOperationAllowed()||this.currentVideoQuality===e||(this.currentVideoQuality=e,this.videoDimensions=void 0,this.emitTrackUpdate())}setVideoDimensions(e){var t,i;this.isManualOperationAllowed()&&(((t=this.videoDimensions)===null||t===void 0?void 0:t.width)===e.width&&((i=this.videoDimensions)===null||i===void 0?void 0:i.height)===e.height||(this.track instanceof oi&&(this.videoDimensions=e),this.currentVideoQuality=void 0,this.emitTrackUpdate()))}setVideoFPS(e){this.isManualOperationAllowed()&&this.track instanceof oi&&this.fps!==e&&(this.fps=e,this.emitTrackUpdate())}get videoQuality(){return this.currentVideoQuality}setTrack(e){const t=this.subscriptionStatus,i=this.permissionStatus,r=this.track;r!==e&&(r&&(r.off(R.VideoDimensionsChanged,this.handleVideoDimensionsChange),r.off(R.VisibilityChanged,this.handleVisibilityChange),r.off(R.Ended,this.handleEnded),r.detach(),r.stopMonitor(),this.emit(R.Unsubscribed,r)),super.setTrack(e),e&&(e.sid=this.trackSid,e.on(R.VideoDimensionsChanged,this.handleVideoDimensionsChange),e.on(R.VisibilityChanged,this.handleVisibilityChange),e.on(R.Ended,this.handleEnded),this.emit(R.Subscribed,e)),this.emitPermissionUpdateIfChanged(i),this.emitSubscriptionUpdateIfChanged(t))}setAllowed(e){const t=this.subscriptionStatus,i=this.permissionStatus;this.allowed=e,this.emitPermissionUpdateIfChanged(i),this.emitSubscriptionUpdateIfChanged(t)}setSubscriptionError(e){this.emit(R.SubscriptionFailed,e)}updateInfo(e){super.updateInfo(e);const t=this.metadataMuted;this.metadataMuted=e.muted,this.track?this.track.setMuted(e.muted):t!==e.muted&&this.emit(e.muted?R.Muted:R.Unmuted)}emitSubscriptionUpdateIfChanged(e){const t=this.subscriptionStatus;e!==t&&this.emit(R.SubscriptionStatusChanged,t,e)}emitPermissionUpdateIfChanged(e){this.permissionStatus!==e&&this.emit(R.SubscriptionPermissionChanged,this.permissionStatus,e)}isManualOperationAllowed(){return this.kind===C.Kind.Video&&this.isAdaptiveStream?(this.log.warn("adaptive stream is enabled, cannot change video track settings",this.logContext),!1):this.isDesired?!0:(this.log.warn("cannot update track settings when not subscribed",this.logContext),!1)}get isAdaptiveStream(){return this.track instanceof oi&&this.track.isAdaptiveStream}emitTrackUpdate(){const e=new nt({trackSids:[this.trackSid],disabled:this.disabled,fps:this.fps});this.videoDimensions?(e.width=Math.ceil(this.videoDimensions.width),e.height=Math.ceil(this.videoDimensions.height)):this.currentVideoQuality!==void 0?e.quality=this.currentVideoQuality:e.quality=ie.HIGH,this.emit(R.UpdateSettings,e)}}class hi extends mc{static fromParticipantInfo(e,t){return new hi(e,t.sid,t.identity,t.name,t.metadata)}constructor(e,t,i,r,s,o){super(t,i||"",r,s,o),this.signalClient=e,this.tracks=new Map,this.audioTracks=new Map,this.videoTracks=new Map,this.volumeMap=new Map}addTrackPublication(e){super.addTrackPublication(e),e.on(R.UpdateSettings,t=>{this.log.debug("send update settings",Object.assign(Object.assign({},this.logContext),H(e))),this.signalClient.sendUpdateTrackSettings(t)}),e.on(R.UpdateSubscription,t=>{t.participantTracks.forEach(i=>{i.participantSid=this.sid}),this.signalClient.sendUpdateSubscription(t)}),e.on(R.SubscriptionPermissionChanged,t=>{this.emit(E.TrackSubscriptionPermissionChanged,e,t)}),e.on(R.SubscriptionStatusChanged,t=>{this.emit(E.TrackSubscriptionStatusChanged,e,t)}),e.on(R.Subscribed,t=>{this.emit(E.TrackSubscribed,t,e)}),e.on(R.Unsubscribed,t=>{this.emit(E.TrackUnsubscribed,t,e)}),e.on(R.SubscriptionFailed,t=>{this.emit(E.TrackSubscriptionFailed,e.trackSid,t)})}getTrack(e){const t=super.getTrack(e);if(t)return t}getTrackByName(e){const t=super.getTrackByName(e);if(t)return t}setVolume(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:C.Source.Microphone;this.volumeMap.set(t,e);const i=this.getTrack(t);i&&i.track&&i.track.setVolume(e)}getVolume(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:C.Source.Microphone;const t=this.getTrack(e);return t&&t.track?t.track.getVolume():this.volumeMap.get(e)}addSubscribedMediaTrack(e,t,i,r,s,o){let a=this.getTrackPublication(t);if(a||t.startsWith("TR")||this.tracks.forEach(u=>{!a&&e.kind===u.kind.toString()&&(a=u)}),!a){if(o===0){this.log.error("could not find published track",Object.assign(Object.assign({},this.logContext),{trackSid:t})),this.emit(E.TrackSubscriptionFailed,t);return}o===void 0&&(o=20),setTimeout(()=>{this.addSubscribedMediaTrack(e,t,i,r,s,o-1)},150);return}if(e.readyState==="ended"){this.log.error("unable to subscribe because MediaStreamTrack is ended. Do not call MediaStreamTrack.stop()",Object.assign(Object.assign({},this.logContext),H(a))),this.emit(E.TrackSubscriptionFailed,t);return}const c=e.kind==="video";let l;return c?l=new oi(e,t,r,s):l=new Nn(e,t,r,this.audioContext,this.audioOutput),l.source=a.source,l.isMuted=a.isMuted,l.setMediaStream(i),l.start(),a.setTrack(l),this.volumeMap.has(a.source)&&l instanceof Nn&&l.setVolume(this.volumeMap.get(a.source)),a}get hasMetadata(){return!!this.participantInfo}getTrackPublication(e){return this.tracks.get(e)}updateInfo(e){if(!super.updateInfo(e))return!1;const t=new Map,i=new Map;return e.tracks.forEach(r=>{var s,o;let a=this.getTrackPublication(r.sid);if(a)a.updateInfo(r);else{const c=C.kindFromProto(r.type);if(!c)return;a=new di(c,r,(s=this.signalClient.connectOptions)===null||s===void 0?void 0:s.autoSubscribe,{loggerContextCb:()=>this.logContext,loggerName:(o=this.loggerOptions)===null||o===void 0?void 0:o.loggerName}),a.updateInfo(r),i.set(r.sid,a);const l=Array.from(this.tracks.values()).find(u=>u.source===(a==null?void 0:a.source));l&&a.source!==C.Source.Unknown&&this.log.debug("received a second track publication for ".concat(this.identity," with the same source: ").concat(a.source),Object.assign(Object.assign({},this.logContext),{oldTrack:H(l),newTrack:H(a)})),this.addTrackPublication(a)}t.set(r.sid,a)}),this.tracks.forEach(r=>{t.has(r.trackSid)||(this.log.trace("detected removed track on remote participant, unpublishing",Object.assign(Object.assign({},this.logContext),H(r))),this.unpublishTrack(r.trackSid,!0))}),i.forEach(r=>{this.emit(E.TrackPublished,r)}),!0}unpublishTrack(e,t){const i=this.tracks.get(e);if(!i)return;const{track:r}=i;switch(r&&(r.stop(),i.setTrack(void 0)),this.tracks.delete(e),i.kind){case C.Kind.Audio:this.audioTracks.delete(e);break;case C.Kind.Video:this.videoTracks.delete(e);break}t&&this.emit(E.TrackUnpublished,i)}setAudioOutput(e){return y(this,void 0,void 0,function*(){this.audioOutput=e;const t=[];this.audioTracks.forEach(i=>{var r;i.track instanceof Nn&&t.push(i.track.setSinkId((r=e.deviceId)!==null&&r!==void 0?r:"default"))}),yield Promise.all(t)})}emit(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];return this.log.trace("participant event",Object.assign(Object.assign({},this.logContext),{event:e,args:i})),super.emit(e,...i)}}class fi extends mc{constructor(e,t,i,r){super(e,t,void 0,void 0,{loggerName:r.loggerName,loggerContextCb:()=>this.engine.logContext}),this.pendingPublishing=new Set,this.pendingPublishPromises=new Map,this.participantTrackPermissions=[],this.allParticipantsAllowedToSubscribe=!0,this.encryptionType=ce.NONE,this.handleReconnecting=()=>{this.reconnectFuture||(this.reconnectFuture=new sc)},this.handleReconnected=()=>{var s,o;(o=(s=this.reconnectFuture)===null||s===void 0?void 0:s.resolve)===null||o===void 0||o.call(s),this.reconnectFuture=void 0,this.updateTrackSubscriptionPermissions()},this.handleDisconnected=()=>{var s,o;this.reconnectFuture&&(this.reconnectFuture.promise.catch(a=>this.log.warn(a.message,this.logContext)),(o=(s=this.reconnectFuture)===null||s===void 0?void 0:s.reject)===null||o===void 0||o.call(s,"Got disconnected during reconnection attempt"),this.reconnectFuture=void 0)},this.updateTrackSubscriptionPermissions=()=>{this.log.debug("updating track subscription permissions",Object.assign(Object.assign({},this.logContext),{allParticipantsAllowed:this.allParticipantsAllowedToSubscribe,participantTrackPermissions:this.participantTrackPermissions})),this.engine.client.sendUpdateSubscriptionPermissions(this.allParticipantsAllowedToSubscribe,this.participantTrackPermissions.map(s=>jd(s)))},this.onTrackUnmuted=s=>{this.onTrackMuted(s,s.isUpstreamPaused)},this.onTrackMuted=(s,o)=>{if(o===void 0&&(o=!0),!s.sid){this.log.error("could not update mute status for unpublished track",Object.assign(Object.assign({},this.logContext),H(s)));return}this.engine.updateMuteStatus(s.sid,o)},this.onTrackUpstreamPaused=s=>{this.log.debug("upstream paused",Object.assign(Object.assign({},this.logContext),H(s))),this.onTrackMuted(s,!0)},this.onTrackUpstreamResumed=s=>{this.log.debug("upstream resumed",Object.assign(Object.assign({},this.logContext),H(s))),this.onTrackMuted(s,s.isMuted)},this.handleSubscribedQualityUpdate=s=>y(this,void 0,void 0,function*(){var o,a,c,l,u,d;if(!(!((u=this.roomOptions)===null||u===void 0)&&u.dynacast))return;const h=this.videoTracks.get(s.trackSid);if(!h){this.log.warn("received subscribed quality update for unknown track",Object.assign(Object.assign({},this.logContext),{trackSid:s.trackSid}));return}if(s.subscribedCodecs.length>0){if(!h.videoTrack)return;const b=yield h.videoTrack.setPublishingCodecs(s.subscribedCodecs);try{for(var m=!0,g=xn(b),v;v=yield g.next(),o=v.done,!o;m=!0){l=v.value,m=!1;const k=l;Vu(k)&&(this.log.debug("publish ".concat(k," for ").concat(h.videoTrack.sid),Object.assign(Object.assign({},this.logContext),H(h))),yield this.publishAdditionalCodecForTrack(h.videoTrack,k,h.options))}}catch(k){a={error:k}}finally{try{!m&&!o&&(c=g.return)&&(yield c.call(g))}finally{if(a)throw a.error}}}else s.subscribedQualities.length>0&&(yield(d=h.videoTrack)===null||d===void 0?void 0:d.setPublishingLayers(s.subscribedQualities))}),this.handleLocalTrackUnpublished=s=>{const o=this.tracks.get(s.trackSid);if(!o){this.log.warn("received unpublished event for unknown track",Object.assign(Object.assign({},this.logContext),{trackSid:s.trackSid}));return}this.unpublishTrack(o.track)},this.handleTrackEnded=s=>y(this,void 0,void 0,function*(){if(s.source===C.Source.ScreenShare||s.source===C.Source.ScreenShareAudio)this.log.debug("unpublishing local track due to TrackEnded",Object.assign(Object.assign({},this.logContext),H(s))),this.unpublishTrack(s);else if(s.isUserProvided)yield s.mute();else if(s instanceof Ee||s instanceof Oe)try{if(Ce())try{const o=yield navigator==null?void 0:navigator.permissions.query({name:s.source===C.Source.Camera?"camera":"microphone"});if(o&&o.state==="denied")throw this.log.warn("user has revoked access to ".concat(s.source),Object.assign(Object.assign({},this.logContext),H(s))),o.onchange=()=>{o.state!=="denied"&&(s.isMuted||s.restartTrack(),o.onchange=null)},new Error("GetUserMedia Permission denied")}catch{}s.isMuted||(this.log.debug("track ended, attempting to use a different device",Object.assign(Object.assign({},this.logContext),H(s))),yield s.restartTrack())}catch{this.log.warn("could not restart track, muting instead",Object.assign(Object.assign({},this.logContext),H(s))),yield s.mute()}}),this.audioTracks=new Map,this.videoTracks=new Map,this.tracks=new Map,this.engine=i,this.roomOptions=r,this.setupEngine(i),this.activeDeviceMap=new Map}get lastCameraError(){return this.cameraError}get lastMicrophoneError(){return this.microphoneError}get isE2EEEnabled(){return this.encryptionType!==ce.NONE}getTrack(e){const t=super.getTrack(e);if(t)return t}getTrackByName(e){const t=super.getTrackByName(e);if(t)return t}setupEngine(e){this.engine=e,this.engine.on(M.RemoteMute,(t,i)=>{const r=this.tracks.get(t);!r||!r.track||(i?r.mute():r.unmute())}),this.engine.on(M.Connected,this.handleReconnected).on(M.SignalRestarted,this.handleReconnected).on(M.SignalResumed,this.handleReconnected).on(M.Restarting,this.handleReconnecting).on(M.Resuming,this.handleReconnecting).on(M.LocalTrackUnpublished,this.handleLocalTrackUnpublished).on(M.SubscribedQualityUpdate,this.handleSubscribedQualityUpdate).on(M.Disconnected,this.handleDisconnected)}setMetadata(e){var t;this.engine.client.sendUpdateLocalMetadata(e,(t=this.name)!==null&&t!==void 0?t:"")}setName(e){var t;this.engine.client.sendUpdateLocalMetadata((t=this.metadata)!==null&&t!==void 0?t:"",e)}setCameraEnabled(e,t,i){return this.setTrackEnabled(C.Source.Camera,e,t,i)}setMicrophoneEnabled(e,t,i){return this.setTrackEnabled(C.Source.Microphone,e,t,i)}setScreenShareEnabled(e,t,i){return this.setTrackEnabled(C.Source.ScreenShare,e,t,i)}setPermissions(e){const t=this.permissions,i=super.setPermissions(e);return i&&t&&this.emit(E.ParticipantPermissionsChanged,t),i}setE2EEEnabled(e){return y(this,void 0,void 0,function*(){this.encryptionType=e?ce.GCM:ce.NONE,yield this.republishAllTracks(void 0,!1)})}setTrackEnabled(e,t,i,r){var s,o;return y(this,void 0,void 0,function*(){this.log.debug("setTrackEnabled",Object.assign(Object.assign({},this.logContext),{source:e,enabled:t}));let a=this.getTrack(e);if(t)if(a)yield a.unmute();else{let c;if(this.pendingPublishing.has(e)){this.log.info("skipping duplicate published source",Object.assign(Object.assign({},this.logContext),{source:e}));return}this.pendingPublishing.add(e);try{switch(e){case C.Source.Camera:c=yield this.createTracks({video:(s=i)!==null&&s!==void 0?s:!0});break;case C.Source.Microphone:c=yield this.createTracks({audio:(o=i)!==null&&o!==void 0?o:!0});break;case C.Source.ScreenShare:c=yield this.createScreenTracks(Object.assign({},i));break;default:throw new ze(e)}const l=[];for(const d of c)this.log.info("publishing track",Object.assign(Object.assign({},this.logContext),H(d))),l.push(this.publishTrack(d,r));[a]=yield Promise.all(l)}catch(l){throw c==null||c.forEach(u=>{u.stop()}),l instanceof Error&&!(l instanceof ze)&&this.emit(E.MediaDevicesError,l),l}finally{this.pendingPublishing.delete(e)}}else if(a&&a.track)if(e===C.Source.ScreenShare){a=yield this.unpublishTrack(a.track);const c=this.getTrack(C.Source.ScreenShareAudio);c&&c.track&&this.unpublishTrack(c.track)}else yield a.mute();return a})}enableCameraAndMicrophone(){return y(this,void 0,void 0,function*(){if(!(this.pendingPublishing.has(C.Source.Camera)||this.pendingPublishing.has(C.Source.Microphone))){this.pendingPublishing.add(C.Source.Camera),this.pendingPublishing.add(C.Source.Microphone);try{const e=yield this.createTracks({audio:!0,video:!0});yield Promise.all(e.map(t=>this.publishTrack(t)))}finally{this.pendingPublishing.delete(C.Source.Camera),this.pendingPublishing.delete(C.Source.Microphone)}}})}createTracks(e){var t,i;return y(this,void 0,void 0,function*(){const r=Za(e,(t=this.roomOptions)===null||t===void 0?void 0:t.audioCaptureDefaults,(i=this.roomOptions)===null||i===void 0?void 0:i.videoCaptureDefaults),s=$i(r);let o;try{o=yield navigator.mediaDevices.getUserMedia(s)}catch(a){throw a instanceof Error&&(s.audio&&(this.microphoneError=a),s.video&&(this.cameraError=a)),a}return s.audio&&(this.microphoneError=void 0,this.emit(E.AudioStreamAcquired)),s.video&&(this.cameraError=void 0),o.getTracks().map(a=>{const c=a.kind==="audio";c?e.audio:e.video;let l;const u=c?s.audio:s.video;typeof u!="boolean"&&(l=u);const d=dc(a,l,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});return d.kind===C.Kind.Video?d.source=C.Source.Camera:d.kind===C.Kind.Audio&&(d.source=C.Source.Microphone),d.mediaStream=o,d})})}createScreenTracks(e){return y(this,void 0,void 0,function*(){if(e===void 0&&(e={}),navigator.mediaDevices.getDisplayMedia===void 0)throw new cs("getDisplayMedia not supported");e.resolution===void 0&&!td()&&(e.resolution=us.h1080fps30.resolution);const t=Hu(e),i=yield navigator.mediaDevices.getDisplayMedia(t),r=i.getVideoTracks();if(r.length===0)throw new ze("no video track found");const s=new Oe(r[0],void 0,!1,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});s.source=C.Source.ScreenShare,e.contentHint&&(s.mediaStreamTrack.contentHint=e.contentHint);const o=[s];if(i.getAudioTracks().length>0){this.emit(E.AudioStreamAcquired);const a=new Ee(i.getAudioTracks()[0],void 0,!1,this.audioContext,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});a.source=C.Source.ScreenShareAudio,o.push(a)}return o})}publishTrack(e,t){var i,r,s,o;return y(this,void 0,void 0,function*(){yield(i=this.reconnectFuture)===null||i===void 0?void 0:i.promise,e instanceof jn&&this.pendingPublishPromises.has(e)&&(yield this.pendingPublishPromises.get(e));let a;if(e instanceof MediaStreamTrack)a=e.getConstraints();else{a=e.constraints;let m;switch(e.source){case C.Source.Microphone:m="audioinput";break;case C.Source.Camera:m="videoinput"}m&&this.activeDeviceMap.has(m)&&(a=Object.assign(Object.assign({},a),{deviceId:this.activeDeviceMap.get(m)}))}if(e instanceof MediaStreamTrack)switch(e.kind){case"audio":e=new Ee(e,a,!0,this.audioContext,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});break;case"video":e=new Oe(e,a,!0,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});break;default:throw new ze("unsupported MediaStreamTrack kind ".concat(e.kind))}else e.updateLoggerOptions({loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});e instanceof Ee&&e.setAudioContext(this.audioContext);let c;if(this.tracks.forEach(m=>{m.track&&m.track===e&&(c=m)}),c)return this.log.warn("track has already been published, skipping",Object.assign(Object.assign({},this.logContext),H(c))),c;const l="channelCount"in e.mediaStreamTrack.getSettings()&&e.mediaStreamTrack.getSettings().channelCount===2||e.mediaStreamTrack.getConstraints().channelCount===2,u=(r=t==null?void 0:t.forceStereo)!==null&&r!==void 0?r:l;u&&(t||(t={}),t.dtx===void 0&&this.log.info("Opus DTX will be disabled for stereo tracks by default. Enable them explicitly to make it work.",Object.assign(Object.assign({},this.logContext),H(e))),t.red===void 0&&this.log.info("Opus RED will be disabled for stereo tracks by default. Enable them explicitly to make it work."),(s=t.dtx)!==null&&s!==void 0||(t.dtx=!1),(o=t.red)!==null&&o!==void 0||(t.red=!1));const d=Object.assign(Object.assign({},this.roomOptions.publishDefaults),t);yn()&&this.roomOptions.e2ee&&(this.log.info("End-to-end encryption is set up, simulcast publishing will be disabled on Safari",Object.assign({},this.logContext)),d.simulcast=!1),d.source&&(e.source=d.source);const h=this.publish(e,d,u);this.pendingPublishPromises.set(e,h);try{return yield h}catch(m){throw m}finally{this.pendingPublishPromises.delete(e)}})}publish(e,t,i){var r,s,o,a,c,l,u,d,h,m,g,v,b;return y(this,void 0,void 0,function*(){Array.from(this.tracks.values()).find(N=>e instanceof jn&&N.source===e.source)&&e.source!==C.Source.Unknown&&this.log.info("publishing a second track with the same source: ".concat(e.source),Object.assign(Object.assign({},this.logContext),H(e))),t.stopMicTrackOnMute&&e instanceof Ee&&(e.stopOnMute=!0),e.source===C.Source.ScreenShare&&Bn()&&(t.simulcast=!1),t.videoCodec==="av1"&&!Yu()&&(t.videoCodec=void 0),t.videoCodec==="vp9"&&!Qu()&&(t.videoCodec=void 0),t.videoCodec===void 0&&(t.videoCodec=Jr);const S=t.videoCodec;e.on(R.Muted,this.onTrackMuted),e.on(R.Unmuted,this.onTrackUnmuted),e.on(R.Ended,this.handleTrackEnded),e.on(R.UpstreamPaused,this.onTrackUpstreamPaused),e.on(R.UpstreamResumed,this.onTrackUpstreamResumed);const O=new je({cid:e.mediaStreamTrack.id,name:t.name,type:C.kindToProto(e.kind),muted:e.isMuted,source:C.sourceToProto(e.source),disableDtx:!(!((r=t.dtx)!==null&&r!==void 0)||r),encryption:this.encryptionType,stereo:i,disableRed:this.isE2EEEnabled||!(!((s=t.red)!==null&&s!==void 0)||s),stream:t==null?void 0:t.stream});let x;if(e.kind===C.Kind.Video){let N={width:0,height:0};try{N=yield e.waitForDimensions()}catch{const V=(a=(o=this.roomOptions.videoCaptureDefaults)===null||o===void 0?void 0:o.resolution)!==null&&a!==void 0?a:li.h720.resolution;N={width:V.width,height:V.height},this.log.error("could not determine track dimensions, using defaults",Object.assign(Object.assign(Object.assign({},this.logContext),H(e)),{dims:N}))}O.width=N.width,O.height=N.height,e instanceof Oe&&(ri(S)&&(e.source===C.Source.ScreenShare&&S==="vp9"&&(t.scalabilityMode="L1T3"),t.scalabilityMode=(c=t.scalabilityMode)!==null&&c!==void 0?c:"L3T3_KEY"),O.simulcastCodecs=[new Be({codec:S,cid:e.mediaStreamTrack.id})],t.backupCodec===!0&&(t.backupCodec={codec:Jr}),t.backupCodec&&S!==t.backupCodec.codec&&O.encryption===ce.NONE&&(this.roomOptions.dynacast||(this.roomOptions.dynacast=!0),O.simulcastCodecs.push(new Be({codec:t.backupCodec.codec,cid:""})))),x=Wr(e.source===C.Source.ScreenShare,O.width,O.height,t),O.layers=Eo(O.width,O.height,x,ri(t.videoCodec))}else e.kind===C.Kind.Audio&&(x=[{maxBitrate:(u=(l=t.audioPreset)===null||l===void 0?void 0:l.maxBitrate)!==null&&u!==void 0?u:t.audioBitrate,priority:(h=(d=t.audioPreset)===null||d===void 0?void 0:d.priority)!==null&&h!==void 0?h:"high",networkPriority:(g=(m=t.audioPreset)===null||m===void 0?void 0:m.priority)!==null&&g!==void 0?g:"high"}]);if(!this.engine||this.engine.isClosed)throw new te("cannot publish track when not connected");const _=yield this.engine.addTrack(O);let A;if(_.codecs.forEach(N=>{A===void 0&&(A=N.mimeType)}),A&&e.kind===C.Kind.Video){const N=tc(A);N!==S&&(this.log.debug("falling back to server selected codec",Object.assign(Object.assign(Object.assign({},this.logContext),H(e)),{codec:N})),t.videoCodec=N,x=Wr(e.source===C.Source.ScreenShare,O.width,O.height,t))}const j=new ui(e.kind,_,e,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});if(j.options=t,e.sid=_.sid,!this.engine.pcManager)throw new te("pcManager is not ready");if(this.log.debug("publishing ".concat(e.kind," with encodings"),Object.assign(Object.assign({},this.logContext),{encodings:x,trackInfo:_})),e.sender=yield this.engine.createSender(e,t,x),x)if(Bn()&&e.kind===C.Kind.Audio){let N;for(const P of this.engine.pcManager.publisher.getTransceivers())if(P.sender===e.sender){N=P;break}N&&this.engine.pcManager.publisher.setTrackCodecBitrate({transceiver:N,codec:"opus",maxbr:!((v=x[0])===null||v===void 0)&&v.maxBitrate?x[0].maxBitrate/1e3:0})}else e.codec&&ri(e.codec)&&(!((b=x[0])===null||b===void 0)&&b.maxBitrate)&&this.engine.pcManager.publisher.setTrackCodecBitrate({cid:O.cid,codec:e.codec,maxbr:x[0].maxBitrate/1e3});return yield this.engine.negotiate(),e instanceof Oe?e.startMonitor(this.engine.client):e instanceof Ee&&e.startMonitor(),this.addTrackPublication(j),this.emit(E.LocalTrackPublished,j),j})}get isLocal(){return!0}publishAdditionalCodecForTrack(e,t,i){var r;return y(this,void 0,void 0,function*(){if(this.encryptionType!==ce.NONE)return;let s;if(this.tracks.forEach(d=>{d.track&&d.track===e&&(s=d)}),!s)throw new ze("track is not published");if(!(e instanceof Oe))throw new ze("track is not a video track");const o=Object.assign(Object.assign({},(r=this.roomOptions)===null||r===void 0?void 0:r.publishDefaults),i),a=Ad(e,t,o);if(!a){this.log.info("backup codec has been disabled, ignoring request to add additional codec for track",Object.assign(Object.assign({},this.logContext),H(e)));return}const c=e.addSimulcastTrack(t,a),l=new je({cid:c.mediaStreamTrack.id,type:C.kindToProto(e.kind),muted:e.isMuted,source:C.sourceToProto(e.source),sid:e.sid,simulcastCodecs:[{codec:o.videoCodec,cid:c.mediaStreamTrack.id}]});if(l.layers=Eo(l.width,l.height,a),!this.engine||this.engine.isClosed)throw new te("cannot publish track when not connected");const u=yield this.engine.addTrack(l);yield this.engine.createSimulcastSender(e,c,o,a),yield this.engine.negotiate(),this.log.debug("published ".concat(t," for track ").concat(e.sid),Object.assign(Object.assign({},this.logContext),{encodings:a,trackInfo:u}))})}unpublishTrack(e,t){var i,r;return y(this,void 0,void 0,function*(){const s=this.getPublicationForTrack(e),o=s?H(s):void 0;if(this.log.debug("unpublishing track",Object.assign(Object.assign({},this.logContext),o)),!s||!s.track){this.log.warn("track was not unpublished because no publication was found",Object.assign(Object.assign({},this.logContext),o));return}e=s.track,e.off(R.Muted,this.onTrackMuted),e.off(R.Unmuted,this.onTrackUnmuted),e.off(R.Ended,this.handleTrackEnded),e.off(R.UpstreamPaused,this.onTrackUpstreamPaused),e.off(R.UpstreamResumed,this.onTrackUpstreamResumed),t===void 0&&(t=(r=(i=this.roomOptions)===null||i===void 0?void 0:i.stopLocalTrackOnUnpublish)!==null&&r!==void 0?r:!0),t&&e.stop();let a=!1;const c=e.sender;if(e.sender=void 0,this.engine.pcManager&&this.engine.pcManager.currentState<ne.FAILED&&c)try{for(const l of this.engine.pcManager.publisher.getTransceivers())l.sender===c&&(l.direction="inactive",a=!0);if(this.engine.removeTrack(c)&&(a=!0),e instanceof Oe){for(const[,l]of e.simulcastCodecs)l.sender&&(this.engine.removeTrack(l.sender)&&(a=!0),l.sender=void 0);e.simulcastCodecs.clear()}}catch(l){this.log.warn("failed to unpublish track",Object.assign(Object.assign(Object.assign({},this.logContext),o),{error:l}))}switch(this.tracks.delete(s.trackSid),s.kind){case C.Kind.Audio:this.audioTracks.delete(s.trackSid);break;case C.Kind.Video:this.videoTracks.delete(s.trackSid);break}return this.emit(E.LocalTrackUnpublished,s),s.setTrack(void 0),a&&(yield this.engine.negotiate()),s})}unpublishTracks(e){return y(this,void 0,void 0,function*(){return(yield Promise.all(e.map(i=>this.unpublishTrack(i)))).filter(i=>i instanceof ui)})}republishAllTracks(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return y(this,void 0,void 0,function*(){const i=[];this.tracks.forEach(r=>{r.track&&(e&&(r.options=Object.assign(Object.assign({},r.options),e)),i.push(r))}),yield Promise.all(i.map(r=>y(this,void 0,void 0,function*(){const s=r.track;yield this.unpublishTrack(s,!1),t&&!s.isMuted&&s.source!==C.Source.ScreenShare&&s.source!==C.Source.ScreenShareAudio&&(s instanceof Ee||s instanceof Oe)&&!s.isUserProvided&&(this.log.debug("restarting existing track",Object.assign(Object.assign({},this.logContext),{track:r.trackSid})),yield s.restartTrack()),yield this.publishTrack(s,r.options)})))})}publishData(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};return y(this,void 0,void 0,function*(){const r=Array.isArray(i)?i:i==null?void 0:i.destination,s=[],o=Array.isArray(i)?void 0:i.topic;r!==void 0&&r.forEach(c=>{c instanceof hi?s.push(c.sid):s.push(c)});const a=new Ke({kind:t,value:{case:"user",value:new Ye({participantSid:this.sid,payload:e,destinationSids:s,topic:o})}});yield this.engine.sendDataPacket(a,t)})}setTrackSubscriptionPermissions(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[];this.participantTrackPermissions=t,this.allParticipantsAllowedToSubscribe=e,this.engine.client.isDisconnected||this.updateTrackSubscriptionPermissions()}updateInfo(e){return e.sid!==this.sid||!super.updateInfo(e)?!1:(e.tracks.forEach(t=>{var i,r;const s=this.tracks.get(t.sid);if(s){const o=s.isMuted||((r=(i=s.track)===null||i===void 0?void 0:i.isUpstreamPaused)!==null&&r!==void 0?r:!1);o!==t.muted&&(this.log.debug("updating server mute state after reconcile",Object.assign(Object.assign(Object.assign({},this.logContext),H(s)),{mutedOnServer:o})),this.engine.client.sendMuteTrack(t.sid,o))}}),!0)}getPublicationForTrack(e){let t;return this.tracks.forEach(i=>{const r=i.track;r&&(e instanceof MediaStreamTrack?(r instanceof Ee||r instanceof Oe)&&r.mediaStreamTrack===e&&(t=i):e===r&&(t=i))}),t}}var B;(function(n){n.Disconnected="disconnected",n.Connecting="connecting",n.Connected="connected",n.Reconnecting="reconnecting"})(B||(B={}));const Vd=2*1e3;class Fi extends ft.EventEmitter{constructor(e){var t,i,r;super(),t=this,this.state=B.Disconnected,this.activeSpeakers=[],this.isE2EEEnabled=!1,this.audioEnabled=!0,this.isVideoPlaybackBlocked=!1,this.log=U,this.bufferedEvents=[],this.connect=(s,o,a)=>y(this,void 0,void 0,function*(){var c;const l=yield this.disconnectLock.lock();if(this.state===B.Connected)return this.log.info("already connected to room ".concat(this.name),this.logContext),l(),Promise.resolve();if(this.connectFuture)return l(),this.connectFuture.promise;this.setAndEmitConnectionState(B.Connecting),((c=this.regionUrlProvider)===null||c===void 0?void 0:c.getServerUrl().toString())!==s&&(this.regionUrl=void 0,this.regionUrlProvider=void 0),Vr(new URL(s))&&(this.regionUrlProvider===void 0?this.regionUrlProvider=new So(s,o):this.regionUrlProvider.updateToken(o),this.regionUrlProvider.fetchRegionSettings().catch(h=>{this.log.warn("could not fetch region settings",Object.assign(Object.assign({},this.logContext),{error:h}))}));const u=(h,m,g)=>y(this,void 0,void 0,function*(){var v;this.abortController&&this.abortController.abort();const b=new AbortController;this.abortController=b,l==null||l();try{yield this.attemptConnection(g??s,o,a,b),this.abortController=void 0,h()}catch(k){if(this.regionUrlProvider&&k instanceof W&&k.reason!==3&&k.reason!==0){let S=null;try{S=yield this.regionUrlProvider.getNextBestRegionUrl((v=this.abortController)===null||v===void 0?void 0:v.signal)}catch(O){if(O instanceof W&&(O.status===401||O.reason===3)){this.handleDisconnect(this.options.stopLocalTrackOnUnpublish),m(O);return}}S?(this.log.info("Initial connection failed with ConnectionError: ".concat(k.message,". Retrying with another region: ").concat(S),this.logContext),yield u(h,m,S)):(this.handleDisconnect(this.options.stopLocalTrackOnUnpublish),m(k))}else this.handleDisconnect(this.options.stopLocalTrackOnUnpublish),m(k)}}),d=this.regionUrl;return this.regionUrl=void 0,this.connectFuture=new sc((h,m)=>{u(h,m,d)},()=>{this.clearConnectionFutures()}),this.connectFuture.promise}),this.connectSignal=(s,o,a,c,l,u)=>y(this,void 0,void 0,function*(){var d,h,m;const g=yield a.join(s,o,{autoSubscribe:c.autoSubscribe,publishOnly:c.publishOnly,adaptiveStream:typeof l.adaptiveStream=="object"?!0:l.adaptiveStream,maxRetries:c.maxRetries,e2eeEnabled:!!this.e2eeManager,websocketTimeout:c.websocketTimeout},u.signal);let v=g.serverInfo;if(v||(v={version:g.serverVersion,region:g.serverRegion}),this.log.debug("connected to Livekit Server ".concat(Object.entries(v).map(b=>{let[k,S]=b;return"".concat(k,": ").concat(S)}).join(", ")),{room:(d=g.room)===null||d===void 0?void 0:d.name,roomSid:(h=g.room)===null||h===void 0?void 0:h.sid,identity:(m=g.participant)===null||m===void 0?void 0:m.identity}),!g.serverVersion)throw new Au("unknown server version");return g.serverVersion==="0.15.1"&&this.options.dynacast&&(this.log.debug("disabling dynacast due to server version",this.logContext),l.dynacast=!1),g}),this.applyJoinResponse=s=>{const o=s.participant;this.localParticipant.sid=o.sid,this.localParticipant.identity=o.identity,this.handleParticipantUpdates([o,...s.otherParticipants]),s.room&&this.handleRoomUpdate(s.room),this.options.e2ee&&this.e2eeManager&&this.e2eeManager.setSifTrailer(s.sifTrailer)},this.attemptConnection=(s,o,a,c)=>y(this,void 0,void 0,function*(){var l,u;this.state===B.Reconnecting?(this.log.info("Reconnection attempt replaced by new connection attempt",this.logContext),this.recreateEngine()):this.maybeCreateEngine(),!((l=this.regionUrlProvider)===null||l===void 0)&&l.isCloud()&&this.engine.setRegionUrlProvider(this.regionUrlProvider),this.acquireAudioContext(),this.connOptions=Object.assign(Object.assign({},fs),a),this.connOptions.rtcConfig&&(this.engine.rtcConfig=this.connOptions.rtcConfig),this.connOptions.peerConnectionTimeout&&(this.engine.peerConnectionTimeout=this.connOptions.peerConnectionTimeout);try{const d=yield this.connectSignal(s,o,this.engine,this.connOptions,this.options,c);this.applyJoinResponse(d),this.setupLocalParticipantEvents(),this.emit(T.SignalConnected)}catch(d){yield this.engine.close(),this.recreateEngine();const h=new W("could not establish signal connection");throw d instanceof Error&&(h.message="".concat(h.message,": ").concat(d.message)),d instanceof W&&(h.reason=d.reason,h.status=d.status),this.log.debug("error trying to establish signal connection",Object.assign(Object.assign({},this.logContext),{error:d})),h}if(c.signal.aborted)throw yield this.engine.close(),this.recreateEngine(),new W("Connection attempt aborted");try{yield this.engine.waitForPCInitialConnection(this.connOptions.peerConnectionTimeout,c)}catch(d){throw yield this.engine.close(),this.recreateEngine(),d}Ce()&&this.options.disconnectOnPageLeave&&(window.addEventListener("pagehide",this.onPageLeave),window.addEventListener("beforeunload",this.onPageLeave)),Ce()&&(document.addEventListener("freeze",this.onPageLeave),(u=navigator.mediaDevices)===null||u===void 0||u.addEventListener("devicechange",this.handleDeviceChange)),this.setAndEmitConnectionState(B.Connected),this.emit(T.Connected),this.registerConnectionReconcile()}),this.disconnect=function(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return y(t,void 0,void 0,function*(){var o,a,c,l;const u=yield this.disconnectLock.lock();try{if(this.state===B.Disconnected){this.log.debug("already disconnected",this.logContext);return}this.log.info("disconnect from room",Object.assign({},this.logContext)),(this.state===B.Connecting||this.state===B.Reconnecting)&&(this.log.warn("abort connection attempt",this.logContext),(o=this.abortController)===null||o===void 0||o.abort(),(c=(a=this.connectFuture)===null||a===void 0?void 0:a.reject)===null||c===void 0||c.call(a,new W("Client initiated disconnect")),this.connectFuture=void 0),!((l=this.engine)===null||l===void 0)&&l.client.isDisconnected||(yield this.engine.client.sendLeave()),this.engine&&(yield this.engine.close()),this.handleDisconnect(s,Wt.CLIENT_INITIATED),this.engine=void 0}finally{u()}})},this.onPageLeave=()=>y(this,void 0,void 0,function*(){yield this.disconnect()}),this.startAudio=()=>y(this,void 0,void 0,function*(){const s=[],o=Kt();if(o&&o.os==="iOS"){const a="livekit-dummy-audio-el";let c=document.getElementById(a);if(!c){c=document.createElement("audio"),c.id=a,c.autoplay=!0,c.hidden=!0;const l=dr();l.enabled=!0;const u=new MediaStream([l]);c.srcObject=u,document.addEventListener("visibilitychange",()=>{c&&(c.srcObject=document.hidden?null:u,document.hidden||(this.log.debug("page visible again, triggering startAudio to resume playback and update playback status",this.logContext),this.startAudio()))}),document.body.append(c),this.once(T.Disconnected,()=>{c==null||c.remove(),c=null})}s.push(c)}this.participants.forEach(a=>{a.audioTracks.forEach(c=>{c.track&&c.track.attachedElements.forEach(l=>{s.push(l)})})});try{yield Promise.all([this.acquireAudioContext(),...s.map(a=>(a.muted=!1,a.play()))]),this.handleAudioPlaybackStarted()}catch(a){throw this.handleAudioPlaybackFailed(a),a}}),this.startVideo=()=>y(this,void 0,void 0,function*(){const s=[];for(const o of this.participants.values())o.videoTracks.forEach(a=>{var c;(c=a.track)===null||c===void 0||c.attachedElements.forEach(l=>{s.includes(l)||s.push(l)})});yield Promise.all(s.map(o=>o.play())).then(()=>{this.handleVideoPlaybackStarted()}).catch(o=>{o.name==="NotAllowedError"?this.handleVideoPlaybackFailed():this.log.warn("Resuming video playback failed, make sure you call `startVideo` directly in a user gesture handler",this.logContext)})}),this.handleRestarting=()=>{this.clearConnectionReconcile();for(const s of this.participants.values())this.handleParticipantDisconnected(s.sid,s);this.setAndEmitConnectionState(B.Reconnecting)&&this.emit(T.Reconnecting)},this.handleSignalRestarted=s=>y(this,void 0,void 0,function*(){this.log.debug("signal reconnected to server, region ".concat(s.serverRegion),Object.assign(Object.assign({},this.logContext),{region:s.serverRegion})),this.bufferedEvents=[],this.applyJoinResponse(s);try{yield this.localParticipant.republishAllTracks(void 0,!0)}catch(o){this.log.error("error trying to re-publish tracks after reconnection",Object.assign(Object.assign({},this.logContext),{error:o}))}try{yield this.engine.waitForRestarted(),this.log.debug("fully reconnected to server",Object.assign(Object.assign({},this.logContext),{region:s.serverRegion}))}catch{return}this.setAndEmitConnectionState(B.Connected),this.emit(T.Reconnected),this.registerConnectionReconcile(),this.emitBufferedEvents()}),this.handleParticipantUpdates=s=>{s.forEach(o=>{if(o.identity===this.localParticipant.identity){this.localParticipant.updateInfo(o);return}const a=this.identityToSid.get(o.identity);a&&a!==o.sid&&this.handleParticipantDisconnected(a,this.participants.get(a));let c=this.participants.get(o.sid);const l=!c;o.state===vn.DISCONNECTED?this.handleParticipantDisconnected(o.sid,c):(c=this.getOrCreateParticipant(o.sid,o),l||c.updateInfo(o))})},this.handleActiveSpeakersUpdate=s=>{const o=[],a={};s.forEach(c=>{if(a[c.sid]=!0,c.sid===this.localParticipant.sid)this.localParticipant.audioLevel=c.level,this.localParticipant.setIsSpeaking(!0),o.push(this.localParticipant);else{const l=this.participants.get(c.sid);l&&(l.audioLevel=c.level,l.setIsSpeaking(!0),o.push(l))}}),a[this.localParticipant.sid]||(this.localParticipant.audioLevel=0,this.localParticipant.setIsSpeaking(!1)),this.participants.forEach(c=>{a[c.sid]||(c.audioLevel=0,c.setIsSpeaking(!1))}),this.activeSpeakers=o,this.emitWhenConnected(T.ActiveSpeakersChanged,o)},this.handleSpeakersChanged=s=>{const o=new Map;this.activeSpeakers.forEach(c=>{o.set(c.sid,c)}),s.forEach(c=>{let l=this.participants.get(c.sid);c.sid===this.localParticipant.sid&&(l=this.localParticipant),l&&(l.audioLevel=c.level,l.setIsSpeaking(c.active),c.active?o.set(c.sid,l):o.delete(c.sid))});const a=Array.from(o.values());a.sort((c,l)=>l.audioLevel-c.audioLevel),this.activeSpeakers=a,this.emitWhenConnected(T.ActiveSpeakersChanged,a)},this.handleStreamStateUpdate=s=>{s.streamStates.forEach(o=>{const a=this.participants.get(o.participantSid);if(!a)return;const c=a.getTrackPublication(o.trackSid);!c||!c.track||(c.track.streamState=C.streamStateFromProto(o.state),a.emit(E.TrackStreamStateChanged,c,c.track.streamState),this.emitWhenConnected(T.TrackStreamStateChanged,c,c.track.streamState,a))})},this.handleSubscriptionPermissionUpdate=s=>{const o=this.participants.get(s.participantSid);if(!o)return;const a=o.getTrackPublication(s.trackSid);a&&a.setAllowed(s.allowed)},this.handleSubscriptionError=s=>{const o=Array.from(this.participants.values()).find(c=>c.tracks.has(s.trackSid));if(!o)return;const a=o.getTrackPublication(s.trackSid);a&&a.setSubscriptionError(s.err)},this.handleDataPacket=(s,o)=>{const a=this.participants.get(s.participantSid);this.emit(T.DataReceived,s.payload,a,o,s.topic),a==null||a.emit(E.DataReceived,s.payload,o)},this.handleAudioPlaybackStarted=()=>{this.canPlaybackAudio||(this.audioEnabled=!0,this.emit(T.AudioPlaybackStatusChanged,!0))},this.handleAudioPlaybackFailed=s=>{this.log.warn("could not playback audio",Object.assign(Object.assign({},this.logContext),{error:s})),this.canPlaybackAudio&&(this.audioEnabled=!1,this.emit(T.AudioPlaybackStatusChanged,!1))},this.handleVideoPlaybackStarted=()=>{this.isVideoPlaybackBlocked&&(this.isVideoPlaybackBlocked=!1,this.emit(T.VideoPlaybackStatusChanged,!0))},this.handleVideoPlaybackFailed=()=>{this.isVideoPlaybackBlocked||(this.isVideoPlaybackBlocked=!0,this.emit(T.VideoPlaybackStatusChanged,!1))},this.handleDeviceChange=()=>y(this,void 0,void 0,function*(){this.emit(T.MediaDevicesChanged)}),this.handleRoomUpdate=s=>{const o=this.roomInfo;this.roomInfo=s,o&&o.metadata!==s.metadata&&this.emitWhenConnected(T.RoomMetadataChanged,s.metadata),(o==null?void 0:o.activeRecording)!==s.activeRecording&&this.emitWhenConnected(T.RecordingStatusChanged,s.activeRecording)},this.handleConnectionQualityUpdate=s=>{s.updates.forEach(o=>{if(o.participantSid===this.localParticipant.sid){this.localParticipant.setConnectionQuality(o.quality);return}const a=this.participants.get(o.participantSid);a&&a.setConnectionQuality(o.quality)})},this.onLocalParticipantMetadataChanged=s=>{this.emit(T.ParticipantMetadataChanged,s,this.localParticipant)},this.onLocalParticipantNameChanged=s=>{this.emit(T.ParticipantNameChanged,s,this.localParticipant)},this.onLocalTrackMuted=s=>{this.emit(T.TrackMuted,s,this.localParticipant)},this.onLocalTrackUnmuted=s=>{this.emit(T.TrackUnmuted,s,this.localParticipant)},this.onLocalTrackPublished=s=>y(this,void 0,void 0,function*(){var o;this.emit(T.LocalTrackPublished,s,this.localParticipant),s.track instanceof Ee&&(yield s.track.checkForSilence())&&this.emit(T.LocalAudioSilenceDetected,s);const a=yield(o=s.track)===null||o===void 0?void 0:o.getDeviceId(),c=Gu(s.source);c&&a&&a!==this.localParticipant.activeDeviceMap.get(c)&&(this.localParticipant.activeDeviceMap.set(c,a),this.emit(T.ActiveDeviceChanged,c,a))}),this.onLocalTrackUnpublished=s=>{this.emit(T.LocalTrackUnpublished,s,this.localParticipant)},this.onLocalConnectionQualityChanged=s=>{this.emit(T.ConnectionQualityChanged,s,this.localParticipant)},this.onMediaDevicesError=s=>{this.emit(T.MediaDevicesError,s)},this.onLocalParticipantPermissionsChanged=s=>{this.emit(T.ParticipantPermissionsChanged,s,this.localParticipant)},this.setMaxListeners(100),this.participants=new Map,this.identityToSid=new Map,this.options=Object.assign(Object.assign({},Td),e),this.log=zt((i=this.options.loggerName)!==null&&i!==void 0?i:dt.Room),this.options.audioCaptureDefaults=Object.assign(Object.assign({},lc),e==null?void 0:e.audioCaptureDefaults),this.options.videoCaptureDefaults=Object.assign(Object.assign({},uc),e==null?void 0:e.videoCaptureDefaults),this.options.publishDefaults=Object.assign(Object.assign({},Cd),e==null?void 0:e.publishDefaults),this.maybeCreateEngine(),this.disconnectLock=new Ge,this.localParticipant=new fi("","",this.engine,this.options),this.options.videoCaptureDefaults.deviceId&&this.localParticipant.activeDeviceMap.set("videoinput",mn(this.options.videoCaptureDefaults.deviceId)),this.options.audioCaptureDefaults.deviceId&&this.localParticipant.activeDeviceMap.set("audioinput",mn(this.options.audioCaptureDefaults.deviceId)),!((r=this.options.audioOutput)===null||r===void 0)&&r.deviceId&&this.switchActiveDevice("audiooutput",mn(this.options.audioOutput.deviceId)).catch(s=>this.log.warn("Could not set audio output: ".concat(s.message),this.logContext)),this.options.e2ee&&this.setupE2EE()}setE2EEEnabled(e){return y(this,void 0,void 0,function*(){if(this.e2eeManager)yield Promise.all([this.localParticipant.setE2EEEnabled(e)]),this.localParticipant.identity!==""&&this.e2eeManager.setParticipantCryptorEnabled(e,this.localParticipant.identity);else throw Error("e2ee not configured, please set e2ee settings within the room options")})}setupE2EE(){var e;this.options.e2ee&&(this.e2eeManager=new cd(this.options.e2ee),this.e2eeManager.on(on.ParticipantEncryptionStatusChanged,(t,i)=>{i instanceof fi&&(this.isE2EEEnabled=t),this.emit(T.ParticipantEncryptionStatusChanged,t,i)}),this.e2eeManager.on(on.EncryptionError,t=>this.emit(T.EncryptionError,t)),(e=this.e2eeManager)===null||e===void 0||e.setup(this))}get logContext(){return{room:this.name,roomSid:this.sid,identity:this.localParticipant.identity}}get isRecording(){var e,t;return(t=(e=this.roomInfo)===null||e===void 0?void 0:e.activeRecording)!==null&&t!==void 0?t:!1}get sid(){var e,t;return(t=(e=this.roomInfo)===null||e===void 0?void 0:e.sid)!==null&&t!==void 0?t:""}get name(){var e,t;return(t=(e=this.roomInfo)===null||e===void 0?void 0:e.name)!==null&&t!==void 0?t:""}get metadata(){var e;return(e=this.roomInfo)===null||e===void 0?void 0:e.metadata}get numParticipants(){var e,t;return(t=(e=this.roomInfo)===null||e===void 0?void 0:e.numParticipants)!==null&&t!==void 0?t:0}get numPublishers(){var e,t;return(t=(e=this.roomInfo)===null||e===void 0?void 0:e.numPublishers)!==null&&t!==void 0?t:0}maybeCreateEngine(){this.engine&&!this.engine.isClosed||(this.engine=new Pd(this.options),this.engine.on(M.ParticipantUpdate,this.handleParticipantUpdates).on(M.RoomUpdate,this.handleRoomUpdate).on(M.SpeakersChanged,this.handleSpeakersChanged).on(M.StreamStateChanged,this.handleStreamStateUpdate).on(M.ConnectionQualityUpdate,this.handleConnectionQualityUpdate).on(M.SubscriptionError,this.handleSubscriptionError).on(M.SubscriptionPermissionUpdate,this.handleSubscriptionPermissionUpdate).on(M.MediaTrackAdded,(e,t,i)=>{this.onTrackAdded(e,t,i)}).on(M.Disconnected,e=>{this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,e)}).on(M.ActiveSpeakersUpdate,this.handleActiveSpeakersUpdate).on(M.DataPacketReceived,this.handleDataPacket).on(M.Resuming,()=>{this.clearConnectionReconcile(),this.setAndEmitConnectionState(B.Reconnecting)&&this.emit(T.Reconnecting)}).on(M.Resumed,()=>{this.setAndEmitConnectionState(B.Connected),this.emit(T.Reconnected),this.registerConnectionReconcile(),this.updateSubscriptions(),this.emitBufferedEvents()}).on(M.SignalResumed,()=>{this.bufferedEvents=[],this.state===B.Reconnecting&&this.sendSyncState()}).on(M.Restarting,this.handleRestarting).on(M.SignalRestarted,this.handleSignalRestarted).on(M.DCBufferStatusChanged,(e,t)=>{this.emit(T.DCBufferStatusChanged,e,t)}),this.localParticipant&&this.localParticipant.setupEngine(this.engine),this.e2eeManager&&this.e2eeManager.setupEngine(this.engine))}static getLocalDevices(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return ve.getInstance().getDevices(e,t)}prepareConnection(e,t){return y(this,void 0,void 0,function*(){if(this.state===B.Disconnected){this.log.debug("prepareConnection to ".concat(e),this.logContext);try{if(Vr(new URL(e))&&t){this.regionUrlProvider=new So(e,t);const i=yield this.regionUrlProvider.getNextBestRegionUrl();i&&this.state===B.Disconnected&&(this.regionUrl=i,yield fetch(uo(i),{method:"HEAD"}),this.log.debug("prepared connection to ".concat(i),this.logContext))}else yield fetch(uo(e),{method:"HEAD"})}catch(i){this.log.warn("could not prepare connection",Object.assign(Object.assign({},this.logContext),{error:i}))}}})}getParticipantByIdentity(e){if(this.localParticipant.identity===e)return this.localParticipant;const t=this.identityToSid.get(e);if(t)return this.participants.get(t)}clearConnectionFutures(){this.connectFuture=void 0}simulateScenario(e,t){return y(this,void 0,void 0,function*(){let i=()=>{},r;switch(e){case"signal-reconnect":yield this.engine.client.handleOnClose("simulate disconnect");break;case"speaker":r=new ae({scenario:{case:"speakerUpdate",value:3}});break;case"node-failure":r=new ae({scenario:{case:"nodeFailure",value:!0}});break;case"server-leave":r=new ae({scenario:{case:"serverLeave",value:!0}});break;case"migration":r=new ae({scenario:{case:"migration",value:!0}});break;case"resume-reconnect":this.engine.failNext(),yield this.engine.client.handleOnClose("simulate resume-disconnect");break;case"disconnect-signal-on-resume":i=()=>y(this,void 0,void 0,function*(){yield this.engine.client.handleOnClose("simulate resume-disconnect")}),r=new ae({scenario:{case:"disconnectSignalOnResume",value:!0}});break;case"disconnect-signal-on-resume-no-messages":i=()=>y(this,void 0,void 0,function*(){yield this.engine.client.handleOnClose("simulate resume-disconnect")}),r=new ae({scenario:{case:"disconnectSignalOnResumeNoMessages",value:!0}});break;case"full-reconnect":this.engine.fullReconnectOnNext=!0,yield this.engine.client.handleOnClose("simulate full-reconnect");break;case"force-tcp":case"force-tls":r=new ae({scenario:{case:"switchCandidateProtocol",value:e==="force-tls"?2:1}}),i=()=>y(this,void 0,void 0,function*(){const s=this.engine.client.onLeave;s&&s(new _e({reason:Wt.CLIENT_INITIATED,canReconnect:!0}))});break;case"subscriber-bandwidth":if(t===void 0||typeof t!="number")throw new Error("subscriber-bandwidth requires a number as argument");r=new ae({scenario:{case:"subscriberBandwidth",value:BigInt(t)}});break}r&&(yield this.engine.client.sendSimulateScenario(r),yield i())})}get canPlaybackAudio(){return this.audioEnabled}get canPlaybackVideo(){return!this.isVideoPlaybackBlocked}getActiveAudioOutputDevice(){var e,t;return(t=(e=this.options.audioOutput)===null||e===void 0?void 0:e.deviceId)!==null&&t!==void 0?t:""}getActiveDevice(e){return this.localParticipant.activeDeviceMap.get(e)}switchActiveDevice(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;var r,s,o;return y(this,void 0,void 0,function*(){let a=!1,c=!0;const l=i?{exact:t}:t;if(e==="audioinput"){const u=this.options.audioCaptureDefaults.deviceId;this.options.audioCaptureDefaults.deviceId=l,a=u!==l;const d=Array.from(this.localParticipant.audioTracks.values()).filter(h=>h.source===C.Source.Microphone);try{c=(yield Promise.all(d.map(h=>{var m;return(m=h.audioTrack)===null||m===void 0?void 0:m.setDeviceId(l)}))).every(h=>h===!0)}catch(h){throw this.options.audioCaptureDefaults.deviceId=u,h}}else if(e==="videoinput"){const u=this.options.videoCaptureDefaults.deviceId;this.options.videoCaptureDefaults.deviceId=l,a=u!==l;const d=Array.from(this.localParticipant.videoTracks.values()).filter(h=>h.source===C.Source.Camera);try{c=(yield Promise.all(d.map(h=>{var m;return(m=h.videoTrack)===null||m===void 0?void 0:m.setDeviceId(l)}))).every(h=>h===!0)}catch(h){throw this.options.videoCaptureDefaults.deviceId=u,h}}else if(e==="audiooutput"){if(!jr()&&!this.options.expWebAudioMix||this.options.expWebAudioMix&&this.audioContext&&!("setSinkId"in this.audioContext))throw new Error("cannot switch audio output, setSinkId not supported");(r=(o=this.options).audioOutput)!==null&&r!==void 0||(o.audioOutput={});const u=this.options.audioOutput.deviceId;this.options.audioOutput.deviceId=t,a=u!==l;try{this.options.expWebAudioMix?(s=this.audioContext)===null||s===void 0||s.setSinkId(t):yield Promise.all(Array.from(this.participants.values()).map(d=>d.setAudioOutput({deviceId:t})))}catch(d){throw this.options.audioOutput.deviceId=u,d}}return a&&c&&(this.localParticipant.activeDeviceMap.set(e,t),this.emit(T.ActiveDeviceChanged,e,t)),c})}setupLocalParticipantEvents(){this.localParticipant.on(E.ParticipantMetadataChanged,this.onLocalParticipantMetadataChanged).on(E.ParticipantNameChanged,this.onLocalParticipantNameChanged).on(E.TrackMuted,this.onLocalTrackMuted).on(E.TrackUnmuted,this.onLocalTrackUnmuted).on(E.LocalTrackPublished,this.onLocalTrackPublished).on(E.LocalTrackUnpublished,this.onLocalTrackUnpublished).on(E.ConnectionQualityChanged,this.onLocalConnectionQualityChanged).on(E.MediaDevicesError,this.onMediaDevicesError).on(E.AudioStreamAcquired,this.startAudio).on(E.ParticipantPermissionsChanged,this.onLocalParticipantPermissionsChanged)}recreateEngine(){var e;(e=this.engine)===null||e===void 0||e.close(),this.engine=void 0,this.participants.clear(),this.bufferedEvents=[],this.maybeCreateEngine()}onTrackAdded(e,t,i){if(this.state===B.Connecting||this.state===B.Reconnecting){const u=()=>{this.onTrackAdded(e,t,i),d()},d=()=>{this.off(T.Reconnected,u),this.off(T.Connected,u),this.off(T.Disconnected,d)};this.once(T.Reconnected,u),this.once(T.Connected,u),this.once(T.Disconnected,d);return}if(this.state===B.Disconnected){this.log.warn("skipping incoming track after Room disconnected",this.logContext);return}const r=$u(t.id),s=r[0];let o=r[1],a=e.id;if(o&&o.startsWith("TR")&&(a=o),s===this.localParticipant.sid){this.log.warn("tried to create RemoteParticipant for local participant",this.logContext);return}const c=this.participants.get(s);if(!c){this.log.error("Tried to add a track for a participant, that's not present. Sid: ".concat(s),this.logContext);return}let l;this.options.adaptiveStream&&(typeof this.options.adaptiveStream=="object"?l=this.options.adaptiveStream:l={}),c.addSubscribedMediaTrack(e,a,t,i,l)}handleDisconnect(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,t=arguments.length>1?arguments[1]:void 0;var i;if(this.clearConnectionReconcile(),this.bufferedEvents=[],this.state!==B.Disconnected){this.regionUrl=void 0;try{this.participants.forEach(r=>{r.tracks.forEach(s=>{r.unpublishTrack(s.trackSid)})}),this.localParticipant.tracks.forEach(r=>{var s,o;r.track&&this.localParticipant.unpublishTrack(r.track,e),e&&((s=r.track)===null||s===void 0||s.detach(),(o=r.track)===null||o===void 0||o.stop())}),this.localParticipant.off(E.ParticipantMetadataChanged,this.onLocalParticipantMetadataChanged).off(E.ParticipantNameChanged,this.onLocalParticipantNameChanged).off(E.TrackMuted,this.onLocalTrackMuted).off(E.TrackUnmuted,this.onLocalTrackUnmuted).off(E.LocalTrackPublished,this.onLocalTrackPublished).off(E.LocalTrackUnpublished,this.onLocalTrackUnpublished).off(E.ConnectionQualityChanged,this.onLocalConnectionQualityChanged).off(E.MediaDevicesError,this.onMediaDevicesError).off(E.AudioStreamAcquired,this.startAudio).off(E.ParticipantPermissionsChanged,this.onLocalParticipantPermissionsChanged),this.localParticipant.tracks.clear(),this.localParticipant.videoTracks.clear(),this.localParticipant.audioTracks.clear(),this.participants.clear(),this.activeSpeakers=[],this.audioContext&&typeof this.options.expWebAudioMix=="boolean"&&(this.audioContext.close(),this.audioContext=void 0),Ce()&&(window.removeEventListener("beforeunload",this.onPageLeave),window.removeEventListener("pagehide",this.onPageLeave),window.removeEventListener("freeze",this.onPageLeave),(i=navigator.mediaDevices)===null||i===void 0||i.removeEventListener("devicechange",this.handleDeviceChange))}finally{this.setAndEmitConnectionState(B.Disconnected),this.emit(T.Disconnected,t)}}}handleParticipantDisconnected(e,t){this.participants.delete(e),t&&(this.identityToSid.delete(t.identity),t.tracks.forEach(i=>{t.unpublishTrack(i.trackSid,!0)}),this.emit(T.ParticipantDisconnected,t))}acquireAudioContext(){var e,t;return y(this,void 0,void 0,function*(){if(typeof this.options.expWebAudioMix!="boolean"&&this.options.expWebAudioMix.audioContext?this.audioContext=this.options.expWebAudioMix.audioContext:(!this.audioContext||this.audioContext.state==="closed")&&(this.audioContext=(e=ec())!==null&&e!==void 0?e:void 0),this.audioContext&&this.audioContext.state==="suspended")try{yield this.audioContext.resume()}catch(r){this.log.warn("Could not resume audio context",Object.assign(Object.assign({},this.logContext),{error:r}))}this.options.expWebAudioMix&&this.participants.forEach(r=>r.setAudioContext(this.audioContext)),this.localParticipant.setAudioContext(this.audioContext);const i=((t=this.audioContext)===null||t===void 0?void 0:t.state)==="running";i!==this.canPlaybackAudio&&(this.audioEnabled=i,this.emit(T.AudioPlaybackStatusChanged,i))})}createParticipant(e,t){var i;let r;return t?r=hi.fromParticipantInfo(this.engine.client,t):r=new hi(this.engine.client,e,"",void 0,void 0,{loggerContextCb:()=>this.logContext,loggerName:this.options.loggerName}),this.options.expWebAudioMix&&r.setAudioContext(this.audioContext),!((i=this.options.audioOutput)===null||i===void 0)&&i.deviceId&&r.setAudioOutput(this.options.audioOutput).catch(s=>this.log.warn("Could not set audio output: ".concat(s.message),this.logContext)),r}getOrCreateParticipant(e,t){if(this.participants.has(e))return this.participants.get(e);const i=this.createParticipant(e,t);return this.participants.set(e,i),this.identityToSid.set(t.identity,t.sid),this.emitWhenConnected(T.ParticipantConnected,i),i.on(E.TrackPublished,r=>{this.emitWhenConnected(T.TrackPublished,r,i)}).on(E.TrackSubscribed,(r,s)=>{r.kind===C.Kind.Audio?(r.on(R.AudioPlaybackStarted,this.handleAudioPlaybackStarted),r.on(R.AudioPlaybackFailed,this.handleAudioPlaybackFailed)):r.kind===C.Kind.Video&&(r.on(R.VideoPlaybackFailed,this.handleVideoPlaybackFailed),r.on(R.VideoPlaybackStarted,this.handleVideoPlaybackStarted)),this.emit(T.TrackSubscribed,r,s,i)}).on(E.TrackUnpublished,r=>{this.emit(T.TrackUnpublished,r,i)}).on(E.TrackUnsubscribed,(r,s)=>{this.emit(T.TrackUnsubscribed,r,s,i)}).on(E.TrackSubscriptionFailed,r=>{this.emit(T.TrackSubscriptionFailed,r,i)}).on(E.TrackMuted,r=>{this.emitWhenConnected(T.TrackMuted,r,i)}).on(E.TrackUnmuted,r=>{this.emitWhenConnected(T.TrackUnmuted,r,i)}).on(E.ParticipantMetadataChanged,r=>{this.emitWhenConnected(T.ParticipantMetadataChanged,r,i)}).on(E.ParticipantNameChanged,r=>{this.emitWhenConnected(T.ParticipantNameChanged,r,i)}).on(E.ConnectionQualityChanged,r=>{this.emitWhenConnected(T.ConnectionQualityChanged,r,i)}).on(E.ParticipantPermissionsChanged,r=>{this.emitWhenConnected(T.ParticipantPermissionsChanged,r,i)}).on(E.TrackSubscriptionStatusChanged,(r,s)=>{this.emitWhenConnected(T.TrackSubscriptionStatusChanged,r,s,i)}).on(E.TrackSubscriptionFailed,(r,s)=>{this.emit(T.TrackSubscriptionFailed,r,i,s)}).on(E.TrackSubscriptionPermissionChanged,(r,s)=>{this.emitWhenConnected(T.TrackSubscriptionPermissionChanged,r,s,i)}),t&&i.updateInfo(t),i}sendSyncState(){const e=Array.from(this.participants.values()).reduce((i,r)=>(i.push(...r.getTracks()),i),[]),t=this.localParticipant.getTracks();this.engine.sendSyncState(e,t)}updateSubscriptions(){for(const e of this.participants.values())for(const t of e.videoTracks.values())t.isSubscribed&&t instanceof di&&t.emitTrackUpdate()}registerConnectionReconcile(){this.clearConnectionReconcile();let e=0;this.connectionReconcileInterval=le.setInterval(()=>{!this.engine||this.engine.isClosed||!this.engine.verifyTransport()?(e++,this.log.warn("detected connection state mismatch",Object.assign(Object.assign({},this.logContext),{numFailures:e,engine:{closed:this.engine.isClosed,transportsConnected:this.engine.verifyTransport()}})),e>=3&&(this.recreateEngine(),this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,Wt.STATE_MISMATCH))):e=0},Vd)}clearConnectionReconcile(){this.connectionReconcileInterval&&le.clearInterval(this.connectionReconcileInterval)}setAndEmitConnectionState(e){return e===this.state?!1:(this.state=e,this.emit(T.ConnectionStateChanged,this.state),!0)}emitBufferedEvents(){this.bufferedEvents.forEach(e=>{let[t,i]=e;this.emit(t,...i)}),this.bufferedEvents=[]}emitWhenConnected(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];return this.state===B.Connected?this.emit(e,...i):(this.state===B.Reconnecting&&this.bufferedEvents.push([e,i]),!1)}simulateParticipants(e){var t,i;return y(this,void 0,void 0,function*(){const r=Object.assign({audio:!0,video:!0,useRealTracks:!1},e.publish),s=Object.assign({count:9,audio:!1,video:!0,aspectRatios:[1.66,1.7,1.3]},e.participants);if(this.handleDisconnect(),this.roomInfo=new Gn({sid:"RM_SIMULATED",name:"simulated-room",emptyTimeout:0,maxParticipants:0,creationTime:L.parse(new Date().getTime()),metadata:"",numParticipants:1,numPublishers:1,turnPassword:"",enabledCodecs:[],activeRecording:!1}),this.localParticipant.updateInfo(new Pe({identity:"simulated-local",name:"local-name"})),this.setupLocalParticipantEvents(),this.emit(T.SignalConnected),this.emit(T.Connected),this.setAndEmitConnectionState(B.Connected),r.video){const o=new ui(C.Kind.Video,new Se({source:X.CAMERA,sid:Math.floor(Math.random()*1e4).toString(),type:he.AUDIO,name:"video-dummy"}),new Oe(r.useRealTracks?(yield window.navigator.mediaDevices.getUserMedia({video:!0})).getVideoTracks()[0]:lo(160*((t=s.aspectRatios[0])!==null&&t!==void 0?t:1),160,!0,!0),void 0,!1,{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext}),{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext});this.localParticipant.addTrackPublication(o),this.localParticipant.emit(E.LocalTrackPublished,o)}if(r.audio){const o=new ui(C.Kind.Audio,new Se({source:X.MICROPHONE,sid:Math.floor(Math.random()*1e4).toString(),type:he.AUDIO}),new Ee(r.useRealTracks?(yield navigator.mediaDevices.getUserMedia({audio:!0})).getAudioTracks()[0]:dr(),void 0,!1,this.audioContext,{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext}),{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext});this.localParticipant.addTrackPublication(o),this.localParticipant.emit(E.LocalTrackPublished,o)}for(let o=0;o<s.count-1;o+=1){let a=new Pe({sid:Math.floor(Math.random()*1e4).toString(),identity:"simulated-".concat(o),state:vn.ACTIVE,tracks:[],joinedAt:L.parse(Date.now())});const c=this.getOrCreateParticipant(a.identity,a);if(s.video){const l=lo(160*((i=s.aspectRatios[o%s.aspectRatios.length])!==null&&i!==void 0?i:1),160,!1,!0),u=new Se({source:X.CAMERA,sid:Math.floor(Math.random()*1e4).toString(),type:he.AUDIO});c.addSubscribedMediaTrack(l,u.sid,new MediaStream([l])),a.tracks=[...a.tracks,u]}if(s.audio){const l=dr(),u=new Se({source:X.MICROPHONE,sid:Math.floor(Math.random()*1e4).toString(),type:he.AUDIO});c.addSubscribedMediaTrack(l,u.sid,new MediaStream([l])),a.tracks=[...a.tracks,u]}c.updateInfo(a)}})}emit(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];if(e!==T.ActiveSpeakersChanged){const s=gc(i).filter(o=>o!==void 0);this.log.debug("room event ".concat(e),Object.assign(Object.assign({},this.logContext),{event:e,args:s}))}return super.emit(e,...i)}}function gc(n){return n.map(e=>{if(e)return Array.isArray(e)?gc(e):typeof e=="object"?"logContext"in e&&e.logContext:e})}var Le;(function(n){n[n.IDLE=0]="IDLE",n[n.RUNNING=1]="RUNNING",n[n.SKIPPED=2]="SKIPPED",n[n.SUCCESS=3]="SUCCESS",n[n.FAILED=4]="FAILED"})(Le||(Le={}));class zn extends ft.EventEmitter{constructor(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};super(),this.status=Le.IDLE,this.logs=[],this.errorsAsWarnings=!1,this.url=e,this.token=t,this.name=this.constructor.name,this.room=new Fi(i.roomOptions),this.connectOptions=i.connectOptions,i.errorsAsWarnings&&(this.errorsAsWarnings=i.errorsAsWarnings)}run(e){return y(this,void 0,void 0,function*(){if(this.status!==Le.IDLE)throw Error("check is running already");this.setStatus(Le.RUNNING);try{yield this.perform()}catch(t){t instanceof Error&&(this.errorsAsWarnings?this.appendWarning(t.message):this.appendError(t.message))}return yield this.disconnect(),yield new Promise(t=>setTimeout(t,500)),this.status!==Le.SKIPPED&&this.setStatus(this.isSuccess()?Le.SUCCESS:Le.FAILED),e&&e(),this.getInfo()})}isSuccess(){return!this.logs.some(e=>e.level==="error")}connect(){return y(this,void 0,void 0,function*(){return this.room.state===B.Connected?this.room:(yield this.room.connect(this.url,this.token),this.room)})}disconnect(){return y(this,void 0,void 0,function*(){this.room&&this.room.state!==B.Disconnected&&(yield this.room.disconnect(),yield new Promise(e=>setTimeout(e,500)))})}skip(){this.setStatus(Le.SKIPPED)}appendMessage(e){this.logs.push({level:"info",message:e}),this.emit("update",this.getInfo())}appendWarning(e){this.logs.push({level:"warning",message:e}),this.emit("update",this.getInfo())}appendError(e){this.logs.push({level:"error",message:e}),this.emit("update",this.getInfo())}setStatus(e){this.status=e,this.emit("update",this.getInfo())}get engine(){var e;return(e=this.room)===null||e===void 0?void 0:e.engine}getInfo(){return{logs:this.logs,name:this.name,status:this.status,description:this.description}}}function vc(n){var e,t;return y(this,void 0,void 0,function*(){n??(n={}),(e=n.audio)!==null&&e!==void 0||(n.audio=!0),(t=n.video)!==null&&t!==void 0||(n.video=!0);const i=Za(n,lc,uc),r=$i(i),s=navigator.mediaDevices.getUserMedia(r);n.audio&&(ve.userMediaPromiseMap.set("audioinput",s),s.catch(()=>ve.userMediaPromiseMap.delete("audioinput"))),n.video&&(ve.userMediaPromiseMap.set("videoinput",s),s.catch(()=>ve.userMediaPromiseMap.delete("videoinput")));const o=yield s;return o.getTracks().map(a=>{const c=a.kind==="audio";c?n.audio:n.video;let l;const u=c?r.audio:r.video;typeof u!="boolean"&&(l=u),l?l.deviceId=a.getSettings().deviceId:l={deviceId:a.getSettings().deviceId};const d=dc(a,l);return d.kind===C.Kind.Video?d.source=C.Source.Camera:d.kind===C.Kind.Audio&&(d.source=C.Source.Microphone),d.mediaStream=o,d})})}function Jd(n){return y(this,void 0,void 0,function*(){return(yield vc({audio:!1,video:n}))[0]})}function qd(n){return y(this,void 0,void 0,function*(){return(yield vc({audio:n,video:!1}))[0]})}class Wd extends zn{get description(){return"Can publish audio"}perform(){var e;return y(this,void 0,void 0,function*(){const t=yield this.connect(),i=yield qd();t.localParticipant.publishTrack(i),yield new Promise(o=>setTimeout(o,3e3));const r=yield(e=i.sender)===null||e===void 0?void 0:e.getStats();if(!r)throw new Error("Could not get RTCStats");let s=0;if(r.forEach(o=>{o.type==="outbound-rtp"&&o.mediaType==="audio"&&(s=o.packetsSent)}),s===0)throw new Error("Could not determine packets are sent");this.appendMessage("published ".concat(s," audio packets"))})}}class Gd extends zn{get description(){return"Can publish video"}perform(){var e;return y(this,void 0,void 0,function*(){const t=yield this.connect(),i=yield Jd();t.localParticipant.publishTrack(i),yield new Promise(o=>setTimeout(o,3e3));const r=yield(e=i.sender)===null||e===void 0?void 0:e.getStats();if(!r)throw new Error("Could not get RTCStats");let s=0;if(r.forEach(o=>{o.type==="outbound-rtp"&&o.mediaType==="video"&&(s=o.packetsSent)}),s===0)throw new Error("Could not determine packets are sent");this.appendMessage("published ".concat(s," video packets"))})}}class Hd extends zn{get description(){return"Resuming connection after interruption"}perform(){var e;return y(this,void 0,void 0,function*(){const t=yield this.connect();let i=!1,r=!1,s;const o=new Promise(c=>{setTimeout(c,5e3),s=c});t.on(T.Reconnecting,()=>{i=!0}).on(T.Reconnected,()=>{r=!0,s(!0)}),(e=t.engine.client.ws)===null||e===void 0||e.close();const a=t.engine.client.onClose;if(a&&a(""),yield o,i){if(!r||t.state!==B.Connected)throw this.appendWarning("reconnection is only possible in Redis-based configurations"),new Error("Not able to reconnect")}else throw new Error("Did not attempt to reconnect")})}}class zd extends zn{get description(){return"Can connect via TURN"}perform(){var e,t;return y(this,void 0,void 0,function*(){const i=new hs,r=yield i.join(this.url,this.token,{autoSubscribe:!0,maxRetries:0,e2eeEnabled:!1,websocketTimeout:15e3});let s=!1,o=!1,a=!1;for(let c of r.iceServers)for(let l of c.urls)l.startsWith("turn:")?(o=!0,a=!0):l.startsWith("turns:")&&(o=!0,a=!0,s=!0),l.startsWith("stun:")&&(a=!0);a?o&&!s&&this.appendWarning("TURN is configured server side, but TURN/TLS is unavailable."):this.appendWarning("No STUN servers configured on server side."),yield i.close(),!((t=(e=this.connectOptions)===null||e===void 0?void 0:e.rtcConfig)===null||t===void 0)&&t.iceServers||o?yield this.room.connect(this.url,this.token,{rtcConfig:{iceTransportPolicy:"relay"}}):(this.appendWarning("No TURN servers configured."),this.skip(),yield new Promise(c=>setTimeout(c,0)))})}}class Kd extends zn{get description(){return"Establishing WebRTC connection"}perform(){return y(this,void 0,void 0,function*(){let e=!1,t=!1;this.room.on(T.SignalConnected,()=>{const i=this.room.engine.client.onTrickle;this.room.engine.client.onTrickle=(r,s)=>{if(r.candidate){const o=new RTCIceCandidate(r);let a="".concat(o.protocol," ").concat(o.address,":").concat(o.port," ").concat(o.type);o.address&&($d(o.address)?a+=" (private)":o.protocol==="tcp"&&o.tcpType==="passive"?(e=!0,a+=" (passive)"):o.protocol==="udp"&&(t=!0)),this.appendMessage(a)}i&&i(r,s)},this.room.engine.pcManager&&(this.room.engine.pcManager.subscriber.onIceCandidateError=r=>{r instanceof RTCPeerConnectionIceErrorEvent&&this.appendWarning("error with ICE candidate: ".concat(r.errorCode," ").concat(r.errorText," ").concat(r.url))})});try{yield this.connect(),U.info("now the room is connected")}catch(i){throw this.appendWarning("ports need to be open on firewall in order to connect."),i}e||this.appendWarning("Server is not configured for ICE/TCP"),t||this.appendWarning("No public IPv4 UDP candidates were found. Your server is likely not configured correctly")})}}function $d(n){const e=n.split(".");if(e.length===4){if(e[0]==="10")return!0;if(e[0]==="192"&&e[1]==="168")return!0;if(e[0]==="172"){const t=parseInt(e[1],10);if(t>=16&&t<=31)return!0}}return!1}class Yd extends zn{get description(){return"Connecting to signal connection via WebSocket"}perform(){var e,t,i;return y(this,void 0,void 0,function*(){(this.url.startsWith("ws:")||this.url.startsWith("http:"))&&this.appendWarning("Server is insecure, clients may block connections to it");let r=new hs;const s=yield r.join(this.url,this.token,{autoSubscribe:!0,maxRetries:0,e2eeEnabled:!1,websocketTimeout:15e3});this.appendMessage("Connected to server, version ".concat(s.serverVersion,".")),((e=s.serverInfo)===null||e===void 0?void 0:e.edition)===Un.Cloud&&(!((t=s.serverInfo)===null||t===void 0)&&t.region)&&this.appendMessage("LiveKit Cloud: ".concat((i=s.serverInfo)===null||i===void 0?void 0:i.region)),yield r.close()})}}class Rg extends ft.EventEmitter{constructor(e,t){super(),this.checkResults=new Map,this.url=e,this.token=t}getNextCheckId(){const e=this.checkResults.size;return this.checkResults.set(e,{logs:[],status:Le.IDLE,name:"",description:""}),e}updateCheck(e,t){this.checkResults.set(e,t),this.emit("checkUpdate",e,t)}isSuccess(){return Array.from(this.checkResults.values()).every(e=>e.status!==Le.FAILED)}getResults(){return Array.from(this.checkResults.values())}createAndRunCheck(e){return y(this,void 0,void 0,function*(){const t=this.getNextCheckId(),i=new e(this.url,this.token),r=o=>{this.updateCheck(t,o)};i.on("update",r);const s=yield i.run();return i.off("update",r),s})}checkWebsocket(){return y(this,void 0,void 0,function*(){return this.createAndRunCheck(Yd)})}checkWebRTC(){return y(this,void 0,void 0,function*(){return this.createAndRunCheck(Kd)})}checkTURN(){return y(this,void 0,void 0,function*(){return this.createAndRunCheck(zd)})}checkReconnect(){return y(this,void 0,void 0,function*(){return this.createAndRunCheck(Hd)})}checkPublishAudio(){return y(this,void 0,void 0,function*(){return this.createAndRunCheck(Wd)})}checkPublishVideo(){return y(this,void 0,void 0,function*(){return this.createAndRunCheck(Gd)})}}function Qd(n){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var t;const i=n instanceof jn?n.mediaStreamTrack:n,r=i.getSettings();let s={facingMode:(t=e.defaultFacingMode)!==null&&t!==void 0?t:"user",confidence:"low"};if("facingMode"in r){const o=r.facingMode;U.debug("rawFacingMode",{rawFacingMode:o}),o&&typeof o=="string"&&eh(o)&&(s={facingMode:o,confidence:"high"})}if(["low","medium"].includes(s.confidence)){U.debug("Try to get facing mode from device label: (".concat(i.label,")"));const o=Zd(i.label);o!==void 0&&(s=o)}return s}const xo=new Map([["obs virtual camera",{facingMode:"environment",confidence:"medium"}]]),Xd=new Map([["iphone",{facingMode:"environment",confidence:"medium"}],["ipad",{facingMode:"environment",confidence:"medium"}]]);function Zd(n){var e;const t=n.trim().toLowerCase();if(t!=="")return xo.has(t)?xo.get(t):(e=Array.from(Xd.entries()).find(i=>{let[r]=i;return t.includes(r)}))===null||e===void 0?void 0:e[1]}function eh(n){return n===void 0||["user","environment","left","right"].includes(n)}const Gr=Math.min,An=Math.max,Bi=Math.round,ln=n=>({x:n,y:n}),th={left:"right",right:"left",bottom:"top",top:"bottom"},nh={start:"end",end:"start"};function Oo(n,e,t){return An(n,Gr(e,t))}function Qi(n,e){return typeof n=="function"?n(e):n}function Sn(n){return n.split("-")[0]}function Xi(n){return n.split("-")[1]}function bc(n){return n==="x"?"y":"x"}function yc(n){return n==="y"?"height":"width"}function Zi(n){return["top","bottom"].includes(Sn(n))?"y":"x"}function kc(n){return bc(Zi(n))}function ih(n,e,t){t===void 0&&(t=!1);const i=Xi(n),r=kc(n),s=yc(r);let o=r==="x"?i===(t?"end":"start")?"right":"left":i==="start"?"bottom":"top";return e.reference[s]>e.floating[s]&&(o=ji(o)),[o,ji(o)]}function rh(n){const e=ji(n);return[Hr(n),e,Hr(e)]}function Hr(n){return n.replace(/start|end/g,e=>nh[e])}function sh(n,e,t){const i=["left","right"],r=["right","left"],s=["top","bottom"],o=["bottom","top"];switch(n){case"top":case"bottom":return t?e?r:i:e?i:r;case"left":case"right":return e?s:o;default:return[]}}function oh(n,e,t,i){const r=Xi(n);let s=sh(Sn(n),t==="start",i);return r&&(s=s.map(o=>o+"-"+r),e&&(s=s.concat(s.map(Hr)))),s}function ji(n){return n.replace(/left|right|bottom|top/g,e=>th[e])}function ah(n){return{top:0,right:0,bottom:0,left:0,...n}}function ch(n){return typeof n!="number"?ah(n):{top:n,right:n,bottom:n,left:n}}function Vi(n){return{...n,top:n.y,left:n.x,right:n.x+n.width,bottom:n.y+n.height}}function Ro(n,e,t){let{reference:i,floating:r}=n;const s=Zi(e),o=kc(e),a=yc(o),c=Sn(e),l=s==="y",u=i.x+i.width/2-r.width/2,d=i.y+i.height/2-r.height/2,h=i[a]/2-r[a]/2;let m;switch(c){case"top":m={x:u,y:i.y-r.height};break;case"bottom":m={x:u,y:i.y+i.height};break;case"right":m={x:i.x+i.width,y:d};break;case"left":m={x:i.x-r.width,y:d};break;default:m={x:i.x,y:i.y}}switch(Xi(e)){case"start":m[o]-=h*(t&&l?-1:1);break;case"end":m[o]+=h*(t&&l?-1:1);break}return m}const lh=async(n,e,t)=>{const{placement:i="bottom",strategy:r="absolute",middleware:s=[],platform:o}=t,a=s.filter(Boolean),c=await(o.isRTL==null?void 0:o.isRTL(e));let l=await o.getElementRects({reference:n,floating:e,strategy:r}),{x:u,y:d}=Ro(l,i,c),h=i,m={},g=0;for(let v=0;v<a.length;v++){const{name:b,fn:k}=a[v],{x:S,y:O,data:x,reset:_}=await k({x:u,y:d,initialPlacement:i,placement:h,strategy:r,middlewareData:m,rects:l,platform:o,elements:{reference:n,floating:e}});u=S??u,d=O??d,m={...m,[b]:{...m[b],...x}},_&&g<=50&&(g++,typeof _=="object"&&(_.placement&&(h=_.placement),_.rects&&(l=_.rects===!0?await o.getElementRects({reference:n,floating:e,strategy:r}):_.rects),{x:u,y:d}=Ro(l,h,c)),v=-1)}return{x:u,y:d,placement:h,strategy:r,middlewareData:m}};async function Sc(n,e){var t;e===void 0&&(e={});const{x:i,y:r,platform:s,rects:o,elements:a,strategy:c}=n,{boundary:l="clippingAncestors",rootBoundary:u="viewport",elementContext:d="floating",altBoundary:h=!1,padding:m=0}=Qi(e,n),g=ch(m),b=a[h?d==="floating"?"reference":"floating":d],k=Vi(await s.getClippingRect({element:(t=await(s.isElement==null?void 0:s.isElement(b)))==null||t?b:b.contextElement||await(s.getDocumentElement==null?void 0:s.getDocumentElement(a.floating)),boundary:l,rootBoundary:u,strategy:c})),S=d==="floating"?{...o.floating,x:i,y:r}:o.reference,O=await(s.getOffsetParent==null?void 0:s.getOffsetParent(a.floating)),x=await(s.isElement==null?void 0:s.isElement(O))?await(s.getScale==null?void 0:s.getScale(O))||{x:1,y:1}:{x:1,y:1},_=Vi(s.convertOffsetParentRelativeRectToViewportRelativeRect?await s.convertOffsetParentRelativeRectToViewportRelativeRect({elements:a,rect:S,offsetParent:O,strategy:c}):S);return{top:(k.top-_.top+g.top)/x.y,bottom:(_.bottom-k.bottom+g.bottom)/x.y,left:(k.left-_.left+g.left)/x.x,right:(_.right-k.right+g.right)/x.x}}const uh=function(n){return n===void 0&&(n={}),{name:"flip",options:n,async fn(e){var t,i;const{placement:r,middlewareData:s,rects:o,initialPlacement:a,platform:c,elements:l}=e,{mainAxis:u=!0,crossAxis:d=!0,fallbackPlacements:h,fallbackStrategy:m="bestFit",fallbackAxisSideDirection:g="none",flipAlignment:v=!0,...b}=Qi(n,e);if((t=s.arrow)!=null&&t.alignmentOffset)return{};const k=Sn(r),S=Sn(a)===a,O=await(c.isRTL==null?void 0:c.isRTL(l.floating)),x=h||(S||!v?[ji(a)]:rh(a));!h&&g!=="none"&&x.push(...oh(a,v,g,O));const _=[a,...x],A=await Sc(e,b),j=[];let N=((i=s.flip)==null?void 0:i.overflows)||[];if(u&&j.push(A[k]),d){const Z=ih(r,o,O);j.push(A[Z[0]],A[Z[1]])}if(N=[...N,{placement:r,overflows:j}],!j.every(Z=>Z<=0)){var P,V;const Z=(((P=s.flip)==null?void 0:P.index)||0)+1,se=_[Z];if(se)return{data:{index:Z,overflows:N},reset:{placement:se}};let de=(V=N.filter(ee=>ee.overflows[0]<=0).sort((ee,Y)=>ee.overflows[1]-Y.overflows[1])[0])==null?void 0:V.placement;if(!de)switch(m){case"bestFit":{var $;const ee=($=N.map(Y=>[Y.placement,Y.overflows.filter(Zt=>Zt>0).reduce((Zt,ir)=>Zt+ir,0)]).sort((Y,Zt)=>Y[1]-Zt[1])[0])==null?void 0:$[0];ee&&(de=ee);break}case"initialPlacement":de=a;break}if(r!==de)return{reset:{placement:de}}}return{}}}};async function dh(n,e){const{placement:t,platform:i,elements:r}=n,s=await(i.isRTL==null?void 0:i.isRTL(r.floating)),o=Sn(t),a=Xi(t),c=Zi(t)==="y",l=["left","top"].includes(o)?-1:1,u=s&&c?-1:1,d=Qi(e,n);let{mainAxis:h,crossAxis:m,alignmentAxis:g}=typeof d=="number"?{mainAxis:d,crossAxis:0,alignmentAxis:null}:{mainAxis:0,crossAxis:0,alignmentAxis:null,...d};return a&&typeof g=="number"&&(m=a==="end"?g*-1:g),c?{x:m*u,y:h*l}:{x:h*l,y:m*u}}const hh=function(n){return n===void 0&&(n=0),{name:"offset",options:n,async fn(e){var t,i;const{x:r,y:s,placement:o,middlewareData:a}=e,c=await dh(e,n);return o===((t=a.offset)==null?void 0:t.placement)&&(i=a.arrow)!=null&&i.alignmentOffset?{}:{x:r+c.x,y:s+c.y,data:{...c,placement:o}}}}},fh=function(n){return n===void 0&&(n={}),{name:"shift",options:n,async fn(e){const{x:t,y:i,placement:r}=e,{mainAxis:s=!0,crossAxis:o=!1,limiter:a={fn:b=>{let{x:k,y:S}=b;return{x:k,y:S}}},...c}=Qi(n,e),l={x:t,y:i},u=await Sc(e,c),d=Zi(Sn(r)),h=bc(d);let m=l[h],g=l[d];if(s){const b=h==="y"?"top":"left",k=h==="y"?"bottom":"right",S=m+u[b],O=m-u[k];m=Oo(S,m,O)}if(o){const b=d==="y"?"top":"left",k=d==="y"?"bottom":"right",S=g+u[b],O=g-u[k];g=Oo(S,g,O)}const v=a.fn({...e,[h]:m,[d]:g});return{...v,data:{x:v.x-t,y:v.y-i}}}}};function un(n){return Cc(n)?(n.nodeName||"").toLowerCase():"#document"}function xe(n){var e;return(n==null||(e=n.ownerDocument)==null?void 0:e.defaultView)||window}function dn(n){var e;return(e=(Cc(n)?n.ownerDocument:n.document)||window.document)==null?void 0:e.documentElement}function Cc(n){return n instanceof Node||n instanceof xe(n).Node}function $t(n){return n instanceof Element||n instanceof xe(n).Element}function ht(n){return n instanceof HTMLElement||n instanceof xe(n).HTMLElement}function Io(n){return typeof ShadowRoot>"u"?!1:n instanceof ShadowRoot||n instanceof xe(n).ShadowRoot}function vi(n){const{overflow:e,overflowX:t,overflowY:i,display:r}=Me(n);return/auto|scroll|overlay|hidden|clip/.test(e+i+t)&&!["inline","contents"].includes(r)}function ph(n){return["table","td","th"].includes(un(n))}function ms(n){const e=gs(),t=Me(n);return t.transform!=="none"||t.perspective!=="none"||(t.containerType?t.containerType!=="normal":!1)||!e&&(t.backdropFilter?t.backdropFilter!=="none":!1)||!e&&(t.filter?t.filter!=="none":!1)||["transform","perspective","filter"].some(i=>(t.willChange||"").includes(i))||["paint","layout","strict","content"].some(i=>(t.contain||"").includes(i))}function mh(n){let e=Vn(n);for(;ht(e)&&!er(e);){if(ms(e))return e;e=Vn(e)}return null}function gs(){return typeof CSS>"u"||!CSS.supports?!1:CSS.supports("-webkit-backdrop-filter","none")}function er(n){return["html","body","#document"].includes(un(n))}function Me(n){return xe(n).getComputedStyle(n)}function tr(n){return $t(n)?{scrollLeft:n.scrollLeft,scrollTop:n.scrollTop}:{scrollLeft:n.pageXOffset,scrollTop:n.pageYOffset}}function Vn(n){if(un(n)==="html")return n;const e=n.assignedSlot||n.parentNode||Io(n)&&n.host||dn(n);return Io(e)?e.host:e}function Tc(n){const e=Vn(n);return er(e)?n.ownerDocument?n.ownerDocument.body:n.body:ht(e)&&vi(e)?e:Tc(e)}function zr(n,e,t){var i;e===void 0&&(e=[]),t===void 0&&(t=!0);const r=Tc(n),s=r===((i=n.ownerDocument)==null?void 0:i.body),o=xe(r);return s?e.concat(o,o.visualViewport||[],vi(r)?r:[],o.frameElement&&t?zr(o.frameElement):[]):e.concat(r,zr(r,[],t))}function wc(n){const e=Me(n);let t=parseFloat(e.width)||0,i=parseFloat(e.height)||0;const r=ht(n),s=r?n.offsetWidth:t,o=r?n.offsetHeight:i,a=Bi(t)!==s||Bi(i)!==o;return a&&(t=s,i=o),{width:t,height:i,$:a}}function Ec(n){return $t(n)?n:n.contextElement}function Dn(n){const e=Ec(n);if(!ht(e))return ln(1);const t=e.getBoundingClientRect(),{width:i,height:r,$:s}=wc(e);let o=(s?Bi(t.width):t.width)/i,a=(s?Bi(t.height):t.height)/r;return(!o||!Number.isFinite(o))&&(o=1),(!a||!Number.isFinite(a))&&(a=1),{x:o,y:a}}const gh=ln(0);function Pc(n){const e=xe(n);return!gs()||!e.visualViewport?gh:{x:e.visualViewport.offsetLeft,y:e.visualViewport.offsetTop}}function vh(n,e,t){return e===void 0&&(e=!1),!t||e&&t!==xe(n)?!1:e}function pi(n,e,t,i){e===void 0&&(e=!1),t===void 0&&(t=!1);const r=n.getBoundingClientRect(),s=Ec(n);let o=ln(1);e&&(i?$t(i)&&(o=Dn(i)):o=Dn(n));const a=vh(s,t,i)?Pc(s):ln(0);let c=(r.left+a.x)/o.x,l=(r.top+a.y)/o.y,u=r.width/o.x,d=r.height/o.y;if(s){const h=xe(s),m=i&&$t(i)?xe(i):i;let g=h.frameElement;for(;g&&i&&m!==h;){const v=Dn(g),b=g.getBoundingClientRect(),k=Me(g),S=b.left+(g.clientLeft+parseFloat(k.paddingLeft))*v.x,O=b.top+(g.clientTop+parseFloat(k.paddingTop))*v.y;c*=v.x,l*=v.y,u*=v.x,d*=v.y,c+=S,l+=O,g=xe(g).frameElement}}return Vi({width:u,height:d,x:c,y:l})}function bh(n){let{rect:e,offsetParent:t,strategy:i}=n;const r=ht(t),s=dn(t);if(t===s)return e;let o={scrollLeft:0,scrollTop:0},a=ln(1);const c=ln(0);if((r||!r&&i!=="fixed")&&((un(t)!=="body"||vi(s))&&(o=tr(t)),ht(t))){const l=pi(t);a=Dn(t),c.x=l.x+t.clientLeft,c.y=l.y+t.clientTop}return{width:e.width*a.x,height:e.height*a.y,x:e.x*a.x-o.scrollLeft*a.x+c.x,y:e.y*a.y-o.scrollTop*a.y+c.y}}function yh(n){return Array.from(n.getClientRects())}function xc(n){return pi(dn(n)).left+tr(n).scrollLeft}function kh(n){const e=dn(n),t=tr(n),i=n.ownerDocument.body,r=An(e.scrollWidth,e.clientWidth,i.scrollWidth,i.clientWidth),s=An(e.scrollHeight,e.clientHeight,i.scrollHeight,i.clientHeight);let o=-t.scrollLeft+xc(n);const a=-t.scrollTop;return Me(i).direction==="rtl"&&(o+=An(e.clientWidth,i.clientWidth)-r),{width:r,height:s,x:o,y:a}}function Sh(n,e){const t=xe(n),i=dn(n),r=t.visualViewport;let s=i.clientWidth,o=i.clientHeight,a=0,c=0;if(r){s=r.width,o=r.height;const l=gs();(!l||l&&e==="fixed")&&(a=r.offsetLeft,c=r.offsetTop)}return{width:s,height:o,x:a,y:c}}function Ch(n,e){const t=pi(n,!0,e==="fixed"),i=t.top+n.clientTop,r=t.left+n.clientLeft,s=ht(n)?Dn(n):ln(1),o=n.clientWidth*s.x,a=n.clientHeight*s.y,c=r*s.x,l=i*s.y;return{width:o,height:a,x:c,y:l}}function _o(n,e,t){let i;if(e==="viewport")i=Sh(n,t);else if(e==="document")i=kh(dn(n));else if($t(e))i=Ch(e,t);else{const r=Pc(n);i={...e,x:e.x-r.x,y:e.y-r.y}}return Vi(i)}function Oc(n,e){const t=Vn(n);return t===e||!$t(t)||er(t)?!1:Me(t).position==="fixed"||Oc(t,e)}function Th(n,e){const t=e.get(n);if(t)return t;let i=zr(n,[],!1).filter(a=>$t(a)&&un(a)!=="body"),r=null;const s=Me(n).position==="fixed";let o=s?Vn(n):n;for(;$t(o)&&!er(o);){const a=Me(o),c=ms(o);!c&&a.position==="fixed"&&(r=null),(s?!c&&!r:!c&&a.position==="static"&&!!r&&["absolute","fixed"].includes(r.position)||vi(o)&&!c&&Oc(n,o))?i=i.filter(u=>u!==o):r=a,o=Vn(o)}return e.set(n,i),i}function wh(n){let{element:e,boundary:t,rootBoundary:i,strategy:r}=n;const o=[...t==="clippingAncestors"?Th(e,this._c):[].concat(t),i],a=o[0],c=o.reduce((l,u)=>{const d=_o(e,u,r);return l.top=An(d.top,l.top),l.right=Gr(d.right,l.right),l.bottom=Gr(d.bottom,l.bottom),l.left=An(d.left,l.left),l},_o(e,a,r));return{width:c.right-c.left,height:c.bottom-c.top,x:c.left,y:c.top}}function Eh(n){const{width:e,height:t}=wc(n);return{width:e,height:t}}function Ph(n,e,t){const i=ht(e),r=dn(e),s=t==="fixed",o=pi(n,!0,s,e);let a={scrollLeft:0,scrollTop:0};const c=ln(0);if(i||!i&&!s)if((un(e)!=="body"||vi(r))&&(a=tr(e)),i){const l=pi(e,!0,s,e);c.x=l.x+e.clientLeft,c.y=l.y+e.clientTop}else r&&(c.x=xc(r));return{x:o.left+a.scrollLeft-c.x,y:o.top+a.scrollTop-c.y,width:o.width,height:o.height}}function Mo(n,e){return!ht(n)||Me(n).position==="fixed"?null:e?e(n):n.offsetParent}function Rc(n,e){const t=xe(n);if(!ht(n))return t;let i=Mo(n,e);for(;i&&ph(i)&&Me(i).position==="static";)i=Mo(i,e);return i&&(un(i)==="html"||un(i)==="body"&&Me(i).position==="static"&&!ms(i))?t:i||mh(n)||t}const xh=async function(n){let{reference:e,floating:t,strategy:i}=n;const r=this.getOffsetParent||Rc,s=this.getDimensions;return{reference:Ph(e,await r(t),i),floating:{x:0,y:0,...await s(t)}}};function Oh(n){return Me(n).direction==="rtl"}const Rh={convertOffsetParentRelativeRectToViewportRelativeRect:bh,getDocumentElement:dn,getClippingRect:wh,getOffsetParent:Rc,getElementRects:xh,getClientRects:yh,getDimensions:Eh,getScale:Dn,isElement:$t,isRTL:Oh},Ih=fh,_h=uh,Mh=(n,e,t)=>{const i=new Map,r={platform:Rh,...t},s={...r.platform,_c:i};return lh(n,e,{...r,platform:s})};var Ic={exports:{}};(function(n){(function(e,t){n.exports?n.exports=t():e.log=t()})(gl,function(){var e=function(){},t="undefined",i=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),r=["trace","debug","info","warn","error"];function s(v,b){var k=v[b];if(typeof k.bind=="function")return k.bind(v);try{return Function.prototype.bind.call(k,v)}catch{return function(){return Function.prototype.apply.apply(k,[v,arguments])}}}function o(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function a(v){return v==="debug"&&(v="log"),typeof console===t?!1:v==="trace"&&i?o:console[v]!==void 0?s(console,v):console.log!==void 0?s(console,"log"):e}function c(v,b){for(var k=0;k<r.length;k++){var S=r[k];this[S]=k<v?e:this.methodFactory(S,v,b)}this.log=this.debug}function l(v,b,k){return function(){typeof console!==t&&(c.call(this,b,k),this[v].apply(this,arguments))}}function u(v,b,k){return a(v)||l.apply(this,arguments)}function d(v,b,k){var S=this,O;b=b??"WARN";var x="loglevel";typeof v=="string"?x+=":"+v:typeof v=="symbol"&&(x=void 0);function _(P){var V=(r[P]||"silent").toUpperCase();if(!(typeof window===t||!x)){try{window.localStorage[x]=V;return}catch{}try{window.document.cookie=encodeURIComponent(x)+"="+V+";"}catch{}}}function A(){var P;if(!(typeof window===t||!x)){try{P=window.localStorage[x]}catch{}if(typeof P===t)try{var V=window.document.cookie,$=V.indexOf(encodeURIComponent(x)+"=");$!==-1&&(P=/^([^;]+)/.exec(V.slice($))[1])}catch{}return S.levels[P]===void 0&&(P=void 0),P}}function j(){if(!(typeof window===t||!x)){try{window.localStorage.removeItem(x);return}catch{}try{window.document.cookie=encodeURIComponent(x)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}S.name=v,S.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},S.methodFactory=k||u,S.getLevel=function(){return O},S.setLevel=function(P,V){if(typeof P=="string"&&S.levels[P.toUpperCase()]!==void 0&&(P=S.levels[P.toUpperCase()]),typeof P=="number"&&P>=0&&P<=S.levels.SILENT){if(O=P,V!==!1&&_(P),c.call(S,P,v),typeof console===t&&P<S.levels.SILENT)return"No console available for logging"}else throw"log.setLevel() called with invalid level: "+P},S.setDefaultLevel=function(P){b=P,A()||S.setLevel(P,!1)},S.resetLevel=function(){S.setLevel(b,!1),j()},S.enableAll=function(P){S.setLevel(S.levels.TRACE,P)},S.disableAll=function(P){S.setLevel(S.levels.SILENT,P)};var N=A();N==null&&(N=b),S.setLevel(N,!1)}var h=new d,m={};h.getLogger=function(b){if(typeof b!="symbol"&&typeof b!="string"||b==="")throw new TypeError("You must supply a name when creating a logger.");var k=m[b];return k||(k=m[b]=new d(b,h.getLevel(),h.methodFactory)),k};var g=typeof window!==t?window.log:void 0;return h.noConflict=function(){return typeof window!==t&&window.log===h&&(window.log=g),h},h.getLoggers=function(){return m},h.default=h,h})})(Ic);var Nh=Ic.exports;const Ah=vl(Nh);var Kr=function(n,e){return Kr=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var r in i)Object.prototype.hasOwnProperty.call(i,r)&&(t[r]=i[r])},Kr(n,e)};function Qt(n,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");Kr(n,e);function t(){this.constructor=n}n.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}function Dh(n,e,t,i){function r(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function a(u){try{l(i.next(u))}catch(d){o(d)}}function c(u){try{l(i.throw(u))}catch(d){o(d)}}function l(u){u.done?s(u.value):r(u.value).then(a,c)}l((i=i.apply(n,e||[])).next())})}function _c(n,e){var t={label:0,sent:function(){if(s[0]&1)throw s[1];return s[1]},trys:[],ops:[]},i,r,s,o;return o={next:a(0),throw:a(1),return:a(2)},typeof Symbol=="function"&&(o[Symbol.iterator]=function(){return this}),o;function a(l){return function(u){return c([l,u])}}function c(l){if(i)throw new TypeError("Generator is already executing.");for(;o&&(o=0,l[0]&&(t=0)),t;)try{if(i=1,r&&(s=l[0]&2?r.return:l[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,l[1])).done)return s;switch(r=0,s&&(l=[l[0]&2,s.value]),l[0]){case 0:case 1:s=l;break;case 4:return t.label++,{value:l[1],done:!1};case 5:t.label++,r=l[1],l=[0];continue;case 7:l=t.ops.pop(),t.trys.pop();continue;default:if(s=t.trys,!(s=s.length>0&&s[s.length-1])&&(l[0]===6||l[0]===2)){t=0;continue}if(l[0]===3&&(!s||l[1]>s[0]&&l[1]<s[3])){t.label=l[1];break}if(l[0]===6&&t.label<s[1]){t.label=s[1],s=l;break}if(s&&t.label<s[2]){t.label=s[2],t.ops.push(l);break}s[2]&&t.ops.pop(),t.trys.pop();continue}l=e.call(n,t)}catch(u){l=[6,u],r=0}finally{i=s=0}if(l[0]&5)throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}}function Jn(n){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&n[e],i=0;if(t)return t.call(n);if(n&&typeof n.length=="number")return{next:function(){return n&&i>=n.length&&(n=void 0),{value:n&&n[i++],done:!n}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function qn(n,e){var t=typeof Symbol=="function"&&n[Symbol.iterator];if(!t)return n;var i=t.call(n),r,s=[],o;try{for(;(e===void 0||e-- >0)&&!(r=i.next()).done;)s.push(r.value)}catch(a){o={error:a}}finally{try{r&&!r.done&&(t=i.return)&&t.call(i)}finally{if(o)throw o.error}}return s}function mi(n,e,t){if(t||arguments.length===2)for(var i=0,r=e.length,s;i<r;i++)(s||!(i in e))&&(s||(s=Array.prototype.slice.call(e,0,i)),s[i]=e[i]);return n.concat(s||Array.prototype.slice.call(e))}function Ln(n){return this instanceof Ln?(this.v=n,this):new Ln(n)}function Lh(n,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i=t.apply(n,e||[]),r,s=[];return r={},o("next"),o("throw"),o("return"),r[Symbol.asyncIterator]=function(){return this},r;function o(h){i[h]&&(r[h]=function(m){return new Promise(function(g,v){s.push([h,m,g,v])>1||a(h,m)})})}function a(h,m){try{c(i[h](m))}catch(g){d(s[0][3],g)}}function c(h){h.value instanceof Ln?Promise.resolve(h.value.v).then(l,u):d(s[0][2],h)}function l(h){a("next",h)}function u(h){a("throw",h)}function d(h,m){h(m),s.shift(),s.length&&a(s[0][0],s[0][1])}}function Uh(n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=n[Symbol.asyncIterator],t;return e?e.call(n):(n=typeof Jn=="function"?Jn(n):n[Symbol.iterator](),t={},i("next"),i("throw"),i("return"),t[Symbol.asyncIterator]=function(){return this},t);function i(s){t[s]=n[s]&&function(o){return new Promise(function(a,c){o=n[s](o),r(a,c,o.done,o.value)})}}function r(s,o,a,c){Promise.resolve(c).then(function(l){s({value:l,done:a})},o)}}function G(n){return typeof n=="function"}function vs(n){var e=function(i){Error.call(i),i.stack=new Error().stack},t=n(e);return t.prototype=Object.create(Error.prototype),t.prototype.constructor=t,t}var gr=vs(function(n){return function(t){n(this),this.message=t?t.length+` errors occurred during unsubscription:
`+t.map(function(i,r){return r+1+") "+i.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=t}});function Ji(n,e){if(n){var t=n.indexOf(e);0<=t&&n.splice(t,1)}}var bi=function(){function n(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._finalizers=null}return n.prototype.unsubscribe=function(){var e,t,i,r,s;if(!this.closed){this.closed=!0;var o=this._parentage;if(o)if(this._parentage=null,Array.isArray(o))try{for(var a=Jn(o),c=a.next();!c.done;c=a.next()){var l=c.value;l.remove(this)}}catch(v){e={error:v}}finally{try{c&&!c.done&&(t=a.return)&&t.call(a)}finally{if(e)throw e.error}}else o.remove(this);var u=this.initialTeardown;if(G(u))try{u()}catch(v){s=v instanceof gr?v.errors:[v]}var d=this._finalizers;if(d){this._finalizers=null;try{for(var h=Jn(d),m=h.next();!m.done;m=h.next()){var g=m.value;try{No(g)}catch(v){s=s??[],v instanceof gr?s=mi(mi([],qn(s)),qn(v.errors)):s.push(v)}}}catch(v){i={error:v}}finally{try{m&&!m.done&&(r=h.return)&&r.call(h)}finally{if(i)throw i.error}}}if(s)throw new gr(s)}},n.prototype.add=function(e){var t;if(e&&e!==this)if(this.closed)No(e);else{if(e instanceof n){if(e.closed||e._hasParent(this))return;e._addParent(this)}(this._finalizers=(t=this._finalizers)!==null&&t!==void 0?t:[]).push(e)}},n.prototype._hasParent=function(e){var t=this._parentage;return t===e||Array.isArray(t)&&t.includes(e)},n.prototype._addParent=function(e){var t=this._parentage;this._parentage=Array.isArray(t)?(t.push(e),t):t?[t,e]:e},n.prototype._removeParent=function(e){var t=this._parentage;t===e?this._parentage=null:Array.isArray(t)&&Ji(t,e)},n.prototype.remove=function(e){var t=this._finalizers;t&&Ji(t,e),e instanceof n&&e._removeParent(this)},n.EMPTY=function(){var e=new n;return e.closed=!0,e}(),n}(),Mc=bi.EMPTY;function Nc(n){return n instanceof bi||n&&"closed"in n&&G(n.remove)&&G(n.add)&&G(n.unsubscribe)}function No(n){G(n)?n():n.unsubscribe()}var Ac={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1},Dc={setTimeout:function(n,e){for(var t=[],i=2;i<arguments.length;i++)t[i-2]=arguments[i];return setTimeout.apply(void 0,mi([n,e],qn(t)))},clearTimeout:function(n){var e=Dc.delegate;return((e==null?void 0:e.clearTimeout)||clearTimeout)(n)},delegate:void 0};function Lc(n){Dc.setTimeout(function(){throw n})}function $r(){}function Ni(n){n()}var bs=function(n){Qt(e,n);function e(t){var i=n.call(this)||this;return i.isStopped=!1,t?(i.destination=t,Nc(t)&&t.add(i)):i.destination=Vh,i}return e.create=function(t,i,r){return new Yr(t,i,r)},e.prototype.next=function(t){this.isStopped||this._next(t)},e.prototype.error=function(t){this.isStopped||(this.isStopped=!0,this._error(t))},e.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},e.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,n.prototype.unsubscribe.call(this),this.destination=null)},e.prototype._next=function(t){this.destination.next(t)},e.prototype._error=function(t){try{this.destination.error(t)}finally{this.unsubscribe()}},e.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},e}(bi),Fh=Function.prototype.bind;function vr(n,e){return Fh.call(n,e)}var Bh=function(){function n(e){this.partialObserver=e}return n.prototype.next=function(e){var t=this.partialObserver;if(t.next)try{t.next(e)}catch(i){Ci(i)}},n.prototype.error=function(e){var t=this.partialObserver;if(t.error)try{t.error(e)}catch(i){Ci(i)}else Ci(e)},n.prototype.complete=function(){var e=this.partialObserver;if(e.complete)try{e.complete()}catch(t){Ci(t)}},n}(),Yr=function(n){Qt(e,n);function e(t,i,r){var s=n.call(this)||this,o;if(G(t)||!t)o={next:t??void 0,error:i??void 0,complete:r??void 0};else{var a;s&&Ac.useDeprecatedNextContext?(a=Object.create(t),a.unsubscribe=function(){return s.unsubscribe()},o={next:t.next&&vr(t.next,a),error:t.error&&vr(t.error,a),complete:t.complete&&vr(t.complete,a)}):o=t}return s.destination=new Bh(o),s}return e}(bs);function Ci(n){Lc(n)}function jh(n){throw n}var Vh={closed:!0,next:$r,error:jh,complete:$r},ys=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}();function ks(n){return n}function Jh(n){return n.length===0?ks:n.length===1?n[0]:function(t){return n.reduce(function(i,r){return r(i)},t)}}var me=function(){function n(e){e&&(this._subscribe=e)}return n.prototype.lift=function(e){var t=new n;return t.source=this,t.operator=e,t},n.prototype.subscribe=function(e,t,i){var r=this,s=Wh(e)?e:new Yr(e,t,i);return Ni(function(){var o=r,a=o.operator,c=o.source;s.add(a?a.call(s,c):c?r._subscribe(s):r._trySubscribe(s))}),s},n.prototype._trySubscribe=function(e){try{return this._subscribe(e)}catch(t){e.error(t)}},n.prototype.forEach=function(e,t){var i=this;return t=Ao(t),new t(function(r,s){var o=new Yr({next:function(a){try{e(a)}catch(c){s(c),o.unsubscribe()}},error:s,complete:r});i.subscribe(o)})},n.prototype._subscribe=function(e){var t;return(t=this.source)===null||t===void 0?void 0:t.subscribe(e)},n.prototype[ys]=function(){return this},n.prototype.pipe=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return Jh(e)(this)},n.prototype.toPromise=function(e){var t=this;return e=Ao(e),new e(function(i,r){var s;t.subscribe(function(o){return s=o},function(o){return r(o)},function(){return i(s)})})},n.create=function(e){return new n(e)},n}();function Ao(n){var e;return(e=n??Ac.Promise)!==null&&e!==void 0?e:Promise}function qh(n){return n&&G(n.next)&&G(n.error)&&G(n.complete)}function Wh(n){return n&&n instanceof bs||qh(n)&&Nc(n)}function Gh(n){return G(n==null?void 0:n.lift)}function pt(n){return function(e){if(Gh(e))return e.lift(function(t){try{return n(t,this)}catch(i){this.error(i)}});throw new TypeError("Unable to lift unknown Observable type")}}function Yt(n,e,t,i,r){return new Hh(n,e,t,i,r)}var Hh=function(n){Qt(e,n);function e(t,i,r,s,o,a){var c=n.call(this,t)||this;return c.onFinalize=o,c.shouldUnsubscribe=a,c._next=i?function(l){try{i(l)}catch(u){t.error(u)}}:n.prototype._next,c._error=s?function(l){try{s(l)}catch(u){t.error(u)}finally{this.unsubscribe()}}:n.prototype._error,c._complete=r?function(){try{r()}catch(l){t.error(l)}finally{this.unsubscribe()}}:n.prototype._complete,c}return e.prototype.unsubscribe=function(){var t;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var i=this.closed;n.prototype.unsubscribe.call(this),!i&&((t=this.onFinalize)===null||t===void 0||t.call(this))}},e}(bs),zh=vs(function(n){return function(){n(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),Wn=function(n){Qt(e,n);function e(){var t=n.call(this)||this;return t.closed=!1,t.currentObservers=null,t.observers=[],t.isStopped=!1,t.hasError=!1,t.thrownError=null,t}return e.prototype.lift=function(t){var i=new Do(this,this);return i.operator=t,i},e.prototype._throwIfClosed=function(){if(this.closed)throw new zh},e.prototype.next=function(t){var i=this;Ni(function(){var r,s;if(i._throwIfClosed(),!i.isStopped){i.currentObservers||(i.currentObservers=Array.from(i.observers));try{for(var o=Jn(i.currentObservers),a=o.next();!a.done;a=o.next()){var c=a.value;c.next(t)}}catch(l){r={error:l}}finally{try{a&&!a.done&&(s=o.return)&&s.call(o)}finally{if(r)throw r.error}}}})},e.prototype.error=function(t){var i=this;Ni(function(){if(i._throwIfClosed(),!i.isStopped){i.hasError=i.isStopped=!0,i.thrownError=t;for(var r=i.observers;r.length;)r.shift().error(t)}})},e.prototype.complete=function(){var t=this;Ni(function(){if(t._throwIfClosed(),!t.isStopped){t.isStopped=!0;for(var i=t.observers;i.length;)i.shift().complete()}})},e.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(e.prototype,"observed",{get:function(){var t;return((t=this.observers)===null||t===void 0?void 0:t.length)>0},enumerable:!1,configurable:!0}),e.prototype._trySubscribe=function(t){return this._throwIfClosed(),n.prototype._trySubscribe.call(this,t)},e.prototype._subscribe=function(t){return this._throwIfClosed(),this._checkFinalizedStatuses(t),this._innerSubscribe(t)},e.prototype._innerSubscribe=function(t){var i=this,r=this,s=r.hasError,o=r.isStopped,a=r.observers;return s||o?Mc:(this.currentObservers=null,a.push(t),new bi(function(){i.currentObservers=null,Ji(a,t)}))},e.prototype._checkFinalizedStatuses=function(t){var i=this,r=i.hasError,s=i.thrownError,o=i.isStopped;r?t.error(s):o&&t.complete()},e.prototype.asObservable=function(){var t=new me;return t.source=this,t},e.create=function(t,i){return new Do(t,i)},e}(me),Do=function(n){Qt(e,n);function e(t,i){var r=n.call(this)||this;return r.destination=t,r.source=i,r}return e.prototype.next=function(t){var i,r;(r=(i=this.destination)===null||i===void 0?void 0:i.next)===null||r===void 0||r.call(i,t)},e.prototype.error=function(t){var i,r;(r=(i=this.destination)===null||i===void 0?void 0:i.error)===null||r===void 0||r.call(i,t)},e.prototype.complete=function(){var t,i;(i=(t=this.destination)===null||t===void 0?void 0:t.complete)===null||i===void 0||i.call(t)},e.prototype._subscribe=function(t){var i,r;return(r=(i=this.source)===null||i===void 0?void 0:i.subscribe(t))!==null&&r!==void 0?r:Mc},e}(Wn),Kh=function(n){Qt(e,n);function e(t){var i=n.call(this)||this;return i._value=t,i}return Object.defineProperty(e.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),e.prototype._subscribe=function(t){var i=n.prototype._subscribe.call(this,t);return!i.closed&&t.next(this._value),i},e.prototype.getValue=function(){var t=this,i=t.hasError,r=t.thrownError,s=t._value;if(i)throw r;return this._throwIfClosed(),s},e.prototype.next=function(t){n.prototype.next.call(this,this._value=t)},e}(Wn),$h={now:function(){return Date.now()},delegate:void 0},Yh=function(n){Qt(e,n);function e(t,i){return n.call(this)||this}return e.prototype.schedule=function(t,i){return this},e}(bi),Qr={setInterval:function(n,e){for(var t=[],i=2;i<arguments.length;i++)t[i-2]=arguments[i];return setInterval.apply(void 0,mi([n,e],qn(t)))},clearInterval:function(n){var e=Qr.delegate;return((e==null?void 0:e.clearInterval)||clearInterval)(n)},delegate:void 0},Qh=function(n){Qt(e,n);function e(t,i){var r=n.call(this,t,i)||this;return r.scheduler=t,r.work=i,r.pending=!1,r}return e.prototype.schedule=function(t,i){var r;if(i===void 0&&(i=0),this.closed)return this;this.state=t;var s=this.id,o=this.scheduler;return s!=null&&(this.id=this.recycleAsyncId(o,s,i)),this.pending=!0,this.delay=i,this.id=(r=this.id)!==null&&r!==void 0?r:this.requestAsyncId(o,this.id,i),this},e.prototype.requestAsyncId=function(t,i,r){return r===void 0&&(r=0),Qr.setInterval(t.flush.bind(t,this),r)},e.prototype.recycleAsyncId=function(t,i,r){if(r===void 0&&(r=0),r!=null&&this.delay===r&&this.pending===!1)return i;i!=null&&Qr.clearInterval(i)},e.prototype.execute=function(t,i){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var r=this._execute(t,i);if(r)return r;this.pending===!1&&this.id!=null&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},e.prototype._execute=function(t,i){var r=!1,s;try{this.work(t)}catch(o){r=!0,s=o||new Error("Scheduled action threw falsy error")}if(r)return this.unsubscribe(),s},e.prototype.unsubscribe=function(){if(!this.closed){var t=this,i=t.id,r=t.scheduler,s=r.actions;this.work=this.state=this.scheduler=null,this.pending=!1,Ji(s,this),i!=null&&(this.id=this.recycleAsyncId(r,i,null)),this.delay=null,n.prototype.unsubscribe.call(this)}},e}(Yh),Lo=function(){function n(e,t){t===void 0&&(t=n.now),this.schedulerActionCtor=e,this.now=t}return n.prototype.schedule=function(e,t,i){return t===void 0&&(t=0),new this.schedulerActionCtor(this,e).schedule(i,t)},n.now=$h.now,n}(),Xh=function(n){Qt(e,n);function e(t,i){i===void 0&&(i=Lo.now);var r=n.call(this,t,i)||this;return r.actions=[],r._active=!1,r}return e.prototype.flush=function(t){var i=this.actions;if(this._active){i.push(t);return}var r;this._active=!0;do if(r=t.execute(t.state,t.delay))break;while(t=i.shift());if(this._active=!1,r){for(;t=i.shift();)t.unsubscribe();throw r}},e}(Lo),Zh=new Xh(Qh);function ef(n){return n&&G(n.schedule)}function tf(n){return n[n.length-1]}function Ss(n){return ef(tf(n))?n.pop():void 0}var Cs=function(n){return n&&typeof n.length=="number"&&typeof n!="function"};function Uc(n){return G(n==null?void 0:n.then)}function Fc(n){return G(n[ys])}function Bc(n){return Symbol.asyncIterator&&G(n==null?void 0:n[Symbol.asyncIterator])}function jc(n){return new TypeError("You provided "+(n!==null&&typeof n=="object"?"an invalid object":"'"+n+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}function nf(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var Vc=nf();function Jc(n){return G(n==null?void 0:n[Vc])}function qc(n){return Lh(this,arguments,function(){var t,i,r,s;return _c(this,function(o){switch(o.label){case 0:t=n.getReader(),o.label=1;case 1:o.trys.push([1,,9,10]),o.label=2;case 2:return[4,Ln(t.read())];case 3:return i=o.sent(),r=i.value,s=i.done,s?[4,Ln(void 0)]:[3,5];case 4:return[2,o.sent()];case 5:return[4,Ln(r)];case 6:return[4,o.sent()];case 7:return o.sent(),[3,2];case 8:return[3,10];case 9:return t.releaseLock(),[7];case 10:return[2]}})})}function Wc(n){return G(n==null?void 0:n.getReader)}function hn(n){if(n instanceof me)return n;if(n!=null){if(Fc(n))return rf(n);if(Cs(n))return sf(n);if(Uc(n))return of(n);if(Bc(n))return Gc(n);if(Jc(n))return af(n);if(Wc(n))return cf(n)}throw jc(n)}function rf(n){return new me(function(e){var t=n[ys]();if(G(t.subscribe))return t.subscribe(e);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function sf(n){return new me(function(e){for(var t=0;t<n.length&&!e.closed;t++)e.next(n[t]);e.complete()})}function of(n){return new me(function(e){n.then(function(t){e.closed||(e.next(t),e.complete())},function(t){return e.error(t)}).then(null,Lc)})}function af(n){return new me(function(e){var t,i;try{for(var r=Jn(n),s=r.next();!s.done;s=r.next()){var o=s.value;if(e.next(o),e.closed)return}}catch(a){t={error:a}}finally{try{s&&!s.done&&(i=r.return)&&i.call(r)}finally{if(t)throw t.error}}e.complete()})}function Gc(n){return new me(function(e){lf(n,e).catch(function(t){return e.error(t)})})}function cf(n){return Gc(qc(n))}function lf(n,e){var t,i,r,s;return Dh(this,void 0,void 0,function(){var o,a;return _c(this,function(c){switch(c.label){case 0:c.trys.push([0,5,6,11]),t=Uh(n),c.label=1;case 1:return[4,t.next()];case 2:if(i=c.sent(),!!i.done)return[3,4];if(o=i.value,e.next(o),e.closed)return[2];c.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return a=c.sent(),r={error:a},[3,11];case 6:return c.trys.push([6,,9,10]),i&&!i.done&&(s=t.return)?[4,s.call(t)]:[3,8];case 7:c.sent(),c.label=8;case 8:return[3,10];case 9:if(r)throw r.error;return[7];case 10:return[7];case 11:return e.complete(),[2]}})})}function Ht(n,e,t,i,r){i===void 0&&(i=0),r===void 0&&(r=!1);var s=e.schedule(function(){t(),r?n.add(this.schedule(null,i)):this.unsubscribe()},i);if(n.add(s),!r)return s}function Hc(n,e){return e===void 0&&(e=0),pt(function(t,i){t.subscribe(Yt(i,function(r){return Ht(i,n,function(){return i.next(r)},e)},function(){return Ht(i,n,function(){return i.complete()},e)},function(r){return Ht(i,n,function(){return i.error(r)},e)}))})}function zc(n,e){return e===void 0&&(e=0),pt(function(t,i){i.add(n.schedule(function(){return t.subscribe(i)},e))})}function uf(n,e){return hn(n).pipe(zc(e),Hc(e))}function df(n,e){return hn(n).pipe(zc(e),Hc(e))}function hf(n,e){return new me(function(t){var i=0;return e.schedule(function(){i===n.length?t.complete():(t.next(n[i++]),t.closed||this.schedule())})})}function ff(n,e){return new me(function(t){var i;return Ht(t,e,function(){i=n[Vc](),Ht(t,e,function(){var r,s,o;try{r=i.next(),s=r.value,o=r.done}catch(a){t.error(a);return}o?t.complete():t.next(s)},0,!0)}),function(){return G(i==null?void 0:i.return)&&i.return()}})}function Kc(n,e){if(!n)throw new Error("Iterable cannot be null");return new me(function(t){Ht(t,e,function(){var i=n[Symbol.asyncIterator]();Ht(t,e,function(){i.next().then(function(r){r.done?t.complete():t.next(r.value)})},0,!0)})})}function pf(n,e){return Kc(qc(n),e)}function mf(n,e){if(n!=null){if(Fc(n))return uf(n,e);if(Cs(n))return hf(n,e);if(Uc(n))return df(n,e);if(Bc(n))return Kc(n,e);if(Jc(n))return ff(n,e);if(Wc(n))return pf(n,e)}throw jc(n)}function $c(n,e){return e?mf(n,e):hn(n)}function Uo(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];var t=Ss(n);return $c(n,t)}function gf(n){return n instanceof Date&&!isNaN(n)}var vf=vs(function(n){return function(t){t===void 0&&(t=null),n(this),this.message="Timeout has occurred",this.name="TimeoutError",this.info=t}});function bf(n,e){var t=gf(n)?{first:n}:typeof n=="number"?{each:n}:n,i=t.first,r=t.each,s=t.with,o=s===void 0?yf:s,a=t.scheduler,c=a===void 0?e??Zh:a,l=t.meta,u=l===void 0?null:l;if(i==null&&r==null)throw new TypeError("No timeout provided.");return pt(function(d,h){var m,g,v=null,b=0,k=function(S){g=Ht(h,c,function(){try{m.unsubscribe(),hn(o({meta:u,lastValue:v,seen:b})).subscribe(h)}catch(O){h.error(O)}},S)};m=d.subscribe(Yt(h,function(S){g==null||g.unsubscribe(),b++,h.next(v=S),r>0&&k(r)},void 0,void 0,function(){g!=null&&g.closed||g==null||g.unsubscribe(),v=null})),!b&&k(i!=null?typeof i=="number"?i:+i-c.now():r)})}function yf(n){throw new vf(n)}function ue(n,e){return pt(function(t,i){var r=0;t.subscribe(Yt(i,function(s){i.next(n.call(e,s,r++))}))})}var kf=Array.isArray;function Sf(n,e){return kf(e)?n.apply(void 0,mi([],qn(e))):n(e)}function Cf(n){return ue(function(e){return Sf(n,e)})}function Tf(n,e,t,i,r,s,o,a){var c=[],l=0,u=0,d=!1,h=function(){d&&!c.length&&!l&&e.complete()},m=function(v){return l<i?g(v):c.push(v)},g=function(v){s&&e.next(v),l++;var b=!1;hn(t(v,u++)).subscribe(Yt(e,function(k){r==null||r(k),s?m(k):e.next(k)},function(){b=!0},void 0,function(){if(b)try{l--;for(var k=function(){var S=c.shift();o?Ht(e,o,function(){return g(S)}):g(S)};c.length&&l<i;)k();h()}catch(S){e.error(S)}}))};return n.subscribe(Yt(e,m,function(){d=!0,h()})),function(){a==null||a()}}function Ts(n,e,t){return t===void 0&&(t=1/0),G(e)?Ts(function(i,r){return ue(function(s,o){return e(i,s,r,o)})(hn(n(i,r)))},t):(typeof e=="number"&&(t=e),pt(function(i,r){return Tf(i,r,n,t)}))}function wf(n){return n===void 0&&(n=1/0),Ts(ks,n)}function Ef(){return wf(1)}function qi(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return Ef()($c(n,Ss(n)))}var Pf=["addListener","removeListener"],xf=["addEventListener","removeEventListener"],Of=["on","off"];function Xr(n,e,t,i){if(G(t)&&(i=t,t=void 0),i)return Xr(n,e,t).pipe(Cf(i));var r=qn(_f(n)?xf.map(function(a){return function(c){return n[a](e,c,t)}}):Rf(n)?Pf.map(Fo(n,e)):If(n)?Of.map(Fo(n,e)):[],2),s=r[0],o=r[1];if(!s&&Cs(n))return Ts(function(a){return Xr(a,e,t)})(hn(n));if(!s)throw new TypeError("Invalid event target");return new me(function(a){var c=function(){for(var l=[],u=0;u<arguments.length;u++)l[u]=arguments[u];return a.next(1<l.length?l:l[0])};return s(c),function(){return o(c)}})}function Fo(n,e){return function(t){return function(i){return n[t](e,i)}}}function Rf(n){return G(n.addListener)&&G(n.removeListener)}function If(n){return G(n.on)&&G(n.off)}function _f(n){return G(n.addEventListener)&&G(n.removeEventListener)}function Yc(n,e){return pt(function(t,i){var r=0;t.subscribe(Yt(i,function(s){return n.call(e,s,r++)&&i.next(s)}))})}function Mf(n,e){return e===void 0&&(e=ks),n=n??Nf,pt(function(t,i){var r,s=!0;t.subscribe(Yt(i,function(o){var a=e(o);(s||!n(r,a))&&(s=!1,r=a,i.next(o))}))})}function Nf(n,e){return n===e}function Af(n){return pt(function(e,t){try{e.subscribe(t)}finally{t.add(n)}})}function Df(n){return pt(function(e,t){var i=!1,r=Yt(t,function(){r==null||r.unsubscribe(),i=!0},$r);hn(n).subscribe(r),e.subscribe(Yt(t,function(s){return i&&t.next(s)}))})}function Ae(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];var t=Ss(n);return pt(function(i,r){(t?qi(n,i,t):qi(n,i)).subscribe(r)})}var Lf=Object.defineProperty,Wi=Object.getOwnPropertySymbols,Qc=Object.prototype.hasOwnProperty,Xc=Object.prototype.propertyIsEnumerable,Bo=(n,e,t)=>e in n?Lf(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,jo=(n,e)=>{for(var t in e||(e={}))Qc.call(e,t)&&Bo(n,t,e[t]);if(Wi)for(var t of Wi(e))Xc.call(e,t)&&Bo(n,t,e[t]);return n},Uf=(n,e)=>{var t={};for(var i in n)Qc.call(n,i)&&e.indexOf(i)<0&&(t[i]=n[i]);if(n!=null&&Wi)for(var i of Wi(n))e.indexOf(i)<0&&Xc.call(n,i)&&(t[i]=n[i]);return t},Tn=(n,e,t)=>new Promise((i,r)=>{var s=c=>{try{a(t.next(c))}catch(l){r(l)}},o=c=>{try{a(t.throw(c))}catch(l){r(l)}},a=c=>c.done?i(c.value):Promise.resolve(c.value).then(s,o);a((t=t.apply(n,e)).next())}),Zc="lk";function Te(n){return typeof n>"u"?!1:Ff(n)||Bf(n)}function Ff(n){var e;return n?n.hasOwnProperty("participant")&&n.hasOwnProperty("source")&&n.hasOwnProperty("track")&&typeof((e=n.publication)==null?void 0:e.track)<"u":!1}function Bf(n){return n?n.hasOwnProperty("participant")&&n.hasOwnProperty("source")&&n.hasOwnProperty("publication")&&typeof n.publication<"u":!1}function gi(n){return n?n.hasOwnProperty("participant")&&n.hasOwnProperty("source")&&typeof n.publication>"u":!1}function pe(n){if(typeof n=="string"||typeof n=="number")return`${n}`;if(gi(n))return`${n.participant.identity}_${n.source}_placeholder`;if(Te(n))return`${n.participant.identity}_${n.publication.source}_${n.publication.trackSid}`;throw new Error(`Can't generate a id for the given track reference: ${n}`)}function Zr(n,e){return typeof e>"u"?!1:Te(n)?e.some(t=>t.participant.identity===n.participant.identity&&Te(t)&&t.publication.trackSid===n.publication.trackSid):gi(n)?e.some(t=>t.participant.identity===n.participant.identity&&gi(t)&&t.source===n.source):!1}function jf(n,e){return gi(n)&&Te(e)&&e.participant.identity===n.participant.identity&&e.source===n.source}function el(n){return n instanceof fi}function Vf(n,e){return Tn(this,null,function*(){const{x:t,y:i}=yield Mh(n,e,{placement:"top",middleware:[hh(6),_h(),Ih({padding:5})]});return{x:t,y:i}})}function Jf(n,e){return!n.contains(e.target)}var qf=[T.ConnectionStateChanged,T.RoomMetadataChanged,T.ActiveSpeakersChanged,T.ConnectionQualityChanged,T.ParticipantConnected,T.ParticipantDisconnected,T.ParticipantPermissionsChanged,T.ParticipantMetadataChanged,T.TrackMuted,T.TrackUnmuted,T.TrackPublished,T.TrackUnpublished,T.TrackStreamStateChanged,T.TrackSubscriptionFailed,T.TrackSubscriptionPermissionChanged,T.TrackSubscriptionStatusChanged],Wf=[...qf,T.LocalTrackPublished,T.LocalTrackUnpublished],Gf=[E.ConnectionQualityChanged,E.IsSpeakingChanged,E.ParticipantMetadataChanged,E.ParticipantPermissionsChanged,E.TrackMuted,E.TrackUnmuted,E.TrackPublished,E.TrackUnpublished,E.TrackStreamStateChanged,E.TrackSubscriptionFailed,E.TrackSubscriptionPermissionChanged,E.TrackSubscriptionStatusChanged];[...Gf,E.LocalTrackPublished,E.LocalTrackUnpublished];var F=Ah.getLogger("lk-components-js");F.setDefaultLevel("WARN");var Vo=[{columns:1,rows:1,name:"1x1",minTiles:1,maxTiles:1,minWidth:0,minHeight:0},{columns:1,rows:2,name:"1x2",minTiles:2,maxTiles:2,minWidth:0,minHeight:0},{columns:2,rows:1,name:"2x1",minTiles:2,maxTiles:2,minWidth:900,minHeight:0},{columns:2,rows:2,name:"2x2",minTiles:3,maxTiles:4,minWidth:560,minHeight:0},{columns:3,rows:3,name:"3x3",minTiles:5,maxTiles:9,minWidth:700,minHeight:0},{columns:4,rows:4,name:"4x4",minTiles:10,maxTiles:16,minWidth:960,minHeight:0},{columns:5,rows:5,name:"5x5",minTiles:17,maxTiles:25,minWidth:1100,minHeight:0}];function tl(n,e,t,i){let r=0,s=n.find((o,a,c)=>{r=a;const l=c.findIndex((u,d)=>{const h=d>a,m=u.maxTiles===o.maxTiles;return h&&m})!==-1;return o.maxTiles>=e&&!l});if(s===void 0)if(s=n[n.length-1],s)F.warn(`No layout found for: participantCount: ${e}, width/height: ${t}/${i} fallback to biggest available layout (${s.name}).`);else throw new Error("No layout or fallback layout found.");if((t<s.minWidth||i<s.minHeight)&&r>0){const o=n[r-1];s=tl(n.slice(0,r),o.maxTiles,t,i)}return s}function Hf(){return typeof navigator<"u"&&navigator.mediaDevices&&!!navigator.mediaDevices.getDisplayMedia}function nl(n){return typeof n=="object"}function il(n){return Array.isArray(n)&&n.filter(nl).length>0}function zf(n,e){return e.audioLevel-n.audioLevel}function Kf(n,e){return n.isSpeaking===e.isSpeaking?0:n.isSpeaking?-1:1}function $f(n,e){var t,i,r,s;return n.lastSpokeAt!==void 0||e.lastSpokeAt!==void 0?((i=(t=e.lastSpokeAt)==null?void 0:t.getTime())!=null?i:0)-((s=(r=n.lastSpokeAt)==null?void 0:r.getTime())!=null?s:0):0}function es(n,e){var t,i,r,s;return((i=(t=n.joinedAt)==null?void 0:t.getTime())!=null?i:0)-((s=(r=e.joinedAt)==null?void 0:r.getTime())!=null?s:0)}function Yf(n,e){return Te(n)?Te(e)?0:-1:Te(e)?1:0}function Qf(n,e){const t=n.participant.isCameraEnabled,i=e.participant.isCameraEnabled;return t!==i?t?-1:1:0}function Xf(n){const e=[],t=[],i=[],r=[];n.forEach(a=>{a.participant.isLocal&&a.source===C.Source.Camera?e.push(a):a.source===C.Source.ScreenShare?t.push(a):a.source===C.Source.Camera?i.push(a):r.push(a)});const s=Zf(t),o=ep(i);return[...e,...s,...o,...r]}function Zf(n){const e=[],t=[];return n.forEach(r=>{r.participant.isLocal?e.push(r):t.push(r)}),e.sort((r,s)=>es(r.participant,s.participant)),t.sort((r,s)=>es(r.participant,s.participant)),[...t,...e]}function ep(n){const e=[],t=[];return n.forEach(i=>{i.participant.isLocal?e.push(i):t.push(i)}),t.sort((i,r)=>i.participant.isSpeaking&&r.participant.isSpeaking?zf(i.participant,r.participant):i.participant.isSpeaking!==r.participant.isSpeaking?Kf(i.participant,r.participant):i.participant.lastSpokeAt!==r.participant.lastSpokeAt?$f(i.participant,r.participant):Te(i)!==Te(r)?Yf(i,r):i.participant.isCameraEnabled!==r.participant.isCameraEnabled?Qf(i,r):es(i.participant,r.participant)),[...e,...t]}function tp(n,e){return n.reduce((t,i,r)=>r%e===0?[...t,[i]]:[...t.slice(0,-1),[...t.slice(-1)[0],i]],[])}function Jo(n,e){const t=Math.max(n.length,e.length);return new Array(t).fill([]).map((i,r)=>[n[r],e[r]])}function Gi(n,e,t){return n.filter(i=>!e.map(r=>t(r)).includes(t(i)))}function ts(n){return n.map(e=>typeof e=="string"||typeof e=="number"?`${e}`:pe(e))}function np(n,e){return{dropped:Gi(n,e,pe),added:Gi(e,n,pe)}}function ip(n){return n.added.length!==0||n.dropped.length!==0}function ns(n,e){const t=e.findIndex(i=>pe(i)===pe(n));if(t===-1)throw new Error(`Element not part of the array: ${pe(n)} not in ${ts(e)}`);return t}function rp(n,e,t){const i=ns(n,t),r=ns(e,t);return t.splice(i,1,e),t.splice(r,1,n),t}function sp(n,e){const t=ns(n,e);return e.splice(t,1),e}function op(n,e){return[...e,n]}function br(n,e){return tp(n,e)}function ap(n,e,t){let i=cp(n,e);if(i.length<e.length){const o=Gi(e,i,pe);i=[...i,...o]}const r=br(i,t),s=br(e,t);if(Jo(r,s).forEach(([o,a],c)=>{if(o&&a){const l=br(i,t)[c],u=np(l,a);ip(u)&&(F.debug(`Detected visual changes on page: ${c}, current: ${ts(o)}, next: ${ts(a)}`,{changes:u}),u.added.length===u.dropped.length&&Jo(u.added,u.dropped).forEach(([d,h])=>{if(d&&h)i=rp(d,h,i);else throw new Error(`For a swap action we need a addition and a removal one is missing: ${d}, ${h}`)}),u.added.length===0&&u.dropped.length>0&&u.dropped.forEach(d=>{i=sp(d,i)}),u.added.length>0&&u.dropped.length===0&&u.added.forEach(d=>{i=op(d,i)}))}}),i.length>e.length){const o=Gi(i,e,pe);i=i.filter(a=>!o.map(pe).includes(pe(a)))}return i}function cp(n,e){return n.map(t=>{const i=e.find(r=>pe(t)===pe(r)||typeof t!="number"&&gi(t)&&Te(r)&&jf(t,r));return i??t})}function ws(n,...e){return new me(i=>{const r=()=>{i.next(n)};return e.forEach(o=>{n.on(o,r)}),()=>{e.forEach(o=>{n.off(o,r)})}}).pipe(Ae(n))}function Es(n,e){return new me(i=>{const r=(...o)=>{i.next(o)};return n.on(e,r),()=>{n.off(e,r)}})}function lp(n){return Es(n,T.ConnectionStateChanged).pipe(ue(([e])=>e),Ae(n.state))}function up(n,e,t=!0){var i;const r=()=>Tn(this,null,function*(){try{const a=yield Fi.getLocalDevices(n,t);s.next(a)}catch(a){e==null||e(a)}}),s=new Wn,o=s.pipe(Af(()=>{var a;(a=navigator==null?void 0:navigator.mediaDevices)==null||a.removeEventListener("devicechange",r)}));if(typeof window<"u"){if(!window.isSecureContext)throw new Error("Accessing media devices is available only in secure contexts (HTTPS and localhost), in some or all supporting browsers. See: https://developer.mozilla.org/en-US/docs/Web/API/Navigator/mediaDevices");(i=navigator==null?void 0:navigator.mediaDevices)==null||i.addEventListener("devicechange",r)}return qi(Fi.getLocalDevices(n,t).catch(a=>e==null?void 0:e(a)),o)}function dp(n){return ws(n,T.AudioPlaybackStatusChanged).pipe(ue(t=>({canPlayAudio:t.canPlaybackAudio})))}function hp(n){return ws(n,T.VideoPlaybackStatusChanged).pipe(ue(t=>({canPlayVideo:t.canPlaybackVideo})))}function fp(n,e){return Es(n,T.ActiveDeviceChanged).pipe(Yc(([t])=>t===e),ue(([t,i])=>(F.debug("activeDeviceObservable | RoomEvent.ActiveDeviceChanged",{kind:t,deviceId:i}),i)),Ae(n.getActiveDevice(e)))}function pp(n,e){return Es(n,T.ParticipantEncryptionStatusChanged).pipe(Yc(([,t])=>e.identity===(t==null?void 0:t.identity)||!t&&e.identity===n.localParticipant.identity),ue(([t])=>t),Ae(e instanceof fi?e.isE2EEEnabled:e.isEncrypted))}function we(n){return`${Zc}-${n}`}function mp(n){const e=is(n),t=rl(n.participant).pipe(ue(()=>is(n)),Ae(e));return{className:we(n.source===C.Source.Camera||n.source===C.Source.ScreenShare?"participant-media-video":"participant-media-audio"),trackObserver:t}}function is(n){if(Te(n))return n.publication;{const{source:e,name:t,participant:i}=n;if(e&&t)return i.getTracks().find(r=>r.source===e&&r.trackName===t);if(t)return i.getTrackByName(t);if(e)return i.getTrack(e);throw new Error("At least one of source and name needs to be defined")}}function Ps(n,...e){return new me(i=>{const r=()=>{i.next(n)};return e.forEach(o=>{n.on(o,r)}),()=>{e.forEach(o=>{n.off(o,r)})}}).pipe(Ae(n))}function rl(n){return Ps(n,E.TrackMuted,E.TrackUnmuted,E.ParticipantPermissionsChanged,E.TrackPublished,E.TrackUnpublished,E.LocalTrackPublished,E.LocalTrackUnpublished,E.MediaDevicesError,E.TrackSubscriptionStatusChanged).pipe(ue(t=>{const{isMicrophoneEnabled:i,isCameraEnabled:r,isScreenShareEnabled:s}=t,o=t.getTrack(C.Source.Microphone),a=t.getTrack(C.Source.Camera);return{isCameraEnabled:r,isMicrophoneEnabled:i,isScreenShareEnabled:s,cameraTrack:a,microphoneTrack:o,participant:t}}))}function gp(n){return Ps(n,E.ParticipantMetadataChanged).pipe(ue(({name:t,identity:i,metadata:r})=>({name:t,identity:i,metadata:r})),Ae({name:n.name,identity:n.identity,metadata:n.metadata}))}function vp(n){return xs(n,E.ConnectionQualityChanged).pipe(ue(([t])=>t),Ae(n.connectionQuality))}function xs(n,e){return new me(i=>{const r=(...o)=>{i.next(o)};return n.on(e,r),()=>{n.off(e,r)}})}function sl(n){var e,t,i,r;return Ps(n.participant,E.TrackMuted,E.TrackUnmuted,E.TrackSubscribed,E.TrackUnsubscribed,E.LocalTrackPublished,E.LocalTrackUnpublished).pipe(ue(s=>{var o,a;const c=(o=n.publication)!=null?o:s.getTrack(n.source);return(a=c==null?void 0:c.isMuted)!=null?a:!0}),Ae((r=(i=(e=n.publication)==null?void 0:e.isMuted)!=null?i:(t=n.participant.getTrack(n.source))==null?void 0:t.isMuted)!=null?r:!0))}function bp(n){return xs(n,E.IsSpeakingChanged).pipe(ue(([e])=>e))}function yp(n){return xs(n,E.ParticipantPermissionsChanged).pipe(ue(()=>n.permissions),Ae(n.permissions))}function kp(n,e,t){const{localParticipant:i}=e,r=(l,u)=>{let d=!1;switch(l){case C.Source.Camera:d=u.isCameraEnabled;break;case C.Source.Microphone:d=u.isMicrophoneEnabled;break;case C.Source.ScreenShare:d=u.isScreenShareEnabled;break}return d},s=rl(i).pipe(ue(l=>r(n,l.participant)),Ae(r(n,i))),o=new Wn,a=(l,u)=>Tn(this,null,function*(){try{switch(u??(u=t),o.next(!0),n){case C.Source.Camera:yield i.setCameraEnabled(l??!i.isCameraEnabled,u);break;case C.Source.Microphone:yield i.setMicrophoneEnabled(l??!i.isMicrophoneEnabled,u);break;case C.Source.ScreenShare:yield i.setScreenShareEnabled(l??!i.isScreenShareEnabled,u);break;default:break}}finally{o.next(!1)}});return{className:we("button"),toggle:a,enabledObserver:s,pendingObserver:o.asObservable()}}function Sp(){let n=!1;const e=new Wn,t=new Wn,i=s=>Tn(this,null,function*(){t.next(!0),n=s??!n,e.next(n),t.next(!1)});return{className:we("button"),toggle:i,enabledObserver:e.asObservable(),pendingObserver:t.asObservable()}}function Cp(n,e,t){const i=new Kh(void 0),r=e?fp(e,n):i.asObservable(),s=(a,...c)=>Tn(this,[a,...c],function*(l,u={}){var d,h,m;if(e){F.debug(`Switching active device of kind "${n}" with id ${l}.`),yield e.switchActiveDevice(n,l,u.exact);const g=(d=e.getActiveDevice(n))!=null?d:l;g!==l&&l!=="default"&&F.info(`We tried to select the device with id (${l}), but the browser decided to select the device with id (${g}) instead.`);let v;n==="audioinput"?v=(h=e.localParticipant.getTrack(C.Source.Microphone))==null?void 0:h.track:n==="videoinput"&&(v=(m=e.localParticipant.getTrack(C.Source.Camera))==null?void 0:m.track);const b=l==="default"&&!v||l==="default"&&(v==null?void 0:v.mediaStreamTrack.label.startsWith("Default"));i.next(b?l:g)}else if(t){yield t.setDeviceId(u.exact?{exact:l}:l);const g=yield t.getDeviceId();i.next(l==="default"&&t.mediaStreamTrack.label.startsWith("Default")?l:g)}else i.value!==l&&(F.warn("device switch skipped, please provide either a room or a local track to switch on. "),i.next(l))});return{className:we("media-device-select"),activeDeviceObservable:r,setActiveMediaDevice:s}}function Tp(n){const e=i=>{n.disconnect(i)};return{className:we("disconnect-button"),disconnect:e}}function wp(n){const e=we("connection-quality"),t=vp(n);return{className:e,connectionQualityObserver:t}}function Ep(n){let e="track-muted-indicator-camera";switch(n.source){case C.Source.Camera:e="track-muted-indicator-camera";break;case C.Source.Microphone:e="track-muted-indicator-microphone";break}const t=we(e),i=sl(n);return{className:t,mediaMutedObserver:i}}function Pp(n){return{className:"lk-participant-name",infoObserver:gp(n)}}function xp(){return{className:we("participant-tile")}}new TextEncoder;new TextDecoder;function Op(){const n=t=>Tn(this,null,function*(){F.info("Start Audio for room: ",t),yield t.startAudio()});return{className:we("start-audio-button"),roomAudioPlaybackAllowedObservable:dp,handleStartAudioPlayback:n}}function Rp(){const n=t=>Tn(this,null,function*(){F.info("Start Video for room: ",t),yield t.startVideo()});return{className:we("start-audio-button"),roomVideoPlaybackAllowedObservable:hp,handleStartVideoPlayback:n}}function Ip(){return{className:[we("button"),we("chat-toggle")].join(" ")}}function _p(){return{className:[we("button"),we("focus-toggle-button")].join(" ")}}function Mp(){return{className:"lk-room-container"}}function qo(n,e,t=!0){const r=[n.localParticipant,...Array.from(n.participants.values())],s=[];return r.forEach(o=>{e.forEach(a=>{const c=Array.from(o.tracks.values()).filter(l=>l.source===a&&(!t||l.track)).map(l=>({participant:o,publication:l,source:l.source}));s.push(...c)})}),{trackReferences:s,participants:r}}function Np(n,e,t){var i,r;const s=(i=t.additionalRoomEvents)!=null?i:Wf,o=(r=t.onlySubscribed)!=null?r:!0,a=Array.from(new Set([T.ParticipantConnected,T.ParticipantDisconnected,T.ConnectionStateChanged,T.LocalTrackPublished,T.LocalTrackUnpublished,T.TrackPublished,T.TrackUnpublished,T.TrackSubscriptionStatusChanged,...s]).values());return ws(n,...a).pipe(ue(l=>{const u=qo(l,e,o);return F.debug(`TrackReference[] was updated. (length ${u.trackReferences.length})`,u),u}),Ae(qo(n,e,o)))}function Ap(n,e=1e3){if(n===null)return Uo(!1);const t=Xr(n,"mousemove",{passive:!0}).pipe(ue(()=>!0)),i=t.pipe(bf({each:e,with:()=>qi(Uo(!1),i.pipe(Df(t)))}),Mf());return i}function Dp(n,e){if(typeof localStorage>"u"){F.error("Local storage is not available.");return}try{localStorage.setItem(n,JSON.stringify(e))}catch(t){F.error(`Error setting item to local storage: ${t}`)}}function Lp(n){if(typeof localStorage>"u"){F.error("Local storage is not available.");return}try{const e=localStorage.getItem(n);if(!e){F.warn(`Item with key ${n} does not exist in local storage.`);return}return JSON.parse(e)}catch(e){F.error(`Error getting item from local storage: ${e}`);return}}function Up(n){return{load:()=>Lp(n),save:e=>Dp(n,e)}}var Fp=`${Zc}-user-choices`,pn={videoEnabled:!0,audioEnabled:!0,videoDeviceId:"",audioDeviceId:"",username:"",e2ee:!1,sharedPassphrase:""},{load:Bp,save:jp}=Up(Fp);function Vp(n,e=!1){if(e===!0)return;const t=n,i=Uf(t,["e2ee","sharedPassphrase"]);jp(i)}function Jp(n,e=!1){var t,i,r,s,o,a,c;const l={videoEnabled:(t=n==null?void 0:n.videoEnabled)!=null?t:pn.videoEnabled,audioEnabled:(i=n==null?void 0:n.audioEnabled)!=null?i:pn.audioEnabled,videoDeviceId:(r=n==null?void 0:n.videoDeviceId)!=null?r:pn.videoDeviceId,audioDeviceId:(s=n==null?void 0:n.audioDeviceId)!=null?s:pn.audioDeviceId,username:(o=n==null?void 0:n.username)!=null?o:pn.username,e2ee:(a=n==null?void 0:n.e2ee)!=null?a:pn.e2ee,sharedPassphrase:(c=n==null?void 0:n.sharedPassphrase)!=null?c:pn.sharedPassphrase};if(e)return l;{const u=Bp();return jo(jo({},l),u??{})}}function qp(n,e){const[t,i]=f.useState(n);return f.useEffect(()=>{const r=setTimeout(()=>i(n),e||500);return()=>{clearTimeout(r)}},[n,e]),t}function Wp(n,{threshold:e=0,root:t=null,rootMargin:i="0%",freezeOnceVisible:r=!1}){const[s,o]=f.useState(),a=(s==null?void 0:s.isIntersecting)&&r,c=([l])=>{o(l)};return f.useEffect(()=>{const l=n==null?void 0:n.current;if(!!!window.IntersectionObserver||a||!l)return;const d={threshold:e,root:t,rootMargin:i},h=new IntersectionObserver(c,d);return h.observe(l),()=>h.disconnect()},[n==null?void 0:n.current,JSON.stringify(e),t,i,a]),s}var Gp=Object.defineProperty,Hp=Object.defineProperties,zp=Object.getOwnPropertyDescriptors,Hi=Object.getOwnPropertySymbols,ol=Object.prototype.hasOwnProperty,al=Object.prototype.propertyIsEnumerable,Wo=(n,e,t)=>e in n?Gp(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,D=(n,e)=>{for(var t in e||(e={}))ol.call(e,t)&&Wo(n,t,e[t]);if(Hi)for(var t of Hi(e))al.call(e,t)&&Wo(n,t,e[t]);return n},Ue=(n,e)=>Hp(n,zp(e)),ge=(n,e)=>{var t={};for(var i in n)ol.call(n,i)&&e.indexOf(i)<0&&(t[i]=n[i]);if(n!=null&&Hi)for(var i of Hi(n))e.indexOf(i)<0&&al.call(n,i)&&(t[i]=n[i]);return t},Kp=(n,e,t)=>new Promise((i,r)=>{var s=c=>{try{a(t.next(c))}catch(l){r(l)}},o=c=>{try{a(t.throw(c))}catch(l){r(l)}},a=c=>c.done?i(c.value):Promise.resolve(c.value).then(s,o);a((t=t.apply(n,e)).next())});function $p(n,e){const t=Qp(),i=wl(e);return f.useLayoutEffect(()=>{let r=!1;const s=n.current;if(!s)return;function o(a,c){r||i.current(a,c)}return t==null||t.subscribe(s,o),()=>{r=!0,t==null||t.unsubscribe(s,o)}},[n.current,t,i]),t==null?void 0:t.observer}function Yp(){let n=!1,e=[];const t=new Map;if(typeof window>"u")return;const i=new ResizeObserver((r,s)=>{e=e.concat(r),n||window.requestAnimationFrame(()=>{const o=new Set;for(let a=0;a<e.length;a++){if(o.has(e[a].target))continue;o.add(e[a].target);const c=t.get(e[a].target);c==null||c.forEach(l=>l(e[a],s))}e=[],n=!1}),n=!0});return{observer:i,subscribe(r,s){var o;i.observe(r);const a=(o=t.get(r))!=null?o:[];a.push(s),t.set(r,a)},unsubscribe(r,s){var o;const a=(o=t.get(r))!=null?o:[];if(a.length===1){i.unobserve(r),t.delete(r);return}const c=a.indexOf(s);c!==-1&&a.splice(c,1),t.set(r,a)}}}var yr,Qp=()=>yr||(yr=Yp()),Xp=n=>{const[e,t]=f.useState({width:0,height:0});f.useLayoutEffect(()=>{if(n.current){const{width:r,height:s}=n.current.getBoundingClientRect();t({width:r,height:s})}},[n.current]);const i=f.useCallback(r=>t(r.contentRect),[]);return $p(n,i),e};function Ne(n,e){const[t,i]=f.useState(e);return f.useEffect(()=>{if(typeof window>"u"||!n)return;const r=n.subscribe(i);return()=>r.unsubscribe()},[n]),t}function Zp(n){const e=s=>typeof window<"u"?window.matchMedia(s).matches:!1,[t,i]=f.useState(e(n));function r(){i(e(n))}return f.useEffect(()=>{const s=window.matchMedia(n);return r(),s.addListener?s.addListener(r):s.addEventListener("change",r),()=>{s.removeListener?s.removeListener(r):s.removeEventListener("change",r)}},[n]),t}var Os=f.createContext(void 0);function em(){const n=f.useContext(Os);if(!n)throw Error("Tried to access LayoutContext context outside a LayoutContextProvider provider.");return n}function Rs(){return f.useContext(Os)}var Is=f.createContext(void 0);function fn(){return f.useContext(Is)}var cl=f.createContext(void 0);function _s(){return f.useContext(cl)}function mt(n){var e;const t=_s(),i=fn(),r=(e=n??t)!=null?e:i==null?void 0:i.participant;if(!r)throw new Error("No participant provided, make sure you are inside a participant context or pass the participant explicitly");return r}var Ms=f.createContext(void 0);function Ns(){const n=f.useContext(Ms);if(!n)throw Error("tried to access room context outside of livekit room component");return n}function nr(){return f.useContext(Ms)}function yi(n){const e=nr(),t=n??e;if(!t)throw new Error("No room provided, make sure you are inside a Room context or pass the room explicitly");return t}var ll=f.createContext(void 0);function tm(n){const e=f.useContext(ll);if(n===!0){if(e)return e;throw Error("tried to access feature context, but none is present")}return e}function nm(...n){return(...e)=>{for(const t of n)typeof t=="function"&&t(...e)}}function Xt(...n){const e=D({},n[0]);for(let t=1;t<n.length;t++){const i=n[t];for(const r in i){const s=e[r],o=i[r];typeof s=="function"&&typeof o=="function"&&r[0]==="o"&&r[1]==="n"&&r.charCodeAt(2)>=65&&r.charCodeAt(2)<=90?e[r]=nm(s,o):(r==="className"||r==="UNSAFE_className")&&typeof s=="string"&&typeof o=="string"?e[r]=bl(s,o):e[r]=o!==void 0?o:s}}return e}function im(n={}){const e=mt(n.participant),{className:t,connectionQualityObserver:i}=f.useMemo(()=>wp(e),[e]),r=Ne(i,Re.Unknown);return{className:t,quality:r}}function rm(n){const e=yi(n),t=f.useMemo(()=>lp(e),[e]);return Ne(t,e.state)}function sm(n){const e=Ns(),t=rm(e);return{buttonProps:f.useMemo(()=>{const{className:r,disconnect:s}=Tp(e);return Xt(n,{className:r,onClick:()=>{var a;return s((a=n.stopTracks)!=null?a:!0)},disabled:t===B.Disconnected})},[e,n,t])}}function om(n){if(n.publication instanceof ui){const e=n.publication.track;if(e){const{facingMode:t}=Qd(e);return t}}return"undefined"}function am({trackRef:n,trackSource:e,participant:t,props:i}){const r=mt(t);if(!n&&!e)throw new Error("trackRef or trackSource must be defined.");const s=Rs(),{className:o}=f.useMemo(()=>_p(),[]),a=f.useMemo(()=>{if(n)return Zr(n,s==null?void 0:s.pin.state);if(e){const l=r.getTrack(e);return s!=null&&s.pin.state&&l?Zr({participant:r,source:e,publication:l},s.pin.state):!1}else throw new Error("trackRef or trackSource and participant must be defined.")},[n,s==null?void 0:s.pin.state,r,e]);return{mergedProps:f.useMemo(()=>Xt(i,{className:o,onClick:l=>{var u,d,h,m,g;if((u=i.onClick)==null||u.call(i,l),n)a?(h=s==null?void 0:(d=s.pin).dispatch)==null||h.call(d,{msg:"clear_pin"}):(g=s==null?void 0:(m=s.pin).dispatch)==null||g.call(m,{msg:"set_pin",trackReference:n});else if(e){const v=r.getTrack(e);s!=null&&s.pin.dispatch&&v&&(a?s.pin.dispatch({msg:"clear_pin"}):s.pin.dispatch({msg:"set_pin",trackReference:{participant:r,publication:v,source:v.source}}))}}}),[i,o,n,e,a,s==null?void 0:s.pin,r]),inFocus:a}}function cm(n,e){const{width:t,height:i}=Xp(n),r=t>0&&i>0?tl(Vo,e,t,i):Vo[0];return f.useEffect(()=>{n.current&&r&&(n.current.style.setProperty("--lk-col-count",r==null?void 0:r.columns.toString()),n.current.style.setProperty("--lk-row-count",r==null?void 0:r.rows.toString()))},[n,r]),{layout:r}}function Go(n,e={}){var t,i;const r=typeof n=="string"?e.participant:n.participant,s=mt(r),o=typeof n=="string"?{participant:s,source:n}:n,[a,c]=f.useState(!!((t=o.publication)!=null&&t.isMuted||(i=s.getTrack(o.source))!=null&&i.isMuted));return f.useEffect(()=>{const l=sl(o).subscribe(c);return()=>l.unsubscribe()},[pe(o)]),a}function lm(n){const e=mt(n),t=f.useMemo(()=>bp(e),[e]);return Ne(t,e.isSpeaking)}var um={connect:!0,audio:!1,video:!1};function dm(n){const e=D(D({},um),n),{token:t,serverUrl:i,options:r,room:s,connectOptions:o,connect:a,audio:c,video:l,screen:u,onConnected:d,onDisconnected:h,onError:m,onMediaDeviceFailure:g,onEncryptionError:v,simulateParticipants:b}=e,k=ge(e,["token","serverUrl","options","room","connectOptions","connect","audio","video","screen","onConnected","onDisconnected","onError","onMediaDeviceFailure","onEncryptionError","simulateParticipants"]);r&&s&&F.warn("when using a manually created room, the options object will be ignored. set the desired options directly when creating the room instead.");const[S,O]=f.useState();f.useEffect(()=>{O(s??new Fi(r))},[s]);const x=f.useMemo(()=>{const{className:_}=Mp();return Xt(k,{className:_})},[k]);return f.useEffect(()=>{if(!S)return;const _=()=>{const N=S.localParticipant;F.debug("trying to publish local tracks"),Promise.all([N.setMicrophoneEnabled(!!c,typeof c!="boolean"?c:void 0),N.setCameraEnabled(!!l,typeof l!="boolean"?l:void 0),N.setScreenShareEnabled(!!u,typeof u!="boolean"?u:void 0)]).catch(P=>{F.warn(P),m==null||m(P)})},A=N=>{const P=ci.getFailure(N);g==null||g(P)},j=N=>{v==null||v(N)};return S.on(T.SignalConnected,_).on(T.MediaDevicesError,A).on(T.EncryptionError,j),()=>{S.off(T.SignalConnected,_).off(T.MediaDevicesError,A).off(T.EncryptionError,j)}},[S,c,l,u,m,v,g]),f.useEffect(()=>{if(S){if(b){S.simulateParticipants({participants:{count:b},publish:{audio:!0,useRealTracks:!0}});return}if(!t){F.debug("no token yet");return}if(!i){F.warn("no livekit url provided"),m==null||m(Error("no livekit url provided"));return}a?(F.debug("connecting"),S.connect(i,t,o).catch(_=>{F.warn(_),m==null||m(_)})):(F.debug("disconnecting because connect is false"),S.disconnect())}},[a,t,JSON.stringify(o),S,m,i,b]),f.useEffect(()=>{if(!S)return;const _=A=>{switch(A){case B.Disconnected:h&&h();break;case B.Connected:d&&d();break}};return S.on(T.ConnectionStateChanged,_),()=>{S.off(T.ConnectionStateChanged,_)}},[t,d,h,S]),f.useEffect(()=>{if(S)return()=>{F.info("disconnecting on onmount"),S.disconnect()}},[S]),{room:S,htmlProps:x}}function hm(){const n=Ns(),e=f.useMemo(()=>yp(n.localParticipant),[n]);return Ne(e,n.localParticipant.permissions)}function fm({kind:n,room:e,track:t,requestPermissions:i,onError:r}){const s=nr(),o=f.useMemo(()=>up(n,r,i),[n,i,r]),a=Ne(o,[]),[c,l]=f.useState(""),{className:u,activeDeviceObservable:d,setActiveMediaDevice:h}=f.useMemo(()=>Cp(n,e??s,t),[n,e,s,t]);return f.useEffect(()=>{const m=d.subscribe(g=>{F.info("setCurrentDeviceId",g),g&&l(g)});return()=>{m==null||m.unsubscribe()}},[d]),{devices:a,className:u,activeDeviceId:c,setActiveMediaDevice:h}}function pm(n){return n!==void 0}function wn(...n){return Xt(...n.filter(pm))}function mm(n,e,t){return f.Children.map(n,i=>f.isValidElement(i)&&f.Children.only(n)?f.cloneElement(i,Ue(D({},e),{key:t})):i)}function ul(n,e={}){var t;const[i,r]=f.useState(is(n)),[s,o]=f.useState(i==null?void 0:i.isMuted),[a,c]=f.useState(i==null?void 0:i.isSubscribed),[l,u]=f.useState(i==null?void 0:i.track),[d,h]=f.useState("landscape"),m=f.useRef(),{className:g,trackObserver:v}=f.useMemo(()=>mp(n),[(t=n.participant.sid)!=null?t:n.participant.identity,n.source,Te(n)&&n.publication.trackSid]);return f.useEffect(()=>{const b=v.subscribe(k=>{F.debug("update track",k),r(k),o(k==null?void 0:k.isMuted),c(k==null?void 0:k.isSubscribed),u(k==null?void 0:k.track)});return()=>b==null?void 0:b.unsubscribe()},[v]),f.useEffect(()=>{var b,k;return l&&(m.current&&l.detach(m.current),(b=e.element)!=null&&b.current&&!(el(n.participant)&&(l==null?void 0:l.kind)==="audio")&&l.attach(e.element.current)),m.current=(k=e.element)==null?void 0:k.current,()=>{m.current&&(l==null||l.detach(m.current))}},[l,e.element]),f.useEffect(()=>{var b,k;if(typeof((b=i==null?void 0:i.dimensions)==null?void 0:b.width)=="number"&&typeof((k=i==null?void 0:i.dimensions)==null?void 0:k.height)=="number"){const S=i.dimensions.width>i.dimensions.height?"landscape":"portrait";h(S)}},[i]),{publication:i,isMuted:s,isSubscribed:a,track:l,elementProps:wn(e.props,D({className:g,"data-lk-local-participant":n.participant.isLocal,"data-lk-source":i==null?void 0:i.source},(i==null?void 0:i.kind)==="video"&&{"data-lk-orientation":d}))}}function gm(n,e,t={}){const i=f.useRef([]),r=f.useRef(-1),s=e!==r.current,o=typeof t.customSortFunction=="function"?t.customSortFunction(n):Xf(n);let a=[...o];if(s===!1)try{a=ap(i.current,o,e)}catch(c){F.error("Error while running updatePages(): ",c)}return s?i.current=o:i.current=a,r.current=e,a}function vm(n,e){const[t,i]=f.useState(1),r=Math.max(Math.ceil(e.length/n),1);t>r&&i(r);const s=t*n,o=s-n,a=d=>{i(h=>d==="next"?h===r?h:h+1:h===1?h:h-1)},c=d=>{d>r?i(r):d<1?i(1):i(d)},u=gm(e,n).slice(o,s);return{totalPageCount:r,nextPage:()=>a("next"),prevPage:()=>a("previous"),setPage:c,firstItemIndex:o,lastItemIndex:s,tracks:u,currentPage:t}}function bm({trackRef:n,participant:e,source:t,publication:i,onParticipantClick:r,disableSpeakingIndicator:s,htmlProps:o}){const a=fn(),c=mt(e),l=f.useMemo(()=>{var v,b,k,S,O,x;const _=(b=(v=n==null?void 0:n.source)!=null?v:a==null?void 0:a.source)!=null?b:t;if(_===void 0)throw new Error("Missing track `source`, provided it via `trackRef`, `source` property or via `TrackRefContext`.");return{participant:(S=(k=n==null?void 0:n.participant)!=null?k:a==null?void 0:a.participant)!=null?S:c,publication:(x=(O=n==null?void 0:n.publication)!=null?O:a==null?void 0:a.publication)!=null?x:i,source:_}},[n==null?void 0:n.participant,n==null?void 0:n.source,n==null?void 0:n.publication,a==null?void 0:a.participant,a==null?void 0:a.source,a==null?void 0:a.publication,c,t,i]),u=f.useMemo(()=>{const{className:v}=xp();return Xt(o,{className:v,onClick:b=>{var k,S;if((k=o.onClick)==null||k.call(o,b),typeof r=="function"){const O=(S=l.publication)!=null?S:l.participant.getTrack(l.source);r({participant:l.participant,track:O})}}})},[o,r,l.publication,l.source,l.participant]),d=Go(C.Source.Camera,{participant:l.participant}),h=Go(C.Source.Microphone,{participant:l.participant}),m=lm(l.participant),g=om(l);return{elementProps:D({"data-lk-audio-muted":h,"data-lk-video-muted":d,"data-lk-speaking":s===!0?!1:m,"data-lk-local-participant":l.participant.isLocal,"data-lk-source":l.source,"data-lk-facing-mode":g},u)}}function ym({room:n,props:e}){const t=yi(n),{className:i,roomAudioPlaybackAllowedObservable:r,handleStartAudioPlayback:s}=f.useMemo(()=>Op(),[]),o=f.useMemo(()=>r(t),[t,r]),{canPlayAudio:a}=Ne(o,{canPlayAudio:t.canPlaybackAudio});return{mergedProps:f.useMemo(()=>Xt(e,{className:i,onClick:()=>{s(t)},style:{display:a?"none":"block"}}),[e,i,a,s,t]),canPlayAudio:a}}function km({room:n,props:e}){const t=yi(n),{className:i,roomVideoPlaybackAllowedObservable:r,handleStartVideoPlayback:s}=f.useMemo(()=>Rp(),[]),o=f.useMemo(()=>r(t),[t,r]),{canPlayVideo:a}=Ne(o,{canPlayVideo:t.canPlaybackVideo});return{mergedProps:f.useMemo(()=>Xt(e,{className:i,onClick:()=>{s(t)},style:{display:a?"none":"block"}}),[e,i,a,s,t]),canPlayVideo:a}}function Sm(n,e={}){var t;const i=f.useRef(null),r=f.useRef(null),s=(t=e.minSwipeDistance)!=null?t:50,o=l=>{r.current=null,i.current=l.targetTouches[0].clientX},a=l=>{r.current=l.targetTouches[0].clientX},c=f.useCallback(()=>{if(!i.current||!r.current)return;const l=i.current-r.current,u=l>s,d=l<-s;u&&e.onLeftSwipe&&e.onLeftSwipe(),d&&e.onRightSwipe&&e.onRightSwipe()},[s,e]);f.useEffect(()=>{const l=n.current;return l&&(l.addEventListener("touchstart",o,{passive:!0}),l.addEventListener("touchmove",a,{passive:!0}),l.addEventListener("touchend",c,{passive:!0})),()=>{l&&(l.removeEventListener("touchstart",o),l.removeEventListener("touchmove",a),l.removeEventListener("touchend",c))}},[n,c])}function Cm({props:n}){const{dispatch:e,state:t}=em().widget,{className:i}=f.useMemo(()=>Ip(),[]);return{mergedProps:f.useMemo(()=>Xt(n,{className:i,onClick:()=>{e&&e({msg:"toggle_chat"})},"aria-pressed":t!=null&&t.showChat?"true":"false","data-lk-unread-msgs":t?t.unreadMessages<10?t.unreadMessages.toFixed(0):"9+":"0"}),[n,i,e,t])}}function Tm(n,e={}){var t,i,r,s;let o=fn();const a=(i=(t=_s())!=null?t:e.participant)!=null?i:o==null?void 0:o.participant;if(typeof n=="string"){if(!a)throw Error("Participant missing, either provide it via context or pass it in directly");o={participant:a,source:n}}else if(n)o=n;else throw Error("No track reference found, either provide it via context or pass it in directly");const{className:c,mediaMutedObserver:l}=f.useMemo(()=>Ep(o),[pe(o)]);return{isMuted:Ne(l,!!((r=o.publication)!=null&&r.isMuted||(s=o.participant.getTrack(o.source))!=null&&s.isMuted)),className:c}}function wm(n){var e=n,{source:t,onChange:i,initialState:r,captureOptions:s}=e,o=ge(e,["source","onChange","initialState","captureOptions"]),a;const c=nr(),l=(a=c==null?void 0:c.localParticipant)==null?void 0:a.getTrack(t),u=f.useRef(!1),{toggle:d,className:h,pendingObserver:m,enabledObserver:g}=f.useMemo(()=>c?kp(t,c,s):Sp(),[c,t,JSON.stringify(s)]),v=Ne(m,!1),b=Ne(g,r??!!(l!=null&&l.isEnabled));f.useEffect(()=>{i==null||i(b,u.current),u.current=!1},[b,i]),f.useEffect(()=>{r!==void 0&&(F.debug("forcing initial toggle state",t,r),d(r))},[]);const k=f.useMemo(()=>Xt(o,{className:h}),[o,h]),S=f.useCallback(O=>{var x;u.current=!0,d().finally(()=>u.current=!1),(x=o.onClick)==null||x.call(o,O)},[o,d]);return{toggle:d,enabled:b,pending:v,track:l,buttonProps:Ue(D({},k),{"aria-pressed":b,"data-lk-source":t,"data-lk-enabled":b,disabled:v,onClick:S})}}function dl(n=[C.Source.Camera,C.Source.Microphone,C.Source.ScreenShare,C.Source.ScreenShareAudio,C.Source.Unknown],e={}){const t=yi(e.room),[i,r]=f.useState([]),[s,o]=f.useState([]),a=f.useMemo(()=>n.map(l=>nl(l)?l.source:l),[JSON.stringify(n)]);return f.useEffect(()=>{const l=Np(t,a,{additionalRoomEvents:e.updateOnlyOn,onlySubscribed:e.onlySubscribed}).subscribe(({trackReferences:u,participants:d})=>{F.debug("setting track bundles",u,d),r(u),o(d)});return()=>l.unsubscribe()},[t,JSON.stringify(e.updateOnlyOn),JSON.stringify(n)]),f.useMemo(()=>{if(il(n)){const l=Pm(n,s),u=Array.from(i);return s.forEach(d=>{var h;l.has(d.identity)&&((h=l.get(d.identity))!=null?h:[]).forEach(g=>{if(i.find(({participant:b,publication:k})=>d.identity===b.identity&&k.source===g))return;F.debug(`Add ${g} placeholder for participant ${d.identity}.`);const v={participant:d,source:g};u.push(v)})}),u}else return i},[i,s,n])}function Em(n,e){const t=new Set(n);for(const i of e)t.delete(i);return t}function Pm(n,e){const t=new Map;if(il(n)){const i=n.filter(r=>r.withPlaceholder).map(r=>r.source);e.forEach(r=>{const s=r.getTracks().map(a=>{var c;return(c=a.track)==null?void 0:c.source}).filter(a=>a!==void 0),o=Array.from(Em(new Set(i),new Set(s)));o.length>0&&t.set(r.identity,o)})}return t}function xm(n={}){var e;const[t,i]=f.useState(Jp(n.defaults,(e=n.preventLoad)!=null?e:!1)),r=f.useCallback(l=>{i(u=>Ue(D({},u),{audioEnabled:l}))},[]),s=f.useCallback(l=>{i(u=>Ue(D({},u),{videoEnabled:l}))},[]),o=f.useCallback(l=>{i(u=>Ue(D({},u),{audioDeviceId:l}))},[]),a=f.useCallback(l=>{i(u=>Ue(D({},u),{videoDeviceId:l}))},[]),c=f.useCallback(l=>{i(u=>Ue(D({},u),{username:l}))},[]);return f.useEffect(()=>{var l;Vp(t,(l=n.preventSave)!=null?l:!1)},[t,n.preventSave]),{userChoices:t,saveAudioInputEnabled:r,saveVideoInputEnabled:s,saveAudioInputDeviceId:o,saveVideoInputDeviceId:a,saveUsername:c}}function Om(n){const e=mt(n),t=yi(),i=f.useMemo(()=>pp(t,e),[t,e]);return Ne(i,e instanceof fi?e.isE2EEEnabled:e.isEncrypted)}function Rm(n){const{mergedProps:e}=Cm({props:n});return f.createElement("button",D({},e),n.children)}function Im(n){const{buttonProps:e}=sm(n);return f.createElement("button",D({},e),n.children)}var _m=n=>f.createElement("svg",D({xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentColor"},n),f.createElement("path",{d:"M1.354.646a.5.5 0 1 0-.708.708l14 14a.5.5 0 0 0 .708-.708L11 10.293V4.5A1.5 1.5 0 0 0 9.5 3H3.707zM0 4.5a1.5 1.5 0 0 1 .943-1.393l9.532 9.533c-.262.224-.603.36-.975.36h-8A1.5 1.5 0 0 1 0 11.5z"}),f.createElement("path",{d:"m15.2 3.6-2.8 2.1a1 1 0 0 0-.4.8v3a1 1 0 0 0 .4.8l2.8 2.1a.5.5 0 0 0 .8-.4V4a.5.5 0 0 0-.8-.4z"})),Mm=_m,Nm=n=>f.createElement("svg",D({xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentColor"},n),f.createElement("path",{d:"M0 4.5A1.5 1.5 0 0 1 1.5 3h8A1.5 1.5 0 0 1 11 4.5v7A1.5 1.5 0 0 1 9.5 13h-8A1.5 1.5 0 0 1 0 11.5zM15.2 3.6l-2.8 2.1a1 1 0 0 0-.4.8v3a1 1 0 0 0 .4.8l2.8 2.1a.5.5 0 0 0 .8-.4V4a.5.5 0 0 0-.8-.4z"})),Am=Nm,Dm=n=>f.createElement("svg",D({xmlns:"http://www.w3.org/2000/svg",width:16,height:18,fill:"none"},n),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M0 2.75A2.75 2.75 0 0 1 2.75 0h10.5A2.75 2.75 0 0 1 16 2.75v13.594a.75.75 0 0 1-1.234.572l-3.691-3.12a1.25 1.25 0 0 0-.807-.296H2.75A2.75 2.75 0 0 1 0 10.75v-8ZM2.75 1.5c-.69 0-1.25.56-1.25 1.25v8c0 .69.56 1.25 1.25 1.25h7.518c.65 0 1.279.23 1.775.65l2.457 2.077V2.75c0-.69-.56-1.25-1.25-1.25H2.75Z",clipRule:"evenodd"}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M3 4.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5Zm0 2a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5Zm0 2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5Z",clipRule:"evenodd"})),Lm=Dm,Um=n=>f.createElement("svg",D({xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none"},n),f.createElement("path",{fill:"currentcolor",fillRule:"evenodd",d:"M5.293 2.293a1 1 0 0 1 1.414 0l4.823 4.823a1.25 1.25 0 0 1 0 1.768l-4.823 4.823a1 1 0 0 1-1.414-1.414L9.586 8 5.293 3.707a1 1 0 0 1 0-1.414z",clipRule:"evenodd"})),Ho=Um,Fm=n=>f.createElement("svg",D({xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none"},n),f.createElement("g",{stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5},f.createElement("path",{d:"M10 1.75h4.25m0 0V6m0-4.25L9 7M6 14.25H1.75m0 0V10m0 4.25L7 9"}))),Bm=Fm,jm=n=>f.createElement("svg",D({xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none"},n),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M2 2.75A2.75 2.75 0 0 1 4.75 0h6.5A2.75 2.75 0 0 1 14 2.75v10.5A2.75 2.75 0 0 1 11.25 16h-6.5A2.75 2.75 0 0 1 2 13.25v-.5a.75.75 0 0 1 1.5 0v.5c0 .69.56 1.25 1.25 1.25h6.5c.69 0 1.25-.56 1.25-1.25V2.75c0-.69-.56-1.25-1.25-1.25h-6.5c-.69 0-1.25.56-1.25 1.25v.5a.75.75 0 0 1-1.5 0v-.5Z",clipRule:"evenodd"}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M8.78 7.47a.75.75 0 0 1 0 1.06l-2.25 2.25a.75.75 0 1 1-1.06-1.06l.97-.97H1.75a.75.75 0 0 1 0-1.5h4.69l-.97-.97a.75.75 0 0 1 1.06-1.06l2.25 2.25Z",clipRule:"evenodd"})),Vm=jm,Jm=n=>f.createElement("svg",D({xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none"},n),f.createElement("path",{fill:"currentcolor",fillRule:"evenodd",d:"M4 6.104V4a4 4 0 1 1 8 0v2.104c1.154.326 2 1.387 2 2.646v4.5A2.75 2.75 0 0 1 11.25 16h-6.5A2.75 2.75 0 0 1 2 13.25v-4.5c0-1.259.846-2.32 2-2.646ZM5.5 4a2.5 2.5 0 0 1 5 0v2h-5V4Z",clipRule:"evenodd"})),qm=Jm,Wm=n=>f.createElement("svg",D({xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentColor"},n),f.createElement("path",{d:"M12.227 11.52a5.477 5.477 0 0 0 1.246-2.97.5.5 0 0 0-.995-.1 4.478 4.478 0 0 1-.962 2.359l-1.07-1.07C10.794 9.247 11 8.647 11 8V3a3 3 0 0 0-6 0v1.293L1.354.646a.5.5 0 1 0-.708.708l14 14a.5.5 0 0 0 .708-.708zM8 12.5c.683 0 1.33-.152 1.911-.425l.743.743c-.649.359-1.378.59-2.154.66V15h2a.5.5 0 0 1 0 1h-5a.5.5 0 0 1 0-1h2v-1.522a5.502 5.502 0 0 1-4.973-4.929.5.5 0 0 1 .995-.098A4.5 4.5 0 0 0 8 12.5z"}),f.createElement("path",{d:"M8.743 10.907 5 7.164V8a3 3 0 0 0 3.743 2.907z"})),Gm=Wm,Hm=n=>f.createElement("svg",D({xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentColor"},n),f.createElement("path",{fillRule:"evenodd",d:"M2.975 8.002a.5.5 0 0 1 .547.449 4.5 4.5 0 0 0 8.956 0 .5.5 0 1 1 .995.098A5.502 5.502 0 0 1 8.5 13.478V15h2a.5.5 0 0 1 0 1h-5a.5.5 0 0 1 0-1h2v-1.522a5.502 5.502 0 0 1-4.973-4.929.5.5 0 0 1 .448-.547z",clipRule:"evenodd"}),f.createElement("path",{d:"M5 3a3 3 0 1 1 6 0v5a3 3 0 0 1-6 0z"})),zm=Hm,Km=n=>f.createElement("svg",D({xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentcolor"},n),f.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-6a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),f.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-6a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"})),$m=Km,Ym=n=>f.createElement("svg",D({xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentcolor"},n),f.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),f.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),f.createElement("g",{opacity:.25},f.createElement("path",{d:"M12 .5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),f.createElement("path",{d:"M12 .5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}))),Qm=Ym,Xm=n=>f.createElement("svg",D({xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentcolor"},n),f.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),f.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),f.createElement("g",{opacity:.25},f.createElement("path",{d:"M6 6.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),f.createElement("path",{d:"M6 6.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-6a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),f.createElement("path",{d:"M12 .5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}))),Zm=Xm,eg=n=>f.createElement("svg",D({xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentColor"},n),f.createElement("g",{opacity:.25},f.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-4Zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-9Zm6-6a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5V.5Z"}),f.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-4Zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-9Zm6-6a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5V.5Z"}))),tg=eg,ng=n=>f.createElement("svg",D({xmlns:"http://www.w3.org/2000/svg",width:20,height:16,fill:"none"},n),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M0 2.75A2.75 2.75 0 0 1 2.75 0h14.5A2.75 2.75 0 0 1 20 2.75v10.5A2.75 2.75 0 0 1 17.25 16H2.75A2.75 2.75 0 0 1 0 13.25V2.75ZM2.75 1.5c-.69 0-1.25.56-1.25 1.25v10.5c0 .69.56 1.25 1.25 1.25h14.5c.69 0 1.25-.56 1.25-1.25V2.75c0-.69-.56-1.25-1.25-1.25H2.75Z",clipRule:"evenodd"}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M9.47 4.22a.75.75 0 0 1 1.06 0l2.25 2.25a.75.75 0 0 1-1.06 1.06l-.97-.97v4.69a.75.75 0 0 1-1.5 0V6.56l-.97.97a.75.75 0 0 1-1.06-1.06l2.25-2.25Z",clipRule:"evenodd"})),hl=ng,ig=n=>f.createElement("svg",D({xmlns:"http://www.w3.org/2000/svg",width:20,height:16,fill:"none"},n),f.createElement("g",{fill:"currentColor"},f.createElement("path",{d:"M7.28 4.22a.75.75 0 0 0-1.06 1.06L8.94 8l-2.72 2.72a.75.75 0 1 0 1.06 1.06L10 9.06l2.72 2.72a.75.75 0 1 0 1.06-1.06L11.06 8l2.72-2.72a.75.75 0 0 0-1.06-1.06L10 6.94z"}),f.createElement("path",{fillRule:"evenodd",d:"M2.75 0A2.75 2.75 0 0 0 0 2.75v10.5A2.75 2.75 0 0 0 2.75 16h14.5A2.75 2.75 0 0 0 20 13.25V2.75A2.75 2.75 0 0 0 17.25 0zM1.5 2.75c0-.69.56-1.25 1.25-1.25h14.5c.69 0 1.25.56 1.25 1.25v10.5c0 .69-.56 1.25-1.25 1.25H2.75c-.69 0-1.25-.56-1.25-1.25z",clipRule:"evenodd"}))),rg=ig,sg=n=>f.createElement("svg",D({xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none"},n),f.createElement("g",{stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5},f.createElement("path",{d:"M13.25 7H9m0 0V2.75M9 7l5.25-5.25M2.75 9H7m0 0v4.25M7 9l-5.25 5.25"}))),og=sg;function ag(n){var e=n,{trackRef:t,trackSource:i,participant:r}=e,s=ge(e,["trackRef","trackSource","participant"]);const o=fn(),{mergedProps:a,inFocus:c}=am({trackRef:t??o,trackSource:i,participant:r,props:s});return f.createElement(Os.Consumer,null,l=>l!==void 0&&f.createElement("button",D({},a),s.children?s.children:c?f.createElement(og,null):f.createElement(Bm,null)))}function kr(n){var e=n,{kind:t,initialSelection:i,onActiveDeviceChange:r,onDeviceListChange:s,onDeviceSelectError:o,exactMatch:a,track:c,requestPermissions:l,onError:u}=e,d=ge(e,["kind","initialSelection","onActiveDeviceChange","onDeviceListChange","onDeviceSelectError","exactMatch","track","requestPermissions","onError"]);const h=nr(),m=f.useCallback(_=>{h&&h.emit(T.MediaDevicesError,_),u==null||u(_)},[h,u]),{devices:g,activeDeviceId:v,setActiveMediaDevice:b,className:k}=fm({kind:t,room:h,track:c,requestPermissions:l,onError:m});f.useEffect(()=>{i!==void 0&&b(i)},[b]),f.useEffect(()=>{typeof s=="function"&&s(g)},[s,g]),f.useEffect(()=>{v&&v!==""&&(r==null||r(v))},[v]);const S=_=>Kp(this,null,function*(){try{yield b(_,{exact:a})}catch(A){if(A instanceof Error)o==null||o(A);else throw A}}),O=f.useMemo(()=>wn(d,{className:k},{className:"lk-list"}),[k,d]);function x(_,A,j){return _===A||j===0&&A==="default"}return f.createElement("ul",D({},O),g.map((_,A)=>f.createElement("li",{key:_.deviceId,id:_.deviceId,"data-lk-active":x(_.deviceId,v,A),"aria-selected":x(_.deviceId,v,A),role:"option"},f.createElement("button",{className:"lk-button",onClick:()=>S(_.deviceId)},_.label))))}function fl(n,e){switch(n){case C.Source.Microphone:return e?f.createElement(zm,null):f.createElement(Gm,null);case C.Source.Camera:return e?f.createElement(Am,null):f.createElement(Mm,null);case C.Source.ScreenShare:return e?f.createElement(rg,null):f.createElement(hl,null);default:return}}function cg(n){switch(n){case Re.Excellent:return f.createElement($m,null);case Re.Good:return f.createElement(Qm,null);case Re.Poor:return f.createElement(Zm,null);default:return f.createElement(tg,null)}}function Sr(n){var e=n,{showIcon:t}=e,i=ge(e,["showIcon"]);const{buttonProps:r,enabled:s}=wm(i);return f.createElement("button",D({},r),(t??!0)&&fl(i.source,s),i.children)}function lg(n){var e;const{className:t,quality:i}=im(n),r=f.useMemo(()=>Ue(D({},wn(n,{className:t})),{"data-lk-quality":i}),[i,n,t]);return f.createElement("div",D({},r),(e=n.children)!=null?e:cg(i))}function zo(n){var e=n,{participant:t}=e,i=ge(e,["participant"]);const r=mt(t),{className:s,infoObserver:o}=f.useMemo(()=>Pp(r),[r]),{identity:a,name:c}=Ne(o,{name:r.name,identity:r.identity,metadata:r.metadata}),l=f.useMemo(()=>wn(i,{className:s,"data-lk-participant-name":c}),[i,s,c]);return f.createElement("span",D({},l),c!==""?c:a,i.children)}function ug(n){var e=n,{source:t,participant:i,trackRef:r,show:s="always"}=e,o=ge(e,["source","participant","trackRef","show"]),a,c;const{className:l,isMuted:u}=Tm(r??t,{participant:i}),d=s==="always"||s==="muted"&&u||s==="unmuted"&&!u,h=f.useMemo(()=>wn(o,{className:l}),[l,o]);return d?f.createElement("div",Ue(D({},h),{"data-lk-muted":u}),(c=o.children)!=null?c:fl((a=r==null?void 0:r.source)!=null?a:t,!u)):null}var dg=n=>f.createElement("svg",D({width:320,height:320,viewBox:"0 0 320 320",preserveAspectRatio:"xMidYMid meet",fill:"none",xmlns:"http://www.w3.org/2000/svg"},n),f.createElement("path",{d:"M160 180C204.182 180 240 144.183 240 100C240 55.8172 204.182 20 160 20C115.817 20 79.9997 55.8172 79.9997 100C79.9997 144.183 115.817 180 160 180Z",fill:"white",fillOpacity:.25}),f.createElement("path",{d:"M97.6542 194.614C103.267 191.818 109.841 192.481 115.519 195.141C129.025 201.466 144.1 205 159.999 205C175.899 205 190.973 201.466 204.48 195.141C210.158 192.481 216.732 191.818 222.345 194.614C262.703 214.719 291.985 253.736 298.591 300.062C300.15 310.997 291.045 320 280 320H39.9997C28.954 320 19.8495 310.997 21.4087 300.062C28.014 253.736 57.2966 214.72 97.6542 194.614Z",fill:"white",fillOpacity:.25})),hg=dg;function fg(n){var e=n,{onTrackClick:t,onClick:i,onSubscriptionStatusChanged:r,trackRef:s,name:o,publication:a,source:c,participant:l,manageSubscription:u}=e,d=ge(e,["onTrackClick","onClick","onSubscriptionStatusChanged","trackRef","name","publication","source","participant","manageSubscription"]),h,m,g,v,b,k,S,O,x,_;const A=fn(),j=(v=(g=(h=s==null?void 0:s.publication)==null?void 0:h.trackName)!=null?g:(m=A==null?void 0:A.publication)==null?void 0:m.trackName)!=null?v:o,N=(k=(b=s==null?void 0:s.source)!=null?b:A==null?void 0:A.source)!=null?k:c,P=(O=(S=s==null?void 0:s.publication)!=null?S:A==null?void 0:A.publication)!=null?O:a,V=(_=(x=s==null?void 0:s.participant)!=null?x:A==null?void 0:A.participant)!=null?_:l;if(N===void 0)throw new Error("VideoTrack: You must provide a trackRef or source property.");const $=mt(V),Z=f.useRef(null),se=Wp(Z,{}),de=qp(se,3e3);f.useEffect(()=>{u&&P instanceof di&&(de==null?void 0:de.isIntersecting)===!1&&(se==null?void 0:se.isIntersecting)===!1&&P.setSubscribed(!1)},[de,P,u]),f.useEffect(()=>{u&&P instanceof di&&(se==null?void 0:se.isIntersecting)===!0&&P.setSubscribed(!0)},[se,P,u]);const{elementProps:ee,publication:Y,isSubscribed:Zt}=ul({participant:$,name:j,source:N,publication:P},{element:Z,props:d});f.useEffect(()=>{r==null||r(!!Zt)},[Zt,r]);const ir=ml=>{i==null||i(ml),t==null||t({participant:$,track:Y})};return f.createElement("video",Ue(D({ref:Z},ee),{muted:!0,onClick:ir}))}function pl(n){var e=n,{trackRef:t,onSubscriptionStatusChanged:i,volume:r,source:s,name:o,publication:a,participant:c}=e,l=ge(e,["trackRef","onSubscriptionStatusChanged","volume","source","name","publication","participant"]),u,d,h,m,g,v,b,k,S,O;const x=fn(),_=(m=(h=(u=t==null?void 0:t.publication)==null?void 0:u.trackName)!=null?h:(d=x==null?void 0:x.publication)==null?void 0:d.trackName)!=null?m:o,A=(v=(g=t==null?void 0:t.source)!=null?g:x==null?void 0:x.source)!=null?v:s,j=(k=(b=t==null?void 0:t.publication)!=null?b:x==null?void 0:x.publication)!=null?k:a,N=(O=(S=t==null?void 0:t.participant)!=null?S:x==null?void 0:x.participant)!=null?O:c;if(A===void 0)throw new Error("The AudioTrack component expects a trackRef or source property.");const P=f.useRef(null),V=mt(N),{elementProps:$,isSubscribed:Z,track:se,publication:de}=ul({source:A,name:_,participant:V,publication:j},{element:P,props:l});return f.useEffect(()=>{i==null||i(!!Z)},[Z,i]),f.useEffect(()=>{se===void 0||r===void 0||(se instanceof Nn?se.setVolume(r):F.warn("Volume can only be set on remote audio tracks."))},[r,se]),f.useEffect(()=>{de===void 0||l.muted===void 0||(de instanceof di?de.setEnabled(!l.muted):F.warn("Can only call setEnabled on remote track publications."))},[l.muted,de,se]),f.createElement("audio",D({ref:P},$))}function pg(n){const e=!!_s();return n.participant&&!e?f.createElement(cl.Provider,{value:n.participant},n.children):f.createElement(f.Fragment,null,n.children)}function mg(n){const e=!!fn();return n.trackRef&&!e?f.createElement(Is.Provider,{value:n.trackRef},n.children):f.createElement(f.Fragment,null,n.children)}function gg(n){var e=n,{trackRef:t,participant:i,children:r,source:s=C.Source.Camera,onParticipantClick:o,publication:a,disableSpeakingIndicator:c}=e,l=ge(e,["trackRef","participant","children","source","onParticipantClick","publication","disableSpeakingIndicator"]),u,d;const h=fn(),m=mt(i),g=f.useMemo(()=>{var x,_,A,j,N,P;return{participant:(_=(x=t==null?void 0:t.participant)!=null?x:h==null?void 0:h.participant)!=null?_:m,source:(j=(A=t==null?void 0:t.source)!=null?A:h==null?void 0:h.source)!=null?j:s,publication:(P=(N=t==null?void 0:t.publication)!=null?N:h==null?void 0:h.publication)!=null?P:a}},[h,m,a,s,t]),{elementProps:v}=bm({participant:g.participant,htmlProps:l,source:g.source,publication:g.publication,disableSpeakingIndicator:c,onParticipantClick:o}),b=Om(m),k=Rs(),S=(u=tm())==null?void 0:u.autoSubscription,O=f.useCallback(x=>{g.source&&!x&&k&&k.pin.dispatch&&Zr(g,k.pin.state)&&k.pin.dispatch({msg:"clear_pin"})},[g,k]);return f.createElement("div",D({style:{position:"relative"}},v),f.createElement(mg,{trackRef:g},f.createElement(pg,{participant:g.participant},r??f.createElement(f.Fragment,null,Te(g)&&(((d=g.publication)==null?void 0:d.kind)==="video"||g.source===C.Source.Camera||g.source===C.Source.ScreenShare)?f.createElement(fg,{trackRef:g,onSubscriptionStatusChanged:O,manageSubscription:S}):Te(g)&&f.createElement(pl,{trackRef:g,onSubscriptionStatusChanged:O}),f.createElement("div",{className:"lk-participant-placeholder"},f.createElement(hg,null)),f.createElement("div",{className:"lk-participant-metadata"},f.createElement("div",{className:"lk-participant-metadata-item"},g.source===C.Source.Camera?f.createElement(f.Fragment,null,b&&f.createElement(qm,{style:{marginRight:"0.25rem"}}),f.createElement(ug,{source:C.Source.Microphone,show:"muted"}),f.createElement(zo,null)):f.createElement(f.Fragment,null,f.createElement(hl,{style:{marginRight:"0.25rem"}}),f.createElement(zo,null,"'s screen"))),f.createElement(lg,{className:"lk-participant-metadata-item"}))),f.createElement(ag,{trackRef:g}))))}function vg(n){var e=n,{tracks:t}=e,i=ge(e,["tracks"]);return f.createElement(f.Fragment,null,t.map(r=>f.createElement(Is.Provider,{value:r,key:pe(r)},mm(i.children))))}function bg({totalPageCount:n,nextPage:e,prevPage:t,currentPage:i,pagesContainer:r}){const[s,o]=f.useState(!1);return f.useEffect(()=>{let a;return r&&(a=Ap(r.current,2e3).subscribe(o)),()=>{a&&a.unsubscribe()}},[r]),f.createElement("div",{className:"lk-pagination-control","data-lk-user-interaction":s},f.createElement("button",{className:"lk-button",onClick:t},f.createElement(Ho,null)),f.createElement("span",{className:"lk-pagination-count"},`${i} of ${n}`),f.createElement("button",{className:"lk-button",onClick:e},f.createElement(Ho,null)))}function yg({totalPageCount:n,currentPage:e}){const t=new Array(n).fill("").map((i,r)=>r+1===e?f.createElement("span",{"data-lk-active":!0,key:r}):f.createElement("span",{key:r}));return f.createElement("div",{className:"lk-pagination-indicator"},t)}function kg(n){var e=n,{tracks:t}=e,i=ge(e,["tracks"]);const r=f.createRef(),s=f.useMemo(()=>wn(i,{className:"lk-grid-layout"}),[i]),{layout:o}=cm(r,t.length),a=vm(o.maxTiles,t);return Sm(r,{onLeftSwipe:a.nextPage,onRightSwipe:a.prevPage}),f.createElement("div",D({ref:r,"data-lk-pagination":a.totalPageCount>1},s),f.createElement(vg,{tracks:a.tracks},i.children),t.length>o.maxTiles&&f.createElement(f.Fragment,null,f.createElement(yg,{totalPageCount:a.totalPageCount,currentPage:a.currentPage}),f.createElement(bg,D({pagesContainer:r},a))))}function Sg(n){const{room:e,htmlProps:t}=dm(n);return f.createElement("div",D({},t),e&&f.createElement(Ms.Provider,{value:e},f.createElement(ll.Provider,{value:n.featureFlags},n.children)))}function Cg({volume:n,muted:e}){const t=dl([C.Source.Microphone,C.Source.ScreenShareAudio,C.Source.Unknown],{updateOnlyOn:[],onlySubscribed:!1}).filter(i=>!el(i.participant)&&i.publication.kind===C.Kind.Audio);return f.useEffect(()=>{for(const i of t)i.publication.setSubscribed(!0)},[t]),f.createElement("div",{style:{display:"none"}},t.map(i=>f.createElement(pl,{key:pe(i),trackRef:i,volume:n,muted:e})))}function Ko(n){var e=n,{kind:t,initialSelection:i,onActiveDeviceChange:r,tracks:s,requestPermissions:o=!1}=e,a=ge(e,["kind","initialSelection","onActiveDeviceChange","tracks","requestPermissions"]);const[c,l]=f.useState(!1),[u,d]=f.useState([]),[h,m]=f.useState(!0),g=(S,O)=>{F.debug("handle device change"),l(!1),r==null||r(S,O)},v=f.useRef(null),b=f.useRef(null);f.useLayoutEffect(()=>{v.current&&b.current&&(u||h)&&Vf(v.current,b.current).then(({x:S,y:O})=>{b.current&&Object.assign(b.current.style,{left:`${S}px`,top:`${O}px`})}),m(!1)},[v,b,u,h]);const k=f.useCallback(S=>{b.current&&S.target!==v.current&&c&&Jf(b.current,S)&&l(!1)},[c,b,v]);return f.useEffect(()=>(document.addEventListener("click",k),window.addEventListener("resize",()=>m(!0)),()=>{document.removeEventListener("click",k),window.removeEventListener("resize",()=>m(!0))}),[k,m]),f.createElement(f.Fragment,null,f.createElement("button",Ue(D({className:"lk-button lk-button-menu","aria-pressed":c},a),{onClick:()=>l(!c),ref:v}),a.children),!a.disabled&&f.createElement("div",{className:"lk-device-menu",ref:b,style:{visibility:c?"visible":"hidden"}},t?f.createElement(kr,{initialSelection:i,onActiveDeviceChange:S=>g(t,S),onDeviceListChange:d,kind:t,track:s==null?void 0:s[t],requestPermissions:o}):f.createElement(f.Fragment,null,f.createElement("div",{className:"lk-device-menu-heading"},"Audio inputs"),f.createElement(kr,{kind:"audioinput",onActiveDeviceChange:S=>g("audioinput",S),onDeviceListChange:d,track:s==null?void 0:s.audioinput,requestPermissions:o}),f.createElement("div",{className:"lk-device-menu-heading"},"Video inputs"),f.createElement(kr,{kind:"videoinput",onActiveDeviceChange:S=>g("videoinput",S),onDeviceListChange:d,track:s==null?void 0:s.videoinput,requestPermissions:o}))))}function Tg(n){var e=n,{label:t}=e,i=ge(e,["label"]);const r=Ns(),{mergedProps:s,canPlayAudio:o}=ym({room:r,props:i}),{mergedProps:a,canPlayVideo:c}=km({room:r,props:s}),l=a,{style:u}=l,d=ge(l,["style"]);return u.display=o&&c?"none":"block",f.createElement("button",D({style:u},d),t??`Start ${o?"Video":"Audio"}`)}function wg(n){var e=n,{variation:t,controls:i,saveUserChoices:r=!0}=e,s=ge(e,["variation","controls","saveUserChoices"]),o,a,c,l,u;const[d,h]=f.useState(!1),m=Rs();f.useEffect(()=>{var ee,Y;((ee=m==null?void 0:m.widget.state)==null?void 0:ee.showChat)!==void 0&&h((Y=m==null?void 0:m.widget.state)==null?void 0:Y.showChat)},[(o=m==null?void 0:m.widget.state)==null?void 0:o.showChat]);const v=Zp(`(max-width: ${d?1e3:760}px)`)?"minimal":"verbose";t??(t=v);const b=D({leave:!0},i),k=hm();k?((a=b.camera)!=null||(b.camera=k.canPublish),(c=b.microphone)!=null||(b.microphone=k.canPublish),(l=b.screenShare)!=null||(b.screenShare=k.canPublish),(u=b.chat)!=null||(b.chat=k.canPublishData&&(i==null?void 0:i.chat))):(b.camera=!1,b.chat=!1,b.microphone=!1,b.screenShare=!1);const S=f.useMemo(()=>t==="minimal"||t==="verbose",[t]),O=f.useMemo(()=>t==="textOnly"||t==="verbose",[t]),x=Hf(),[_,A]=f.useState(!1),j=f.useCallback(ee=>{A(ee)},[A]),N=wn({className:"lk-control-bar"},s),{saveAudioInputEnabled:P,saveVideoInputEnabled:V,saveAudioInputDeviceId:$,saveVideoInputDeviceId:Z}=xm({preventSave:!r}),se=f.useCallback((ee,Y)=>Y?P(ee):null,[P]),de=f.useCallback((ee,Y)=>Y?V(ee):null,[V]);return f.createElement("div",D({},N),b.microphone&&f.createElement("div",{className:"lk-button-group"},f.createElement(Sr,{source:C.Source.Microphone,showIcon:S,onChange:se},O&&"Microphone"),f.createElement("div",{className:"lk-button-group-menu"},f.createElement(Ko,{kind:"audioinput",onActiveDeviceChange:(ee,Y)=>$(Y??"")}))),b.camera&&f.createElement("div",{className:"lk-button-group"},f.createElement(Sr,{source:C.Source.Camera,showIcon:S,onChange:de},O&&"Camera"),f.createElement("div",{className:"lk-button-group-menu"},f.createElement(Ko,{kind:"videoinput",onActiveDeviceChange:(ee,Y)=>Z(Y??"")}))),b.screenShare&&x&&f.createElement(Sr,{source:C.Source.ScreenShare,captureOptions:{audio:!0,selfBrowserSurface:"include"},showIcon:S,onChange:j},O&&(_?"Stop screen share":"Share screen")),b.chat&&f.createElement(Rm,null,S&&f.createElement(Lm,null),O&&"Chat"),b.leave&&f.createElement(Im,null,S&&f.createElement(Vm,null),O&&"Leave"),f.createElement(Tg,null))}var ni=(n=>(n.TIMER_START="timer_start",n.TIMER_CHANGE="time_change",n.TIMER_STOP="timer_stop",n.TIMEOUT="timeout",n))(ni||{});const Ig=n=>{const{enablesVideo:e,callInfo:t,status:i,reject:r,accept:s,hangup:o}=$o(),a=yl(kl)||"",c=i===gt.CALLING&&(t==null?void 0:t.wsInfo),l=()=>{u==null||u.postMessage({event:ni.TIMER_STOP,data:null}),u&&(u.terminate(),d(null))},[u,d]=f.useState(null),[h,m]=f.useState(60);f.useEffect(()=>((async()=>{var A,j;if(i===gt.WAITING&&a!==(((A=t==null?void 0:t.userInfo)==null?void 0:A.user_id)||((j=t==null?void 0:t.groupInfo)==null?void 0:j.user_id))&&!u){const N=new Worker(new URL("/assets/timer-87CNA4vV.js",import.meta.url));N.postMessage({event:ni.TIMER_START,data:{duration:h*1e3}}),N.onmessage=P=>{const{event:V,data:$}=P.data;switch(V){case ni.TIMEOUT:Sl(Cl.CALL,"未接来电","您有未接来电待处理！"),r(),rr.dialog.close();break;case ni.TIMER_CHANGE:m($.remainder);break}},d(N)}i===gt.CALLING&&!(t!=null&&t.wsInfo)&&rr.dialog.alert("通话信息异常，请重新发起通话！",()=>{o(),l(),rr.dialog.close()}),i===gt.IDLE&&(console.log("空闲"),l(),n.f7router.back()),i===gt.HANGUP&&(console.log("挂断"),l())})(),()=>{l()}),[i,t==null?void 0:t.wsInfo]);const[g,v]=f.useState(0),b=()=>{console.log("通话连接成功"),v(0)},k=()=>{console.log("通话断开"),g>=3&&o()},S=A=>{v(g+1),console.log("通话出现异常：",As(i),A),i===gt.WAITING&&r()},O=async()=>{await r(),l()},x=async()=>{await s(),l()},_=async()=>{await o(),l()};return K.jsxs(Tl,{className:"bg-bgPrimary bg-zinc-900 z-[999] flex flex-col justify-center items-center",noNavbar:!0,noToolbar:!0,onPageBeforeOut:l,children:[c&&K.jsxs(Sg,{"data-lk-theme":"default",token:t.wsInfo.token,serverUrl:t.wsInfo.url,audio:!0,video:e,screen:!1,onConnected:b,onDisconnected:k,onError:S,children:[K.jsx(Eg,{}),K.jsx(Cg,{}),K.jsx(Pg,{errCount:g,hangup:_})]}),K.jsxs("div",{className:"absolute bottom-10 w-full flex flex-col justify-evenly items-center",children:[i!==gt.CALLING&&K.jsxs("div",{className:"text-white fixed top-1/2",children:[i===gt.WAITING&&K.jsxs("div",{className:"",children:["等待时间：",h,"s"]}),K.jsx("div",{className:"",children:As(i)})]}),i===gt.WAITING&&K.jsxs("div",{className:"w-full flex flex-row justify-evenly items-center",children:[K.jsx(Ds,{className:"size-[45px] box-content p-2 rounded-full bg-gray-100 text-red-500",onClick:O}),K.jsx(Ds,{className:"size-[45px] box-content p-2 rounded-full bg-gray-100 text-green-500",onClick:x})]})]})]})};function Eg(){const n=dl([{source:C.Source.Camera,withPlaceholder:!0},{source:C.Source.ScreenShare,withPlaceholder:!1}],{onlySubscribed:!1});return K.jsx(kg,{tracks:n,style:{height:"calc(100% - var(--lk-control-bar-height))"},children:K.jsx(gg,{})})}function Pg(n){const{updateHideCall:e}=$o();return K.jsxs(K.Fragment,{children:[K.jsx(wg,{}),n.errCount>0&&K.jsx("div",{className:"p-2 fixed top-1/2 left-1/2 translate-y-[-50%] translate-x-[-50%] text-center bg-white text-red-500",children:K.jsxs("div",{children:["网络异常,重试中(3/",n.errCount,")..."]})}),K.jsxs("div",{className:"px-2 pb-6 flex justify-evenly items-center",children:[K.jsx(Ls,{className:"flex-1 mx-2 py-4 px-[14px]",fill:!0,onClick:()=>e(!0),children:"收起"}),K.jsx(Ls,{className:"flex-1 mx-2 py-4 px-[14px]",fill:!0,color:"red",onClick:n.hangup,children:"挂断"})]})]})}export{Ig as default};
