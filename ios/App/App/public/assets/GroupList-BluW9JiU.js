import{ac as L,e as O,ap as U,y as u,aq as v,ar as A,as as b,at as j,au as M,av as E,aw as C,ax as k,ay as B,C as x,az as T,aA as $,aB as F,M as K,aC as P,r as q,X as z,f as N,$ as D,aj as Y,j as w,P as H,N as W,W as X,L as J,al as Q,m as G}from"./index-BMnTsVIf.js";const R=L(O)||"",V=U((_,c)=>({messages:[],all_meesages:[],shareKey:null,tableName:u.tables.private_chats,is_group:!1,receiver_id:"",dialog_id:0,userInfo:null,members:[],myInfo:null,trgger:!1,at_all_user:0,at_users:[],reads:[],opened:!1,height:0,refresh:!1,num:0,updateTrgger:e=>_({trgger:e}),updateMessage:async e=>{const{messages:r}=c();_({messages:[...r,e]})},deleteMessage:async e=>{var s;const{tableName:r,messages:a}=c();try{_({messages:a.filter(i=>i.msg_id!==e)});const d=((s=a.find(i=>i.msg_id===e))==null?void 0:s.id)??0;await u.delete(r,"id",d)}catch(d){console.log("删除消息失败",d)}},craeteMessage:async(e,r,a)=>{var d,i,l;let s={};try{const{messages:f,receiver_id:t,dialog_id:g,myInfo:n,at_all_user:m,at_users:y,userInfo:h}=c();let{is_group:S}=c();S=(a==null?void 0:a.is_group)??S;const I=((a==null?void 0:a.is_forward)??!1)&&t===(a==null?void 0:a.receiver_id)||!(a!=null&&a.receiver_id);s={dialog_id:(a==null?void 0:a.dialog_id)??g,content:r,created_at:Date.now(),is_burn_after_reading:(a==null?void 0:a.is_burn_after_reading)??((d=h==null?void 0:h.preferences)==null?void 0:d.open_burn_after_reading)??0,is_label:v.NOT_MARK,is_read:A.READ,msg_id:0,msg_send_state:b.SENDING,receiver:(a==null?void 0:a.receiver_id)??t,read_at:Date.now(),reply_id:(a==null?void 0:a.replay_id)??0,sender_id:R,type:e,sender_info:{avatar:(i=n==null?void 0:n.user_info)==null?void 0:i.avatar,nickname:(l=n==null?void 0:n.user_info)==null?void 0:l.nickname,user_id:R},at_all_user:m||0,at_users:y||[],group_id:S?Number((a==null?void 0:a.receiver_id)||t):0,uid:j(),is_tips:!1,msg_url:(a==null?void 0:a.msg_url)??"",file_id:(a==null?void 0:a.file_id)??"",duration:(a==null?void 0:a.duration)??0},s.group_id||(s.group_id=0),I&&_({messages:[...f,s]})}catch(f){console.log("err",f)}return s},send:async(e,r)=>{const{receiver_id:a,at_all_user:s,at_users:d,updateDB:i}=c();let{is_group:l}=c();l=(r==null?void 0:r.is_group)??l;const t=((r==null?void 0:r.is_forward)??!1)&&a===(r==null?void 0:r.receiver_id)||!(r!=null&&r.receiver_id);let g="";try{const n={type:e.type,content:e.content,dialog_id:e.dialog_id,replay_id:e.reply_id,is_burn_after_reading:e.is_burn_after_reading};l?(n.at_all_user=s||0,n.at_users=d||[],n.group_id=e.group_id):n.receiver_id=e.receiver;const{code:m,data:y,msg:h}=l?await M.sendGroupMessageApi(n):await M.sendUserMessageApi(n);e.msg_send_state=m===200?b.SEND_SUCCESS:b.SEND_FAILED,e.msg_id=(y==null?void 0:y.msg_id)||Date.now(),m!==200&&(g=h)}catch(n){console.error("发送消息失败",n),e.msg_send_state=b.SEND_FAILED}finally{i(e,g,t)}},updateDB:async(e,r,a)=>{const s=[];s.push(e),await E(u.tables.messages,e.uid,e),r?(s.push({dialog_id:e.dialog_id,msg_id:null,is_tips:!0,content:r,type:C.ERROR,uid:j()}),a&&await E(u.tables.messages,s[1].uid,s[1])):await k(e.dialog_id,e),a&&_(d=>({messages:[...d.messages.slice(0,-1),...s],at_all_user:0,at_users:[]}))},sendMessage:async(e,r,a={})=>{const{messages:s,receiver_id:d,craeteMessage:i,send:l}=c(),t=((a==null?void 0:a.is_forward)??!1)&&d===(a==null?void 0:a.receiver_id)||!(a!=null&&a.receiver_id),g=await i(e,r,a);console.log(g,t),g.group_id||(g.group_id=0),t&&_({messages:[...s,g]}),await l(g,a)},editMessage:async(e,r)=>{const{is_group:a,messages:s,tableName:d}=c();e.content=r,e.msg_send_state=b.SENDING,_({messages:s.map(i=>i.msg_id===e.msg_id?{...i,...e}:i)});try{const i={msg_type:e==null?void 0:e.type,content:r,msg_id:e==null?void 0:e.msg_id},{code:l}=a?await M.editGroupMessageApi(i):await M.editUserMessageApi(i);e.msg_send_state=l===200?b.SEND_SUCCESS:b.SEND_FAILED}catch{e.msg_send_state=b.SEND_FAILED}finally{_(i=>({messages:i.messages.map(l=>l.msg_id===e.msg_id?{...l,...e}:l)})),await E(d,e.uid,e,!0)}},markMessage:async e=>{const{is_group:r,messages:a,tableName:s}=c();try{const d={msg_id:e==null?void 0:e.msg_id,is_label:(e==null?void 0:e.is_label)===v.MARK?v.NOT_MARK:v.MARK},{code:i}=r?await M.labelGroupMessageApi(d):await M.labelUserMessageApi(d);if(i===200){e.is_label=d.is_label;const l=a.map(t=>t.msg_id===e.msg_id?{...t,...e}:t);await E(s,e.uid,e,!0);const f=await B(s,e,e.is_label);l.push(f),_({messages:l})}}catch(d){return console.error("标记消息失败:",d),!1}return!0},readMessage:async e=>{const{is_group:r,dialog_id:a,tableName:s,receiver_id:d,clearReads:i,messages:l}=c(),f=e.filter(m=>(m==null?void 0:m.is_read)===A.NOT_READ),t=f.map(m=>m.msg_id);if(!t.length)return;const g={msg_ids:t,dialog_id:a};r&&(g.group_id=Number(d));const{code:n}=r?await M.readGroupMessageApi(g):await M.readUserMessageApi(g);if(n===200){f.map(y=>{E(s,y.uid,{...y,is_read:A.READ},!0)}),i(e),_({messages:l.map(y=>t.includes(y.msg_id)?{...y,is_read:A.READ}:y)});const m=await u.findOneById(u.tables.dialogs,"dialog_id",a);m&&await u.update(u.tables.dialogs,"dialog_id",a,{...m,dialog_unread_count:0})}},initMessage:async(e,r,a)=>{const{height:s}=c(),d=Math.ceil(s/80),i=u.tables.messages,l=await u.findOneAllById(u.tables.messages,"dialog_id",r),f=await u.findOneById(u.tables.friends,"user_id",a),t=await x.findOneById(x.tables.users,"user_id",R);_({messages:l.slice(-d),tableName:i,num:d,is_group:e,receiver_id:a,dialog_id:r,all_meesages:l,userInfo:f,myInfo:t})},updateMessages:async e=>{try{const{messages:r}=c(),a=T(r,(s,d)=>$(s,e[d]));if(F(a))return;console.log("Object.values(differences)",Object.values(a)),_({messages:[...r,...Object.values(a)]})}catch(r){console.error("更新消息失败",r)}},clearMessages:async()=>{_({messages:[],all_meesages:[],dialog_id:0,refresh:!1})},updateMessageById:async e=>{const{messages:r}=c(),a=r.map(s=>s.msg_id===e.msg_id?{...s,...e}:s);_({messages:a})},updateAtAllUser:e=>{_({at_all_user:e?1:0})},updateAtUsers:e=>{const{at_users:r}=c();_({at_users:[...r,e]})},updateReads:e=>{var d;const{reads:r,userInfo:a}=c();if(r.findIndex(i=>i.msg_id===e.msg_id)===-1)_({reads:[...r,e]});else{const i=r.filter(l=>l.msg_id!==e.msg_id);_({reads:i})}(e==null?void 0:e.is_burn_after_reading)===K.YES&&u.add(u.tables.read_destroy,{uid:e.uid,msg_id:e==null?void 0:e.msg_id,read_time:Date.now(),self_destruct_time:((d=a==null?void 0:a.preferences)==null?void 0:d.open_burn_after_reading_time_out)??10})},clearReads:e=>{const{reads:r}=c(),a=P(r,e,"msg_id");_({reads:a})},recallMessage:async e=>{const{messages:r,is_group:a}=c();try{const s={msg_id:e.msg_id},{code:d,msg:i}=a?await M.revokeGroupMessageApi(s):await M.revokeUserMessageApi(s);if(d!==200)return{success:!1,msg:i};const l=r.filter(f=>f.msg_id!==e.msg_id);return u.delete(u.tables.messages,"id",e.id),_({messages:l}),{success:!1,msg:"撤回消息成功"}}catch(s){return console.error(s),{success:!1,msg:"撤回消息失败"}}},updateOpened:e=>_({opened:e}),updateHeight:e=>_({height:e}),updateRefresh:e=>_({refresh:e}),addMessages:async()=>{const{messages:e,all_meesages:r,num:a,refresh:s}=c();if(s)return;if(_({refresh:!0}),e.length>=r.length)return _({refresh:!1});const d=r.slice(-(a+e.length));setTimeout(()=>{_({messages:d,refresh:!1})},1e3)}})),p=({f7router:_})=>{const c=V(),[e,r]=q.useState({});return z(async()=>{try{N.dialog.preloader(D("获取中..."));const{code:a,data:s}=await Y.groupListApi();a===200&&r(s)}catch(a){N.dialog.alert(D((a==null?void 0:a.message)||"获取群列表失败..."))}finally{N.dialog.close()}},()=>{},[]),w.jsxs(H,{className:"group-page",noToolbar:!0,messagesContent:!0,children:[w.jsx(W,{className:"messages-navbar",backLink:!0,children:w.jsx(X,{children:w.jsx("div",{className:"",children:D("群组")})})}),w.jsx(J,{contactsList:!0,noChevron:!0,dividers:!0,children:Object.keys(e).map(a=>w.jsxs(Q,{children:[w.jsx(G,{groupTitle:!0,title:a}),e[a].map(s=>w.jsx(G,{title:s.name,popupClose:!0,onClick:async()=>{await c.initMessage(!!(s!=null&&s.group_id),s==null?void 0:s.dialog_id,(s==null?void 0:s.user_id)??(s==null?void 0:s.group_id)),_.navigate(`/message/${s==null?void 0:s.group_id}/${s==null?void 0:s.dialog_id}/?is_group=${s!=null&&s.user_id?"false":"true"}&dialog_name=${s==null?void 0:s.name}`)},children:w.jsx("img",{slot:"media",className:"size-10  object-cover rounded-full",src:s.avatar,alt:""})},s.group_id))]},a))})]})};export{p as default};
