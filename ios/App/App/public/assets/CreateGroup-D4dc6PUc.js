import{R as N,r as m,X as S,j as e,o as O,ak as T,P as I,N as P,V as A,a as R,I as B,W as F,$ as n,x as G,b as E,S as q,L as y,al as M,m as x,E as U,am as V,aj as C,f as u,an as w,y as L}from"./index-BMnTsVIf.js";import{C as b,a as _}from"./card-DOTaUnGT.js";import{S as W}from"./searchbar-Da0mksPT.js";function k(){return k=Object.assign||function(l){for(var o=1;o<arguments.length;o++){var i=arguments[o];for(var t in i)Object.prototype.hasOwnProperty.call(i,t)&&(l[t]=i[t])}return l},k.apply(this,arguments)}function X(l,o){if(l==null)return{};var i={},t=Object.keys(l),d,c;for(c=0;c<t.length;c++)d=t[c],!(o.indexOf(d)>=0)&&(i[d]=l[d]);return i}function $(l){l.children;var o=X(l,["children"]);return N.createElement("svg",k({fill:"currentcolor",xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",viewBox:"0 0 56 56"},o),N.createElement("path",{d:"M 10.0234 43.0234 C 9.2266 43.8203 9.2031 45.1797 10.0234 45.9766 C 10.8438 46.7734 12.1797 46.7734 13.0000 45.9766 L 28.0000 30.9766 L 43.0000 45.9766 C 43.7969 46.7734 45.1563 46.7969 45.9766 45.9766 C 46.7734 45.1562 46.7734 43.8203 45.9766 43.0234 L 30.9531 28.0000 L 45.9766 13.0000 C 46.7734 12.2031 46.7969 10.8437 45.9766 10.0469 C 45.1328 9.2266 43.7969 9.2266 43.0000 10.0469 L 28.0000 25.0469 L 13.0000 10.0469 C 12.1797 9.2266 10.8203 9.2031 10.0234 10.0469 C 9.2266 10.8672 9.2266 12.2031 10.0234 13.0000 L 25.0234 28.0000 Z"}))}const D=({completed:l,defaults:o,opened:i,setOpened:t})=>{const[d,c]=m.useState({}),j=(a,r)=>{var g;return(g=r||o)==null?void 0:g.some(v=>(v==null?void 0:v.dialog_id)===(a==null?void 0:a.dialog_id))},f=async()=>{const a=U.getState().cacheContacts;a&&c(V(a)),p(o||[])};S(async()=>{await f()},()=>{},[i]);const[h,p]=m.useState([]),s=a=>{j(a,h)?p(h.filter(r=>(r==null?void 0:r.dialog_id)!==(a==null?void 0:a.dialog_id))):p([...h,a])};return e.jsx(O,{className:"contact-popup",onPopupOpen:async()=>await f(),onPopupClosed:()=>{c([]),p([]),t&&t(!1)},opened:i,children:e.jsx(T,{children:e.jsxs(I,{className:"bg-bgTertiary",children:[e.jsxs(P,{className:"hidden-navbar-bg bg-bgPrimary coss_contact_navbar",children:[e.jsx(A,{children:e.jsx(R,{popupClose:!0,children:e.jsx(B,{icon:"icon-back"})})}),e.jsx(F,{children:n("选择联系人")}),e.jsx(G,{children:e.jsx(E,{popupClose:!0,onClick:()=>l(h),children:n("完成")})}),e.jsx(q,{inner:!1,children:e.jsx(W,{searchContainer:".contacts-list",placeholder:n("搜索联系人"),searchIn:".item-title",outline:!1,disableButtonText:n("取消")})})]}),e.jsx(y,{strong:!0,noChevron:!0,dividers:!0,contactsList:!0,children:Object.keys(d).map(a=>e.jsxs(M,{children:[e.jsx(x,{groupTitle:!0,title:a}),d[a].map((r,g)=>e.jsx(x,{title:r==null?void 0:r.nickname,checkbox:!0,checkboxIcon:"end",onChange:()=>s(r),defaultChecked:j(r),children:e.jsx("div",{slot:"media",className:"w-10 h-10 ",children:e.jsx("img",{src:r==null?void 0:r.avatar,alt:"",className:"w-full h-full object-cover rounded-full"})})},g))]},a))})]})})})},J=({f7route:l,f7router:o})=>{var p;const i=m.useMemo(()=>{var s;return(s=l==null?void 0:l.query)==null?void 0:s.id},[(p=l==null?void 0:l.query)==null?void 0:p.id]),[t,d]=m.useState({name:"",avatar:"https://cdn.framework7.io/placeholder/nature-1000x600-3.jpg",type:0,max_members_limit:500,member:[]});S(async()=>{try{const{code:s,data:a,msg:r}=await C.groupInfoApi({group_id:i});if(s!==200){u.dialog.alert(n(r||"获取群信息失败"));return}d(w(a,["name","avatar","type","max_members_limit","member"]))}catch(s){u.dialog.alert(n((s==null?void 0:s.message)||"获取群信息失败"))}finally{u.dialog.close()}},()=>{},[]);const[c,j]=m.useState([]),f=async()=>{try{u.dialog.preloader("创建中...");const{code:s,data:a,msg:r}=await C.createGroupApi(t);if(s!==200){u.dialog.alert(r,n("新建群聊失败"));return}const g={dialog_id:a==null?void 0:a.dialog_id,group_id:a==null?void 0:a.id,dialog_type:a==null?void 0:a.type,dialog_name:a==null?void 0:a.name,dialog_avatar:a==null?void 0:a.avatar,dialog_unread_count:0,last_message:{msg_type:0,content:"",sender_id:"",send_time:0,msg_id:0},dialog_create_at:Date.now(),top_at:0};await L.add(L.tables.dialogs,g),o.back()}catch(s){u.dialog.alert(n((s==null?void 0:s.message)||"群聊创建失败"))}finally{u.dialog.close()}},h=async()=>{try{u.dialog.preloader("修改中...");const{code:s,msg:a}=await C.groupUpdateApi({...w(t,["name","avatar","type"]),group_id:parseInt(i)});if(s!==200){u.dialog.alert(n(a||"编辑群聊失败"));return}s===200&&o.back()}catch(s){u.dialog.alert(n((s==null?void 0:s.message)||"编辑群聊失败"))}finally{u.dialog.close()}};return m.useEffect(()=>{if(!c.length)return;const s=c.map(a=>a.user_id);d({...t,member:s})},[c]),e.jsxs(I,{noToolbar:!0,className:"bg-bgTertiary relative",children:[e.jsx(P,{backLink:!0,title:n(i?"修改群聊信息":"新建群聊"),className:"bg-bgPrimary hidden-navbar-bg",children:e.jsx(G,{children:e.jsx(E,{large:!0,disabled:!t.name,onClick:i?h:f,children:n("完成")})})}),e.jsx(b,{className:"coss_card_title pt-6",children:e.jsxs(_,{className:"flex justify-center flex-col items-center",children:[e.jsx("img",{className:"w-20 h-20 rounded-full mb-5",src:t.avatar}),e.jsx("input",{className:"text-center bg-transparent",placeholder:n("请输入群名称"),name:"name",value:t.name,onChange:s=>d({...t,name:s.target.value})})]})}),e.jsx(b,{title:n("群类型"),className:"coss_card_title",children:e.jsx(_,{children:e.jsxs(y,{strongIos:!0,dividersIos:!0,children:[e.jsx(x,{radio:!0,radioIcon:"end",defaultChecked:t.type==1,name:"type",value:"1",onChange:s=>d({...t,type:Number(s.target.value)}),children:e.jsx("span",{slot:"title",className:"text-base",children:n("公开")})}),e.jsx(x,{radio:!0,radioIcon:"end",defaultChecked:t.type==0,name:"type",value:"0",onChange:s=>d({...t,type:Number(s.target.value)}),children:e.jsx("span",{slot:"title",className:"text-base",children:n("私有")})})]})})}),!i&&e.jsx(b,{title:n("群成员"),className:"coss_card_title",children:e.jsx(_,{padding:!1,children:e.jsx(y,{children:e.jsx(x,{link:!0,popupOpen:".contact-popup",children:n("从好友列表选取")})})})}),e.jsx(b,{title:c.length&&n("已选择"),className:"coss_card_title",children:e.jsx(_,{padding:!1,children:e.jsx(y,{children:c.map((s,a)=>e.jsxs(x,{link:!0,noChevron:!0,title:s==null?void 0:s.nickname,children:[e.jsx("img",{slot:"media",src:s==null?void 0:s.avatar,alt:"",className:"w-12 h-12 rounded-full object-cover"}),e.jsx($,{slot:"after",onClick:()=>j(c.filter(r=>r!==s))})]},a))})})}),e.jsx(D,{completed:j,defaults:c})]})};export{J as default};
