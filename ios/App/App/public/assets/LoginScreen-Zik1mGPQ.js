import{r as a,u as B,j as s,P as M,B as v,$ as t,L,c as k,t as S,a as F,b as O,d as D,D as R,U as $,f as E,C as i,s as d,e as z,A as K,T as q}from"./index-BMnTsVIf.js";import{L as N}from"./list-input-Y0iWo3cI.js";import{C as G,L as H,A as J,a as Q,c as V}from"./Auth-RONbL0g7.js";import{v as W}from"./validate-6tRYFLtu.js";import"./tweetnacl-CZjkbTba.js";const re=({f7router:y,defaultData:l})=>{const[o,u]=a.useState({email:"",password:""}),[f,m]=a.useState(""),[x,p]=a.useState(""),[g,h]=a.useState(!1),I=()=>{let r=!1;return g?r:o.email.trim()?W(o.email.trim())?o.password.trim()?(r=!0,h(!0),r):(p(t("密码不能为空")),r):(m(t("邮箱格式不正确")),r):(m(t("邮箱不能为空")),r)},C=B(),A=async()=>{var r,_,j,w;try{if(!I())return;const{identifier:n}=await R.getId(),{code:P,data:e,msg:T}=await $.loginApi({...o,driver_id:n,platform:"ios",driver_token:"7bd439461e80d13a889e08d0c351fdcfa2c697b920536b4a3787ecf69a5206dc"});if(console.dir(e),P!==200){E.dialog.alert(T);return}const c=(r=e==null?void 0:e.user_info)==null?void 0:r.user_id;console.log("user_id",c);const b=await i.findOneById(i.tables.users,"user_id",c);if(b)await i.update(i.tables.users,"user_id",c,{...b,user_info:e==null?void 0:e.user_info});else{const U=await V(c,o.email,!0);await i.add(i.tables.users,{...U,keyPair:null,user_info:e==null?void 0:e.user_info})}d(z,(_=e==null?void 0:e.user_info)==null?void 0:_.user_id),d(K,(j=e==null?void 0:e.user_info)==null?void 0:j.email),d(q,e==null?void 0:e.token),C.update({userId:(w=e==null?void 0:e.user_info)==null?void 0:w.user_id,token:e==null?void 0:e.token,userInfo:e==null?void 0:e.user_info,deviceId:n}),location.reload()}catch(n){console.error("登录失败",n),E.dialog.alert(t("登录失败,请稍后重试"))}finally{h(!1)}};return a.useEffect(()=>{l&&u({email:l.email,password:l.password})},[l]),s.jsxs(M,{loginScreen:!0,noToolbar:!0,children:[s.jsx(v,{className:"fixed top-0 left-0",children:s.jsx(G,{className:"text-2xl text-primary",onClick:()=>y.back()})}),s.jsxs(v,{className:"px-2",children:[s.jsx(H,{children:t("登录")}),s.jsxs(L,{form:!0,children:[s.jsx(N,{label:t("邮箱"),type:"text",placeholder:t("请输入邮箱"),className:"el-input",outline:!0,value:o.email,onInput:r=>{u({...o,email:r.target.value}),m("")},floatingLabel:!0,errorMessage:f,errorMessageForce:!!f,children:s.jsx(J,{slot:"media",className:k("w-5 h-5 text-icon-60",S.ios&&"mt-1")})}),s.jsx(N,{label:t("密码"),type:"password",placeholder:t("请输入密码"),value:o.password,onInput:r=>{u({...o,password:r.target.value}),p("")},outline:!0,floatingLabel:!0,errorMessage:x,errorMessageForce:!!x,children:s.jsx(Q,{slot:"media",className:k("w-5 h-5 text-icon-60",S.ios&&"mt-1")})}),s.jsx("p",{className:"mx-[18px] mt-[6px] flex justify-end",children:s.jsx(F,{href:"#",className:"text-sm text-blue-500",children:"验证码登录"})})]}),s.jsx(L,{inset:!0,children:s.jsx(O,{onClick:A,large:!0,className:"mx-[16px] mb-5",fill:!0,round:!0,text:t("登录"),children:g&&s.jsx(D,{size:"18",color:"white"})})})]})]})};export{re as default};
